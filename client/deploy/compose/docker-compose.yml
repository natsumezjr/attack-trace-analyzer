name: ata-client

services:
  # --- Suricata: network flow + IDS alerts (EVE JSON) ---
  suricata:
    # Image docs (community-maintained by an OISF member):
    # - https://github.com/jasonish/docker-suricata
    image: jasonish/suricata:8.0.1
    container_name: ata-suricata
    restart: unless-stopped
    network_mode: host
    # Follow Suricata container recommendations: allow capturing packets and adjusting niceness.
    # - https://docs.suricata.io/en/suricata-8.0.1/security.html#containers
    cap_add:
      - NET_ADMIN
      - NET_RAW
      - SYS_NICE
    command:
      - -i
      - ${SURICATA_INTERFACE:-eth0}
      - -l
      - /var/log/suricata
      # Load extra rules in addition to those configured in suricata.yaml.
      # - https://docs.suricata.io/en/suricata-8.0.1/command-line-options.html
      - -s
      - /var/lib/suricata/rules/local.rules
    volumes:
      - ./data/suricata:/var/log/suricata
      - ./suricata/rules/local.rules:/var/lib/suricata/rules/local.rules:ro

  # --- Falco: host behavior alerts (JSON) ---
  falco:
    # Official docs:
    # - https://falco.org/docs/setup/container/
    image: falcosecurity/falco:0.42.0
    container_name: ata-falco
    restart: unless-stopped
    privileged: true
    network_mode: host
    volumes:
      # Align with Falco's official docker instructions (Modern eBPF, fully-privileged).
      - /sys/kernel/tracing:/sys/kernel/tracing:ro
      - /var/run/docker.sock:/host/var/run/docker.sock
      - /proc:/host/proc:ro
      - /etc:/host/etc:ro
      - ./falco/falco.yaml:/etc/falco/falco.yaml:ro
      - ./data/falco:/var/log/falco

  # --- Client Backend (Go + SQLite): ECS normalize + buffer + register + /health + /pull ---
  client-backend:
    build:
      context: ../../backend
    container_name: ata-client-backend
    restart: unless-stopped
    network_mode: host
    depends_on:
      - falco
      - suricata
    environment:
      # Identity
      - CLIENT_ID=${CLIENT_ID}
      - CLIENT_VERSION=0.1.0
      - HOST_ID=${HOST_ID}
      - HOST_NAME=${HOST_NAME}

      # Center connectivity
      - CENTER_BASE_URL=${CENTER_BASE_URL}
      - CLIENT_LISTEN_URL=${CLIENT_LISTEN_URL}
      - CLIENT_BIND_ADDR=${CLIENT_BIND_ADDR:-0.0.0.0:18080}

      # Storage
      - ATA_SQLITE_PATH=/var/lib/ata/buffer.sqlite

      # Sensor inputs (container paths)
      - ATA_WAZUH_ALERTS_JSON=/var/lib/wazuh/logs/alerts/alerts.json
      - ATA_WAZUH_ARCHIVES_JSON=/var/lib/wazuh/logs/archives/archives.json
      - ATA_FALCO_EVENTS_JSON=/var/log/falco/events.json
      - ATA_SURICATA_EVE_JSON=/var/log/suricata/eve.json
    volumes:
      - ./data/client:/var/lib/ata
      # Wazuh is installed on the host; mount its log directory so the backend can read JSON logs.
      - /var/ossec/logs:/var/lib/wazuh/logs:ro
      - ./data/suricata:/var/log/suricata:ro
      - ./data/falco:/var/log/falco:ro
