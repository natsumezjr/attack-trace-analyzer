services:
  rabbitmq:
    image: swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/rabbitmq:management
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 5s
      timeout: 5s
      retries: 12

  falco:
    image: swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/falcosecurity/falco:0.42.1
    depends_on:
      rabbitmq:
        condition: service_healthy
    privileged: true
    pid: host
    volumes:
      - /var/run/docker.sock:/host/var/run/docker.sock
      - /dev:/host/dev
      - /proc:/host/proc:ro
      - /boot:/host/boot:ro
      - /lib/modules:/host/lib/modules:ro
      - /usr:/host/usr:ro
      - /etc:/host/etc:ro
      - /sys/kernel/debug:/sys/kernel/debug
      - /sys/kernel/tracing:/sys/kernel/tracing
      - ./data:/data
    command:
      - falco
      - -o
      - json_output=true
      - -o
      - file_output.enabled=true
      - -o
      - file_output.filename=/data/falco.jsonl

  falco-ecs:
    build:
      context: ./sensor/falco/ecs-converter
    depends_on:
      falco:
        condition: service_started
      rabbitmq:
        condition: service_healthy
    environment:
      RABBITMQ_URL: "amqp://guest:guest@rabbitmq:5672/"
      RABBITMQ_QUEUE: "data.falco"
    volumes:
      - ./data:/data
    command:
      - --input
      - /data/falco.jsonl
      - --follow
      - --queue
      - data.falco

  filebeat:
    build:
      context: ./sensor/filebeat
      dockerfile: Dockerfile
    depends_on:
      rabbitmq:
        condition: service_healthy
    volumes:
      - /var/log:/var/log/host:ro
      - ./data/filebeat-output:/app/output
      - ./data:/data
    restart: unless-stopped
    environment:
      - TZ=${TZ:-Asia/Shanghai}
      - RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672/
      - RABBITMQ_QUEUE=data.filebeat
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  suricata:
    build:
      context: ./sensor/suricata/engine
    depends_on:
      rabbitmq:
        condition: service_healthy
    command: ["/bin/sh", "/run-suricata.sh"]
    volumes:
      - ./data:/data
    environment:
      SURICATA_MODE: ${SURICATA_MODE:-live}
      # Optional override, otherwise auto-detected inside container.
      SURICATA_INTERFACE: ${SURICATA_INTERFACE:-auto}
      # Optional override for Suricata address groups:
      # - auto: infer from the capture interface's on-link routes (recommended for one-click deploy)
      # - or an explicit CIDR/list, e.g. "192.168.1.0/24" or "[10.0.0.0/8,192.168.0.0/16]"
      SURICATA_HOME_NET: "${SURICATA_HOME_NET:-auto}"
      # Used when auto-detection fails (e.g. no IPv4 on the capture interface).
      SURICATA_HOME_NET_FALLBACK: "${SURICATA_HOME_NET_FALLBACK:-[10.0.0.0/8,172.16.0.0/12,192.168.0.0/16]}"
      # Only used when SURICATA_MODE=pcap
      PCAP_FILE: ${PCAP_FILE:-/data/pcap/sample.pcap}
    cap_add:
      - NET_ADMIN
      - NET_RAW
    network_mode: host

  suricata-exporter:
    build:
      context: ./sensor/suricata/exporter
    depends_on:
      suricata:
        condition: service_started
      rabbitmq:
        condition: service_healthy
    environment:
      HOST_ID: ${HOST_ID:-sensor-01}
      HOST_NAME: ${HOST_NAME:-suricata-sensor}
      RABBITMQ_URL: "amqp://guest:guest@rabbitmq:5672/"
      RABBITMQ_QUEUE: "data.suricata"
    volumes:
      - ./data:/data

  backend:
    build:
      context: ./backend
    ports:
      - "${CLIENT_API_PORT:-8888}:8888"
    environment:
      RABBITMQ_URL: "amqp://guest:guest@rabbitmq:5672/"
      FALCO_QUEUE: "data.falco"
      FILEBEAT_QUEUE: "data.filebeat"
      SURICATA_QUEUE: "data.suricata"
      # Required: registration server host[:port], e.g. "host.docker.internal:8080".
      SERVER_IP: ${SERVER_IP}
      # Optional override; otherwise backend auto-detects a non-loopback IPv4.
      SELF_IP: ${SELF_IP:-}
    depends_on:
      rabbitmq:
        condition: service_healthy
      falco:
        condition: service_started
      falco-ecs:
        condition: service_started
      filebeat:
        condition: service_started
      suricata:
        condition: service_started
      suricata-exporter:
        condition: service_started
