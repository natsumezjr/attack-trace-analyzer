# Attack Trace Analyzer（恶意攻击行为溯源分析系统）

> 课程设计题目：**基于主机日志、主机行为、网络流量的恶意攻击行为溯源分析系统设计与实现**

本仓库以"文档先行"为核心方法：先把**要求 → 需求 → 规格 → 调研 → 架构 → 接口 → 存储**写死，再并行实现各模块，保证 3 天开发窗口内不走弯路。

---

## 30 秒读懂本项目

### 核心目标

把多源采集到的事件统一为 ECS 子集，并在中心机侧完成检索、检测、关联、攻击链重建与可视化展示。

### 端到端数据流

```
Step 1️⃣ 采集层
   Wazuh / Falco / Suricata
   → 各自格式的 JSON 事件 + 告警
   ⬇️

Step 2️⃣ 客户端后端
   → ECS 归一化（统一字段格式）
   → SQLite 缓冲（本地存储）
   → 启动注册
   → 提供 /health + /pull 接口
   ⬇️

Step 3️⃣ 中心机后端
   → 接收注册，维护注册表
   → 轮询拉取客户端数据
   → 写入 OpenSearch（3个索引）
   ⬇️

Step 4️⃣ 分析层
   → 告警融合：raw → canonical
   → 时间窗关联：聚合相关事件
   → 实体关系抽取：提取节点和边
   → 攻击链重建：识别攻击路径
   → APT 相似度匹配：输出候选组织
   ⬇️

Step 5️⃣ 图谱层
   → Neo4j 存储实体关系图
   → 支持多跳查询和路径推理
   ⬇️

Step 6️⃣ 展示层
   → Next.js UI 从 OpenSearch + Neo4j 读取数据
   → 展示时间线 / 关系图 / 攻击链
   → 导出报告和证据包
```

---

## 文档入口（唯一真相来源）

### 推荐阅读路径

1. **[00-文档索引.md](docs/00-文档索引.md)** - 建议从这里开始，按软件工程生命周期阅读
2. **[01-课程设计要求文档.md](docs/01-课程设计要求文档.md)** - 外部约束与验收标准
3. **[05-模块与数据流说明.md](docs/05-模块与数据流说明.md)** - 面向组员快速上手的"故事线"
4. **[06C-客户端中心机接口规范.md](docs/06C-客户端中心机接口规范.md)** - 客户端 ↔ 中心机接口

### 核心文档速查

| 文档 | 用途 |
|------|------|
| [01-课程设计要求文档.md](docs/01-课程设计要求文档.md) | 题目要求、考核方式、时间地点 |
| [02-整体需求文档.md](docs/02-整体需求文档.md) | 项目目标、范围、功能需求 |
| [03-系统规格说明书.md](docs/03-系统规格说明书.md) | 技术规格、算法设计、输出物 |
| [04-开源项目调研与借鉴清单.md](docs/04-开源项目调研与借鉴清单.md) | 技术选型依据、开源方案对比 |
| [05-模块与数据流说明.md](docs/05-模块与数据流说明.md) | 六大核心模块、数据流6步走 |
| [06-数据库设计.md](docs/06-数据库设计.md) | 数据对象、流转路径总览 |
| [06A-ECS字段规范.md](docs/06A-ECS字段规范.md) | ECS 字段规范、dataset 约定 |
| [06B-存储与图谱设计.md](docs/06B-存储与图谱设计.md) | OpenSearch 索引、Neo4j 图模型 |
| [06C-客户端中心机接口规范.md](docs/06C-客户端中心机接口规范.md) | 客户端 ↔ 中心机接口定义 |

> **重要**：当文档与代码冲突时，以 `docs/` 下的规格文档为准。代码实现应严格遵循文档规范。

---

## 代码结构（当前仓库）

| 目录 | 技术栈 | 作用 |
|------|--------|------|
| `server/` | Next.js + TypeScript | **中心机全栈**（页面 + API，承载注册表/轮询器/展示） |
| `analyzer/` | Python | 关联/溯源相关的 **模型与算法**（逐步落地） |
| `graph/` | Python + Neo4j | 图谱试验代码与数据样例 |
| `docs/` | Markdown | 全部可交付文档（需求/规格/字段/接口/存储/调研） |

---

## 快速运行（中心机 UI）

> UI 开发与页面联调在 `server/` 下进行。

```bash
cd server
npm ci
npm run dev
```

浏览器打开：`http://localhost:3000`

---

## 客户端 ↔ 中心机接口（v1 摘要）

接口详情以 [06C-客户端中心机接口规范.md](docs/06C-客户端中心机接口规范.md) 为准；这里给一个"看一眼就能写代码"的摘要。

| 方向 | 接口 | 方法 | 说明 |
|---|---|---|---|
| Client → Center | `/api/v1/clients/register` | `POST` | 客户端启动注册，拿到 `client_token` 与轮询间隔 |
| Center → Client | `/api/v1/health` | `GET` | **v1 必做**：健康检查（在线探测/排障） |
| Center → Client | `/api/v1/pull` | `POST` | 核心拉取接口：SQLite cursor + `want.*` 过滤 |

**已拍板的实现口径**：
- **Client Backend**：Go；本地缓冲 **SQLite**；`cursor=SQLite 自增 id`；传输使用 **HTTP**（靶场内网）
- **Center**：注册表落 **OpenSearch**（建议索引 `client-registry-*`）；轮询参数固定；离线仅做状态展示不做对外通知
- **算法模块**：Python

---

## 技术栈总览

| 层级 | 技术 | 作用 |
|------|------|------|
| 采集 | Wazuh / Falco / Suricata | 主机日志、主机行为、网络流量 |
| 客户端后端 | Go + SQLite | ECS 归一化、本地缓冲、注册拉取 |
| 中心机后端 | Next.js | API、注册表、轮询器 |
| 存储 | OpenSearch | 3个索引（events/raw-findings/canonical-findings） |
| 检测 | Security Analytics + Sigma | Store-first 检测 |
| 分析 | Python | 告警融合、攻击链重建、APT 匹配 |
| 图谱 | Neo4j | 实体关系图、路径推理 |
| 展示 | Next.js + React | UI、报告导出 |

---

## 核心概念

### 数据分类

- **事实事件（Events / Telemetry）**：只描述"发生了什么"，不做善恶判断
- **告警/发现（Findings / Alerts）**：描述"哪些事实值得怀疑"，对应 ATT&CK 技术点

### 告警分层

- **Raw Findings（原始告警）**：所有来源的告警先都收下，便于追溯
- **Canonical Findings（规范告警）**：去重融合后的唯一信号，用于串链

### 设计原则

- 以 **ECS（Elastic Common Schema）思想**做统一范式：只保留"能关联/溯源"的最小字段集合
- 不追求"严格归因某个 APT 组织"，输出 **基于 TTP 的相似性匹配候选列表**

---

## 开发规范

### 分支管理

- `main`：主分支，保持稳定可部署
- `Huafucius/singapore`：开发分支，日常开发在此分支
- 功能分支：从开发分支切出，完成后合并回开发分支

### 提交规范

使用 Conventional Commits 格式：
- `feat:` 新功能
- `fix:` 修复 bug
- `docs:` 文档更新
- `refactor:` 重构（不改变功能）
- `test:` 测试相关
- `chore:` 构建/工具链相关

### 代码风格

- **TypeScript/JavaScript**：遵循 ESLint 配置
- **Python**：遵循 ruff 规范
- **Go**：遵循 gofmt 标准格式
- **Markdown**：标题层级清晰，编号统一

---

## 验收要求

- 展示完整攻击链，至少覆盖 **入侵/执行/外联(C2)/外传** 中的 3 个阶段
- 输出物包含：时间线 + 关系图 + ATT&CK 标注 + 关键证据
- 在 ≥5 节点靶场环境中完成演示
- 答辩时间：**2026年1月16日**，沙河校区 N108

---

## License

本项目仅用于课程设计，不得用于商业用途。
