# Attack Trace Analyzer（恶意攻击行为溯源分析系统）

> **课程设计题目**: 基于主机日志、主机行为、网络流量的恶意攻击行为溯源分析系统设计与实现

本仓库以"文档先行"为核心方法:先把**要求 → 需求 → 规格 → 调研 → 架构 → 接口 → 存储**写死,再并行实现各模块,保证 3 天开发窗口内不走弯路。

---

## 目录

- [项目概述](#项目概述)
- [核心目标](#核心目标)
- [端到端数据流](#端到端数据流)
- [文档导航](#文档导航)
- [快速开始](#快速开始)
- [技术栈](#技术栈)
- [核心概念](#核心概念)
- [团队成员](#团队成员)
- [开发规范](#开发规范)
- [验收要求](#验收要求)

---

## 项目概述

本项目是一个面向网络空间安全的**多源攻击溯源分析系统**,通过采集主机日志、主机行为和网络流量,实现攻击链重建、实体关系图构建和 APT 组织相似性匹配。

### 核心特性

- **多源数据采集**: 集成 Filebeat（主机系统日志采集 + Sigma 规则检测）、Falco、Suricata 三大传感器
- **统一数据范式**: 基于 ECS (Elastic Common Schema) v9.2.0 的字段规范
- **智能关联分析**: 时间窗聚合 + 实体关系图 + Neo4j 图算法
- **攻击链重建**: 基于 ATT&CK 框架的攻击阶段识别与路径重建
- **APT 相似度匹配**: 基于离线 MITRE ATT&CK Enterprise CTI（STIX 2.1）做 TTP 相似性分析
- **可视化展示**: 时间线、关系图、ATT&CK 矩阵多维度展示

---

## 核心目标

把多源采集到的事件统一为 ECS 子集,并在中心机侧完成**检索、检测、关联、攻击链重建与可视化展示**。

---

## 端到端数据流

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ Step 1️⃣  采集层                                                             │
│   Filebeat+Sigma (主机系统日志与异常检测) / Falco (主机行为) / Suricata (网络流量) │
│   → 各自格式的 JSON 事件 + 告警                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│ Step 2️⃣  客户端后端 (Go)                                                    │
│   → ECS 归一化(统一字段格式)                                                 │
│   → SQLite 缓冲(本地存储)                                                    │
│   → 启动注册(向中心机登记)                                                   │
│   → 提供 /health + /pull 接口(供中心机轮询拉取)                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│ Step 3️⃣  中心机后端 (Python FastAPI)                                       │
│   → 接收注册,维护注册表(OpenSearch: client-registry-*)                       │
│   → 轮询拉取客户端数据(每 5 秒,带抖动)                                        │
│   → 写入 OpenSearch (3个索引: ecs-events-*, raw-findings-*,                  │
│                      canonical-findings-*)                                  │
│   → 触发关联分析算法                                                         │
└─────────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│ Step 4️⃣  分析层 (Python + Neo4j GDS)                                       │
│   → 告警融合: raw → canonical(去重合并)                                      │
│   → 时间窗关联: 聚合相关事件(Δt = 5-20分钟)                                  │
│   → 实体关系抽取: 提取节点(host/user/process/file/ip/domain)和边            │
│   → 攻击链重建: 基于 Neo4j GDS 加权最短路输出关键路径                        │
│   → APT 相似度匹配: TF-IDF + 余弦相似度输出 Top-3 候选组织                    │
└─────────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│ Step 5️⃣  图谱层 (Neo4j + GDS)                                              │
│   → Neo4j 存储实体关系图                                                      │
│   → 支持多跳查询和路径推理                                                    │
│   → GDS 算法: 加权最短路（路径重建）                                          │
└─────────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│ Step 6️⃣  展示层 (Next.js + React 前端)                                      │
│   → 从中心机后端 API 获取数据                                                │
│   → 展示时间线 / 关系图 / 攻击链                                              │
│   → 导出报告(PDF)和证据包(ATT&CK Navigator layer)                            │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 文档导航

> **重要**: 当文档与代码冲突时,以 `docs/` 下的规格文档为准。代码实现应严格遵循文档规范。

### 推荐阅读路径(按软件工程生命周期)

#### 第一步: 理解要求
**[01-课程设计要求文档.md](docs/01-课程设计要求文档.md)**
- 题目要求、组队方法、考核方式、时间地点
- 本项目必须满足的外部约束和验收标准

#### 第二步: 明确需求
**[02-整体需求文档.md](docs/02-整体需求文档.md)**
- 项目目标、范围、功能需求/非功能需求
- 验收标准与交付物

#### 第三步: 技术规格
**[03-系统规格说明书.md](docs/03-系统规格说明书.md)**
- 数据流、模块划分、输入/输出
- 检测与关联算法设计
- 接口与输出物规格

**[04-开源项目调研与借鉴清单.md](docs/04-开源项目调研与借鉴清单.md)**
- 技术选型依据与开源方案对比
- 可复用组件的集成方案

#### 第四步: 架构设计
**[05-模块与数据流说明.md](docs/05-模块与数据流说明.md)**
- 面向组员快速上手的"全流程故事线"
- 六大核心模块的职责划分
- 数据流完整路径(6 步走)

#### 第五步: 详细设计

**[06-数据库设计.md](docs/06-数据库设计.md)**
- 06 系列总览: 数据对象、流转路径、入库路由规则

**[06A-ECS字段规范.md](docs/06A-ECS字段规范.md)**
- ECS 字段规范(ECS v9.2.0 子集 + `custom.*`)
- Telemetry/Findings 的字段口径与 dataset 约定

**[06B-存储与图谱设计.md](docs/06B-存储与图谱设计.md)**
- OpenSearch 索引划分/保留策略
- Neo4j 图模型设计
- 关系型表结构(用于课程报告)

**[06C-客户端中心机接口规范.md](docs/06C-客户端中心机接口规范.md)**
- 客户端 ↔ 中心机接口定义
- 注册流程、轮询拉取机制

### 核心文档速查表

| 文档 | 用途 | 关键内容 |
|------|------|----------|
| [00-文档索引.md](docs/00-文档索引.md) | 阅读导航 | 按生命周期/功能的阅读路径 |
| [01-课程设计要求文档.md](docs/01-课程设计要求文档.md) | 外部约束 | 题目要求、考核方式、时间地点 |
| [02-整体需求文档.md](docs/02-整体需求文档.md) | 需求定义 | 功能需求(FR-01 ~ FR-14)、非功能需求 |
| [03-系统规格说明书.md](docs/03-系统规格说明书.md) | 技术规格 | 数据对象、检测设计、关联算法 |
| [04-开源项目调研与借鉴清单.md](docs/04-开源项目调研与借鉴清单.md) | 技术选型 | 最终选型、开源方案对比 |
| [05-模块与数据流说明.md](docs/05-模块与数据流说明.md) | 快速上手 | 六大模块、数据流 6 步走 |
| [06-数据库设计.md](docs/06-数据库设计.md) | 数据设计总览 | 5 类数据对象、流转路径、路由规则 |
| [06A-ECS字段规范.md](docs/06A-ECS字段规范.md) | 字段标准 | ECS 子集 + custom.* 命名空间 |
| [06B-存储与图谱设计.md](docs/06B-存储与图谱设计.md) | 存储设计 | OpenSearch 索引、Neo4j 图模型 |
| [06C-客户端中心机接口规范.md](docs/06C-客户端中心机接口规范.md) | 接口定义 | 注册、健康检查、拉取接口 |

---

## 快速开始

### 前置要求

- Docker & Docker Compose
- Node.js 18+
- Go 1.21+
- Python 3.10+
- uv (Python 包管理器)

### 启动中心机

**启动后端 (FastAPI)**:
```bash
cd backend
uv sync
uv run uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

**启动前端 (Next.js)**:
```bash
cd frontend
npm ci
npm run dev
```

浏览器打开: `http://localhost:3000`

### 代码结构

| 目录 | 技术栈 | 作用 |
|------|--------|------|
| `client/` | Go + SQLite | **客户端侧**(采集层编排 + ECS 归一化 + 本地缓冲 + 注册/拉取接口) |
| `backend/` | Python FastAPI + uv | **中心机后端**(API、注册表、轮询器、入库路由) |
| `frontend/` | Next.js + TypeScript | **中心机前端**(页面展示、可视化、报告导出) |
| `analyzer/` | Python | 关联/溯源相关的**模型与算法**(逐步落地) |
| `graph/` | Python + Neo4j | 图谱试验代码与数据样例 |
| `docs/` | Markdown | 全部可交付文档(需求/规格/字段/接口/存储/调研) |

---

## 技术栈

### 分层技术栈

| 层级 | 技术 | 作用 |
|------|------|------|
| **采集** | Filebeat(+Sigma) / Falco / Suricata | 主机系统日志、主机行为、网络流量 |
| **客户端后端** | Go + SQLite | ECS 归一化、本地缓冲、注册拉取 |
| **中心机后端** | Python FastAPI + uv | API、注册表、轮询器、入库路由、算法触发 |
| **中心机前端** | Next.js + React | 页面展示、可视化、报告导出 |
| **存储** | OpenSearch | 3 个索引( events/raw-findings/canonical-findings) |
| **检测** | Security Analytics + Sigma | Store-first 检测 |
| **分析** | Python + Neo4j GDS + 离线 ATT&CK Enterprise CTI(STIX 2.1) | 告警融合、攻击链重建、APT 相似度 |
| **图谱** | Neo4j + GDS | 实体关系图、加权最短路（路径重建） |

### 最终选型(已拍板)

- **存储/检索**: OpenSearch
- **库内检测**: OpenSearch Security Analytics (Sigma 规则)
- **图谱与图算法**: Neo4j + Neo4j GDS (加权最短路｜路径重建)
- **中心机后端**: Python FastAPI + uv (API、注册表、轮询器)
- **中心机前端**: Next.js + React (页面展示、可视化)
- **主机侧**: Filebeat (主机系统日志) + Sigma (规则检测) + Falco (主机行为告警)
- **网络侧**: Suricata (统一作为网络流量数据源,EVE JSON 同时产出事实与告警)
- **统一范式**: ECS v9.2.0 + 自定义字段 `custom.*`
- **TTP 知识库**: 离线 ATT&CK Enterprise CTI（STIX 2.1｜attack-stix-data｜默认路径：`backend/app/services/ttp_similarity/cti/enterprise-attack.json`，可用 `ATTACK_CTI_PATH` 覆盖）。数据文件较大，默认不提交到 Git；可用 `./scripts/fetch_attack_cti.sh` 一键下载。
- **攻击复现**: Atomic Red Team
- **输出导出**: ATT&CK Navigator layer
- **Python 包管理**: uv (快速、可靠的 Python 包管理器)

---

## 核心概念

### 数据分类

**事实事件 (Events / Telemetry)**
- 只描述"发生了什么",不做善恶判断
- 来源: 主机日志、主机行为、网络流量
- 存储: OpenSearch `ecs-events-*`

**告警/发现 (Findings / Alerts)**
- 描述"哪些事实值得怀疑",对应 ATT&CK 技术点
- 来源: Detect-first (传感器) + Store-first (Security Analytics)
- 存储: OpenSearch `raw-findings-*` → 融合 → `canonical-findings-*`

### 告警分层

**Raw Findings (原始告警)**
- 所有来源的告警先都收下,便于追溯
- 量级: 中等

**Canonical Findings (规范告警)**
- 去重融合后的唯一信号,用于串链
- 量级: 小 (去重后)

### 关键设计原则

1. **ECS 思想**: 统一范式,只保留"能关联/溯源"的最小字段集合
2. **证据可回溯**: 任意 Finding/边/链路都能回到原始事件
3. **不严格归因**: 不追求"确定归因某 APT 组织",输出**基于 TTP 的相似性匹配候选列表**

---

## 团队成员

| 姓名 | 任务 | 备注 |
| ---- | ---- | ---- |
| 董容嘉 | 数据获取 | 主机行为: Falco |
| 马民泽 | 数据获取 | 网络流量: Suricata |
| 姜乐 | 数据获取 | 主机系统日志: Filebeat + Sigma |
| 田炎烁 | 数据湖构建 | OpenSearch Security Analytics |
| 吕梓杰 | 数据湖构建 | OpenSearch → Neo4j 实体转化 |
| 伍万圣 | 客户机、中心机后端 | FastAPI + Go,包括后端 API |
| 张天华 | 中心机前端、项目教练 | Next.js 前端展示 |
| 范玉彬 | 关联溯源算法 | |
| 曾靖然 | 关联溯源算法 | |
| 王一安 | 靶场环境 | 能部署靶机,并发起模拟 APT 攻击 |

---

## 开发规范

### 提交规范

使用 [Conventional Commits](https://www.conventionalcommits.org/) 格式:

- `feat`: 新功能
- `fix`: 修复 bug
- `docs`: 文档更新
- `refactor`: 重构(不改变功能)
- `test`: 测试相关
- `chore`: 构建/工具链相关

### 代码风格

- **TypeScript/JavaScript**: 遵循 ESLint 配置
- **Python**: 遵循 ruff 规范
- **Go**: 遵循 gofmt 标准格式
- **Markdown**: 标题层级清晰,编号统一

---

## 验收要求

### 功能要求

- 展示完整攻击链,至少覆盖 **入侵/执行/外联(C2)/外传** 中的 3 个阶段
- 输出物包含: 时间线 + 关系图 + ATT&CK 标注 + 关键证据
- 在 ≥5 节点靶场环境中完成演示

### 答辩信息

- **时间**: 2026 年 1 月 16 日
- **地点**: 沙河校区 N108
- **形式**: 10 分钟 PPT 介绍 + 作品演示

---

## License

本项目仅用于课程设计,不得用于商业用途。
