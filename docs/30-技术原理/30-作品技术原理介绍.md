# 作品技术原理介绍

## 文档目的

本文件用于说明本项目从“多源采集”到“检测融合”再到“图谱溯源”的端到端技术原理，面向课程答辩的讲述与评分。

## 读者对象

- 老师与助教
- 负责答辩讲解的同学

## 引用关系

- 字段口径与示例：`../80-规范/81-ECS字段规范.md`
- 图谱规范：`../80-规范/84-Neo4j实体图谱规范.md`
- 接口规范：`../80-规范/86-接口全局约定.md`、`../80-规范/88-前端与中心机接口.md`
- 概要设计：`../40-概要设计/40-概要设计报告.md`

## 1. 多源采集与归一化

系统接入三类数据源：

1. Falco：主机行为与告警（进程、文件、网络相关 syscall 事件）
2. Filebeat：主机日志（认证、系统日志等）
3. Suricata：网络流量与告警（DNS、HTTP、Flow 等）

客户机侧将不同来源的原始数据统一转换为 ECS 子集字段，并为每条事件生成稳定的 `event.id`，最终以队列方式缓冲后提供拉取接口给中心机。

## 2. 中心机轮询拉取与存储

中心机以固定周期轮询所有已注册客户机，拉取增量事件并写入 OpenSearch。

关键机制：

- 单一轮询任务：避免并发导致的数据漂移
- 写入前字段校验：保证三时间字段存在并符合约束
- 幂等写入：以 `event.id` 作为全局去重键

## 3. Storefirst 检测与告警融合

中心机对 Telemetry 触发 Storefirst 检测，产生 Raw Findings，并在固定时间窗内进行融合去重生成 Canonical Findings：

- Raw Findings：保留检测来源与原始信息，用于审计与回放
- Canonical Findings：为图谱与溯源提供稳定输入，并携带证据引用

## 4. 图谱建模与查询

中心机将 Canonical Findings 与必要的 Telemetry 转换为实体关系图写入 Neo4j：

- 节点：主机、用户、进程、文件、域名、IP 等
- 边：进程创建、网络连接、DNS 解析、文件访问等关系
- 边属性承载证据引用与溯源写回结果

前端通过中心机 API 以时间窗查询图边集合并渲染可视化视图。

## 5. 溯源任务与算法

老师在前端点选节点后，中心机创建异步溯源任务：

1. 从 Neo4j 读取目标节点相关的时间窗子图
2. 执行溯源算法生成关键路径边集合
3. 将结果写回到 Neo4j 的边属性 `analysis.*`
4. 更新任务状态，前端轮询并展示结果

溯源算法同时输出解释性摘要，确保每个结论可回溯到 `event.id` 证据链。

## 6. APT 相似度匹配

系统从 Canonical Findings 中提取 `threat.technique.id` 与 `threat.tactic.id`，与离线 ATT&CK CTI 数据进行相似度计算，输出 Top-3 相似组织并给出解释性 techniques。

## 7. 报告导出

前端提供报告导出能力，报告至少包含：

- 时间线摘要
- 关键图谱与证据点
- Technique 覆盖与溯源结果摘要

同一输入时间窗在同一数据集上的导出结果保持一致。

