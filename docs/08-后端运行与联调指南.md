# 后端运行与联调指南（Backend / FastAPI）

> 说明：为避免 `backend/` 目录下文档分散，本指南承接原先位于 `backend/README.md` 与 `backend/scripts/README.md` 的说明内容，统一迁移到 `docs/`。

当本文与规格文档冲突时，以规格文档为准（尤其是字段/接口/存储设计）：
- 环境变量：`docs/ENV_CONFIG.md`
- 入库路由/索引：`docs/06-数据库设计.md`
- 图谱模型：`docs/06B-存储与图谱设计.md`
- 客户端接口：`docs/06C-客户端中心机接口规范.md`

---

## 1. 快速开始（启动 OpenSearch + Neo4j + FastAPI）

### 1.1 启动依赖服务（OpenSearch + Neo4j）

后端依赖服务统一由：`backend/docker-compose.yml` 管理。

```bash
cd backend
cp .env.example .env  # 可选：覆盖默认配置
docker compose up -d
```

默认端口：
- OpenSearch：`https://localhost:9200`（镜像版本固定为 `opensearchproject/opensearch:3.4.0`；开发环境通常是自签名证书，`curl` 需要加 `-k`）
- Neo4j Browser：`http://localhost:7474`
- Neo4j Bolt：`bolt://localhost:7687`

### 1.2 安装 Python 依赖

```bash
cd backend
uv sync
```

### 1.3 启动 FastAPI

```bash
cd backend
uv run uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

---

## 2. 环境变量（.env / os.getenv）

统一说明见：`docs/ENV_CONFIG.md`。

补充约定：
- `backend/.env` **主要用于 Docker Compose 变量替换**；Python 代码默认使用 `os.getenv(..., default)`，不会自动读取 `.env`（除非在入口处引入 `python-dotenv`）。
- OpenSearch 客户端会根据 `OPENSEARCH_NODE` 的 scheme（`http/https`）自动判断 `use_ssl`（见 `backend/app/services/opensearch/client.py`）。

---

## 3. 运行测试（pytest）

```bash
cd backend
uv run pytest
```

部分测试依赖外部服务（OpenSearch / Neo4j），默认会跳过；需要显式开启：

```bash
# 需要 OpenSearch 的测试
RUN_OPENSEARCH_TESTS=1 uv run pytest

# 需要 Neo4j 的测试
RUN_NEO4J_TESTS=1 uv run pytest
```

OpenSearch 测试套件（可选）：
- Bash：`backend/tests/opensearch/run_tests.sh`
- PowerShell：`backend/tests/opensearch/run_tests.ps1`

---

## 4. OpenSearch 模块（Security Analytics / 入库 / 去重）

代码位置：`backend/app/services/opensearch/`

常用入口（对外 API）建议从包导入：
- `initialize_indices()`：创建/初始化索引
- `store_events()`：入库（按 `event.kind` + `event.dataset` 路由）
- `run_data_analysis()`：检测 + 去重（可选依赖 Security Analytics）

> 入库路由规则以 `docs/06-数据库设计.md` 为准；实现见 `backend/app/services/opensearch/storage.py`。

### 4.1 Sigma 规则库（Submodule）

Sigma 规则库目录：`backend/app/services/opensearch/sigma-rules/`

```bash
git submodule update --init --recursive
```

### 4.2 规则导入 / Detector 配置脚本

脚本位置：`backend/app/services/opensearch/scripts/`

```bash
cd backend

# 配置 ISM / Index Management policy（索引保留策略，推荐先跑一次）
uv run python app/services/opensearch/scripts/setup_index_management.py

# 导入 Sigma 规则（示例：自动模式）
uv run python app/services/opensearch/scripts/import_sigma_rules.py --auto

# 配置 Security Analytics detector
uv run python app/services/opensearch/scripts/setup_security_analytics.py
```

### 4.3 索引生命周期与保留策略（ISM / Index Management policy）

本项目使用 OpenSearch **ISM / Index Management policy**（Index State Management）自动管理索引生命周期（主要是到期删除），并与规格文档保持一致：
- `ecs-events-*`：保留 30 天（policy：`ata-ecs-events-retention-30d`）
- `raw-findings-*` / `canonical-findings-*`：保留 180 天（policy：`ata-findings-retention-180d`）
- `attack-chains-*` / `client-registry`：长期保留，不做删除策略

落地方式（代码侧已实现）：
- 脚本入口：`backend/app/services/opensearch/scripts/setup_index_management.py`
- `initialize_indices()` / `setup_security_analytics.py` / `import_sigma_rules.py` 会 best-effort 确保 policies 存在（避免漏配）

> 规格口径见：`docs/06B-存储与图谱设计.md`（生命周期与保留策略 / ISM Policies）。

---

## 5. 图谱模块（ECS → Neo4j）

代码位置：`backend/app/services/graph/`

样例导入（用于快速联调）：
- 样例文件：`backend/tests/fixtures/graph/testExample.json`

```bash
cd backend
uv run python -m app.services.graph.load --file
```

### 5.1 关系类型（当前代码实现）

当前代码中的关系类型定义在 `backend/app/services/graph/models.py`：
- `LOGON`：User → Host
- `PARENT_OF`：Process → Process
- `USES`：Process → File
- `OWNS`：Host/Process → IP/NetConn
- `CONNECTED`：NetConn → NetConn
- `RESOLVED`：Host → Domain
- `RESOLVES_TO`：Domain → IP

> 注意：图谱 node/edge 的权威规格以 `docs/09-实体图谱节点与关系规范v2.md` 为准。  
> 当前代码属于 v1 实现快照：关系命名与网络建模方式（`NetConn + OWNS/CONNECTED`）后续需要按 v2 规范更新实现与测试数据。

---

## 6. 后端脚本（backend/scripts/）

脚本目录用于辅助工具与联调（尤其是 OpenSearch/Security Analytics）。

目录结构：

```
backend/scripts/
├── fetch_mitre_attack_cti.sh              # MITRE ATT&CK CTI 数据下载脚本
└── opensearch/                            # OpenSearch 相关脚本
    ├── clear_findings_data.py             # Findings 数据清理工具
    ├── generate_security_test_events.py   # 测试事件生成器
    ├── test_findings_conversion.py        # Findings 转换和存储测试
    ├── test_findings_deduplication.py     # 告警去重测试工具
    ├── test_full_analysis_flow.py         # 完整分析流程测试
    ├── test_security_analytics_flow.py    # Security Analytics 完整测试流程
    └── test_storage_with_cleanup.py       # 存储测试（含数据清理）
```

### 6.1 MITRE ATT&CK CTI 数据下载/更新

脚本：`backend/scripts/fetch_mitre_attack_cti.sh`

用途：
- 从 MITRE ATT&CK 官方仓库下载 Enterprise CTI（STIX 2.1）数据包
- 供离线 TTP 相似度分析使用（默认输出到 `backend/app/services/ttp_similarity/cti/enterprise-attack.json`）

用法：

```bash
cd backend
./scripts/fetch_mitre_attack_cti.sh
./scripts/fetch_mitre_attack_cti.sh --force
./scripts/fetch_mitre_attack_cti.sh /custom/path/enterprise-attack.json
```

### 6.2 OpenSearch 相关脚本

#### 6.2.1 数据清理工具

文件：`backend/scripts/opensearch/clear_findings_data.py`

用途：
- 清除 OpenSearch 中的 `raw-findings-*` 与 `canonical-findings-*` 索引数据（测试前清空环境）

用法：

```bash
cd backend
uv run python scripts/opensearch/clear_findings_data.py
```

#### 6.2.2 测试事件生成器

文件：`backend/scripts/opensearch/generate_security_test_events.py`

用途：
- 生成符合 ECS 格式的测试安全事件（包含可疑/正常事件，便于触发检测规则）

用法：

```bash
cd backend
uv run python scripts/opensearch/generate_security_test_events.py
```

#### 6.2.3 Findings 转换和存储测试

文件：`backend/scripts/opensearch/test_findings_conversion.py`

用途：
- 验证 findings 的转换与存储（Security Analytics findings → ECS → OpenSearch 入库）

```bash
cd backend
uv run python scripts/opensearch/test_findings_conversion.py
```

#### 6.2.4 告警去重测试工具

文件：`backend/scripts/opensearch/test_findings_deduplication.py`

用途：
- raw → canonical 去重融合验证

```bash
cd backend
uv run python scripts/opensearch/test_findings_deduplication.py
```

#### 6.2.5 存储测试（含数据清理）

文件：`backend/scripts/opensearch/test_storage_with_cleanup.py`

用途：
- 先清除已有数据，再运行检测/存储，验证完整流程

```bash
cd backend
uv run python scripts/opensearch/test_storage_with_cleanup.py
```

#### 6.2.6 完整分析流程测试

文件：`backend/scripts/opensearch/test_full_analysis_flow.py`

用途：
- 检测 + 去重的完整流程验证

```bash
cd backend
uv run python scripts/opensearch/test_full_analysis_flow.py
```

#### 6.2.7 Security Analytics 完整测试流程

文件：`backend/scripts/opensearch/test_security_analytics_flow.py`

用途：
- 最全面联调脚本：索引/规则/detector/检测/去重/验证

```bash
cd backend
uv run python scripts/opensearch/test_security_analytics_flow.py
```

---

## 7. 故障排查

### 问题 1：无法连接到 OpenSearch

常见错误：`ConnectionError` / `Connection refused`

```bash
# 检查 OpenSearch 是否运行
docker ps | rg -n opensearch || true

# 启动 OpenSearch
cd backend
docker compose up -d opensearch
```

### 问题 2：没有检测到 findings

可能原因：
1. Security Analytics 还在扫描中（可能需要等待 1-2 分钟）
2. 测试数据没有触发规则
3. 规则配置需要调整

建议流程：

```bash
cd backend
uv run python scripts/opensearch/generate_security_test_events.py
uv run python scripts/opensearch/test_security_analytics_flow.py
```

### 问题 3：MITRE ATT&CK 数据下载失败

```bash
curl -I https://raw.githubusercontent.com
```

需要代理时：

```bash
export https_proxy=http://your-proxy:port
cd backend
./scripts/fetch_mitre_attack_cti.sh
```

---

## 8. 维护说明（脚本）

### 添加新脚本

1. 将脚本放到相应子目录（如 `backend/scripts/opensearch/`）
2. 添加清晰的文档注释与用法示例
3. 在本文档中补充说明

### 更新现有脚本

1. 保持注释与代码同步
2. 更新使用示例
3. 自测脚本功能（至少跑通关键路径）

---

**最后更新**: 2026-01-13
**维护者**: 张天华
