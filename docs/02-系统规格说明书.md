# 系统规格说明书（SRS / Specification）

## 1. 总体架构

系统由“客户机模块”和“中心机模块”两大部分组成：

- **客户机模块**：Wazuh/Falco/Suricata 采集数据，由 **Go 客户端后端（SQLite 缓冲）**统一归一化/缓冲，并向中心机注册（注册后等待中心轮询拉取）。  
- **中心机模块**：以 **Next.js 全栈**为核心，维护客户端注册表与轮询状态；拉取数据后写入 OpenSearch/Neo4j，并运行关联算法生成攻击链，最终由前端展示与导出。

> 模块与数据流故事线见：`docs/04-模块与数据流说明.md`  
> 客户端注册与中心轮询接口见：`docs/03C-客户端中心机接口规范.md`

### 1.1 组件分层

1) **客户机采集层（Sensors）**  
主机日志/主机行为/网络流量分别由对应传感器采集（本项目固定为 Wazuh/Falco/Suricata）。

2) **客户端后端层（Client Backend / Go）**  
把不同来源事件映射到 ECS 子集字段并 **SQLite 本地缓冲**；启动后向中心机注册；对外提供拉取接口供中心机轮询。

3) **中心机全栈服务（Center / Next.js）**  
接收客户端注册、维护注册表与 cursor；按 interval 轮询拉取数据；提供查询 API 与前端页面。

4) **存储与检索层（Storage）**  
以 **OpenSearch + Neo4j** 为核心存储：OpenSearch 保存 Telemetry/Findings/Chains；Neo4j 保存实体关系图。

5) **检测与关联层（Detection & Correlation）**  
既支持传感器直接产告警（Detect-first），也支持入库后扫描产告警（Store-first）；并基于实体图完成路径重建与攻击链生成。

6) **展示与导出（UI & Export）**  
Next.js 前端展示：时间线、告警、关系图、攻击链摘要、ATT&CK 覆盖矩阵与报告导出。

## 2. 数据对象：从大到小的“金字塔”

为避免“统一进 OpenSearch 后还会产出什么数据”的混乱，本项目定义 5 类核心数据对象：

1) **Raw Events（原始事件）**：格式各异，来自传感器/日志源。  
2) **Normalized Events（规范化事件 / Telemetry）**：Raw → ECS 子集后的事实记录。  
3) **Findings/Alerts（检测结果）**：规则/检测对 Telemetry 的判定输出。  
4) **Graph/Chain/Attribution（分析产物）**：实体关系图、攻击链实例、相似 APT 候选等。
5) **Client Registry（注册表/轮询状态）**：中心机维护的客户端清单、cursor、last_seen 等（本项目落 OpenSearch：`client-registry-*`，支撑轮询与展示“多节点在线”）。

> 原则：越往上层，数据量越小、价值越高、越适合展示/汇报。

## 3. 数据采集与输入规范

### 3.1 数据源（本项目最终选型）

- 主机日志：Wazuh（主机日志采集只使用 Wazuh）
- 主机行为：Falco（输出行为告警为主）
- 网络流量：Suricata（统一作为网络流量数据源，EVE JSON 同时产出事实与告警）

### 3.2 归一化（ECS 子集）必填字段

为了保证后续“串链”，至少应填充以下字段（缺失会显著影响关联效果）：

- ECS 版本：`ecs.version`（统一为 ECS v9.2.0）
- 时间：`@timestamp`
- 事件元信息：`event.kind`（event/alert）、`event.category`、`event.type`、`event.action`、`event.module`
- 事件唯一标识：`event.id`（用于证据引用与跨索引关联）
- 主机：`host.name`（必填；如可提供稳定唯一标识，也建议补充 `host.id`）
- 用户（如适用）：`user.name`（建议必填）、`user.id`（可获取则补充）
- 进程（如适用）：`process.entity_id`、`process.pid`、`process.parent.pid`、`process.name`、`process.command_line`
- 网络（如适用）：`source.ip`、`destination.ip`、`destination.port`、`network.transport`、`network.direction`
- DNS（如适用）：`dns.question.name`
- 文件（如适用）：`file.path`、`file.hash.*`
- 回溯：`event.original`（本项目按课程规模默认保留，便于截图/复盘）

## 4. 检测（Detection）设计

### 4.1 两条流水线：Detect-first 与 Store-first

#### A) Detect-first（源头产 Findings）

典型来源：Suricata、Falco、Wazuh。  
特点：快速见效、开发友好；但需要后续统一字段，跨主机/跨源关联仍要自研。

输入：本机/本链路遥测 + 本地规则  
输出：告警事件（Alert/Finding），含规则名、严重度、关键实体

#### B) Store-first（入库后扫描产 Findings）

典型来源：Sigma 规则库 + OpenSearch Security Analytics。  
特点：字段统一、跨源更强；但前置“解析/映射”质量要求高。

输入：ECS Telemetry 索引 + 规则（Sigma/自定义）  
输出：Findings/Alerts（统一结构）

### 4.2 Finding 统一结构（规格）

无论来源如何，进入“关联与溯源层”的 Finding 统一为以下结构（字段名可按栈选型适配）：

- `event.id`：唯一 ID
- `custom.finding.stage`：`raw` / `canonical`
- `custom.finding.providers`：告警来源列表（raw 可为单元素；canonical 为多元素）
- `@timestamp`：命中时间（或检测时间）
- `rule.id` / `rule.name` / `rule.version`：规则信息（ECS）
- `event.severity`：严重度（统一为 0–100 的整数，ECS）
- `custom.confidence`：可信度（0–1）
- `threat.tactic.*` / `threat.technique.*`：ATT&CK 标注（至少 technique_id，ECS）
- `host.* / user.* / process.* / source.* / destination.* / file.* / dns.*`：用于串链的关键实体（ECS 子集）
- `custom.evidence.event_ids`：证据引用（命中的 Telemetry `event.id` 列表，`custom.*` 自定义字段）
- `custom.evidence.query`：预留字段（v1 不作为实现目标）

> 统一 Finding 模型是本项目最关键的“胶水层”。它决定了后续能否用一套关联逻辑处理不同来源告警。
>
> 说明：本项目以 ECS 为主（`event.* / rule.* / threat.* / host.* ...`），所有自定义字段统一放入 `custom.*` 命名空间（见 `docs/03A-ECS字段规范.md`）。

### 4.3 告警融合去重（Raw → Canonical Findings）

当 Detect-first（Suricata/Falco…）与 Store-first（Sigma/Detectors…）同时运行时，**重复告警是常态**。正确做法不是“强行避免重复”，而是把告警当作 **信号（signal）**，并在进入串链前做一层“信号融合”（Alert Fusion）。

#### 三层数据（逻辑分层即可）

- **Telemetry（事实层）**：ECS 规范化事件，作为证据原文与上下文（量最大）
- **Raw Findings（原始告警层）**：所有来源的告警先全部收下，用于回溯与审计（量中等）
- **Canonical Findings（规范告警层）**：对 Raw Findings 去重/合并后的“唯一信号”，后续串链只吃这一层（量最小）

> 这样做的核心收益：  
> 1) 避免“同一件事被喊 5 次”导致链条虚假拉长；  
> 2) 多引擎对同一行为的共识可转化为更高置信度；  
> 3) 关联图可视化更干净，不会变成“毛线团”。

#### 指纹（fingerprint）与合并策略（MVP 可落地）

在时间窗 Δt 内，将满足下列条件的 Raw Finding 合并为一条 Canonical Finding：

- 指纹建议由以下元素组成：  
  `technique_id + host + (process_entity_id | dst_ip/domain | file_hash) + time_bucket`
- 其中 `time_bucket = floor(@timestamp / Δt)`，Δt 可取 1–5 分钟（实验规模小建议偏小）。

合并时：

- `custom.finding.providers`：来源引擎追加（suricata/falco/opensearch-security-analytics…）
- `custom.evidence.event_ids`：证据引用合并去重
- `event.severity`：取 max 或加权
- `custom.confidence`：可按“来源数量/一致性”上调

## 5. 关联分析与攻击链重建

### 5.1 实体关系图（Entity Graph）

图模型的节点类型（Node Types）建议至少包含：

- `host`、`user`、`process`、`file`、`ip`、`domain`（`session` 为派生概念，不单独作为节点长期落地）

边类型（Edge Types）按“证据能证明的关系”定义：

- `spawned`：进程创建（parent → child）
- `connects_to`：进程/主机对外连接（process/host → ip:port）
- `queries`：DNS 查询（process/host → domain）
- `writes/reads`：文件写入/读取（process → file）
- `logged_in_to`：登录会话（user → host/session）

每条边必须携带 `custom_evidence_event_ids`，能回溯到 Telemetry/Findings。

### 5.2 串链策略（3 天可落地版本）

#### 关联键（Join Keys）

优先用以下键连边（从强到弱）：

1) `process.entity_id` / PID-PPID 链  
2) `user + logon_id/session_id`  
3) `destination.ip/domain`（外联/C2/外传）  
4) 时间窗口 Δt 约束（例如 5–20 分钟）

#### 攻击链抽取

> 建议以 **Canonical Findings** 作为攻击链的“种子/节点”，必要时再回查 Raw Findings 与 Telemetry 做证据回放。

1) 将每个 technique 映射到 tactic（ATT&CK 自带映射关系）。  
2) 规定阶段顺序（示例）：  
   `Initial Access → Execution → Persistence → Privilege Escalation → Lateral Movement → Command and Control → Exfiltration`
3) 从“初始入侵候选点”（外联入口/可疑登录/漏洞利用告警）出发，在图上 BFS/DFS：
   - 优先沿进程链与同一主机边扩展
   - 其次沿网络外联边扩展（C2/下载/外传）
   - 若出现“新主机触达”（同一账号在另一主机登录/远程服务），标记横向移动
4) 输出：
   - 时间线（technique 序列）
   - 路径图（节点/边 + 每步 technique）
   - 阶段摘要（每个 tactic 的关键证据与持续时间）

### 5.3 APT/TTP 相似性匹配（候选输出）

严格归因较难，课程项目更合理的做法是基于 TTP 做相似性匹配：

- 取本次攻击链 technique 集合 `S`
- 对比各组织/剧本 technique 集合 `G_i`
- 相似度：Jaccard(`S`,`G_i`) = `|S∩G_i| / |S∪G_i|`
- 本项目不做加权（普通 Jaccard 足够支撑“解释性候选输出”）

输出建议：

- Top-3 候选组织 + 相似度分数
- 最具区分度的 3–5 个 techniques（作为解释）

> 输出措辞建议：使用“相似度最高的候选”，避免宣称“确定归因”。

## 6. 接口与输出物

### 6.1 服务形态与接口（建议规格）

中心机以 **Next.js 全栈服务**为核心，包含两类接口：

1) **客户端对接接口（注册 + 拉取）**：见 `docs/03C-客户端中心机接口规范.md`  
2) **分析与展示接口（前端/后端）**：由 Next.js 提供页面与 API（MVP 可先做页面直连查询）

建议中心机前端页面（示意）：

- Clients：客户端列表/在线状态（注册表）
- Events：Telemetry 检索（时间/host/实体过滤）
- Findings：告警检索（technique/tactic/规则过滤）
- Graph：子图展示（按 chain 或时间窗）
- Chains：攻击链摘要与证据回放

### 6.2 输出物清单

- `Attack Chain Report`：链路摘要（**PDF**）
- `Evidence Bundle`：关键证据 event_id/raw_ref 列表 + 截图说明
- `ATT&CK Navigator layer`：矩阵标注文件

## 7. 靶场与演示建议

### 7.1 靶场规模

满足课程要求：不少于 5 个节点（可包括：域控/业务主机/攻击机/日志平台/网络传感器等）。

### 7.2 复现与验证

- 使用 Atomic Red Team 复现若干 ATT&CK techniques，产生稳定日志/流量，保证演示可重复、可对照
