# 存储与图谱设计（OpenSearch + Neo4j + GDS，v1）

> **本文定位**：本文是 **03 系列（数据设计）** 的"存储落地篇"，关注：
> - OpenSearch 索引划分与字段类型建议
> - Neo4j 实体关系图建模（用于多跳关联/路径重建）
> - 关系型表结构（用于课程报告展示；系统运行不依赖关系型数据库）
>
> **相关文档**：
> - ECS 字段规范（Telemetry/Findings 统一口径）：`docs/06A-ECS字段规范.md`
> - 客户端注册与中心轮询接口：`docs/06C-客户端中心机接口规范.md`
> - 数据设计总览：`docs/06-数据库设计.md`

---

## 目录

- [1. 设计目标与原则](#1-设计目标与原则)
- [2. OpenSearch 索引设计](#2-opensearch-索引设计推荐落地)
- [3. Neo4j 图数据库设计](#3-neo4j-图数据库设计最终落地)
- [4. 关系型数据库表结构](#4-关系型数据库表结构用于报告或中心机元数据)

---

## 1. 设计目标与原则

### 1.1 核心设计目标

| 目标 | 说明 | 实现方式 |
|------|------|---------|
| **跨源关联优先** | 围绕实体展开关联 | host/user/process/ip/domain/file |
| **证据可回溯** | 任意 Finding/边/链路都能回到原始事件 | 保存 `event.id` 引用 |
| **数据量可控** | 分层存储，按价值保留 | Telemetry 短期，Findings/Graph 长期 |
| **中心机权威写入** | 客户端只输出 ECS | 索引/图谱/融合/串链由中心机完成 |
| **图算法可解释** | 路径重建与相似度输出可解释 | Neo4j GDS（加权最短路、相似度检索） |

---

### 1.2 设计原则

**实体优先**：
- `session` 为派生概念（从认证事件抽象），不作为核心实体
- 核心实体：`Host`, `User`, `Process`, `File`, `IP`, `Domain`

**证据回溯**：
- 任意 Finding 通过 `custom.evidence.event_ids` 引用 Telemetry
- Neo4j 边通过 `custom_evidence_event_ids` 引用 Telemetry
- 攻击链通过 Neo4j 子图引用 + 关键证据回放

**分层存储**：
- Telemetry：量大，短期保留（**30 天**）
- Raw Findings：量中等，中期保留（**180 天**）
- Canonical Findings：量小，长期保留（**180 天**）
- Entity Graph：量小，长期保留
- Attack Chains：量最小，永久保留

---

## 2. OpenSearch 索引设计（推荐落地）

### 2.1 索引划分（按数据对象）

> **术语说明**：OpenSearch 中叫 **Index（索引）**，在课程报告里可类比为"表"。

---

#### 2.1.1 `ecs-events-*`（Telemetry）

**用途**：存放 ECS 化后的事实事件。

**数据来源**：
- 主机日志（`hostlog.*`）
- 主机行为（`hostbehavior.*`）
- 网络流量（`netflow.*`）

**保留周期**：30 天

**数据量**：⭐⭐⭐⭐⭐（最大）

---

#### 2.1.2 `raw-findings-*`（Raw Findings）

**用途**：存放所有来源的原始告警/发现（Detect-first + Store-first），用于证据回溯与审计。

**数据来源**：
- 端侧 Detect-first（Falco、Suricata）
- 中心侧 Store-first（OpenSearch Security Analytics）

**保留周期**：180 天

**数据量**：⭐⭐⭐⭐

---

#### 2.1.3 `canonical-findings-*`（Canonical Findings）

**用途**：存放对 Raw Findings 融合去重后的"规范告警"，后续攻击链构建主要消费这一层。

**数据来源**：
- 中心机告警融合模块生成

**保留周期**：180 天

**数据量**：⭐⭐⭐

---

#### 2.1.4 `attack-chains-*`（Attack Chains）

**用途**：存放攻击链实例与摘要（阶段、关键证据、Top-N 相似度等）。

**数据来源**：
- 中心机攻击链生成模块输出

**保留周期**：长期（永久）

**数据量**：⭐（最小）

---

#### 2.1.5 `client-registry-*`（客户端注册表）

**用途**：存放中心机维护的"客户端注册表 + 轮询状态"。

**数据来源**：
- 客户端注册（`POST /api/v1/clients/register`）
- 中心机轮询状态更新

**保留周期**：长期

**数据量**：⭐（最小，只与客户端数量相关）

---

### 2.1.6 索引汇总

| 索引模式 | 数据对象 | 保留周期 | 数据量 |
|---------|---------|---------|:----:|
| `ecs-events-*` | Telemetry | 30 天 | ⭐⭐⭐⭐⭐ |
| `raw-findings-*` | Raw Findings | 180 天 | ⭐⭐⭐⭐ |
| `canonical-findings-*` | Canonical Findings | 180 天 | ⭐⭐⭐ |
| `attack-chains-*` | Attack Chains | 长期 | ⭐ |
| `client-registry-*` | 客户端注册表 | 长期 | ⭐ |

**说明**：
- 实体关系图（节点/边）的权威存储在 **Neo4j** 中
- 本方案不再单独维护 `analysis-edges-*` / `analysis-entities-*` 索引，避免双写与数据漂移

---

### 2.2 Mapping 级别要点（避免踩坑）

字段语义与"各 dataset 的字段要求"统一以 `docs/06A-ECS字段规范.md` 为准。本节仅给出 **索引模板（mapping）层面的要点**。

---

#### 2.2.1 时间字段

| 字段 | 类型（建议） | 说明 |
|------|-----------|------|
| `@timestamp` | `date` | 主时间轴（排序、时间窗关联） |
| `event.created` | `date` | 采集观察时间 |
| `event.ingested` | `date` | 入库时间 |

**约束**：所有时间字段统一使用 `date` 类型，格式为 ISO 8601（UTC 时区）。

---

#### 2.2.2 主键与关联键

| 字段 | 类型（建议） | 说明 |
|------|-----------|------|
| `event.id` | `keyword` | 事件唯一 ID（主键） |
| `host.id` | `keyword` | 主机唯一标识（跨源关联键） |
| `process.entity_id` | `keyword` | 进程实例标识（进程树关联） |
| `session.id` | `keyword` | 会话标识（会话重建） |
| `flow.id` | `keyword` | 流/会话 ID |
| `network.community_id` | `keyword` | 会话聚合 ID |

**约束**：所有 ID 字段统一使用 `keyword` 类型，避免分词。

---

#### 2.2.3 枚举字段

| 字段 | 类型（建议） | 说明 |
|------|-----------|------|
| `event.kind` | `keyword` | `event` / `alert` |
| `event.dataset` | `keyword` | `hostlog.*`, `hostbehavior.*`, ... |
| `event.action` | `keyword` | 动作枚举 |
| `rule.id` | `keyword` | 规则 ID |
| `threat.tactic.id` | `keyword` | 战术 ID |
| `threat.technique.id` | `keyword` | 技术 ID |

**约束**：枚举字段统一使用 `keyword` 类型，便于聚合与筛选。

---

#### 2.2.4 网络字段

| 字段 | 类型（建议） | 说明 |
|------|-----------|------|
| `source.ip` | `ip` | 源 IP |
| `destination.ip` | `ip` | 目的 IP |
| `source.port` | `long` | 源端口 |
| `destination.port` | `long` | 目的端口 |

**约束**：
- IP 字段统一使用 `ip` 类型（支持 IPv4/IPv6）
- 端口统一使用 `long` 类型

---

#### 2.2.5 全文与模糊检索字段

| 字段 | 类型（建议） | 说明 |
|------|-----------|------|
| `process.command_line` | `wildcard` | 命令行（支持模糊匹配） |
| `url.full` | `wildcard` | 完整 URL（支持模糊匹配） |
| `event.original` | `text` | 原始日志（关闭索引，只存储） |
| `message` | `text` | 人类可读摘要 |

**约束**：
- `wildcard` 类型兼顾搜索与聚合（不会分词）
- `event.original` 关闭索引（`index: false`），只存储用于证据回放

---

#### 2.2.6 自定义字段（custom.*）

| 字段 | 类型（建议） | 说明 |
|------|-----------|------|
| `custom.finding.stage` | `keyword` | 告警阶段（raw/canonical） |
| `custom.finding.providers` | `keyword[]` | 告警来源（数组） |
| `custom.finding.fingerprint` | `keyword` | 融合指纹 |
| `custom.evidence.event_ids` | `keyword[]` | 证据事件列表 |
| `custom.dns.entropy` | `float` | DNS 熵值 |
| `custom.dns.query_length` | `long` | DNS 查询长度 |
| `custom.dns.tunnel_score` | `float` | DNS 隧道评分 |
| `custom.icmp.payload_size` | `long` | ICMP 载荷大小 |
| `custom.yara.rule_names` | `keyword[]` | YARA 命中规则名列表 |
| `custom.fingerprint.labels` | `keyword[]` | 指纹标签（家族/工具/特征） |

**约束**：
- 自定义字段结构稳定，避免动态字段爆炸
- 用于聚合/去重/引用的字段优先使用 `keyword` / `keyword[]`

---

### 2.3 `client-registry-*`（中心机元数据｜本项目采用）

注册表不是 ECS 事件，但本项目将其作为**中心机注册表/轮询状态的权威存储**，并放入独立索引，便于查询与 UI 展示。

---

#### 2.3.1 建议字段

| 字段 | 类型 | 说明 | 示例 |
|------|------|------|------|
| `client.id` | `keyword` | 客户端唯一 ID（主键） | `client-victim-01` |
| `client.listen_url` | `keyword` | 客户端对外地址 | `http://10.0.0.11:18080` |
| `client.version` | `keyword` | 客户端版本 | `0.1.0` |
| `client.host.id` | `keyword` | 主机 ID | `h-a1b2c3d4e5f6a7b8c` |
| `client.host.name` | `keyword` | 主机名 | `victim-01` |
| `client.capabilities.wazuh` | `boolean` | 能力：Wazuh | `true` |
| `client.capabilities.falco` | `boolean` | 能力：Falco | `true` |
| `client.capabilities.suricata` | `boolean` | 能力：Suricata | `true` |
| `client.capabilities.yara` | `boolean` | 能力：YARA | `true` |
| `client.token_hash` | `keyword` | Token 哈希（不存明文） | `sha256(token)` |
| `poll.cursor` | `keyword` | 中心机消费位置 | `cursor-0123456789abcdef` |
| `poll.last_seen` | `date` | 最后拉取成功时间 | `2026-01-12T12:00:00Z` |
| `poll.last_error` | `text` | 最后错误（如有） | `Connection refused` |
| `@timestamp` | `date` | 中心机更新时间 | `2026-01-12T12:00:00Z` |

**约束**：
- `client.id` 为唯一标识（主键）
- `client.token_hash` 不得存储明文 token
- 同一 `client.id` 重复注册应更新而非创建新记录

---

#### 2.3.2 存储方案（v1 固定）

本项目注册表与轮询状态固定落到 **OpenSearch**（索引：`client-registry-*`），中心机运行不依赖 SQLite/PG 等关系型元数据库。

---

### 2.4 生命周期与保留策略（v1 固定）

| 索引 | 保留周期 | 删除策略 | 备份建议 |
|------|---------|---------|---------|
| `ecs-events-*` | 30 天 | 到期删除（ILM） | 不归档 |
| `raw-findings-*` | 180 天 | 到期删除（ILM） | 归档 |
| `canonical-findings-*` | 180 天 | 到期删除（ILM） | 归档 |
| `attack-chains-*` | 长期 | 不删除 | 备份 |
| `client-registry-*` | 长期 | 不删除 | 备份 |
| **Neo4j** | 长期 | 不删除 | Docker volume 持久化（本项目不做备份/快照） |

**说明**：
- 本项目启用 OpenSearch **ILM（Index Lifecycle Management）** 自动管理（rollover + 到期删除）
- 不同生命周期的数据可设置不同的保留策略
- Neo4j 用于路径重建与展示，长期保留（本项目仅做持久化，不做备份策略）

---

## 3. Neo4j 图数据库设计（最终落地）

> **OpenSearch 擅长"时间序列检索与聚合"，不擅长"多跳关系推理"。**
> **本项目采用 Neo4j 作为图谱权威存储，并通过 Neo4j GDS 运行加权最短路与相似度检索算法。**

---

### 3.1 建模目标

| 目标 | 说明 | 实现方式 |
|------|------|---------|
| **实体抽象** | 将 Telemetry 与 Canonical Findings 抽象成实体与关系 | 节点/边建模 |
| **路径重建** | 支持关键路径输出：初始入侵 → 执行 → 横向 → C2 → 外传 | Neo4j GDS 加权最短路 |
| **证据回溯** | 任意边都能回放证据 | 边属性保存 `event.id` 列表 |
| **TTP 相似度** | 输出 Intrusion Set Top-3 候选 + 解释性 techniques | GDS 余弦相似度检索（向量） |

---

### 3.2 节点（Labels）与关键属性

#### 3.2.1 节点类型

| Label | 说明 | 唯一属性 | 关键属性 | 示例 |
|-------|------|---------|---------|------|
| `Host` | 主机 | `id` | `name` | `id: "h-a1b2c3d4e5f6a7b8c"` |
| `User` | 用户 | `id` | `name` | `id: "u-alice-12345678"` |
| `Process` | 进程 | `id` | `name`, `pid`, `host_id`, `start_ts` | `id: "p-f1e2d3c4b5a69788"` |
| `File` | 文件 | `id` | `path`, `hash` | `id: "f-0123456789abcdef"` |
| `IP` | IP 地址 | `addr` | - | `addr: "10.0.0.5"` |
| `Domain` | 域名 | `name` | - | `name: "evil.com"` |
| `Technique` | ATT&CK 技术 | `id` | `name` | `id: "T1055"` |
| `IntrusionSet` | ATT&CK 组织（Group） | `id` | `name`, `aliases`, `embedding` | `id: "G0016"` |
| `AttackChain` | 攻击链实例 | `id` | `start_ts`, `end_ts`, `embedding` | `id: "chain-2026-01-12-0001"` |

**约束**：
- `Process.id` 对齐 ECS `process.entity_id`（跨源一致）
- `IP.addr` 和 `Domain.name` 为唯一标识
- `Technique.id` 使用 ATT&CK 技术 ID（`Txxxx`）
- `IntrusionSet.id` 使用 ATT&CK 组织 ID（`Gxxxx`）
- 节点属性不存储敏感信息（如密码、密钥）

---

#### 3.2.2 节点属性示例

**Host 节点**：
```cypher
{
  id: "h-a1b2c3d4e5f6a7b8c",
  name: "victim-01"
}
```

**Process 节点**：
```cypher
{
  id: "p-f1e2d3c4b5a6978869504132a7b6c8d9",
  name: "ssh",
  pid: 1234,
  host_id: "h-a1b2c3d4e5f6a7b8c",
  start_ts: "2026-01-12T03:21:10.123Z"
}
```

**File 节点**：
```cypher
{
  id: "f-0123456789abcdef0123456789abcdef",
  path: "/etc/passwd",
  hash: "sha256:..."
}
```

---

### 3.3 关系（Relationships）与证据引用

#### 3.3.1 关系类型

| 关系 | 说明 | 属性 | 示例 |
|------|------|------|------|
| `(User)-[:LOGON]->(Host)` | 用户登录主机 | `ts`, `weight`, `custom_evidence_event_ids` | alice 登录 victim-01 |
| `(Process)-[:SPAWNED]->(Process)` | 进程启动进程 | `ts`, `weight`, `custom_evidence_event_ids` | bash 启动 ssh |
| `(Process)-[:ACCESSED]->(File)` | 进程访问文件 | `op`, `ts`, `weight`, `custom_evidence_event_ids` | ssh 读取 /etc/passwd |
| `(Process)-[:CONNECTED]->(IP)` | 进程连接 IP | `ts`, `dst_port`, `weight`, `custom_evidence_event_ids` | curl 连接 10.0.0.5:443 |
| `(Host)-[:RESOLVED]->(Domain)` | 主机解析域名 | `ts`, `weight`, `custom_evidence_event_ids` | victim-01 解析 evil.com |
| `(Domain)-[:RESOLVES_TO]->(IP)` | 域名解析到 IP | `ts`, `weight`, `custom_evidence_event_ids` | evil.com → 10.0.0.5 |
| `(IntrusionSet)-[:USES]->(Technique)` | 组织使用技术（离线 CTI） | `source` | G0016 uses T1055 |
| `(AttackChain)-[:OBSERVED]->(Technique)` | 本次攻击链观察到技术 | `score` | chain observed T1071 |

**约束**：
- `custom_evidence_event_ids` 为字符串数组，指向 OpenSearch `ecs-events-*` 中的 `event.id`
- 所有关系必须包含时间戳 `ts`（用于时间窗过滤）
- `op` 表示操作类型（如 `read`/`write`/`execute`）
- `weight` 为浮点权重（用于 Neo4j GDS 加权最短路），权重越小表示关联越强、路径越可信

---

#### 3.3.2 关系示例

**LOGON 关系**：
```cypher
(:User {id: "u-alice-12345678"})-[:LOGON {
  ts: "2026-01-12T03:21:10.123Z",
  custom_evidence_event_ids: ["evt-1b2c3d4e5f6a7b8c"]
}]->(:Host {id: "h-a1b2c3d4e5f6a7b8c"})
```

**SPAWNED 关系**：
```cypher
(:Process {id: "p-parent"} )-[:SPAWNED {
  ts: "2026-01-12T03:21:10.123Z",
  custom_evidence_event_ids: ["evt-2c3d4e5f6a7b8c9d"]
}]->(:Process {id: "p-child"})
```

---

### 3.4 约束与索引（落地）

#### 3.4.1 唯一约束

| Label | 唯一属性 | 说明 |
|-------|---------|------|
| `Host` | `id` | 主机 ID 唯一 |
| `User` | `id` | 用户 ID 唯一 |
| `Process` | `id` | 进程 ID 唯一 |
| `File` | `id` | 文件 ID 唯一 |
| `Domain` | `name` | 域名唯一 |
| `IP` | `addr` | IP 地址唯一 |
| `Technique` | `id` | 技术 ID 唯一 |
| `IntrusionSet` | `id` | 组织 ID 唯一 |
| `AttackChain` | `id` | 攻击链 ID 唯一 |

**创建约束示例**：
```cypher
CREATE CONSTRAINT host_id_unique IF NOT EXISTS FOR (h:Host) REQUIRE h.id IS UNIQUE
CREATE CONSTRAINT user_id_unique IF NOT EXISTS FOR (u:User) REQUIRE u.id IS UNIQUE
CREATE CONSTRAINT process_id_unique IF NOT EXISTS FOR (p:Process) REQUIRE p.id IS UNIQUE
```

---

#### 3.4.2 常用索引

| Label | 属性 | 说明 |
|-------|------|------|
| `Host` | `name` | 按主机名查询 |
| `User` | `name` | 按用户名查询 |
| `Process` | `name` | 按进程名查询 |
| `File` | `path` | 按路径查询 |
| `Technique` | `id` | 按技术 ID 查询 |
| `IntrusionSet` | `id` | 按组织 ID 查询 |

**创建索引示例**：
```cypher
CREATE INDEX host_name_index IF NOT EXISTS FOR (h:Host) ON (h.name)
CREATE INDEX user_name_index IF NOT EXISTS FOR (u:User) ON (u.name)
CREATE INDEX process_name_index IF NOT EXISTS FOR (p:Process) ON (p.name)
```

---

### 3.5 与告警（Findings）的关系

**架构设计**：
- Canonical Findings 仍以 **OpenSearch** 为主存储（便于检索与统计）
- Neo4j 用于**路径重建与图展示**

**典型用法**：
1. 从 `canonical-findings-*` 选出"链路种子"（technique + 关键实体）
2. 在 Neo4j 中按时间窗抓取子图，并用 Neo4j GDS 加权最短路做路径搜索
3. 输出攻击链对象写回 `attack-chains-*`，并附带 Neo4j 子图引用（图投影参数/节点 ID 列表等）

**示例流程**：
```
1. 查询 canonical-findings-*
   WHERE threat.technique.id = "T1055"
   AND custom.finding.fingerprint = "fp-xxx"

2. 提取关键实体：host_id, process_entity_id

3. Neo4j GDS 路径搜索（加权最短路）：
   - 使用投影图 + `weight` 权重属性
   - 输出关键路径的节点/边序列，并保留每条边的证据引用

4. 生成攻击链，写入 attack-chains-*
```

---

## 4. 关系型数据库表结构（用于报告或中心机元数据）

> **说明**：本项目注册表/轮询状态落 OpenSearch（`client-registry-*`）。本节用于课程报告中展示传统"关系型表设计"的等价表达，系统运行不依赖关系型数据库。

---

### 4.1 表：`events`（Telemetry）

**用途**：存放事实事件（Telemetry）。

| 字段 | 类型 | 约束 | 说明 | 示例 |
|------|------|------|------|------|
| `event_id` | `varchar(64)` | PK | 事件唯一 ID | `evt-1b2c3d4e5f6a7b8c` |
| `ts` | `datetime` | NOT NULL | 事件时间（`@timestamp`） | `2026-01-12 03:21:10` |
| `source` | `varchar(64)` | NOT NULL | 数据来源 | `wazuh`, `falco`, `suricata` |
| `etype` | `varchar(64)` | NOT NULL | 事件类型 | `process_create`, `dns`, `net_conn` |
| `host` | `varchar(128)` | NOT NULL | 主机标识 | `h-a1b2c3d4e5f6a7b8c` |
| `session_id` | `varchar(128)` | NULL | 登录会话标识 | `sess-0123456789abcdef` |
| `user` | `varchar(128)` | NULL | 用户名/ID | `alice` |
| `process_entity_id` | `varchar(128)` | NULL | 进程实体 ID | `p-f1e2d3c4b5a69788` |
| `process_pid` | `int` | NULL | PID | `1234` |
| `process_ppid` | `int` | NULL | PPID | `456` |
| `process_name` | `varchar(256)` | NULL | 进程名 | `ssh` |
| `process_cmd` | `text` | NULL | 命令行 | `ssh user@10.0.0.8` |
| `dns_query` | `varchar(512)` | NULL | DNS 查询域名 | `evil.com` |
| `src_ip` | `varchar(45)` | NULL | 源 IP | `10.0.0.5` |
| `dst_ip` | `varchar(45)` | NULL | 目的 IP | `10.0.0.8` |
| `dst_port` | `int` | NULL | 目的端口 | `443` |
| `network_proto` | `varchar(16)` | NULL | 传输协议 | `tcp`, `udp` |
| `direction` | `varchar(16)` | NULL | 流向 | `outbound`, `inbound` |
| `file_path` | `text` | NULL | 文件路径 | `/etc/passwd` |
| `file_hash` | `varchar(128)` | NULL | 文件哈希 | `sha256:...` |
| `raw_json` | `json` | NULL | 原始事件（JSON） | `{...}` |

**索引**：
- 主键：`event_id`
- 常用索引：`ts`, `host`, `process_entity_id`, `src_ip`, `dst_ip`

---

### 4.2 表：`findings`（Alerts）

**用途**：存放告警（Raw Findings + Canonical Findings）。

| 字段 | 类型 | 约束 | 说明 | 示例 |
|------|------|------|------|------|
| `finding_id` | `varchar(64)` | PK | 告警 ID（`event.id`） | `alrt-1b2c3d4e5f6a7b8c` |
| `ts` | `datetime` | NOT NULL | 命中时间 | `2026-01-12 03:21:10` |
| `stage` | `varchar(16)` | NOT NULL | 告警阶段 | `raw`, `canonical` |
| `providers_json` | `json` | NOT NULL | 告警来源列表 | `["suricata", "falco"]` |
| `rule_id` | `varchar(128)` | NOT NULL | 规则 ID | `R-DNS-001` |
| `rule_name` | `varchar(256)` | NOT NULL | 规则名 | `DNS Tunnel Suspected` |
| `severity` | `int` | NOT NULL | 严重程度（0-100） | `70` |
| `tactic_id` | `varchar(64)` | NULL | ATT&CK 战术 ID | `TA0011` |
| `technique_id` | `varchar(64)` | NULL | ATT&CK 技术 ID | `T1071` |
| `host` | `varchar(128)` | NOT NULL | 主机 | `h-a1b2c3d4e5f6a7b8c` |
| `user` | `varchar(128)` | NULL | 用户 | `alice` |
| `process_entity_id` | `varchar(128)` | NULL | 进程 | `p-f1e2d3c4b5a69788` |
| `src_ip` | `varchar(45)` | NULL | 源 IP | `10.0.0.5` |
| `dst_ip` | `varchar(45)` | NULL | 目的 IP | `10.0.0.8` |
| `domain` | `varchar(512)` | NULL | 域名 | `evil.com` |
| `fingerprint` | `varchar(256)` | NULL | 去重指纹 | `fp-a1b2c3d4e5f6a7b8c` |
| `evidence_event_ids` | `json` | NULL | 证据事件列表 | `["evt-123", "evt-456"]` |
| `raw_json` | `json` | NULL | 原始告警（如有） | `{...}` |

**索引**：
- 主键：`finding_id`
- 常用索引：`ts`, `host`, `rule_id`, `fingerprint`

---

### 4.3 表：`clients`（注册表）

**用途**：存放客户端注册信息。

| 字段 | 类型 | 约束 | 说明 | 示例 |
|------|------|------|------|------|
| `client_id` | `varchar(128)` | PK | 客户端唯一 ID | `client-victim-01` |
| `listen_url` | `text` | NOT NULL | 客户端对外地址 | `http://10.0.0.11:18080` |
| `host_id` | `varchar(128)` | NOT NULL | 主机 ID | `h-a1b2c3d4e5f6a7b8c` |
| `host_name` | `varchar(128)` | NOT NULL | 主机名 | `victim-01` |
| `client_version` | `varchar(64)` | NOT NULL | 客户端版本 | `0.1.0` |
| `token_hash` | `varchar(256)` | NOT NULL | Token 哈希（不存明文） | `sha256(...)` |
| `cap_wazuh` | `boolean` | NOT NULL | 能力：Wazuh | `true` |
| `cap_falco` | `boolean` | NOT NULL | 能力：Falco | `true` |
| `cap_suricata` | `boolean` | NOT NULL | 能力：Suricata | `true` |
| `registered_at` | `datetime` | NOT NULL | 注册时间 | `2026-01-12 00:00:00` |
| `last_seen` | `datetime` | NULL | 最后拉取成功时间 | `2026-01-12 12:00:00` |
| `last_error` | `text` | NULL | 最后错误 | `Connection refused` |

**索引**：
- 主键：`client_id`
- 常用索引：`host_id`, `last_seen`

---

### 4.4 表：`client_poll_state`（轮询消费位置）

**用途**：存放中心机轮询状态。

| 字段 | 类型 | 约束 | 说明 | 示例 |
|------|------|------|------|------|
| `client_id` | `varchar(128)` | PK/FK | 对应 clients.client_id | `client-victim-01` |
| `cursor` | `text` | NOT NULL | 当前 cursor | `cursor-0123456789abcdef` |
| `updated_at` | `datetime` | NOT NULL | 更新时间 | `2026-01-12 12:00:00` |

**索引**：
- 主键：`client_id`
- 外键：`client_id` → `clients(client_id)`

---

## 附录：相关文档

- **ECS 字段规范**：`docs/06A-ECS字段规范.md`
- **客户端中心机接口规范**：`docs/06C-客户端中心机接口规范.md`
- **数据设计总览**：`docs/06-数据库设计.md`
- **模块与数据流说明**：`docs/05-模块与数据流说明.md`
