# 整体需求文档（Overall Requirements）

## 1. 背景与目标

课程设计题目要求基于 **主机日志、主机行为、网络流量** 等多源数据，完成对恶意攻击行为的检测、关联与溯源分析，并在不少于 5 节点的靶场中验证。

本项目目标是搭建一个“多源采集 → 统一范式 → 检测（ATT&CK）→ 关联（时间线+图）→ 溯源输出”的分析系统，使得安全分析者能够：

- 在同一平台检索主机/网络事件与告警；
- 将离散事件映射为 ATT&CK 技术点（Technique）与战术阶段（Tactic）；
- 自动/半自动重建攻击链（Kill Chain / ATT&CK 阶段序列）；
- 输出可用于汇报/答辩的证据链（时间线、实体关系图、链路摘要、相似 APT 候选）。

## 2. 范围与边界

### 2.1 在范围内（In Scope）

- 多源数据的采集接入（可用开源组件完成）
- 时间对齐、字段范式化（统一到 ECS 子集）
- 关键实体抽取（host/user/process/file/ip/domain/session）
- 检测结果（Findings/Alerts）汇聚与统一
- 多源关联：时间窗口聚合 + 实体关系图构建
- 攻击链重建：从“初始入侵候选点”到“外联/C2/外传”的路径
- APT/TTP 相似性匹配（Top-N 候选 + 解释性证据）
- 靶场验证（≥5 节点）与演示材料输出

### 2.2 不在范围内（Out of Scope / 降级）

为适配“开发窗口短（约 3 天）”的现实约束，以下内容默认不做或仅做演示级：

- 全量系统调用（full syscall）采集与存储：数据量过大，风险高
- 复杂内存取证（如全面的代码注入检测）：可用现成传感器告警替代
- 账号/权限系统（登录认证、鉴权、多角色、多租户等）：课程项目默认单用户使用
- 严格的“确定归因某 APT 组织”：仅做基于 TTP 的相似性匹配与推断

## 3. 术语与定义

- **Telemetry（事实事件）**：未下结论的观测数据，如 Zeek 协议日志、Linux auditd 进程/文件/网络审计事件等。
- **Finding/Alert（检测结果）**：规则或模型对 Telemetry 的判定结果（含严重度、规则、ATT&CK 标注）。
- **ECS（Elastic Common Schema）**：用于跨源字段统一的通用字段集合（本项目采用“ECS 子集”）。
- **ATT&CK**：MITRE 攻击知识库；包含 **Tactic/Technique**。
- **TTP**：战术、技术与过程；常用于基于行为特征的相似性分析。
- **Attack Chain / Kill Chain**：将多个阶段的行为按时间与逻辑关系串联成链路。

## 4. 系统角色与典型使用场景

### 4.1 角色

- **分析员（Analyst）**：负责数据源接入与参数配置（规则/阈值等），并完成事件检索、告警查看、攻击链生成与报告导出。系统默认**单用户/单角色**使用，不提供登录、账号与权限控制等功能。

### 4.2 场景（Use Cases）

1. 导入/接入一段靶场攻击产生的数据（主机 + 网络）。
2. 在统一视图中按时间线查看“可疑登录 → 进程链 → 外联 → 横向 → 外传”的证据。
3. 生成本次攻击实例的“攻击链报告”，包含：
   - 攻击阶段摘要（按 ATT&CK tactic/technique）
   - 关键实体图（user↔process↔file↔ip/domain）
   - 初始入侵点/横向移动路径/外传路径
   - 相似 APT/组织 Top-N 与相似度解释

## 5. 功能需求（Functional Requirements）

> 编号用于后续“概要设计/详细设计/测试用例”引用。

### FR-01 多源采集接入

- 支持接入三类数据源：
  - 主机日志（Linux `auditd`、`auth.log` 等）
  - 主机行为（Falco 产生的行为事件/告警）
  - 网络流量（Zeek/Suricata 输出）

### FR-02 时间对齐

- 支持不同主机与传感器的时间统一（NTP/时区/漂移修正策略）。
- 统一字段 `@timestamp`（或等价字段）作为全局排序依据。

### FR-03 范式解析与统一（ECS 子集）

- 将不同来源的事件转换为统一范式（ECS 子集字段），至少包含：
  - host、user、process、file、network/source/destination、event 基本字段
- 保留原始事件 `raw` 或引用，便于证据回溯与截图。

### FR-04 关键实体抽取

- 从日志/流量中抽取实体并生成唯一标识：
  - host / user / process / file / ip / domain / session

### FR-05 会话重建

- 登录会话重建：通过登录/注销事件重建 user-session 时间线，并关联源 IP。
- 网络会话重建：基于五元组/会话 ID 关联网络事件（连接、DNS、HTTP 等）。

### FR-06 检测与告警统一（Findings）

- 支持两种告警产生模式：
  - **Detect-first**：传感器侧直接产生告警（如 Suricata/Falco）
  - **Store-first**：事件入库后由规则引擎扫描产生告警（如 Sigma → Security Analytics）
- 统一产出 Finding 模型：规则信息 + ATT&CK 标注 + 证据引用 + 关键实体。

### FR-07 攻击链识别与 ATT&CK 映射

- 将 Findings 映射到 ATT&CK tactic/technique，并能展示覆盖情况。
- 支持输出“阶段序列”（例如 Initial Access → Execution → Persistence → C2 → Exfiltration）。

### FR-08 多源关联分析

- 在指定时间窗口 Δt 内聚合相关事件/告警，基于实体与逻辑关系连边。
- 构建实体关系图（Entity Graph），并能回溯每条边的证据事件。

### FR-09 溯源输出（路径重建）

- 输出至少三类关键路径：
  1) 初始入侵点（边界/外联/登录入口）
  2) 内网横向移动路径（身份/远程服务/新主机触达）
  3) 数据外传路径（从数据所在到外发会话/目的地）

### FR-10 APT/TTP 相似性匹配（候选）

- 基于本次攻击链中出现的 technique 集合，与已知组织/剧本做相似度比较。
- 输出 Top-3 候选及分数，并给出“区分度最高的 techniques”作为解释。

### FR-11 报告与导出

支持生成/导出用于答辩与报告的材料：

- 攻击链时间线（按时间排序）
- 关系图（节点/边 + 证据）
- ATT&CK Navigator layer（矩阵标注）

### FR-12 靶场验证

- 在不少于 5 节点靶场环境中复现实验，验证：
  - 多源采集是否完整
  - 告警是否产生并可追溯证据
  - 攻击链是否可串联并输出关键路径
  -（推荐实现方式）使用 Atomic Red Team 复现若干 ATT&CK technique，确保演示可重复、可对照

## 6. 非功能需求（Non-Functional Requirements）

### NFR-01 性能与数据量控制

- 允许的策略：采集“高价值事件/告警”为主，避免全量 syscall 入库导致不可控的数据爆炸。
- 在 5 节点靶场规模下，应能在分钟级完成“近 N 分钟 Findings 的关联与链路生成”。

### NFR-02 可追溯与可解释

- 任何告警与链路边都必须能关联到原始事件证据（event_id/raw_ref）。

### NFR-03 可复现

- 支持用固定的攻击脚本/用例（如 ATT&CK technique 测试）复现相同输出。

### NFR-04 安全性（最小化）

- 分析系统本身不运行未知样本；采集与分析在隔离靶场内进行。

## 7. 约束与假设

- 开发周期短：优先“借鉴/复用开源平台”，自研集中在“统一 Finding 模型 + 关联/攻击链/相似度输出”。
- 统一范式以 ECS 子集为核心，字段缺失会显著影响串链效果。
- 靶场内所有主机应统一时区与 NTP（或提供校正方案）。

## 8. 验收标准（可直接写进测试报告）

- 能展示一条完整攻击链：至少覆盖 **入侵/执行/外联(C2)/外传**中的 3 个阶段。
- 输出物包含：时间线 + 关系图 + ATT&CK 标注（矩阵或列表）+ 关键证据截图/引用。
- 在 ≥5 节点环境中完成演示，并能解释每一步证据来自哪类数据源。
