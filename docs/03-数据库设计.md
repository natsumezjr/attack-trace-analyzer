# 数据库/索引设计（Database & Index Design）

> 说明：本项目以“日志与安全分析”场景为主，天然适合 **OpenSearch** 这类文档型检索数据库。  
> 为了便于课程报告撰写，本设计同时给出：  
> 1) OpenSearch 索引设计（推荐落地）  
> 2) 关系型数据库表结构（用于 ER/表结构展示，或用于存储分析产物）

## 1. 设计目标与原则

- **跨源关联优先**：字段设计围绕 host/user/process/ip/domain/file/session 这些实体展开。
- **证据可回溯**：任意 Finding、边、链路都能回到原始事件。
- **数据量可控**：Telemetry 可能很大；Findings/Graph/Chain 相对小，适合长期保留。

## 2. 逻辑数据模型（概念）

核心对象与关系：

- `Event(Telemetry)`：事实记录（规范化事件）
- `Finding(Alert)`：检测结论（规则命中/告警），引用若干 Event
- `Entity`：抽象实体（host/user/process/file/ip/domain/session）
- `Edge`：实体关系边（由 Event/Finding 作为证据）
- `AttackChain`：一次攻击实例（时间窗口内的相关边/告警集合）
- `AttributionCandidate`：APT/TTP 相似性输出（Top-N 候选）

## 3. OpenSearch 索引设计（推荐）

### 3.1 索引划分

建议按“数据对象类型”分索引（物理上可用 alias 管理）：

> 术语说明：OpenSearch 里叫 **Index（索引）**，在课程报告里可类比为“表”。
>
> 兼容性说明：
> - `ecs-events-*` 与告警索引中的 `event.* / host.* / user.* / process.* / rule.* / threat.*` 等字段，遵循 ECS 字段命名与语义（但我们只用其子集）。
> - 本项目所有自定义字段统一放入 `ata.*` 命名空间（见 `docs/99-选型决策记录.md`），避免与 ECS 字段冲突。

1) `ecs-events-*`  
存放 ECS 化后的事实事件（Normalized Events / Telemetry）。

2) `raw-findings-*`  
存放所有来源的原始告警/发现（Detect-first + Store-first），用于证据回溯与审计。

3) `canonical-findings-*`  
存放对 Raw Findings 融合去重后的“规范告警”，后续攻击链构建主要消费这一层。

4) `attack-chains-*`  
存放攻击链实例与摘要（阶段、关键证据、topn 相似度等）。

> 实体关系图（节点/边）的“权威存储”在 Neo4j 中，本次方案不再单独维护 `analysis-edges-*` / `analysis-entities` 索引，避免双写与数据漂移。

### 3.2 关键字段（建议映射）

#### A) `ecs-events-*`（事实事件索引）

- `ecs.version`：keyword
- `@timestamp`：date
- `event.kind`：keyword（`event`）
- `event.category/event.type/event.action`：keyword
- `host.name`：keyword
- `user.name`：keyword
- `process.entity_id`：keyword
- `process.pid/process.parent.pid`：long
- `process.name`：keyword
- `process.command_line`：text + keyword
- `source.ip/destination.ip`：ip
- `destination.port`：integer
- `dns.question.name`：keyword
- `file.path`：keyword
- `file.hash.sha256`：keyword
- `event.original`：text（或只存 raw_ref）

#### B) `raw-findings-*` / `canonical-findings-*`（告警索引）

- `ecs.version`：keyword
- `@timestamp`：date
- `event.kind`：keyword（`alert`）
- `event.severity`：integer（统一 0–100）
- `ata.finding.stage`：keyword（`raw`/`canonical`）
- `ata.finding.providers`：keyword[]（suricata/falco/opensearch-security-analytics…）
- `ata.finding.fingerprint`：keyword（用于 raw→canonical 融合与聚合）
- `ata.confidence`：float（0–1）
- `rule.id/rule.name`：keyword
- `threat.tactic.id/threat.technique.id`：keyword
- `host.name/user.name/process.entity_id/source.ip/destination.ip/dns.question.name/file.path`：keyword/ip
- `related.event.id`：keyword[]（证据事件 ID 列表，ECS）
- `ata.evidence.query`：text（可选）

#### C) `attack-chains-*`（攻击链索引）

- `ecs.version`：keyword
- `@timestamp`：date（链生成时间）
- `ata.chain.id`：keyword
- `ata.chain.time_range.start` / `ata.chain.time_range.end`：date
- `ata.chain.seed`：object（起始线索：host/user/process/domain…）
- `ata.chain.tactics` / `ata.chain.techniques`：keyword[]
- `ata.chain.steps`：nested/object（按时间排序的步骤，含 tactic/technique + 证据引用）
- `ata.chain.neo4j`：object（子图引用：查询模板/节点 ID 列表/参数等）
- `ata.chain.apt_topn`：object（可选：相似度候选列表）

### 3.3 生命周期与保留策略（建议）

- `ecs-events-*`：保留短一些（例如 7–30 天），或按实验批次归档
- `raw-findings-*`：保留中等（例如 30–180 天），用于回放证据
- `canonical-findings-*`：保留更久（例如 30–180 天，甚至更长），用于统计/串链/报告复现
- `attack-chains-*`：尽量长期保留（用于报告复现）
- Neo4j（实体关系图）：尽量长期保留（用于路径重建与展示）

## 4. Neo4j 图数据库设计（最终落地）

> 说明：OpenSearch 擅长“时间序列检索与聚合”，但不擅长“多跳关系推理”。  
> 由于本项目已确定使用 Neo4j，因此实体关系图以 Neo4j 为权威存储，用于路径重建与图展示。

### 4.1 建模目标

- 把 Telemetry（`ecs-events-*`）与 Canonical Findings（`canonical-findings-*`）抽象成实体与关系
- 支持多跳查询：初始入侵 → 执行 → 横向 → C2 → 外传（按时间窗约束过滤）
- 任意边都能回放证据：边属性里保存 OpenSearch 的 `event.id`（或等价 ID）

### 4.2 节点（Labels）与关键属性（建议）

- `Host`：`id`（唯一）、`name`
- `User`：`id`（唯一）、`name`
- `Process`：`id`（唯一，建议与 ECS `process.entity_id` 对齐）、`name`、`pid`、`host_id`、`start_ts`
- `File`：`id`（唯一）、`path`、`hash`
- `IP`：`addr`（唯一）
- `Domain`：`name`（唯一）
- `Session`（可选）：`id`（唯一）

### 4.3 关系（Relationships）与证据引用

建议的最小关系集合：

- `(User)-[:LOGON {ts, ata_evidence_event_ids}]->(Host)`
- `(Process)-[:SPAWNED {ts, ata_evidence_event_ids}]->(Process)`
- `(Process)-[:ACCESSED {op, ts, ata_evidence_event_ids}]->(File)`
- `(Process)-[:CONNECTED {ts, dst_port, ata_evidence_event_ids}]->(IP)`
- `(Host)-[:RESOLVED {ts, ata_evidence_event_ids}]->(Domain)`
- `(Domain)-[:RESOLVES_TO]->(IP)`（可选，用 DNS 解析事件构建）

其中 `ata_evidence_event_ids` 是一组字符串 ID，指向 OpenSearch `ecs-events-*` 中的 `event.id`，用于证据回放。

### 4.4 约束与索引（建议）

- 唯一约束：`Host.id`、`User.id`、`Process.id`、`File.id`、`Domain.name`、`IP.addr`
- 常用索引：`Host.name`、`User.name`、`Process.name`（按查询需求取舍）

### 4.5 与告警（Findings）的关系

Canonical Findings 仍以 OpenSearch 为主存储（便于检索与统计）。Neo4j 的典型用法是：

- 先从 `canonical-findings-*` 选出“链路种子”（technique + 关键实体）
- 再在 Neo4j 中抓取对应时间窗/邻域子图并做路径搜索
- 输出攻击链对象写回 `attack-chains-*`，并附带 Neo4j 子图引用（查询参数/节点 ID 列表等）

## 5. 关系型数据库表结构（用于报告/可选落地）

若需要在课程报告中提供传统“数据库表设计”，可按下述结构描述（实现可用 PostgreSQL/SQLite）。

### 5.1 表：`events`

| 字段 | 类型 | 说明 |
|---|---|---|
| event_id | varchar(64) PK | 事件唯一 ID |
| ts | datetime | 事件时间 |
| source | varchar(64) | auditd/zeek/suricata/falco/opensearch-security-analytics… |
| etype | varchar(64) | process_create/dns/net_conn/file/… |
| host | varchar(128) | 主机唯一标识 |
| session_id | varchar(128) NULL | 登录/会话标识 |
| user | varchar(128) NULL | 用户名/ID |
| process_entity_id | varchar(128) NULL | 进程实体 ID |
| process_pid | int NULL | PID |
| process_ppid | int NULL | PPID |
| process_name | varchar(256) NULL | 进程名 |
| process_cmd | text NULL | 命令行 |
| dns_query | varchar(512) NULL | DNS 查询域名 |
| src_ip | varchar(45) NULL | 源 IP |
| dst_ip | varchar(45) NULL | 目的 IP |
| dst_port | int NULL | 目的端口 |
| network_proto | varchar(16) NULL | tcp/udp/… |
| direction | varchar(16) NULL | outbound/inbound/unknown |
| file_path | text NULL | 文件路径 |
| file_hash | varchar(128) NULL | 文件哈希 |
| raw_json | json | 原始事件（或引用） |

索引建议：

- `idx_events_ts(ts)`
- `idx_events_host_ts(host, ts)`
- `idx_events_process(process_entity_id, ts)`
- `idx_events_net(dst_ip, dst_port, ts)`

### 5.2 表：`findings`

| 字段 | 类型 | 说明 |
|---|---|---|
| finding_id | varchar(64) PK | 检测结果 ID |
| ts | datetime | 命中时间 |
| stage | varchar(16) | raw / canonical |
| provider | varchar(64) NULL | 告警来源（raw 用；canonical 可为空或用 providers_json） |
| providers_json | json NULL | canonical 的来源列表（可选） |
| rule_id | varchar(128) | 规则 ID |
| rule_name | varchar(256) | 规则名 |
| severity | varchar(16)/int | 严重度 |
| confidence | float NULL | 可信度（可选） |
| tactic_id | varchar(64) NULL | ATT&CK tactic |
| technique_id | varchar(64) NULL | ATT&CK technique |
| host | varchar(128) | 主机 |
| user | varchar(128) NULL | 用户 |
| process_entity_id | varchar(128) NULL | 进程 |
| src_ip | varchar(45) NULL | 源 IP |
| dst_ip | varchar(45) NULL | 目的 IP |
| domain | varchar(512) NULL | 域名 |
| file_path | text NULL | 文件路径 |
| fingerprint | varchar(256) NULL | 去重指纹（用于 raw→canonical 融合） |
| evidence_event_ids | json | 证据事件列表 |
| raw_json | json NULL | 原始告警（可选） |

### 5.3 表：`entities`（可选）

| 字段 | 类型 | 说明 |
|---|---|---|
| entity_id | varchar(128) PK | 统一实体 ID |
| entity_type | varchar(16) | host/user/process/file/ip/domain/session |
| canonical_key | varchar(512) | 去重键（如 host.name、process.entity_id） |
| attrs_json | json | 属性扩展（可选） |

### 5.4 表：`edges` 与 `edge_evidence`

`edges`：

| 字段 | 类型 | 说明 |
|---|---|---|
| edge_id | varchar(64) PK | 边 ID |
| src_type | varchar(16) | 源实体类型 |
| src_id | varchar(128) | 源实体 ID |
| relation | varchar(64) | 关系类型 |
| dst_type | varchar(16) | 目的实体类型 |
| dst_id | varchar(128) | 目的实体 ID |
| first_seen | datetime | 首次出现 |
| last_seen | datetime | 最后出现 |

`edge_evidence`：

| 字段 | 类型 | 说明 |
|---|---|---|
| edge_id | varchar(64) FK | 边 ID |
| event_id | varchar(64) FK | 证据事件 |

### 5.5 表：`attack_chains` 与 `apt_candidates`

`attack_chains`：

| 字段 | 类型 | 说明 |
|---|---|---|
| chain_id | varchar(64) PK | 链路 ID |
| host | varchar(128) | 主要受害主机 |
| start_ts | datetime | 起始时间 |
| end_ts | datetime | 结束时间 |
| tactics_json | json | tactics 集合 |
| techniques_json | json | techniques 集合 |
| stages_json | json | 阶段摘要 |
| summary_json | json | 其他摘要信息 |

`apt_candidates`：

| 字段 | 类型 | 说明 |
|---|---|---|
| chain_id | varchar(64) FK | 链路 ID |
| group_id | varchar(128) | 组织/剧本 ID |
| score | float | 相似度 |
| matched_techniques_json | json | 命中 techniques |
| note | text NULL | 解释说明 |
