# 数据设计总览（03 系列）

> 本文是 **03 系列（数据设计）** 的“总览页”：把数据对象、流转路径、入库路由规则一次性说清楚。  
> 详细内容已拆分为三份子文档：
>
> - **03A**：ECS 字段规范（Telemetry/Findings 字段口径，ECS 子集 + `custom.*`）  
>   `docs/03A-ECS字段规范.md`
> - **03B**：存储与图谱设计（OpenSearch 索引 + Neo4j 图模型 + 可选关系表）  
>   `docs/03B-存储与图谱设计.md`
> - **03C**：客户端 ↔ 中心机接口规范（注册 + 中心轮询拉取数据）  
>   `docs/03C-客户端中心机接口规范.md`

---

## 1. 本项目的数据对象（从大到小）

为避免“日志、告警、图谱、攻击链”混在一起，本项目定义 5 类核心对象：

1) **Telemetry（事实事件）**：描述“发生了什么”，不做善恶判断（量最大）  
2) **Raw Findings（原始告警）**：各类规则/引擎直接产出的告警（量中等）  
3) **Canonical Findings（规范告警）**：对 Raw Findings 融合去重后的“唯一信号”（量更小）  
4) **Entity Graph（实体关系图）**：由 Telemetry/Findings 抽取的实体与关系（Neo4j）  
5) **Attack Chains（攻击链）**：链路摘要、步骤、证据引用、相似度输出（量最小、展示价值最高）

> 统一原则：越往上层，数据量越小、价值越高、越适合展示/汇报。

---

## 2. 数据流转路径（与模块设计对齐）

端到端的数据流由“客户机模块 → 中心机模块”两段组成（详见 `docs/04-模块与数据流说明.md`）：

### 2.1 客户机模块（采集 + 客户端后端）

- 采集组件（只用三种）：
  - **Wazuh**：主机日志
  - **Falco**：主机行为告警
  - **Suricata**：网络流量与告警（EVE JSON）
- 客户端后端（Client Backend）：
  - 归一化：Raw → ECS 子集（见 03A）
  - 缓冲：本地队列/文件/SQLite（实现方式不强制）
  - 启动注册：客户端启动后主动向中心机注册（见 03C）
  - 提供拉取接口：等待中心机轮询拉取（见 03C）

### 2.2 中心机模块（Next.js 全栈）

- 注册表：维护客户端清单与轮询 cursor（可落 OpenSearch 或 SQLite）
- 轮询器：按 interval 拉取客户端数据（见 03C）
- 入库：写入 OpenSearch（Telemetry/Findings/Chains），写入 Neo4j（实体图）
- 关联算法：告警融合、时间窗关联、路径重建、攻击链生成
- 前端：时间线、关系图、ATT&CK 覆盖矩阵、报告导出

---

## 3. 入库路由规则（中心机侧）

中心机从客户端拉取到的文档为 ECS 子集（见 03A），其归类依据是：

- `event.kind`：`event`（Telemetry）/ `alert`（Finding）
- `event.dataset`：`hostlog.* / hostbehavior.* / netflow.* / finding.*`

推荐路由：

- `event.kind="event"` → OpenSearch `ecs-events-*`
- `event.kind="alert"` → OpenSearch `raw-findings-*`
- 中心机融合去重生成 → OpenSearch `canonical-findings-*`
- 中心机攻击链输出 → OpenSearch `attack-chains-*`
- 实体关系图（权威）→ Neo4j

> 具体索引划分、mapping 类型建议与 Neo4j 模型见：`docs/03B-存储与图谱设计.md`。

---

## 4. 字段与命名约定（简表）

完整字段规范见：`docs/03A-ECS字段规范.md`。这里只列“全局必须对齐”的几条：

- `ecs.version = 9.2.0`
- 三时间：`@timestamp`（发生时间）/ `event.created`（采集观察时间）/ `event.ingested`（中心机入库时间）
- `event.id`：全局幂等键（中心机按此去重入库）
- 自定义字段统一使用 `custom.*`（避免污染 ECS 标准字段）

