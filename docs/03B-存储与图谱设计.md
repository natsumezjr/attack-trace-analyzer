# 存储与图谱设计（OpenSearch + Neo4j，v1）

> 本文是 **03 系列（数据设计）** 的“存储落地篇”，关注：  
> - OpenSearch 索引划分与字段类型建议  
> - Neo4j 实体关系图建模（用于多跳关联/路径重建）  
> -（可选）关系型表结构（用于课程报告展示或存储中心机元数据）  
>
> ECS 字段规范（Telemetry/Findings 统一口径）见：`docs/03A-ECS字段规范.md`  
> 客户端注册与中心轮询接口见：`docs/03C-客户端中心机接口规范.md`

---

## 1. 设计目标与原则

- **跨源关联优先**：字段与建模围绕 host/user/process/ip/domain/file 等实体展开（session 为派生概念）。
- **证据可回溯**：任意 Finding、边、链路都能回到原始事件（`event.id`）。
- **数据量可控**：Telemetry 量最大；Findings/Graph/Chain/Registry 量小但价值高，适合长期保留。
- **中心机权威写入**：客户端只负责输出 ECS 文档与缓冲；索引/图谱/融合/串链由中心机完成（Next.js）。

---

## 2. OpenSearch 索引设计（推荐落地）

### 2.1 索引划分（按数据对象）

> 术语说明：OpenSearch 中叫 Index（索引），在课程报告里可类比为“表”。

1) `ecs-events-*`  
存放 ECS 化后的事实事件（Telemetry）。

2) `raw-findings-*`  
存放所有来源的原始告警/发现（Detect-first + Store-first），用于证据回溯与审计。

3) `canonical-findings-*`  
存放对 Raw Findings 融合去重后的“规范告警”，后续攻击链构建主要消费这一层。

4) `attack-chains-*`  
存放攻击链实例与摘要（阶段、关键证据、Top-N 相似度等）。

5) `client-registry-*`（可选但建议）  
存放中心机维护的“客户端注册表 + 轮询状态”（client_id、listen_url、capabilities、cursor、last_seen…）。

> 说明：实体关系图（节点/边）的权威存储在 Neo4j 中；本方案不再单独维护 `analysis-edges-*` / `analysis-entities-*` 索引，避免双写与数据漂移。

### 2.2 mapping 级别要点（避免踩坑）

字段语义与“各 dataset 的字段要求”统一以 `docs/03A-ECS字段规范.md` 为准。  
本节仅给出 **索引模板（mapping）层面的要点**：

- **时间字段**：`@timestamp / event.created / event.ingested` 建议均为 `date`。
- **主键/关联键**：`event.id / host.id / process.entity_id / session.id / flow.id / network.community_id` 建议均为 `keyword`。
- **枚举字段**：`event.kind / event.dataset / event.action / rule.id / threat.*.id` 建议 `keyword`。
- **网络字段**：`source.ip / destination.ip` 用 `ip`；端口用 `long` 或 `integer`（统一即可）。
- **全文/模糊检索字段**：
  - `process.command_line`、`url.full` 建议用 `wildcard`（或 `text` + `.keyword` 双字段）兼顾搜索与聚合。
  - `event.original` 建议保留用于证据回放，但注意数据量：可考虑截断/压缩；如不需要检索，可在 mapping 上关闭索引（只存储）。
- **`custom.*` 自定义字段**：尽量结构稳定，避免动态字段爆炸；用于聚合/去重/引用的字段（如 `custom.finding.providers`、`custom.evidence.event_ids`、`custom.finding.fingerprint`）优先 `keyword`/`keyword[]`。

### 2.3 `client-registry-*`（中心机元数据，可选）

注册表不是 ECS 事件，但为了演示/查询方便，可以放入独立索引。

建议字段（示意）：

- `client.id`：keyword（等同 `client_id`）
- `client.listen_url`：keyword
- `client.version`：keyword
- `client.host.id` / `client.host.name`：keyword
- `client.capabilities.wazuh/falco/suricata`：boolean
- `client.token_hash`：keyword（不要明文存 token）
- `poll.cursor`：keyword（中心机消费位置）
- `poll.last_seen`：date
- `poll.last_error`：text（可选）
- `@timestamp`：date（中心机更新时间）

> 如果你们未来使用 Prisma/SQLite 维护注册表，也可以不落 OpenSearch，只保留关系表（见第 5 节）。

### 2.4 生命周期与保留策略（建议）

- `ecs-events-*`：保留短一些（例如 7–30 天），或按实验批次归档
- `raw-findings-*`：保留中等（例如 30–180 天），用于回放证据
- `canonical-findings-*`：保留更久（例如 30–180 天，甚至更长），用于统计/串链/报告复现
- `attack-chains-*`：尽量长期保留（用于报告复现）
- `client-registry-*`：长期保留（体量小，便于展示“多节点在线状态”）
- Neo4j：尽量长期保留（用于路径重建与展示）

---

## 3. Neo4j 图数据库设计（最终落地）

> OpenSearch 擅长“时间序列检索与聚合”，不擅长“多跳关系推理”。  
> 本项目采用 Neo4j 作为实体关系图权威存储，用于路径重建与图展示。

### 3.1 建模目标

- 将 Telemetry（`ecs-events-*`）与 Canonical Findings（`canonical-findings-*`）抽象成实体与关系
- 支持多跳查询：初始入侵 → 执行 → 横向 → C2 → 外传（按时间窗约束过滤）
- 任意边都能回放证据：边属性里保存 OpenSearch 的 `event.id` 列表

### 3.2 节点（Labels）与关键属性（建议）

- `Host`：`id`（唯一）、`name`
- `User`：`id`（唯一）、`name`
- `Process`：`id`（唯一，建议对齐 ECS `process.entity_id`）、`name`、`pid`、`host_id`、`start_ts`
- `File`：`id`（唯一）、`path`、`hash`
- `IP`：`addr`（唯一）
- `Domain`：`name`（唯一）
- `Endpoint`（可选）：`addr`（如 `ip:port/proto`）

### 3.3 关系（Relationships）与证据引用

建议最小关系集合：

- `(User)-[:LOGON {ts, custom_evidence_event_ids}]->(Host)`
- `(Process)-[:SPAWNED {ts, custom_evidence_event_ids}]->(Process)`
- `(Process)-[:ACCESSED {op, ts, custom_evidence_event_ids}]->(File)`
- `(Process)-[:CONNECTED {ts, dst_port, custom_evidence_event_ids}]->(IP)`
- `(Host)-[:RESOLVED {ts, custom_evidence_event_ids}]->(Domain)`
- `(Domain)-[:RESOLVES_TO]->(IP)`（在有 DNS 解析事件时构建）

其中 `custom_evidence_event_ids` 为字符串数组，指向 OpenSearch `ecs-events-*` 中的 `event.id`，用于证据回放。

### 3.4 约束与索引（建议）

- 唯一约束：`Host.id`、`User.id`、`Process.id`、`File.id`、`Domain.name`、`IP.addr`
- 常用索引：`Host.name`、`User.name`、`Process.name`（按查询需求取舍）

### 3.5 与告警（Findings）的关系

Canonical Findings 仍以 OpenSearch 为主存储（便于检索与统计）。Neo4j 的典型用法是：

- 先从 `canonical-findings-*` 选出“链路种子”（technique + 关键实体）
- 再在 Neo4j 中抓取对应时间窗/邻域子图并做路径搜索
- 输出攻击链对象写回 `attack-chains-*`，并附带 Neo4j 子图引用（查询参数/节点 ID 列表等）

---

## 4. （可选）关系型数据库表结构（用于报告或中心机元数据）

若需要在课程报告中提供传统“数据库表设计”，或你们中心机希望用 SQLite/PG 管理注册表，可按下述结构描述。

### 4.1 表：`events`（Telemetry）

| 字段 | 类型 | 说明 |
|---|---|---|
| event_id | varchar(64) PK | 事件唯一 ID |
| ts | datetime | 事件时间（对应 `@timestamp`） |
| source | varchar(64) | wazuh/falco/suricata/security-analytics… |
| etype | varchar(64) | process_create/dns/net_conn/file/… |
| host | varchar(128) | 主机标识 |
| session_id | varchar(128) NULL | 登录会话标识 |
| user | varchar(128) NULL | 用户名/ID |
| process_entity_id | varchar(128) NULL | 进程实体 ID |
| process_pid | int NULL | PID |
| process_ppid | int NULL | PPID |
| process_name | varchar(256) NULL | 进程名 |
| process_cmd | text NULL | 命令行 |
| dns_query | varchar(512) NULL | DNS 查询域名 |
| src_ip | varchar(45) NULL | 源 IP |
| dst_ip | varchar(45) NULL | 目的 IP |
| dst_port | int NULL | 目的端口 |
| network_proto | varchar(16) NULL | tcp/udp/… |
| direction | varchar(16) NULL | outbound/inbound/unknown |
| file_path | text NULL | 文件路径 |
| file_hash | varchar(128) NULL | 文件哈希 |
| raw_json | json | 原始事件（JSON/原文，用于证据回溯） |

### 4.2 表：`findings`（Alerts）

| 字段 | 类型 | 说明 |
|---|---|---|
| finding_id | varchar(64) PK | 告警 ID（可用 `event.id`） |
| ts | datetime | 命中时间 |
| stage | varchar(16) | raw / canonical |
| providers_json | json | 告警来源列表（如 suricata/falco/security-analytics…） |
| rule_id | varchar(128) | 规则 ID |
| rule_name | varchar(256) | 规则名 |
| severity | int | 0–100 |
| confidence | float NULL | 可信度 |
| tactic_id | varchar(64) NULL | ATT&CK tactic |
| technique_id | varchar(64) NULL | ATT&CK technique |
| host | varchar(128) | 主机 |
| user | varchar(128) NULL | 用户 |
| process_entity_id | varchar(128) NULL | 进程 |
| src_ip | varchar(45) NULL | 源 IP |
| dst_ip | varchar(45) NULL | 目的 IP |
| domain | varchar(512) NULL | 域名 |
| fingerprint | varchar(256) NULL | 去重指纹 |
| evidence_event_ids | json | 证据事件列表（`event.id`） |
| raw_json | json NULL | 原始告警（可选） |

### 4.3 表：`clients`（注册表）

| 字段 | 类型 | 说明 |
|---|---|---|
| client_id | varchar(128) PK | 客户端唯一 ID |
| listen_url | text | 客户端对外地址 |
| host_id | varchar(128) | host.id |
| host_name | varchar(128) | host.name |
| client_version | varchar(64) | 客户端版本 |
| token_hash | varchar(256) | token 哈希（不存明文） |
| cap_wazuh | boolean | 能力 |
| cap_falco | boolean | 能力 |
| cap_suricata | boolean | 能力 |
| registered_at | datetime | 注册时间 |
| last_seen | datetime | 最后拉取成功时间 |
| last_error | text NULL | 最后错误 |

### 4.4 表：`client_poll_state`（轮询消费位置）

| 字段 | 类型 | 说明 |
|---|---|---|
| client_id | varchar(128) PK/FK | 对应 clients |
| cursor | text | 当前 cursor |
| updated_at | datetime | 更新时间 |

