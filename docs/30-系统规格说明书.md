# 系统规格说明书（SRS）

## 0. 文档定位与引用关系

本文件定义系统的**总体架构与关键机制**，尤其是：

- 中心机“单定时器一条龙”定时流水线；
- 前端可视化的查询链路；
- 面向老师交互的“异步溯源任务”模型；
- 三大模块（OpenSearch / Neo4j / Analysis）的边界与协作方式。

本文件不重复以下文档的细节：

- 字段口径：`51-ECS字段规范.md`
- 图谱口径：`52-实体图谱规范.md`
- 环境变量：`53-环境变量规范.md`
- 客户机与中心机接口：`54-客户机-中心机接口规范.md`
- OpenSearch 模块：`31-OpenSearch模块规格说明书.md`
- Neo4j 模块：`32-Neo4j模块规格说明书.md`
- Analysis 模块：`33-Analysis模块规格说明书.md`

## 1. 总体架构

系统由“客户机侧”和“中心机侧”组成：

- 客户机侧负责：采集/转换/本地缓冲/对外提供拉取接口；
- 中心机侧负责：定时拉取、入库、检测、融合、入图、对外 API、异步溯源与报告。

总体组件关系如下（逻辑视图）：

```
┌──────────────────────┐
│ 客户机（≥5 节点）     │
│  Filebeat / Falco /  │
│  Suricata            │
│  → ECS 事件写入 RabbitMQ│
│  → Client API        │
└─────────┬────────────┘
          │ 定时拉取（中心机轮询）
          ▼
┌──────────────────────────────────────────────────────────────┐
│ 中心机后端（FastAPI）                                         │
│  - 定时流水线调度器（单定时器）                               │
│  - OpenSearch 模块（入库/检测/融合）                          │
│  - Neo4j 模块（入图/图查询）                                  │
│  - Analysis 模块（异步溯源任务/结果写回）                      │
│  - 对外 API（供前端调用）                                     │
└───────┬───────────────────────────────┬──────────────────────┘
        │                               │
        ▼                               ▼
┌──────────────────────┐        ┌──────────────────────────────┐
│ OpenSearch            │        │ Neo4j (+ GDS)                │
│  - Telemetry 索引     │        │  - Entity Graph              │
│  - Findings 索引      │        │  - 图查询/最短路             │
│  - Task 索引          │        │  - 边属性承载溯源结果         │
└─────────┬────────────┘        └───────────────┬──────────────┘
          │                                      │
          ▼                                      ▼
┌──────────────────────────────────────────────────────────────┐
│ 中心机前端（Next.js）                                          │
│  - 查询 OpenSearch（事件/告警）                                │
│  - 查询 Neo4j（图可视化）                                      │
│  - 创建溯源任务并轮询状态                                      │
│  - 导出报告（含溯源结果）                                      │
└──────────────────────────────────────────────────────────────┘
```

## 2. 核心数据分层（中心机视角）

系统只承认以下数据层次（从底到顶）：

1. **Telemetry（事实层）**
   - `event.kind="event"`
   - 落 OpenSearch：`ecs-events-*`
2. **Raw Findings（原始告警层）**
   - `event.kind="alert"` 且 `event.dataset!="finding.canonical"`
   - 落 OpenSearch：`raw-findings-*`
3. **Canonical Findings（规范告警层）**
   - `event.kind="alert"` 且 `event.dataset="finding.canonical"`
   - 由中心机融合去重生成
   - 落 OpenSearch：`canonical-findings-*`
4. **Entity Graph（图谱层）**
   - Telemetry + Canonical Findings 转换得到
   - 落 Neo4j：节点/边（规范见 `52-实体图谱规范.md`）
5. **Trace Task（溯源任务层）**
   - 由前端触发创建，后台异步执行
   - 任务状态落 OpenSearch：`analysis-tasks-*`
   - 任务结果写回 Neo4j：边属性

> 说明：攻击链作为“展示结构”由图谱与任务结果共同承载：前端展示时以图谱边序列+边属性为主，不依赖单独的“链路索引”。

## 3. 中心机定时流水线（单定时器一条龙）

### 3.1 调度原则

- 中心机必须使用**单一**定时器触发流水线。
- 定时器周期由环境变量 `CENTER_POLL_INTERVAL_SECONDS` 控制，默认值为 `5` 秒。
- 同一时间只允许存在一个流水线实例在运行：当上一次流水线未结束时，新的定时触发必须被跳过，避免并发写入导致的数据漂移与重复工作。

### 3.2 流水线输入与输出

- 输入：所有“已注册客户机”的新数据（由轮询拉取接口返回，格式为 ECS 文档）。
- 输出：
  - OpenSearch：Telemetry / Raw Findings / Canonical Findings / Tasks
  - Neo4j：Entity Graph（含溯源任务写回的边属性）

### 3.3 四步顺序与职责（每次 tick 内严格顺序执行）

#### Step 1：从客户机拉取数据

对每个已注册客户机：

1) 中心机读取注册表条目（含 `listen_url`、`client_token_hash` 等元数据）。  
2) 调用客户机拉取接口（见 `54-客户机-中心机接口规范.md`）。  
3) 客户机从 RabbitMQ 队列中取出消息并返回 ECS 文档列表：
   - 队列为空则返回空数组
   - 拉取行为会消费队列中的消息（队列语义保证“增量”）

#### Step 2：写入 OpenSearch（字段处理）

中心机必须对每条 ECS 文档做字段处理（细节见 `31-OpenSearch模块规格说明书.md` 与 `51-ECS字段规范.md`）：

- 三时间字段补齐与覆盖规则；
- `event.kind` 与 `event.dataset` 校验；
- `event.id` 补齐与幂等去重；
- 按 `event.kind/event.dataset` 路由写入对应索引。

#### Step 3：Store-first 检测 + Raw→Canonical 融合

中心机必须在每个 tick 内执行：

1) 触发 Store-first 检测：由 OpenSearch Security Analytics 对 Telemetry 索引执行扫描；  
2) 读取检测产生的 Findings，并转换为 ECS Finding 文档，写入 `raw-findings-*`；  
3) 对“指定时间窗内”的 Raw Findings 做融合去重，生成 Canonical Findings，写入 `canonical-findings-*`。

融合去重的指纹规则、provider 合并规则与幂等规则由 `31-OpenSearch模块规格说明书.md` 定义。

> 实现提示（与当前代码对齐）：Step 3 可通过环境变量 `CENTER_RUN_ANALYSIS_EACH_TICK=1` 打开；默认关闭以降低对 OpenSearch Security Analytics 权限/配置的耦合。

#### Step 4：触发 ECS→Graph 写入 Neo4j

中心机必须在每个 tick 内执行入图：

1) 以 Canonical Findings 为主，补充必要的 Telemetry（用于补边与证据回溯）；  
2) 对每条输入文档执行 ECS→Graph 转换；  
3) 将节点/边写入 Neo4j，并满足 `52-实体图谱规范.md` 的唯一键与边属性规范；  
4) 边必须写入 `ts_float`（数值时间戳），支撑时间窗查询与图算法投影。

> 实现提示（与当前代码对齐）：Step 4 当前通常以离线/手动方式触发（例如调试脚本或后续扩展为定时执行），避免在未配置 Neo4j 时影响中心机主链路。

## 4. 前端可视化查询链路

### 4.1 查询边界

- Telemetry / Findings 的检索由 OpenSearch 提供；
- 图谱可视化（节点/边）与路径查询由 Neo4j 提供；
- 前端不得直连数据库，只通过后端 API 访问。

### 4.2 图可视化最小闭环

1) 前端请求后端“图查询接口”（动作包含：时间窗边查询、告警边查询、时间窗最短路）。  
2) 后端调用 Neo4j 模块，返回图数据（nodes/edges）。  
3) 前端渲染图，允许老师点击节点查看其属性与相关边的证据引用。

对应 API 的对外形状由后端路由定义（实现已存在：`/api/v1/graph/query`），模块内部规则见 `32-Neo4j模块规格说明书.md`。

## 5. 异步溯源任务（create_task）

### 5.1 为什么必须异步

节点溯源可能涉及：

- 子图扩展与多跳查询；
- 图算法（最短路、风险权重路径等）；
- 解释性生成（TTP 解释与文本说明）。

这些步骤的耗时不稳定，必须以异步任务执行，并对前端提供可轮询的进度状态。

### 5.2 任务模型（状态机）

每个溯源任务在 OpenSearch `analysis-tasks-*` 里保存一条任务文档，任务状态只能取以下值：

- `queued`：已创建，等待执行
- `running`：执行中
- `succeeded`：已完成
- `failed`：失败（含错误信息）

### 5.3 创建、执行与结果写回

1) 前端在图上选定目标节点后，请求后端创建任务；  
2) 后端立即返回 `task_id`；  
3) Analysis 模块异步执行任务：从 Neo4j 读取数据、执行算法、得到“关键边集合 + 风险评分 + Technique/Tactic 摘要 + 解释文本”；  
4) Analysis 模块把结果写回 Neo4j 边属性，形成“被标注的图”；  
5) 前端轮询任务状态，任务完成后再次请求图查询接口，读取边属性并展示溯源结果。

对应后端 API（固定）：

- 创建任务：`POST /api/v1/analysis/tasks`
- 查询任务状态：`GET /api/v1/analysis/tasks/{task_id}`
- 拉取写回边：`POST /api/v1/graph/query`（`analysis_edges_by_task` 或 `edges_in_window` + 前端过滤）

写回字段命名、覆盖规则与数据类型由 `33-Analysis模块规格说明书.md` 与 `32-Neo4j模块规格说明书.md` 定义。

## 6. 安全与审计边界（课程演示）

- 运行环境：靶场内网。中心机所有服务与数据库端口只对靶场内可达网络开放。
- CTI 数据：使用离线 ATT&CK Enterprise CTI 数据包；运行时不依赖外网。
- 数据留痕：所有结论必须能回溯到 `event.id`，并能定位到数据源类型与时间窗范围（证据链）。
