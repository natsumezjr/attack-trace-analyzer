# 中心机后端规格说明书

## 0. 文档定位

本文件定义**中心机后端（FastAPI 应用）**的实现细节：

- FastAPI 应用结构与生命周期管理
- API 路由组织（8 个路由模块）
- 在线靶机注册与轮询服务
- 与三大模块（OpenSearch / Neo4j / Analysis）的集成方式
- 环境变量与配置

本文件不重复以下文档的细节：

- OpenSearch 模块：`31-OpenSearch模块规格说明书.md`
- Neo4j 模块：`32-Neo4j模块规格说明书.md`
- Analysis 模块：`33-Analysis模块规格说明书.md`
- 环境变量清单：`53-环境变量规范.md`

## 1. 总体架构

### 1.1 应用入口与生命周期

**文件位置：** `backend/main.py`

```python
from contextlib import asynccontextmanager
from fastapi import FastAPI
from app.api.router import api_router
from app.core.config import settings
from app.core.logging import configure_logging
from app.services.analyze.runner import start_task_runner, stop_task_runner
from app.services.client_poller import start_polling, stop_polling

configure_logging(settings.log_level)

@asynccontextmanager
async def lifespan(_: FastAPI):
    # 应用启动时开启后台任务
    await start_polling()
    await start_task_runner()
    try:
        yield
    finally:
        # 应用关闭时停止后台任务
        await stop_task_runner()
        await stop_polling()

app = FastAPI(title=settings.app_name, version=settings.app_version, lifespan=lifespan)
app.include_router(api_router)
```

**生命周期保证：**

1. 应用启动时自动启动中心机轮询任务（`start_polling()`）
2. 应用启动时自动启动 Analysis 异步任务 runner（`start_task_runner()`）
3. 应用关闭时优雅停止上述后台任务（`stop_*()`），不阻塞 HTTP 请求处理

### 1.2 目录结构

```
backend/
├── main.py                        # FastAPI 应用入口
├── app/
│   ├── __init__.py
│   ├── api/
│   │   ├── __init__.py
│   │   ├── router.py              # 路由汇总
│   │   ├── routes/                # 路由实现（8 个模块）
│   │   │   ├── root.py            # GET  /
│   │   │   ├── health.py          # GET  /health
│   │   │   ├── targets.py         # POST /api/v1/targets/register
│   │   │   │                     # GET  /api/v1/targets
│   │   │   ├── events.py          # POST /api/v1/events/search
│   │   │   ├── findings.py        # POST /api/v1/findings/search
│   │   │   ├── graph.py           # POST /api/v1/graph/query
│   │   │   ├── chains.py          # POST /api/v1/chains/generate (TODO)
│   │   │   │                     # GET  /api/v1/chains/{chain_id} (TODO)
│   │   │   └── utils.py           # 响应构造工具（ok/err）
│   ├── core/
│   │   ├── config.py              # Settings 数据类
│   │   ├── deps.py                # 依赖注入（预留）
│   │   └── logging.py             # 日志配置
│   ├── dto/
│   │   └── targets.py             # Request/Response DTO
│   ├── schemas/
│   │   └── common.py              # Pydantic 模型
│   └── services/
│       ├── online_targets/
│       │   ├── __init__.py
│       │   ├── registry.py        # 内存注册表（set[str]）
│       │   └── poller.py          # 后台轮询服务
│       ├── opensearch/            # OpenSearch 模块（见 31）
│       ├── neo4j/                 # Neo4j 模块（见 32）
│       └── analyze/               # Analysis 算法模块（见 33）
│           ├── pipeline.py        # task_id 驱动分析流水线（写回 OS + Neo4j）
│           ├── trace.py           # 回溯链条/关键路径（主算法）
│           ├── killchain.py       # 回溯链条算法实现（Phase A/B/C）
│           ├── killchain_llm.py   # LLM 选择器封装
│           ├── attack_fsa.py      # 攻击阶段 FSA
│           └── ttp_similarity/    # APT 相似度（主算法：Tactics + Techniques）
│               ├── router.py
│               ├── service.py
│               └── cti/
│                   └── enterprise-attack.json
└── tests/
    ├── opensearch/
    └── graph/
```

## 2. API 路由组织

### 2.1 路由汇总

**文件位置：** `backend/app/api/router.py`

```python
from fastapi import APIRouter
from app.api.routes import analysis_tasks, chains, events, findings, graph, health, root, targets
from app.services.analyze.ttp_similarity.router import router as ttp_similarity_router

api_router = APIRouter()
api_router.include_router(root.router, tags=["root"])
api_router.include_router(health.router, tags=["health"])
api_router.include_router(events.router, tags=["events"])
api_router.include_router(findings.router, tags=["findings"])
api_router.include_router(graph.router, tags=["graph"])
api_router.include_router(chains.router, tags=["chains"])
api_router.include_router(targets.router, tags=["targets"])
api_router.include_router(analysis_tasks.router, tags=["analysis"])
api_router.include_router(ttp_similarity_router, tags=["analysis"])
```

### 2.2 根路由与健康检查

#### `GET /`

**文件：** `backend/app/api/routes/root.py`

```python
@router.get("/")
def root():
    return {"message": "Backend service is running"}
```

#### `GET /health`

**文件：** `backend/app/api/routes/health.py`

```python
@router.get("/health")
def health():
    return {"status": "ok"}
```

### 2.3 靶机管理路由

#### `POST /api/v1/targets/register`

**文件：** `backend/app/api/routes/targets.py`

**请求体：**
```json
{
  "ip": "10.0.0.11"
}
```

**响应：**
```json
{
  "status": "ok",
  "ip": "10.0.0.11",
  "server_time": "2026-01-14T12:00:00.000Z"
}
```

**实现：**
```python
from app.dto.targets import RegisterTargetRequest
from app.services.online_targets import register_target
from app.services.online_targets.registry import list_targets

@router.post("/api/v1/targets/register")
def register_online_target(req: RegisterTargetRequest):
    ip_str = str(req.ip)
    register_target(ip_str)
    return ok(ip=ip_str)
```

#### `GET /api/v1/targets`

**响应：**
```json
{
  "status": "ok",
  "targets": ["10.0.0.11", "10.0.0.12", "10.0.0.13"]
}
```

### 2.4 事件检索路由

#### `POST /api/v1/events/search`

**文件：** `backend/app/api/routes/events.py`

**请求体（EventsSearchRequest）：**
```json
{
  "start_ts": "2026-01-14T00:00:00Z",
  "end_ts": "2026-01-14T23:59:59Z",
  "host_id": "10.0.0.11",
  "host_name": null,
  "event_ids": null,
  "datasets": ["hostbehavior.syscall", "network.connection"],
  "query": null,
  "size": 100,
  "offset": 0,
  "sort_order": "desc"
}
```

**查询构建规则：**

1. **高级模式**：如果 `query` 字段非空，直接作为 OpenSearch DSL 的 `query` 值（透传）
2. **基础模式**（`query` 为 null）：
   - 时间范围：`range` 查询 `@timestamp`
   - 主机：`term` 查询 `host.id` 或 `host.name`
   - 事件 ID：`terms` 查询 `event.id`
   - 数据集：`wildcard` 或 `term` 查询 `event.dataset`（支持通配符）
   - 无过滤条件：`match_all`

**响应：**
```json
{
  "status": "ok",
  "total": 1523,
  "items": [
    {
      "ecs": {"version": "9.2.0"},
      "event": {
        "id": "evt-aaaaaaaaaaaaaaaa",
        "kind": "event",
        "dataset": "hostbehavior.syscall",
        "@timestamp": "2026-01-14T12:34:56.789Z"
      },
      "host": {"id": "10.0.0.11"},
      ...
    }
  ],
  "server_time": "2026-01-14T12:35:00.000Z"
}
```

**错误响应：**
```json
{
  "status": "error",
  "error": {
    "code": "OPENSEARCH_UNAVAILABLE",
    "message": "Connection timeout"
  }
}
```

### 2.5 告警检索路由

#### `POST /api/v1/findings/search`

**文件：** `backend/app/api/routes/findings.py`

**请求体（FindingsSearchRequest）：**
```json
{
  "stage": "canonical",
  "start_ts": "2026-01-14T00:00:00Z",
  "end_ts": "2026-01-14T23:59:59Z",
  "host_id": "10.0.0.11",
  "tactic_ids": ["TA0004"],
  "technique_ids": ["T1059.004"],
  "rule_ids": ["9c9c8f77-4e71-4b1a-b4bb-0b05d30a66bc"],
  "providers": ["Security Analytics"],
  "min_severity": 50,
  "query": null,
  "size": 100,
  "offset": 0,
  "sort_order": "desc"
}
```

**索引路由：**
- `stage="raw"` → `raw-findings-*`
- `stage="canonical"` → `canonical-findings-*`

**查询构建规则：**

1. 高级模式：透传 `query` 字段
2. 基础模式：
   - 时间范围：`range` 查询 `@timestamp`
   - 主机：`term` 查询 `host.id`
   - 战术 ID：`terms` 查询 `threat.tactic.id`
   - 技术 ID：`terms` 查询 `threat.technique.id`
   - 规则 ID：`terms` 查询 `rule.id`
   - Provider：`terms` 查询 `custom.finding.providers`
   - 最低严重度：`range` 查询 `event.severity >= min_severity`

**响应：**
```json
{
  "status": "ok",
  "total": 42,
  "items": [
    {
      "event": {
        "kind": "alert",
        "dataset": "finding.canonical",
        "severity": 75,
        "@timestamp": "2026-01-14T12:34:56.789Z"
      },
      "threat": {
        "tactic": {"id": "TA0004", "name": "Privilege Escalation"},
        "technique": {"id": "T1059.004", "name": "Unix Shell"}
      },
      "custom": {
        "finding": {
          "providers": ["Security Analytics"],
          "first_seen": "2026-01-14T12:30:00Z",
          "event_count": 5
        }
      },
      ...
    }
  ],
  "server_time": "2026-01-14T12:35:00.000Z"
}
```

### 2.6 图查询路由

#### `POST /api/v1/graph/query`

**文件：** `backend/app/api/routes/graph.py`

**请求体（GraphQueryRequest）：**
```json
{
  "action": "alarm_edges",
  "start_ts": "2026-01-14T00:00:00Z",
  "end_ts": "2026-01-14T23:59:59Z",
  "allowed_reltypes": null,
  "only_alarm": false,
  "src_uid": null,
  "dst_uid": null,
  "risk_weights": null,
  "min_risk": 0.0,
  "task_id": null,
  "only_path": false,
  "include_nodes": true
}
```

**动作类型：**

| 动作 | 说明 | 必需参数 |
|------|------|----------|
| `alarm_edges` | 查询所有告警边 | 无 |
| `edges_in_window` | 时间窗内边查询 | `start_ts`, `end_ts` |
| `shortest_path_in_window` | 时间窗内最短路（GDS） | `start_ts`, `end_ts`, `src_uid`, `dst_uid`, `risk_weights` |
| `analysis_edges_by_task` | 按 `analysis.task_id` 拉取本次溯源写回的边（可选仅关键路径） | `task_id` |

**响应（alarm_edges）：**
```json
{
  "status": "ok",
  "edges": [
    {
      "src_uid": "user-root-0",
      "dst_uid": "file-bin-bash",
      "rtype": "EXEC",
      "props": {
        "ts_float": 1736852096.789,
        "event_ids": ["evt-aaaaaaaaaaaaaaaa"],
        "alarm": true
      }
    }
  ],
  "nodes": [
    {
      "uid": "user-root-0",
      "ntype": "USER",
      "key": "root",
      "props": {"host_id": "10.0.0.11"}
    },
    {
      "uid": "file-bin-bash",
      "ntype": "FILE",
      "key": "/bin/bash",
      "props": {"host_id": "10.0.0.11"}
    }
  ],
  "server_time": "2026-01-14T12:35:00.000Z"
}
```

**响应（shortest_path_in_window，未找到）：**
```json
{
  "status": "ok",
  "found": false,
  "cost": null,
  "edges": [],
  "server_time": "2026-01-14T12:35:00.000Z"
}
```

**响应（shortest_path_in_window，找到路径）：**
```json
{
  "status": "ok",
  "found": true,
  "cost": 3.5,
  "edges": [
    {"src_uid": "A", "dst_uid": "B", "rtype": "EXEC", "props": {...}},
    {"src_uid": "B", "dst_uid": "C", "rtype": "WRITE", "props": {...}},
    {"src_uid": "C", "dst_uid": "D", "rtype": "CONNECT", "props": {...}}
  ],
  "server_time": "2026-01-14T12:35:00.000Z"
}
```

### 2.7 攻击链路由（TODO）

#### `POST /api/v1/chains/generate`

**文件：** `backend/app/api/routes/chains.py`

**状态：** 未实现（返回 501 NOT_IMPLEMENTED）

**计划实现：**
- 触发攻击链生成流水线（Phase A/B/C）
- 持久化到 OpenSearch `attack-chains-*`
- 返回生成的 `chain_id`

#### `GET /api/v1/chains/{chain_id}`

**状态：** 未实现（返回 501 NOT_IMPLEMENTED）

**计划实现：**
- 从 OpenSearch 加载攻击链详情

### 2.8 TTP 相似度路由（Analysis 模块）

#### `POST /api/v1/analysis/ttp-similarity`

**文件：** `backend/app/services/analyze/ttp_similarity/router.py`

**请求体：**
```json
{
  "host_id": "10.0.0.11",
  "start_ts": "2026-01-14T00:00:00Z",
  "end_ts": "2026-01-14T23:59:59Z"
}
```

**实现逻辑：**

1. 从 `canonical-findings-*` 提取 `threat.tactic.id` + `threat.technique.id`
2. 过滤占位符（TA0000/T0000、UNKNOWN、TBD）
3. 加载 Enterprise CTI 数据（`enterprise-attack.json`）
4. 计算 TF-IDF + 余弦相似度（Technique 相似度 + Tactic 相似度加权融合）
5. 返回 Top-3 相似 APT 组织（并给出 top tactics/techniques 解释）

**响应：**
```json
{
  "host_id": "10.0.0.11",
  "start_ts": "2026-01-14T00:00:00Z",
  "end_ts": "2026-01-14T23:59:59Z",
  "attack_tactics": ["TA0001", "TA0002"],
  "attack_techniques": ["T1059.004", "T1003", "T1003.008"],
  "similar_apts": [
    {
      "intrusion_set": {"id": "G0016", "name": "APT29"},
      "similarity_score": 0.85,
      "top_tactics": ["TA0001", "TA0003"],
      "top_techniques": ["T1059.004", "T1003.008", "T1003", "T1055.001", "T1204"]
    },
    {
      "intrusion_set": {"id": "G0019", "name": "APT41"},
      "similarity_score": 0.72,
      "top_tactics": ["TA0002", "TA0005"],
      "top_techniques": ["T1059.004", "T1003", "T1055", "T1018", "T1021"]
    },
    {
      "intrusion_set": {"id": "G0060", "name": "APT28"},
      "similarity_score": 0.68,
      "top_tactics": ["TA0001"],
      "top_techniques": ["T1059.004", "T1003", "T1566.001", "T1190", "T1059.001"]
    }
  ]
}
```

**错误响应：**
- `400`：`end_ts < start_ts`
- `500`：CTI 文件未找到（`ATTACK_CTI_PATH`）

### 2.9 Analysis Tasks 路由（异步任务闭环）

Analysis 任务遵循 `docs/33-Analysis模块规格说明书.md` 的任务状态机与字段规范，任务文档存储在 OpenSearch：`analysis-tasks-*`。

任务执行采用 **进程内异步 runner**（无外部队列依赖）：

- 任务创建后立即写入 `task.status=queued` 的任务文档，前端可立刻轮询；
- 后端后台 runner 依次执行任务，并持续更新任务文档与 Neo4j 边属性；
- 执行入口：`backend/app/services/analyze/pipeline.py`（`run_analysis_task`）；
- runner：`backend/app/services/analyze/runner.py`（应用启动时自动启动，见 `backend/main.py`）。

#### `POST /api/v1/analysis/tasks`

**文件：** `backend/app/api/routes/analysis_tasks.py`

**请求体：**
```json
{
  "target_node_uid": "Host:host.id=h-001",
  "start_ts": "2026-01-14T00:00:00Z",
  "end_ts": "2026-01-14T23:59:59Z"
}
```

**响应：**
```json
{
  "status": "ok",
  "task_id": "trace-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
  "task": {
    "@timestamp": "2026-01-14T12:00:00Z",
    "task.id": "trace-...",
    "task.status": "queued",
    "task.progress": 0,
    "task.target.node_uid": "Host:host.id=h-001",
    "task.window.start_ts": "2026-01-14T00:00:00Z",
    "task.window.end_ts": "2026-01-14T23:59:59Z"
  },
  "server_time": "2026-01-14T12:00:00.000000Z"
}
```

#### `GET /api/v1/analysis/tasks/{task_id}`

**说明：** 查询任务状态/进度/任务级结果（OpenSearch 任务文档）。

#### `GET /api/v1/analysis/tasks`

**说明：** 列出任务（支持按 `status` / `target_node_uid` / 创建时间范围过滤）。

#### 与图查询接口联动（结果展示）

任务完成后，前端可通过以下任一方式拿到写回结果：

1) 继续使用 `POST /api/v1/graph/query` 的 `edges_in_window` 拉取边，并在前端筛选 `analysis.task_id == task_id`；或
2) 使用 `POST /api/v1/graph/query` 的 `analysis_edges_by_task` 动作直接按 `task_id` 拉取本次写回边（可选 `only_path=true` 仅看关键路径边）。

## 3. 在线靶机服务

### 3.1 内存注册表

**文件位置：** `backend/app/services/online_targets/registry.py`

**数据结构：**
```python
from threading import RLock

_REGISTRY: set[str] = set()
_LOCK = RLock()
```

**API：**
```python
def register_target(ip: str) -> None:
    """注册在线靶机（仅存 IP）"""
    with _LOCK:
        _REGISTRY.add(ip)

def list_targets() -> list[str]:
    """读取当前注册的 IP 列表"""
    with _LOCK:
        return list(_REGISTRY)

def remove_target(ip: str) -> None:
    """移除超时的在线靶机"""
    with _LOCK:
        _REGISTRY.discard(ip)
```

**设计决策：**

- 使用线程锁保证并发安全
- 存储在内存（应用重启后丢失）
- 后续可替换为 Redis 或数据库持久化

### 3.2 后台轮询服务

**文件位置：** `backend/app/services/online_targets/poller.py`

**环境变量：**

| 变量名 | 默认值 | 说明 |
|--------|--------|------|
| `TARGET_POLL_INTERVAL_SECONDS` | `5` | 轮询间隔（秒），范围 [1, 3600] |
| `TARGET_POLL_SCHEME` | `http` | 请求协议（`http` 或 `https`） |
| `TARGET_POLL_TIMEOUT_SECONDS` | `5` | 请求超时（秒） |

**轮询流程：**

```python
async def _poll_loop(stop_event: asyncio.Event) -> None:
    routes = ["falco", "suricata", "filebeat"]
    async with httpx.AsyncClient(timeout=_poll_timeout()) as client:
        while not stop_event.is_set():
            targets = list_targets()
            for ip in targets:
                timed_out = await _poll_target_routes(client, ip, routes)
                if timed_out:
                    remove_target(ip)
            try:
                await asyncio.wait_for(stop_event.wait(), timeout=_poll_interval_seconds())
            except asyncio.TimeoutError:
                continue
```

**单个靶机轮询（`_poll_target_routes`）：**

1. 遍历 3 个路由：`falco`, `suricata`, `filebeat`
2. 发送 POST 请求：`http://{ip}/{route}`（body 为空）
3. 超时则标记为超时并从注册表移除
4. 响应为 `{"total": N, "data": [...]}` 时，提取 `data` 并调用 `store_events()`
5. 跳过不可达的靶机（不中断其他靶机的轮询）

**请求重试（`_post_with_retries`）：**

```python
async def _post_with_retries(client: httpx.AsyncClient, url: str, retries: int):
    for attempt in range(retries):
        try:
            return await client.post(url, content=b"")
        except httpx.TimeoutException:
            if attempt == retries - 1:
                raise
            continue
```

**生命周期管理：**

```python
async def start_polling() -> None:
    """启动后台轮询任务"""
    global _stop_event, _poll_task
    if _poll_task and not _poll_task.done():
        return
    _stop_event = asyncio.Event()
    _poll_task = asyncio.create_task(_poll_loop(_stop_event))

async def stop_polling() -> None:
    """停止后台轮询任务"""
    global _stop_event, _poll_task
    if _stop_event is None or _poll_task is None:
        return
    _stop_event.set()
    try:
        await _poll_task
    except asyncio.CancelledError:
        pass
    finally:
        _stop_event = None
        _poll_task = None
```

## 4. 核心配置

### 4.1 Settings 数据类

**文件位置：** `backend/app/core/config.py`

```python
from dataclasses import dataclass
import os

@dataclass(frozen=True)
class Settings:
    app_name: str = os.getenv("APP_NAME", "Attack Trace Analyzer API")
    app_env: str = os.getenv("APP_ENV", "dev")
    app_version: str = os.getenv("APP_VERSION", "0.1.0")
    log_level: str = os.getenv("LOG_LEVEL", "INFO")

    # LLM 配置
    llm_provider: str = os.getenv("LLM_PROVIDER", "openai")
    openai_api_key: str = os.getenv("OPENAI_API_KEY", "")
    openai_base_url: str = os.getenv("OPENAI_BASE_URL", "https://api.openai.com/v1")
    openai_model: str = os.getenv("OPENAI_MODEL", "gpt-3.5-turbo")
    openai_timeout: float = float(os.getenv("OPENAI_TIMEOUT", "30.0"))
    openai_max_retries: int = int(os.getenv("OPENAI_MAX_RETRIES", "2"))

settings = Settings()
```

**环境变量清单（后端相关）：**

| 变量名 | 默认值 | 说明 |
|--------|--------|------|
| `APP_NAME` | `Attack Trace Analyzer API` | 应用名称 |
| `APP_ENV` | `dev` | 运行环境（`dev` / `prod`） |
| `APP_VERSION` | `0.1.0` | 应用版本 |
| `LOG_LEVEL` | `INFO` | 日志级别 |
| `LLM_PROVIDER` | `openai` | LLM 提供商（`openai` / `mock`） |
| `OPENAI_API_KEY` | `""` | OpenAI API 密钥 |
| `OPENAI_BASE_URL` | `https://api.openai.com/v1` | OpenAI API 基础 URL |
| `OPENAI_MODEL` | `gpt-3.5-turbo` | 使用的模型 |
| `OPENAI_TIMEOUT` | `30.0` | 请求超时（秒） |
| `OPENAI_MAX_RETRIES` | `2` | 最大重试次数 |
| `TARGET_POLL_INTERVAL_SECONDS` | `5` | 靶机轮询间隔（秒） |
| `TARGET_POLL_SCHEME` | `http` | 靶机请求协议 |
| `TARGET_POLL_TIMEOUT_SECONDS` | `5` | 靶机请求超时（秒） |
| `ATTACK_CTI_PATH` | `backend/app/services/analyze/ttp_similarity/cti/enterprise-attack.json` | CTI 文件路径 |

> 完整环境变量清单见 `docs/53-环境变量规范.md`（含 OpenSearch / Neo4j 连接参数）

### 4.2 日志配置

**文件位置：** `backend/app/core/logging.py`

```python
import logging
import sys

def configure_logging(level: str = "INFO"):
    logging.basicConfig(
        level=level,
        format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
        handlers=[logging.StreamHandler(sys.stdout)],
    )
```

**日志格式：**
```
2026-01-14 12:34:56,789 - app.services.online_targets.poller - INFO - Polling targets: ['10.0.0.11', '10.0.0.12']
```

## 5. 模块集成

### 5.1 OpenSearch 模块集成

**入口点：** `backend/app/services/opensearch/internal.py`

**关键函数：**
```python
def get_client() -> OpenSearch:
    """获取 OpenSearch 客户端（单例）"""

def search(index: str, query: dict, size: int = 100) -> list[dict]:
    """执行搜索并返回 _source 列表"""
```

**调用位置：**
- `events.py`：`POST /api/v1/events/search`
- `findings.py`：`POST /api/v1/findings/search`
- `poller.py`：`store_events()` （拉取后入库）

### 5.2 Neo4j 模块集成

**入口点：** `backend/app/services/neo4j/internal.py`

**关键函数：**
```python
def get_alarm_edges() -> list[Edge]:
    """获取所有告警边"""

def get_edges_in_window(
    t_min: float,
    t_max: float,
    allowed_reltypes: list[str] | None = None,
    only_alarm: bool = False,
) -> list[Edge]:
    """查询时间窗内的边"""

def get_node(uid: str) -> Node | None:
    """获取单个节点"""

def gds_shortest_path_in_window(
    src_uid: str,
    dst_uid: str,
    t_min: float,
    t_max: float,
    risk_weights: dict[str, float],
    min_risk: float = 0.0,
    allowed_reltypes: list[str] | None = None,
) -> tuple[float, list[Edge]] | None:
    """使用 GDS 计算最短路"""
```

**调用位置：**
- `graph.py`：`POST /api/v1/graph/query`

### 5.3 Analysis 模块集成

**TTP 相似度模块：** `backend/app/services/analyze/ttp_similarity/`

**关键函数：**
```python
def fetch_attack_ttps_from_canonical_findings(
    *,
    host_id: str,
    start_ts: datetime,
    end_ts: datetime,
    size: int = 10000,
) -> tuple[set[str], set[str]]:
    """从 Canonical Findings 提取 (tactic_ids, technique_ids)"""

def rank_similar_intrusion_sets(
    *,
    attack_tactics: set[str],
    attack_techniques: set[str],
) -> tuple[tuple[str, ...], list[SimilarAptCandidate]]:
    """计算 Top-3 相似 APT 组织（融合 tactic + technique 相似度）"""
```

**调用位置：**
- `analyze/ttp_similarity/router.py`：`POST /api/v1/analysis/ttp-similarity`

**CTI 数据：**
- 文件：`enterprise-attack.json`（MITRE ATT&CK Enterprise STIX Bundle）
- 加载：`@lru_cache(maxsize=1)` 单例缓存
- 索引结构：`EnterpriseCtiIndex`（intrusion_sets / uses / group_tactics / technique_idf / tactic_idf / norms）

## 6. 响应构造工具

**文件位置：** `backend/app/api/utils.py`

**函数签名：**
```python
def ok(**kwargs) -> dict[str, Any]:
    """构造成功响应"""
    return {"status": "ok", **kwargs}

def err(code: str, message: str) -> dict[str, Any]:
    """构造错误响应"""
    return {"status": "error", "error": {"code": code, "message": message}}

def utc_now_rfc3339() -> str:
    """获取当前 UTC 时间（RFC 3339 格式）"""
    return datetime.now(timezone.utc).strftime("%Y-%m-%dT%H:%M:%S.%f")[:-3] + "Z"
```

## 7. 启动与运行

### 7.1 开发环境启动

```bash
cd backend
python -m uvicorn main:app --reload --port 8000
```

### 7.2 生产环境启动（Docker）

```yaml
# backend/docker-compose.yml
version: "3.8"
services:
  backend:
    build: .
    ports:
      - "8000:8000"
    environment:
      - APP_ENV=prod
      - LOG_LEVEL=INFO
      - OPENSEARCH_URL=https://opensearch:9200
      - NEO4J_URI=bolt://neo4j:7687
    depends_on:
      - opensearch
      - neo4j
```

### 7.3 启动验证

```bash
# 1. 健康检查
curl http://localhost:8000/health
# {"status": "ok"}

# 2. 注册靶机
curl -X POST http://localhost:8000/api/v1/targets/register \
  -H "Content-Type: application/json" \
  -d '{"ip": "10.0.0.11"}'

# 3. 查看在线靶机
curl http://localhost:8000/api/v1/targets
# {"status": "ok", "targets": ["10.0.0.11"]}

# 4. 检查轮询日志
# 应该看到：Polling targets: ['10.0.0.11']
```

## 8. 相关文件清单

### 8.1 核心文件

| 文件路径 | 说明 |
|----------|------|
| `backend/main.py` | FastAPI 应用入口、lifespan 管理 |
| `backend/app/api/router.py` | 路由汇总 |
| `backend/app/core/config.py` | Settings 数据类 |
| `backend/app/core/logging.py` | 日志配置 |
| `backend/app/api/utils.py` | 响应构造工具 |

### 8.2 路由文件

| 文件路径 | 说明 |
|----------|------|
| `backend/app/api/routes/root.py` | GET / |
| `backend/app/api/routes/health.py` | GET /health |
| `backend/app/api/routes/targets.py` | POST /api/v1/targets/register, GET /api/v1/targets |
| `backend/app/api/routes/events.py` | POST /api/v1/events/search |
| `backend/app/api/routes/findings.py` | POST /api/v1/findings/search |
| `backend/app/api/routes/graph.py` | POST /api/v1/graph/query |
| `backend/app/api/routes/chains.py` | POST /api/v1/chains/generate (TODO), GET /api/v1/chains/{id} (TODO) |
| `backend/app/api/routes/analysis_tasks.py` | POST /api/v1/analysis/tasks, GET /api/v1/analysis/tasks, GET /api/v1/analysis/tasks/{task_id} |

### 8.3 服务文件

| 文件路径 | 说明 |
|----------|------|
| `backend/app/services/online_targets/registry.py` | 内存注册表（set[str]） |
| `backend/app/services/online_targets/poller.py` | 后台轮询服务 |
| `backend/app/services/opensearch/internal.py` | OpenSearch 模块入口 |
| `backend/app/services/neo4j/internal.py` | Neo4j 模块入口 |
| `backend/app/services/analyze/ttp_similarity/router.py` | TTP 相似度路由 |
| `backend/app/services/analyze/ttp_similarity/service.py` | TTP 相似度服务 |
| `backend/app/services/analyze/pipeline.py` | task_id 驱动分析流水线（写回 OS + Neo4j） |
| `backend/app/services/analyze/runner.py` | 异步任务 runner（进程内队列） |

### 8.4 数据模型文件

| 文件路径 | 说明 |
|----------|------|
| `backend/app/dto/targets.py` | RegisterTargetRequest DTO |
| `backend/app/schemas/common.py` | Pydantic 基础模型 |

---

## 9. 与其他文档的关系

- **系统总体规格：** `docs/30-系统规格说明书.md`（中心机定时流水线、前端查询链路）
- **OpenSearch 模块：** `docs/31-OpenSearch模块规格说明书.md`
- **Neo4j 模块：** `docs/32-Neo4j模块规格说明书.md`
- **Analysis 模块：** `docs/33-Analysis模块规格说明书.md`
- **客户机规格：** `docs/34-客户机规格说明书.md`
- **客户机-中心机接口：** `docs/54-客户机-中心机接口规范.md`
- **环境变量：** `docs/53-环境变量规范.md`
