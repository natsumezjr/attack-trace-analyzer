# 实体图谱节点与关系规范（v2）

> **目的**：统一“实体关系图（Entity Graph）”的 **node/edge 类型、唯一键、属性口径、抽取方式**，并与 `docs/06A-ECS字段规范.md` 做字段对齐。
>
> **背景约束（来自实际数据源）**：本项目真实输入为 `filebeat + falco + suricata`，因此图谱抽取必须以这些来源能提供的字段为边界。
>
> **v2 核心取舍**：
> 1) 图谱只承载 **Canonical Findings + 少量上下文 Telemetry**（上下文补边的“时间窗策略”后续再定，本文件先只定义 node/edge 与抽取规则）。
> 2) **不引入 NetConn/Flow 节点**：`NET_CONNECT` 直接连到 `IP/Domain`；`flow.id`、`network.community_id` 等会话键保留为 **边属性**（用于回溯与聚合）。
> 3) **IP 为主**：网络侧的强实体优先用 IP（域名作为可选补充实体）。

---

## 0. 范围与术语

### 0.1 图谱输入（上游）

图谱抽取只接受两类上游数据对象（OpenSearch 文档）：

1. **Telemetry**（`event.kind="event"`）  
   - 来自：`hostlog.*`（Filebeat）、`hostbehavior.*`（Falco）、`netflow.*`（Suricata）
   - 字段口径：`docs/06A-ECS字段规范.md`

2. **Canonical Findings**（`event.kind="alert" && event.dataset="finding.canonical"`）  
   - 来自：Falco / Suricata / Security Analytics 等告警融合后的规范告警
   - 字段口径：同样遵循 `docs/06A-ECS字段规范.md` 的 Finding 章节

> 说明：v2 规定“图谱以 Canonical Findings 为主”，但 Telemetry 仍是 **边的证据来源**（通过 `custom.evidence.event_ids` 回溯）。

### 0.2 图谱存储（下游）

- 图数据库：Neo4j（权威存储）
- 关系方向：本规范为每条边定义语义方向；但多数查询/路径搜索可按无向关系使用（实现层可用 `MATCH (a)-[r]-(b)`）。

---

## 1. 节点（Node）规范

> 统一原则：**节点必须可去重**，且唯一键应尽量“跨源稳定”。  
> 本规范推荐使用 **复合唯一键**（例如 `host.id + user.name`），以避免跨主机误合并。

### 1.1 节点类型总览

| Label | 含义 | 唯一键（Key） | 主要来源 |
|------|------|--------------|---------|
| `Host` | 主机 | `host.id` | 全部数据源（必填） |
| `User` | 用户 | `user.id`（优先）或 `host.id + user.name` | `hostlog.auth` / `hostbehavior.*` |
| `Process` | 进程实例 | `process.entity_id` | `hostlog.process` / `hostbehavior.*` |
| `File` | 文件（主机内视角） | `host.id + file.path` | `hostbehavior.file` / `hostlog.file_registry` |
| `IP` | IP 地址 | `ip`（字符串） | `netflow.*` / `hostlog.auth` |
| `Domain` | 域名 | `domain.name`（FQDN） | `netflow.dns` / `netflow.http`（可选） |

> 关键变化：相较于当前代码（v1），v2 **不再使用** `NetConn` 节点。

---

### 1.2 各节点字段建议

#### 1.2.1 `Host`

- **Key**：`host.id`（与 `docs/06A` 口径一致；若上游缺失，归一化层应按 `sha1(host.name)` 补齐）
- **推荐属性**：
  - `host.name`（展示友好）
  - `host.ip[]`（如可得，用于 `HAS_IP` 边）

#### 1.2.2 `User`

- **Key 优先级**：
  1) 若存在 `user.id`：Key = `user.id`（跨主机更稳）
  2) 否则：Key = `host.id + user.name`（避免不同主机同名用户误合并）
- **推荐属性**：
  - `user.name`
  - `user.id`（如存在）
  - `host.id`（当使用复合键时必须写入）

#### 1.2.3 `Process`

- **Key**：`process.entity_id`
- **说明**：
  - `hostbehavior.*` 数据集要求 `process.entity_id` 必填（见 `docs/06A`），因此 v2 抽取允许把它当作强关联键。
  - 若上游未提供，应在归一化层按 `docs/06A` 的生成策略补齐（`sha1(host.id + pid + process.start_time + process.executable)`）。
- **推荐属性**：
  - `process.pid`
  - `process.executable`
  - `process.command_line`
  - `process.parent.entity_id`（可选，用于 `SPAWN`）
  - `user.name`（可选，便于解释）
  - `host.id`（便于反查主机；也可通过 `RUNS_ON` 边表达）

#### 1.2.4 `File`（主机内视角）

- **Key**：`host.id + file.path`
- **原因**：`file.path` 单独作为唯一键会导致不同主机的同路径文件被误合并（例如 `/etc/passwd`）。
- **推荐属性**：
  - `file.path`
  - `file.hash.sha256`（如存在）
  - `file.name`（可选）
  - `host.id`（用于 Key 与归属）

#### 1.2.5 `IP`

- **Key**：`ip`（字符串，IPv4/IPv6）
- **推荐属性**：
  - `ip`（同 Key）
  - `ip.is_private`（可选；中心机侧可计算）

> 映射说明：ECS 输入侧通常是 `source.ip` / `destination.ip` / `host.ip[]`；落图时统一写入 `IP.ip`。

#### 1.2.6 `Domain`

- **Key**：`domain.name`（FQDN）
- **推荐属性**：
  - `domain.name`（同 Key）
  - `domain.tld`（可选；中心机侧可计算）

> 映射说明：ECS 输入侧可能是 `dns.question.name` 或 `url.domain`；落图时统一写入 `Domain.domain.name`。

---

## 2. 边（Edge）规范

> 统一原则：边必须可回溯证据。  
> **每条边至少写入**：
> - `ts`（事件时间，建议等同 `@timestamp`）
> - `custom.evidence.event_ids[]`（指向 Telemetry 的 `event.id`；若边来自 Telemetry 本身，可填 `[event.id]`）
>
> 若边来自 Canonical Finding（`finding.canonical`），则额外建议写入：
> - `is_alarm = true`
> - `rule.*`、`threat.*`、`event.severity`、`risk.score`（见 `docs/06A` 第 5 章）

### 2.1 边类型总览（v2）

| RelType | 语义 | from → to | 主要数据集 |
|--------|------|-----------|------------|
| `LOGON` | 用户登录主机 | `User → Host` | `hostlog.auth` |
| `RUNS_ON` | 进程运行于主机 | `Process → Host` | `hostlog.process`, `hostbehavior.*` |
| `SPAWN` | 父进程创建子进程 | `Process → Process` | `hostlog.process`, `hostbehavior.syscall(execve)` |
| `FILE_ACCESS` | 进程/主机访问文件 | `Process → File`（优先），或 `Host → File`（降级） | `hostbehavior.file`, `hostlog.file_registry` |
| `NET_CONNECT` | 发起网络连接 | `Process → IP`（优先），或 `Host → IP`（降级） | `hostbehavior.syscall(connect)`, `netflow.flow` |
| `DNS_QUERY` | 发起 DNS 查询 | `Process → Domain`（若能关联进程）或 `Host → Domain` | `netflow.dns` |
| `RESOLVES_TO` | 域名解析到 IP | `Domain → IP` | `netflow.dns`（有 answers 才生成） |
| `HAS_IP` | 主机拥有本机 IP | `Host → IP` | 任意包含 `host.ip[]` 的事件 |

> 降级策略：当事件缺少 `process.entity_id`（例如 Suricata 网络流量），允许把网络/DNS 行为挂到 `Host` 级别。

---

### 2.2 各边的抽取规则（与字段要求）

下面按 **最常见的数据源** 给出抽取规则。所有字段名/必填项以 `docs/06A-ECS字段规范.md` 为准。

#### 2.2.1 `LOGON`（`hostlog.auth`）

**触发条件**：
- `event.dataset = hostlog.auth`

**端点**：
- `User`：`user.id`（若有）否则 `host.id + user.name`
- `Host`：`host.id`

**边属性（建议最小集）**：
- `ts`（=`@timestamp`）
- `event.outcome`（`success`/`failure`）
- `source.ip`
- `session.id`（注意失败登录可缺失，见 `docs/06A`）
- `authentication.method`（可选）
- `custom.evidence.event_ids = [event.id]`

#### 2.2.2 `RUNS_ON`（进程归属）

**触发条件**（任一）：
- `event.dataset = hostlog.process`
- `event.dataset = hostbehavior.syscall`
- `event.dataset = hostbehavior.file`

**端点**：
- `Process`：`process.entity_id`
- `Host`：`host.id`

**边属性（建议最小集）**：
- `ts`
- `custom.evidence.event_ids`

> 说明：`RUNS_ON` 是“结构边”，便于路径搜索在 `Host ↔ Process` 间跳转；其证据可复用触发该进程出现的事件 `event.id`。

#### 2.2.3 `SPAWN`（父子进程）

**触发条件**（任一）：
- `hostlog.process` 且存在 `process.parent.entity_id`
- `hostbehavior.syscall` 且 `event.action` 表示 `execve`（并能拿到 parent/child 的 entity_id）

**端点**：
- `Process(parent)`：`process.parent.entity_id`
- `Process(child)`：`process.entity_id`

**边属性（建议最小集）**：
- `ts`
- `custom.evidence.event_ids`

> 注意：如果只有 `process.parent.pid` 但没有 `process.parent.entity_id`，v2 不建议创建“猜测边”（避免误连）。后续如要支持，可在归一化层补齐 parent entity_id。

#### 2.2.4 `FILE_ACCESS`（文件访问）

**触发条件**（任一）：
- `event.dataset = hostbehavior.file`（Falco 行为）
- `event.dataset = hostlog.file_registry` 且 `event.category` 包含 `file`

**端点**：
- 优先：`Process → File`（当存在 `process.entity_id`）
- 降级：`Host → File`（仅当没有 `process.entity_id` 但存在 `host.id + file.path`）

**File 节点 Key**：
- `host.id + file.path`

**边属性（建议最小集）**：
- `ts`
- `op`：从 `event.action` 映射（`read`/`write`/`execute`/其它）
- `custom.evidence.event_ids`

> 与 `docs/06A` 对齐提示：`hostbehavior.file` 要求 `process.entity_id` 必填；因此“Host→File 的降级”主要面向 `hostlog.file_registry` 这类日志事件。

#### 2.2.5 `NET_CONNECT`（网络连接）

**触发条件**（任一）：
- `event.dataset = netflow.flow`
- `hostbehavior.syscall` 且 `event.action` / `event.code` 表示 `connect`

**端点**：
- 优先：`Process → IP`（存在 `process.entity_id` 时）
- 降级：`Host → IP`（Suricata 通常缺少进程信息）

**IP 取值**：
- 强烈建议以 `destination.ip` 作为对外连接目标（C2/外传/横向的主要线索）

**边属性（建议最小集）**：
- `ts`
- `destination.port`（如有）
- `network.transport` / `network.protocol`（如有）
- `flow.id`、`network.community_id`（如有，用于会话聚合/回溯）
- `custom.evidence.event_ids`

> 关键取舍：v2 不创建 `NetConn(flow)` 节点；会话键只作为边属性保留。

#### 2.2.6 `DNS_QUERY`（DNS 查询）

**触发条件**：
- `event.dataset = netflow.dns`

**端点**：
- `Domain`：从 `dns.question.name` 映射到 `domain.name`
- `Host` 或 `Process`：优先 Process（若能关联 `process.entity_id`），否则 Host

**边属性（建议最小集）**：
- `ts`
- `dns.question.type`
- `dns.response_code`（可选）
- `custom.dns.*`（可选：entropy/query_length/tunnel_score）
- `custom.evidence.event_ids`

#### 2.2.7 `RESOLVES_TO`（DNS answers）

**触发条件**：
- `event.dataset = netflow.dns`
- 且存在可解析的 DNS answers（例如 `dns.answers.data` 中的 IP）

**端点**：
- `Domain(domain.name) → IP(ip)`

**边属性（建议最小集）**：
- `ts`
- `custom.evidence.event_ids`

> 对齐说明：`docs/06A` 的 `netflow.dns` 最小字段表未要求 answers；因此本边是 **可选边**，只有输入确实携带 answers 时才生成。  
> 若希望规范化支持本边，建议在 `docs/06A` 的 `netflow.dns` 补充可选字段 `dns.answers.data`（见第 3 章对齐检查）。

#### 2.2.8 `HAS_IP`（主机 IP）

**触发条件**：
- 任意事件出现 `host.ip`（数组或单值）

**端点**：
- `Host(host.id) → IP(ip)`

**边属性（建议最小集）**：
- `ts`（取该事件的 `@timestamp`）
- `custom.evidence.event_ids`

---

## 3. 字段对齐检查（v2 vs `docs/06A`）

本节只做“**抽取依赖字段是否在 06A 明确**”的检查，不涉及补边时间窗与算法策略。

### 3.1 关键对齐结论（必须明确的点）

1. `hostlog.auth` 的 `session.id` 在 06A 里是 ✅（必填），但允许在 `event.outcome=failure` 时缺失。  
   → 因此 `LOGON` 抽取规则必须把“失败可缺 session”写清楚（已在 2.2.1 体现）。

2. `hostbehavior.file` 的 `process.entity_id` 在 06A 里是 ✅（必填）。  
   → 因此 `FILE_ACCESS` 的 “Host→File 降级”只能用于 `hostlog.file_registry` 等日志类数据集，不能套用到 `hostbehavior.file`（已在 2.2.4 体现）。

3. `netflow.flow` 的五元组与 `flow.id` 在 06A 里是 ✅（必填）。  
   → v2 把它们保留为 `NET_CONNECT` 的边属性（不建 NetConn 节点），但字段要求不变。

4. `netflow.dns` 的 answers 字段在 06A 最小表中未出现（已在 06A 补充为 ⭐ 可选）。  
   → v2 仍将 `RESOLVES_TO` 视为可选边（有 answers 才生成）。

5. 告警严重度字段：06A 规范是 `event.severity`（✅）+ `risk.score`（⭐）。  
   → v2 不使用 `event.risk_score` 之类非规范字段；落图属性建议按 06A。

---

## 4. 与当前代码实现（v1）的差异与迁移建议

当前实现位于：
- `backend/app/services/graph/models.py`
- `backend/app/services/graph/ecs_ingest.py`

### 4.1 v1 现状摘要（仅用于对照）

- 节点：`Host/User/Process/File/IP/Domain/NetConn`
- 边：`LOGON/PARENT_OF/USES/OWNS/CONNECTED/RESOLVED/RESOLVES_TO`
- 网络侧：通过 `NetConn(flow.id|community_id)` 节点承载会话，再用 `OWNS/CONNECTED` 连接

### 4.2 v1 → v2 关系映射（建议）

| v1 关系/节点 | v2 对应 | 说明 |
|------------|--------|------|
| `NetConn` 节点 | （移除） | `flow.id` / `network.community_id` 变为 `NET_CONNECT` 边属性 |
| `PARENT_OF` | `SPAWN` | 命名更贴近语义（父进程创建子进程） |
| `USES` | `FILE_ACCESS` | v2 把“read/write/execute”作为 `op` 属性 |
| `OWNS(Host/Process→NetConn)` | `NET_CONNECT(Host/Process→IP)` | 直接连到 IP，减少一跳 |
| `RESOLVED(Host→Domain)` | `DNS_QUERY(Host/Process→Domain)` | 语义更明确（查询而非“解析”） |
| `RESOLVES_TO(Domain→IP)` | `RESOLVES_TO(Domain→IP)` | 保留（可选边） |

### 4.3 代码侧需要改动的最小清单（不在本文件实现）

1. 更新 `NodeType/RelType` 枚举与 schema constraint（去掉 NetConn）
2. 更新 ECS ingest：`netflow.flow` 直接落 `NET_CONNECT`，不再创建 NetConn 节点
3. 更新测试样例 `backend/tests/fixtures/graph/*`（如存在 NetConn）
4. 更新 `docs/06` / `docs/06B` 的简表口径，统一引用本 v2 规范

---

## 5. 非目标（本文件暂不讨论）

- 上下文补边窗口（Δt）如何选择、如何做跨源因果推断
- ATT&CK tactic 阶段序列如何走、状态机/规则如何定
- APT 剧本匹配与 TTP 序列向量化细节（后续可单独出文档/实现）

