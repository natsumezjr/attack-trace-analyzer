# 客户机 ↔ 中心机接口规范（v1）

## 0. 文档定位

本文只定义“客户机与中心机之间”的接口与协议：

- 中心机提供客户机注册接口（记录 `listen_url/host/capabilities` 等元数据）；
- 中心机定时轮询客户机拉取数据；
- 客户机侧以 RabbitMQ 队列作为采集缓冲。

字段口径见 `51-ECS字段规范.md`，中心机流水线机制见 `30-系统规格说明书.md`。

## 1. 总体约定（固定）

### 1.1 API 路径与内容类型

- 中心机 API 版本固定为 `v1`，体现在路径 `/api/v1/...`。
- 客户机侧拉取接口为简化实现，不带版本前缀，固定为：`GET /falco` / `GET /filebeat` / `GET /suricata`。
- 所有请求与响应的 `Content-Type` 固定为 `application/json; charset=utf-8`。

### 1.2 鉴权

v1 客户机拉取接口不做鉴权。

> 说明：中心机注册接口仍返回 `client_token` 字段，当前仅用于中心机侧登记/展示；客户机拉取接口不会校验该 token。

### 1.3 幂等与去重

- 事件幂等键为 `event.id`（见 `51-ECS字段规范.md`）。
- 拉取增量由 RabbitMQ 队列语义保证：客户机拉取时会从对应队列中取出消息并 `ack`，消息不会在后续拉取中再次出现。
- 因此 v1 不再使用 `cursor` 作为拉取幂等机制。

## 2. 中心机接口：客户机注册

### 2.1 `POST /api/v1/clients/register`

#### Request Body（固定结构）

```json
{
  "client_id": "client-victim-01",
  "client_version": "0.1.0",
  "listen_url": "http://10.0.0.11:8888",
  "host": {
    "id": "h-1111111111111111",
    "name": "victim-01"
  },
  "capabilities": {
    "filebeat": true,
    "falco": true,
    "suricata": true
  }
}
```

约束：

- `listen_url` 必须以 `http://` 或 `https://` 开头；
- `client_id` 必须稳定不变；
- `host.id` 与 `host.name` 必须稳定不变；
- `capabilities` 必须如实反映客户机侧可提供的三类数据源。

#### Response Body（固定结构）

```json
{
  "status": "ok",
  "client_token": "ata_xxx",
  "poll_interval_seconds": 5,
  "server_time": "2026-01-13T12:00:00.000Z"
}
```

约束：

- `poll_interval_seconds` 必须等于中心机环境变量 `CENTER_POLL_INTERVAL_SECONDS` 的实际取值；
- 中心机必须把注册信息写入 OpenSearch `client-registry`（OpenSearch 不可用时，中心机必须写入进程内内存注册表并在响应中附带 warning 字段）。

## 3. 客户机接口：中心机轮询拉取

客户机侧不再维护本地数据库缓冲；三路数据均进入 RabbitMQ 队列，由拉取接口负责“从队列取出并返回”。

### 3.1 `GET /falco`

返回并消费 Falco 队列中的所有消息（队列名由客户机环境变量 `FALCO_QUEUE`/`RABBITMQ_QUEUE` 决定，默认 `data.falco`）。

#### Response Body（固定结构）

```json
{
  "total": 2,
  "data": [
    { "ecs": { "version": "9.2.0" }, "event": { "id": "evt-..." } },
    { "ecs": { "version": "9.2.0" }, "event": { "id": "evt-..." } }
  ]
}
```

### 3.2 `GET /filebeat`

返回并消费 Filebeat/Sigma 队列中的所有消息（默认 `data.filebeat`）。

响应结构同 3.1。

### 3.3 `GET /suricata`

返回并消费 Suricata 队列中的所有消息（默认 `data.suricata`）。

响应结构同 3.1。

约束（所有 3.x 拉取接口通用）：

- `data[]` 的每个元素必须为可直接入库的 ECS JSON 文档；
- 必须满足 `51-ECS字段规范.md` 的公共字段要求，尤其是：
  - 三时间字段存在
  - `event.kind` 与 `event.dataset` 正确
  - `event.id` 稳定（缺失时必须按 51 的规则生成）
- 拉取接口不接受 `cursor` / `limit` 参数；增量由队列语义保证。

## 4. 错误码与重试语义

### 4.1 客户机侧错误响应

```json
{
  "error": "..."
}
```

### 4.2 中心机侧错误响应（注册接口）

中心机注册接口的错误响应固定形态为：

```json
{
  "status": "error",
  "error": {
    "code": "BAD_REQUEST",
    "message": "..."
  }
}
```

### 4.3 重试语义（中心机侧）

中心机轮询失败时必须：

1) 将错误写入注册表 `poll.last_error`；  
2) 在下一次 tick 继续重试；  
3) 不得因为单个客户机失败阻塞其它客户机的拉取与后续流程。
