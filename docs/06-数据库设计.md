# 数据设计总览（03 系列）

> **本文定位**：本文是 **03 系列（数据设计）** 的"总览页"，把数据对象、流转路径、入库路由规则一次性说清楚。
>
> **相关文档**：
> - **03A**：ECS 字段规范（Telemetry/Findings 字段口径，ECS 子集 + `custom.*`）
>   `docs/06A-ECS字段规范.md`
> - **03B**：存储与图谱设计（OpenSearch 索引 + Neo4j 图模型 + 可选关系表）
>   `docs/06B-存储与图谱设计.md`
> - **03C**：客户端 ↔ 中心机接口规范（注册 + 中心轮询拉取数据）
>   `docs/06C-客户端中心机接口规范.md`

---

## 目录

- [1. 数据对象定义](#1-数据对象定义从大到小)
- [2. 数据流转路径](#2-数据流转路径与模块设计对齐)
- [3. 入库路由规则](#3-入库路由规则中心机侧)
- [4. 字段与命名约定](#4-字段与命名约定简表)

---

## 1. 数据对象定义（从大到小）

为避免"日志、告警、图谱、攻击链"混在一起，本项目定义 **5 类核心数据对象**：

### 1.1 对象层次结构

```
Telemetry (事实事件)
    ↓
Raw Findings (原始告警)
    ↓
Canonical Findings (规范告警)
    ↓
Entity Graph (实体关系图)
    ↓
Attack Chains (攻击链)
```

**统一原则**：越往上层，数据量越小、价值越高、越适合展示/汇报。

---

### 1.2 对象详解

#### 1) Telemetry（事实事件）

**定义**：描述"发生了什么"，不做善恶判断。

**特点**：
- 量最大（原始采集数据）
- 不带善恶判断（客观记录）
- 作为告警和关联的基础

**数据源**：
- 主机日志（`hostlog.*`）：Wazuh
- 主机行为（`hostbehavior.*`）：Falco
- 网络流量（`netflow.*`）：Suricata

**存储位置**：OpenSearch `ecs-events-*`

**示例**：
- 用户登录事件
- 进程启动事件
- DNS 查询事件

---

#### 2) Raw Findings（原始告警）

**定义**：各类规则/引擎直接产出的告警。

**特点**：
- 量中等（低于 Telemetry）
- 带规则信息（`rule.*`）
- 带 ATT&CK 标注（`threat.*`）
- 未去重（同一事件可能触发多个规则）

**来源**：
- **Detect-first**：端侧检测（Falco 规则命中）
- **Store-first**：中心侧检测（OpenSearch Security Analytics）

**存储位置**：OpenSearch `raw-findings-*`

**示例**：
- Falco 检测到可疑 shell 执行
- Suricata 检测到 DNS 隧道

---

#### 3) Canonical Findings（规范告警）

**定义**：对 Raw Findings 融合去重后的"唯一信号"。

**特点**：
- 量更小（去重后）
- 融合多源告警（`custom.finding.providers`）
- 唯一标识（`custom.finding.fingerprint`）
- 用于攻击链重建（主要消费层）

**融合策略**：
- 基于 `technique_id + host + (process_entity_id | dst_ip/domain | file_hash) + time_bucket` 生成指纹
- 相同指纹的 Raw Findings 融合为一个 Canonical Finding

**存储位置**：OpenSearch `canonical-findings-*`

**示例**：
- 同一主机在 5 分钟内被多个引擎检测到"进程注入" → 融合为一个 Canonical Finding

---

#### 4) Entity Graph（实体关系图）

**定义**：由 Telemetry/Findings 抽取的实体与关系。

**特点**：
- 支持多跳关联（初始入侵 → 执行 → 横向 → C2 → 外传）
- 任意边都能回放证据（边属性保存 `custom_evidence_event_ids`）
- 用于路径重建与图展示

**实体类型（节点）**：
- `Host`：主机
- `User`：用户
- `Process`：进程
- `File`：文件
- `IP`：IP 地址
- `Domain`：域名

**关系类型（边）**：
- `LOGON`：用户登录主机
- `SPAWNED`：进程启动进程
- `ACCESSED`：进程访问文件
- `CONNECTED`：进程连接 IP
- `RESOLVED`：主机解析域名

**存储位置**：Neo4j（权威存储）

---

#### 5) Attack Chains（攻击链）

**定义**：链路摘要、步骤、证据引用、相似度输出。

**特点**：
- 量最小（最高层抽象）
- 展示价值最高（可直接用于报告）
- 包含攻击阶段（`Initial Access` → `Execution` → ...）
- 包含关键证据（`custom_evidence_event_ids`）

**攻击链阶段**：
1. **Initial Access**（初始访问）
2. **Execution**（执行）
3. **Persistence**（持久化）
4. **Privilege Escalation**（权限提升）
5. **Defense Evasion**（防御规避）
6. **Credential Access**（凭证访问）
7. **Discovery**（发现）
8. **Lateral Movement**（横向移动）
9. **Collection**（收集）
10. **Command and Control**（命令与控制）
11. **Exfiltration**（数据外传）
12. **Impact**（影响）

**存储位置**：OpenSearch `attack-chains-*`

---

### 1.3 数据量对比

| 数据对象 | 相对数据量 | 价值 | 保留周期 |
|---------|-----------|:----:|---------|
| Telemetry | ⭐⭐⭐⭐⭐ | ⭐⭐ | 30 天 |
| Raw Findings | ⭐⭐⭐⭐ | ⭐⭐⭐ | 180 天 |
| Canonical Findings | ⭐⭐⭐ | ⭐⭐⭐⭐ | 180 天 |
| Entity Graph | ⭐⭐ | ⭐⭐⭐⭐ | 长期 |
| Attack Chains | ⭐ | ⭐⭐⭐⭐⭐ | 长期 |

---

## 2. 数据流转路径（与模块设计对齐）

端到端的数据流由 **"客户机模块 → 中心机模块"** 两段组成（详见 `docs/05-模块与数据流说明.md`）。

---

### 2.1 客户机模块（采集 + 客户端后端）

#### 2.1.1 采集组件（只用三种）

| 采集组件 | 数据类型 | Dataset | 说明 |
|---------|---------|---------|------|
| **Wazuh** | 主机日志 | `hostlog.*` | 认证/登录、进程事件、文件/注册表 |
| **Falco** | 主机行为告警 | `hostbehavior.*` | Syscall、文件操作、内存注入 |
| **Suricata** | 网络流量与告警 | `netflow.*` | Flow、DNS、HTTP、ICMP |

**约束**：
- 不使用其他采集组件（如 Zeek、Packetbeat 等）
- 采集组件输出需在归一化层映射为 ECS 子集

---

#### 2.1.2 客户端后端（Client Backend / Go）

**职责**：
1. **归一化**：Raw → ECS 子集（见 03A）
2. **缓冲**：SQLite（本项目固定）
3. **启动注册**：客户端启动后主动向中心机注册（见 03C）
4. **提供拉取接口**：等待中心机轮询拉取（见 03C）

**数据流**：

```
采集组件 (Wazuh/Falco/Suricata)
    ↓ (原始事件)
客户端后端 (归一化 → ECS 子集)
    ↓ (缓冲)
SQLite
    ↓ (等待拉取)
HTTP API (POST /api/v1/pull)
```

---

### 2.2 中心机模块（Next.js 全栈）

**职责**：
1. **注册表**：维护客户端清单与轮询 cursor（落 OpenSearch，建议索引 `client-registry-*`）
2. **轮询器**：按 interval 拉取客户端数据（见 03C）
3. **入库**：写入 OpenSearch（Telemetry/Findings/Chains），写入 Neo4j（实体图）
4. **关联算法**：告警融合、时间窗关联、路径重建、攻击链生成
5. **前端**：时间线、关系图、ATT&CK 覆盖矩阵、报告导出

**数据流**：

```
轮询器 (定时拉取客户端数据)
    ↓ (ECS 文档)
入库路由 (根据 event.kind + event.dataset)
    ↓
OpenSearch (ecs-events-* / raw-findings-* / ...)
Neo4j (实体关系图)
    ↓
关联算法 (告警融合、时间窗关联、路径重建)
    ↓
OpenSearch (canonical-findings-* / attack-chains-*)
    ↓
前端展示 (时间线、关系图、ATT&CK 矩阵)
```

---

## 3. 入库路由规则（中心机侧）

中心机从客户端拉取到的文档为 **ECS 子集**（见 03A），其归类依据是：

- `event.kind`：`event`（Telemetry）/ `alert`（Finding）
- `event.dataset`：`hostlog.* / hostbehavior.* / netflow.* / finding.*`

---

### 3.1 路由规则

| event.kind | event.dataset | 存储位置 | 说明 |
|-----------|--------------|---------|------|
| `event` | `hostlog.*` | `ecs-events-*` | 主机日志 Telemetry |
| `event` | `hostbehavior.*` | `ecs-events-*` | 主机行为 Telemetry |
| `event` | `netflow.*` | `ecs-events-*` | 网络流量 Telemetry |
| `alert` | `finding.raw` | `raw-findings-*` | 原始告警 |
| `alert` | `finding.canonical` | `canonical-findings-*` | 规范告警（融合后） |
| - | - | `attack-chains-*` | 攻击链（中心机生成） |
| - | - | Neo4j | 实体关系图（中心机生成） |

**约束**：
- `event.kind = "event"` 统一路由到 `ecs-events-*`
- `event.kind = "alert"` 根据 `event.dataset` 路由到 `raw-findings-*` 或 `canonical-findings-*`
- `attack-chains-*` 由中心机生成，不来自客户端

---

### 3.2 索引命名约定

| 索引模式 | 数据对象 | 生命周期 |
|---------|---------|---------|
| `ecs-events-*` | Telemetry | 30 天 |
| `raw-findings-*` | Raw Findings | 180 天 |
| `canonical-findings-*` | Canonical Findings | 180 天 |
| `attack-chains-*` | Attack Chains | 长期 |
| `client-registry-*` | 客户端注册表 | 长期 |

**说明**：
- 使用 `*` 后缀支持按日期分割索引（如 `ecs-events-2026-01-12`）
- 不同生命周期的数据可设置不同的保留策略（ILM）

---

### 3.3 图数据库写入

**写入时机**：
1. Telemetry 入库后，抽取实体与关系写入 Neo4j
2. Canonical Findings 生成后，更新 Neo4j 图（添加告警节点）

**写入策略**：
- 节点（实体）：`Host`, `User`, `Process`, `File`, `IP`, `Domain`
- 边（关系）：`LOGON`, `SPAWNED`, `ACCESSED`, `CONNECTED`, `RESOLVED`
- 边属性：`custom_evidence_event_ids`（指向 Telemetry 的 `event.id`）

---

## 4. 字段与命名约定（简表）

完整字段规范见：`docs/06A-ECS字段规范.md`。这里只列"全局必须对齐"的几条：

---

### 4.1 全局约定

| 约定 | 值 | 说明 |
|------|---|------|
| `ecs.version` | `9.2.0` | ECS 版本固定 |
| `custom.*` | 自定义字段 | 避免污染 ECS 标准字段 |
| 标记约定 | `✅` = 必填，`⭐` = 建议，`⭕` = 可选 | 字段必填性 |

---

### 4.2 时间字段（三时间）

| 字段 | 说明 |
|------|------|
| `@timestamp` | 发生时间（主时间轴） |
| `event.created` | 采集观察时间 |
| `event.ingested` | 中心机入库时间 |

**约束**：所有事件必须包含三个时间字段。

---

### 4.3 标识字段（ID 生成策略）

| 字段 | 用途 | 生成策略 |
|------|------|---------|
| `event.id` | 全局幂等键 | `uuidv4()` 或 `sha1(source + raw_unique_key + @timestamp)` |
| `host.id` | 跨源最强关联键 | 环境提供或 `sha1(host.name)` |
| `process.entity_id` | 进程实例标识 | `sha1(host.id + pid + process.start_time + process.executable)` |
| `session.id` | 会话标识 | `sha1(host.id + user.name + source.ip + floor(@timestamp / Δt))` |

**约束**：中心机按 `event.id` 去重入库。

---

### 4.4 Dataset 命名约定

| Dataset 前缀 | 数据类型 | 示例 |
|-------------|---------|------|
| `hostlog.*` | 主机日志 | `hostlog.auth`, `hostlog.process` |
| `hostbehavior.*` | 主机行为 | `hostbehavior.syscall`, `hostbehavior.file` |
| `netflow.*` | 网络流量 | `netflow.flow`, `netflow.dns` |
| `finding.*` | 检测告警 | `finding.raw`, `finding.canonical` |

**约束**：所有 `event.dataset` 必须遵循上述命名约定。

---

## 附录：相关文档

- **ECS 字段规范**：`docs/06A-ECS字段规范.md`
- **存储与图谱设计**：`docs/06B-存储与图谱设计.md`
- **客户端中心机接口规范**：`docs/06C-客户端中心机接口规范.md`
- **模块与数据流说明**：`docs/05-模块与数据流说明.md`
- **系统规格说明书**：`docs/03-系统规格说明书.md`
