# 客户端 ↔ 中心机：注册与数据拉取接口规范（v1）

> **本文定位**：本文定义 **客户端后端（Client Backend / Go）** 与 **中心机后端（Center Backend / Next.js）** 的交互协议：
> - 客户端启动后 **主动向中心机注册**
> - 注册成功后，中心机 **轮询客户端** 拉取数据（Telemetry/Findings）
>
> **相关文档**：
> - 字段规范（ECS 子集 + `custom.*`）：`docs/06A-ECS字段规范.md`
> - 存储与图谱设计（OpenSearch + Neo4j）：`docs/06B-存储与图谱设计.md`
> - 数据设计总览：`docs/06-数据库设计.md`

---

## 目录

- [1. 背景与目标](#1-背景与目标)
- [2. 角色与组件边界](#2-角色与组件边界)
- [3. 约定（必读）](#3-约定必读)
- [4. 接口定义](#4-接口定义)
- [5. 数据分类建议](#5-数据分类建议用于后续入库路由)
- [6. 轮询策略](#6-轮询策略中心机侧)

---

## 1. 背景与目标

### 1.1 为什么是"注册 + 轮询"

课程靶场通常是"多节点、短周期、网络环境不稳定"的形态。采用 **客户端注册 + 中心轮询**的好处：

| 优势 | 说明 | 实现方式 |
|------|------|---------|
| **中心机掌握全局** | 知道有哪些客户端在线、各自能力是什么 | 注册表 |
| **天然背压** | 中心机慢时拉取变慢，客户端只需本地缓冲 | 轮询机制 |
| **MVP 友好** | 客户端无需持续推送，降低实现复杂度 | 定时拉取 |

**对比推送模式**：
- 推送（Push）：客户端主动推送，需要维护连接、处理失败重试、实现背压
- 拉取（Pull）：中心机按需拉取，客户端只需提供 API，无需维护连接状态

---

### 1.2 本接口覆盖什么

**覆盖**：
- ✅ 客户端向中心机注册（登记：客户端 ID、地址、能力、版本等）
- ✅ 中心机向客户端拉取事件（ECS Telemetry + Findings）
- ✅ 最小安全机制（token）与幂等性/去重建议

**不覆盖（v1 不做）**：
- ❌ 复杂鉴权/多租户/证书分发
- ❌ 双向流式传输（WebSocket/gRPC）
- ❌ 远程下发采集/规则配置（可作为 v2 扩展）

---

## 2. 角色与组件边界

### 2.1 客户端（Client Backend / Go）

每个靶场节点（或关键节点）部署一个客户端后端进程。

> 本项目拍板：客户端后端使用 **Go** 实现。

---

#### 2.1.1 数据来源

从 3 个采集组件获取数据（本项目只用这些）：

| 采集组件 | 数据类型 | Dataset | 说明 |
|---------|---------|---------|------|
| **Wazuh** | 主机日志 | `hostlog.*` | 认证/登录、进程事件、文件/注册表 |
| **Falco** | 主机行为告警 | `hostbehavior.*` | Syscall、文件操作、内存注入 |
| **Suricata** | 网络流量与告警 | `netflow.*` + `alert` | Flow、DNS、HTTP、ICMP |

---

#### 2.1.2 核心职责

| 职责 | 说明 | 实现方式 |
|------|------|---------|
| **数据采集** | 从采集组件获取原始事件 | Wazuh/Falco/Suricata API |
| **归一化** | 将原始事件映射为 ECS 子集字段 | 见 `docs/06A-ECS字段规范.md` |
| **缓冲** | 本地缓冲，避免数据丢失 | SQLite |
| **注册** | 启动后主动向中心机注册 | `POST /api/v1/clients/register` |
| **拉取接口** | 提供 HTTP API，供中心机轮询拉取 | `POST /api/v1/pull` |
| **健康检查** | 提供健康检查接口（v1 必做） | `GET /api/v1/health` |

---

### 2.2 中心机（Center Backend / Next.js）

中心机后端由 **Next.js 全栈**承担（API + 页面）。

---

#### 2.2.1 核心职责

| 职责 | 说明 | 实现方式 |
|------|------|---------|
| **注册表** | 接收客户端注册，维护在线状态 | OpenSearch（建议索引：`client-registry-*`） |
| **轮询器** | 定时轮询客户端拉取事件/告警 | 定时任务 + HTTP 客户端 |
| **入库** | 写入 OpenSearch/Neo4j | OpenSearch Client + Neo4j Driver |
| **关联算法** | 告警融合、时间窗关联、路径重建 | Python 算法模块 |
| **攻击链构建** | 生成攻击链对象 | 关联算法输出 |
| **前端** | 提供查询与可视化页面 | Next.js Pages + React |

---

## 3. 约定（必读）

### 3.1 命名与版本

| 约定 | 值 | 说明 |
|------|---|------|
| API 版本 | `v1` | 体现在路径 `/api/v1/...` |
| 内容类型 | `application/json; charset=utf-8` | 所有接口统一使用 JSON |

**示例**：
- 请求：`POST /api/v1/clients/register`
- 响应：`Content-Type: application/json; charset=utf-8`

---

### 3.2 标识与幂等

| 标识 | 类型 | 说明 | 示例 |
|------|------|------|------|
| `client_id` | `string` | 客户端唯一标识（稳定不变） | `client-victim-01` |
| `event.id` | `string` | 事件唯一标识（Telemetry/Finding 必填） | `evt-1b2c3d4e5f6a7b8c` |

**幂等性**：
- 中心机入库去重：以 `event.id` 为幂等键
- 同一事件重复拉取不应产生重复入库
- 客户端注册：同一 `client_id` 重复注册应更新而非创建新记录

---

### 3.3 安全（MVP）

**认证机制**：
- 注册成功后，中心机下发 `client_token`（Bearer token）
- 中心机轮询客户端时必须携带：`Authorization: Bearer <client_token>`

**传输安全**：
- v1 默认使用 **HTTP**（靶场内网环境）
- 如后续需要，可升级为 **HTTPS**（v2/生产化增强）
- Token 不得在日志中明文打印

---

## 4. 接口定义

> **说明**：路径写的是"建议"，实现可按你们 Next.js/Go 框架调整，但语义保持一致。

---

### 4.1 客户端 → 中心机：注册

#### 4.1.1 基本信息

| 项目 | 值 |
|------|---|
| **方法** | `POST` |
| **路径** | `/api/v1/clients/register` |
| **提供方** | 中心机（Center Backend） |
| **调用方** | 客户端（Client Backend） |

---

#### 4.1.2 Request Body

```json
{
  "client_id": "client-victim-01",
  "client_version": "0.1.0",
  "listen_url": "http://10.0.0.11:18080",
  "host": {
    "id": "h-a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6",
    "name": "victim-01"
  },
  "capabilities": {
    "wazuh": true,
    "falco": true,
    "suricata": true
  }
}
```

**字段说明**：

| 字段 | 类型 | 必填 | 说明 | 示例 |
|------|------|:----:|------|------|
| `client_id` | `string` | ✅ | 客户端唯一标识（稳定不变） | `client-victim-01` |
| `client_version` | `string` | ✅ | 客户端版本 | `0.1.0` |
| `listen_url` | `string` | ✅ | 中心机可访问的客户端地址（含端口） | `http://10.0.0.11:18080` |
| `host.id` | `string` | ✅ | 主机唯一标识（与 ECS 对齐） | `h-a1b2c3d4e5f6a7b8c` |
| `host.name` | `string` | ✅ | 主机名（用于展示/筛选） | `victim-01` |
| `capabilities.wazuh` | `boolean` | ✅ | 能力：Wazuh | `true` |
| `capabilities.falco` | `boolean` | ✅ | 能力：Falco | `true` |
| `capabilities.suricata` | `boolean` | ✅ | 能力：Suricata | `true` |

**约束**：
- `client_id` 建议由部署脚本生成并落盘（避免手动输入）
- `listen_url` 必须为中心机可访问的地址（内网 IP 或域名）
- `host.id` 与 `host.name` 应与 ECS 文档中的 `host.id` 和 `host.name` 一致

---

#### 4.1.3 Response（200）

```json
{
  "status": "ok",
  "client_token": "token-xxxx-xxxx-xxxx",
  "poll_interval_seconds": 5,
  "server_time": "2026-01-12T12:00:00Z"
}
```

**字段说明**：

| 字段 | 类型 | 说明 | 示例 |
|------|------|------|------|
| `status` | `string` | 状态，固定为 `ok` | `ok` |
| `client_token` | `string` | 客户端 Token（Bearer token） | `token-xxxx-xxxx-xxxx` |
| `poll_interval_seconds` | `integer` | 建议轮询间隔（秒） | `5` |
| `server_time` | `string` | 中心机当前时间（ISO 8601） | `2026-01-12T12:00:00Z` |

**约束**：
- `client_token` 应为随机生成的安全字符串（建议 32 字符以上）
- 中心机应存储 `client_token` 的哈希值（而非明文）

---

#### 4.1.4 幂等性

**规则**：同一 `client_id` 重复注册应返回同一个逻辑客户端。

**行为**：
- ✅ 更新 `listen_url` / `client_version` / `capabilities`
- ✅ 更新 `last_seen` 时间戳
- ❌ 不应创建重复记录

---

### 4.2 中心机 → 客户端：健康检查（v1 必做）

#### 4.2.1 基本信息

| 项目 | 值 |
|------|---|
| **方法** | `GET` |
| **路径** | `/api/v1/health` |
| **提供方** | 客户端（Client Backend） |
| **调用方** | 中心机（Center Backend） |

---

#### 4.2.2 Request

无需参数。

---

#### 4.2.3 Response（200）

```json
{
  "status": "ok",
  "client_id": "client-victim-01",
  "time": "2026-01-12T12:00:01Z"
}
```

**字段说明**：

| 字段 | 类型 | 说明 | 示例 |
|------|------|------|------|
| `status` | `string` | 状态，固定为 `ok` | `ok` |
| `client_id` | `string` | 客户端唯一标识 | `client-victim-01` |
| `time` | `string` | 客户端当前时间（ISO 8601） | `2026-01-12T12:00:01Z` |

**用途**：
- 中心机可用于探测客户端是否在线
- 可用于离线检测与排障（本项目 v1 **不做离线对外通知**，仅用于 UI 展示与日志记录）

---

### 4.3 中心机 → 客户端：拉取事件（核心接口）

#### 4.3.1 基本信息

| 项目 | 值 |
|------|---|
| **方法** | `POST` |
| **路径** | `/api/v1/pull` |
| **提供方** | 客户端（Client Backend） |
| **调用方** | 中心机（Center Backend） |

---

#### 4.3.2 Headers

| Header | 值 | 说明 |
|--------|---|------|
| `Authorization` | `Bearer <client_token>` | Bearer Token 认证 |

**示例**：
```
Authorization: Bearer token-xxxx-xxxx-xxxx
```

---

#### 4.3.3 Request Body

```json
{
  "cursor": "0",
  "limit": 500,
  "want": {
    "event_kinds": ["event", "alert"],
    "datasets": ["hostlog.*", "hostbehavior.*", "netflow.*", "finding.*"]
  }
}
```

**字段说明**：

| 字段 | 类型 | 必填 | 说明 | 示例 |
|------|------|:----:|------|------|
| `cursor` | `string` | ✅ | 上次拉取位置（本项目：SQLite 自增 id） | `"0"`, `"500"` |
| `limit` | `integer` | ✅ | 分页大小（本项目：固定 500；客户端可上限保护） | `500` |
| `want.event_kinds` | `string[]` | ⭐ | 想要的事件类型（`event`/`alert`） | `["event", "alert"]` |
| `want.datasets` | `string[]` | ⭐ | 想要的数据集（支持通配符） | `["hostlog.*", "netflow.dns"]` |

**cursor 的实现方式**：
- **SQLite 自增 id（本项目采用）**

**约束**：
- `limit` 不宜过大，避免单次响应过大（建议 ≤ 2000；本项目中心机固定使用 500）
- `want.*` 为可选字段；**本项目 v1 支持并按其进行过滤**（缺省则返回全部）

---

#### 4.3.4 Response（200）

```json
{
  "status": "ok",
  "items": [
    {
      "ecs": { "version": "9.2.0" },
      "@timestamp": "2026-01-12T03:21:10.123Z",
      "event": {
        "id": "evt-1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e",
        "kind": "event",
        "created": "2026-01-12T03:21:12.001Z",
        "ingested": "2026-01-12T03:21:12.900Z",
        "category": ["authentication"],
        "type": ["start"],
        "action": "user_login",
        "dataset": "hostlog.auth",
        "outcome": "success"
      },
      "host": { "id": "h-a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6", "name": "victim-01" },
      "user": { "name": "alice" },
      "source": { "ip": "10.0.0.8" },
      "session": { "id": "sess-0123456789abcdef0123456789abcdef" },
      "agent": { "name": "wazuh-agent", "version": "4.0.0" }
    }
  ],
  "next_cursor": "500",
  "has_more": true,
  "server_time": "2026-01-12T12:00:02Z"
}
```

**字段说明**：

| 字段 | 类型 | 说明 | 示例 |
|------|------|------|------|
| `status` | `string` | 状态，固定为 `ok` | `ok` |
| `items` | `object[]` | ECS 事件数组（见 `docs/06A-ECS字段规范.md`） | - |
| `next_cursor` | `string` | 下次拉取的 cursor | `"500"` |
| `has_more` | `boolean` | 是否还有更多数据 | `true` |
| `server_time` | `string` | 客户端当前时间（ISO 8601） | `2026-01-12T12:00:02Z` |

**约束**：
- `items` 中的每个对象必须符合 ECS 子集规范（见 03A）
- `event.id` 必须唯一且稳定
- `next_cursor` 为空字符串 `""` 时表示无更多数据

---

#### 4.3.5 语义与实现建议

**去重**：
- 中心机按 `event.id` 去重（幂等键）
- 客户端应保证 cursor 推进后不重复输出（游标单向递增）

**ACK（确认机制）**：
- **v1 简化**：不做 ACK 接口
- 中心机保存 `next_cursor` 即认为消费成功
- 若担心入库失败，可在"入库成功后"才推进 cursor

**错误处理**：
- 客户端异常：返回错误响应（见 4.4）
- 中心机应记录错误日志，稍后重试
- 连续失败超过阈值（如 10 次）标记客户端为离线

---

### 4.4 错误响应（统一格式）

#### 4.4.1 错误响应格式

```json
{
  "status": "error",
  "error": {
    "code": "UNAUTHORIZED",
    "message": "missing or invalid token"
  }
}
```

**字段说明**：

| 字段 | 类型 | 说明 | 示例 |
|------|------|------|------|
| `status` | `string` | 状态，固定为 `error` | `error` |
| `error.code` | `string` | 错误码（见下表） | `UNAUTHORIZED` |
| `error.message` | `string` | 错误描述（人类可读） | `missing or invalid token` |

---

#### 4.4.2 错误码定义

| 错误码 | HTTP 状态码 | 说明 | 处理建议 |
|--------|-----------|------|---------|
| `UNAUTHORIZED` | `401` | Token 缺失或无效 | 检查 Token 是否正确 |
| `BAD_REQUEST` | `400` | 参数错误 | 检查请求参数格式 |
| `INTERNAL_ERROR` | `500` | 客户端内部异常 | 稍后重试或联系管理员 |
| `FORBIDDEN` | `403` | 无权限访问 | 检查 Token 权限 |

**HTTP 状态码**：
- `2xx`：成功
- `4xx`：客户端错误（参数错误、认证失败）
- `5xx`：服务端错误（客户端异常）

---

## 5. 数据分类建议（用于后续入库路由）

客户端输出的文档以 `event.kind` + `event.dataset` 作为路由依据：

| event.kind | event.dataset | 存储位置 | 说明 |
|-----------|--------------|---------|------|
| `event` | `hostlog.*` | `ecs-events-*` | 主机日志 Telemetry |
| `event` | `hostbehavior.*` | `ecs-events-*` | 主机行为 Telemetry |
| `event` | `netflow.*` | `ecs-events-*` | 网络流量 Telemetry |
| `alert` | `finding.raw` | `raw-findings-*` | 原始告警 |
| `alert` | `finding.canonical` | `canonical-findings-*` | 规范告警（融合后） |

**中心机融合后产出**：
- `canonical-findings-*`：融合去重后的规范告警
- `attack-chains-*`：攻击链实例
- Neo4j：实体关系图

> 具体索引划分见 `docs/06B-存储与图谱设计.md`。

---

## 6. 轮询策略（中心机侧）

### 6.1 中心机维护的状态

本项目中心机对每个客户端维护以下状态，并落到 **OpenSearch**（建议索引：`client-registry-*`）：

| 字段 | 类型 | 说明 | 示例 |
|------|------|------|------|
| `client_id` | `string` | 客户端唯一标识 | `client-victim-01` |
| `listen_url` | `string` | 客户端对外地址 | `http://10.0.0.11:18080` |
| `client_token_hash` | `string` | Token 哈希（不存明文） | `sha256(token)` |
| `last_seen` | `datetime` | 最后成功拉取时间 | `2026-01-12 12:00:00` |
| `last_error` | `text` | 最后错误（可选） | `Connection refused` |
| `cursor` | `string` | 当前消费位置 | `"500"` |

> 说明：注册表与轮询状态以 OpenSearch 为权威存储；关系型/内存方案不作为 v1 落地目标。

---

### 6.2 轮询参数（v1 固定）

| 参数 | 值 | 说明 |
|------|-------|------|
| `poll_interval_seconds` | 5 秒 | 轮询间隔（演示优先"实时可见"） |
| `timeout` | 10 秒 | 单次拉取超时时间 |
| `retry` | 3 次 | 失败重试次数 |
| `jitter` | ±20% | 轮询间隔抖动（避免同时打到中心机） |
| `/api/v1/pull` `limit` | 500 | 单次拉取上限（固定值） |

**多客户端轮询**：
- 建议对每个客户端的轮询时间做**抖动**（jitter）
- 避免多个客户端同时被轮询（导致中心机负载瞬时飙升）

**示例**：
```python
# 伪代码：带抖动的轮询
base_interval = 5  # 秒
jitter = random.uniform(0.8, 1.2)  # ±20%
actual_interval = base_interval * jitter

for client in clients:
    schedule_poll(client, interval=actual_interval)
```

---

### 6.3 离线检测

**检测规则**：
- 连续失败 ≥ 10 次：标记为**离线**
- 连续失败 ≥ 30 次：标记为**长期离线**
- 成功拉取一次：恢复为**在线**

**处理（v1）**：
- 客户端离线：记录日志；注册表状态置为 offline；前端展示离线状态
- 长期离线：同上（标记为长期离线用于 UI 展示/排障）
- 不做：邮件/Webhook/IM 等对外通知；不额外生成离线 Finding

---

## 附录：相关文档

- **ECS 字段规范**：`docs/06A-ECS字段规范.md`
- **存储与图谱设计**：`docs/06B-存储与图谱设计.md`
- **数据设计总览**：`docs/06-数据库设计.md`
- **模块与数据流说明**：`docs/05-模块与数据流说明.md`
- **系统规格说明书**：`docs/03-系统规格说明书.md`
