# 非功能设计

## 文档目的

本文件将需求中的非功能要求落地为确定的工程设计约束，覆盖幂等、一致性、可解释、性能、稳定性与可复现性。

## 读者对象

- 负责系统架构与后端实现的同学
- 负责测试与验收的同学

## 引用关系

- 需求分析：`../20-需求与验收/20-需求分析报告.md`
- 数据与规范：`../80-规范/`
- 测试报告：`../96-测试/96-测试分析报告.md`

## 1. 幂等与去重

### 1.1 OpenSearch 幂等

系统以 `event.id` 作为全局幂等键：

- 同一 `event.id` 重复写入 OpenSearch 不产生重复文档
- `event.id` 的生成规则由 `../80-规范/81-ECS字段规范.md` 定义

### 1.2 图谱幂等

Neo4j 节点写入使用唯一键约束保证幂等；边写入携带证据引用并具备可过滤的去重口径，具体规范见：

- `../80-规范/84-Neo4j实体图谱规范.md`
- `../80-规范/85-溯源结果写回规范.md`

## 2. 一致性与可回放

### 2.1 数据规模假设

系统设计与性能目标基于以下数据规模假设：

| 指标 | 规模 | 说明 |
|------|------|------|
| 单客户机每分钟事件量 | ~1000 条 | 三传感器（Falco/Filebeat/Suricata）合计 |
| 单客户机每天事件量 | ~144 万条 | 按 24 小时连续运行计算 |
| 10 客户机集群每天事件量 | ~1440 万条 | 典型部署规模 |
| 图谱节点规模（30天窗口） | ~10 万节点 | Host/User/Process/File/IP/Domain 等实体 |
| 图谱边规模（30天窗口） | ~50 万边 | 包含时间属性的关系边 |
| Raw Findings 每天生成量 | ~1000 条 | 基于 Sigma 与 Security Analytics 检测 |
| Canonical Findings 每天生成量 | ~100 条 | 经融合去重后的规范告警 |
| 单次溯源任务查询时间窗 | 1-60 分钟 | 用户可选的时间窗范围 |

### 2.2 一致性目标

一致性目标：

1. 同一批输入事件在重复拉取与重复执行下，OpenSearch 与 Neo4j 的关键输出一致。
2. 任意告警与溯源结论可回溯到 Telemetry 的 `event.id` 证据。

## 3. 可解释与证据链

可解释性要求：

- 前端展示的告警、边与溯源结果必须包含证据引用
- 溯源写回字段使用统一前缀 `analysis.`，字段集合与覆盖规则由 `../80-规范/85-溯源结果写回规范.md` 定义

## 4. 性能目标与容量边界

性能目标：

- 图查询在秒级返回满足可视化展示的数据量
- 溯源任务允许长耗时，但必须提供可轮询的状态与进度

容量边界与数据保留策略见：

- `../80-规范/80-数据对象与生命周期.md`

### 4.1 前端查询性能

| 指标 | 目标值 | 测量方法 |
|------|--------|----------|
| 图查询响应时间 | <3 秒 | 实际负载测试 |
| 事件检索响应时间 | <1 秒 | 实际负载测试 |
| 页面首次渲染 | <2 秒 | 浏览器性能测试 |

### 4.2 中心机轮询性能

| 指标 | 目标值 | 测量方法 |
|------|--------|----------|
| 单次轮询耗时 | <10 秒 | 轮询日志统计 |
| 单轮拉取吞吐量 | >1000 evt/s | 轮询日志统计 |
| 数据积压恢复时间 | <5 分钟 | 积压场景测试 |

### 4.3 Neo4j 入图性能

| 指标 | 目标值 | 测量方法 |
|------|--------|----------|
| 100 事件入图耗时 | <1 秒 | 性能测试 `test_batch_ingest_performance` |
| 1000 事件入图耗时 | <5 秒 | 性能测试 `test_batch_ingest_performance` |
| 单事件平均网络往返 | <2 次 | 实现：批量 UNWIND MERGE |
| 批量写入吞吐量 | >100 evt/s | 实际负载测试 |

## 5. 稳定性与故障处理

### 5.1 故障处理原则

故障处理原则：

1. 单次轮询失败不影响后续轮询继续执行
2. LLM 调用失败必须走固定回退路径，保证演示不因外部服务中断而失败
3. 数据重置与复现流程固定，见 `../90-运维与靶场/95-重置复现与排障.md`

### 5.2 失败场景与处理策略

| 失败场景 | 检测方式 | 恢复策略 | 用户影响 |
|---|---|---|---|
| 客户机进程崩溃 | 中心机轮询超时 | 客户机自动重启（Docker restart policy） | 数据缺失，可从历史日志恢复 |
| RabbitMQ 消息队列满 | 队列写入失败 | 告警 + 手动扩容 | 实时性下降，需人工介入 |
| OpenSearch 写入失败 | 写入错误响应 | 重试 3 次 → 失败则丢弃 + 告警 | 事件丢失 |
| Neo4j 连接断开 | Cypher 查询异常 | 自动重连 + 重试 | 图谱更新延迟 |
| 前端 API 调用超时 | HTTP timeout | 前端重试 + 错误提示 | 页面功能暂时不可用 |
| LLM 服务不可用 | API 调用失败 | 走固定回退路径（基于规则的解释生成） | 解释文本质量下降，功能仍可用 |

