# 模块与数据流说明（快速上手）

本文档聚焦系统的"故事线"与"输入输出"关系，帮助新同学快速理解系统运行机理与数据流转路径。字段口径与接口规范等技术细节分别在 5x 文档与 31/32/33 文档中详细阐述，此处仅引用而不展开。

## 1. 数据分层与术语（最小集）

系统中的数据对象共分五类。

**Telemetry（遥测事实事件）**：传感器产出的原始观测事件，以 `event.kind="event"` 标识，存储于 OpenSearch 的 `ecs-events-*` 索引，构成系统的基础数据层。

**Raw Finding（原始告警）**：单一检测规则（如 Sigma 规则、Security Analytics 检测器）触发的初步告警，`event.kind="alert"` 且 `dataset` 不为 canonical，落库于 `raw-findings-*` 索引。

**Canonical Finding（规范告警）**：对 Raw Findings 融合去重后的标准化告警，`event.dataset="finding.canonical"`，存储于 `canonical-findings-*` 索引，用于图谱入图与溯源分析。

**Entity Graph（实体关系图）**：将 Telemetry 与 Canonical Finding 转换为属性图——以 Host、User、Process 等实体为节点，事件为边，存储于 Neo4j。

**Trace Task（溯源任务）**：记录异步分析任务的状态与结果，在 OpenSearch 中保存任务文档，并将分析结论写回 Neo4j 边属性。

## 2. 端到端数据流（中心机单定时器流水线）

### 2.1 客户机侧（每台主机）

客户机是数据采集的起点。Filebeat、Falco、Suricata 三类传感器持续采集系统事件、系统调用与网络流量，输出各自格式的原始数据。客户机程序将这些异构数据转换为统一的 ECS 文档格式（字段口径详见 `../80-规范/81-ECS字段规范.md`），写入本机 RabbitMQ 队列作为缓冲，防止数据丢失或积压。同时，客户机对外提供 HTTP 拉取接口，中心机通过轮询方式从队列中取出数据（接口口径见 `../80-规范/87-客户机与中心机接口.md`），实现"增量消费"语义。

### 2.2 中心机侧（每次 tick，严格顺序）

中心机采用单定时器驱动的顺序流水线架构，每次触发后严格按序执行四个步骤。

**第一步：拉取**。中心机遍历所有已注册客户机，调用各自的拉取接口获取新增数据。

**第二步：入库**。将拉取到的 ECS 文档写入 OpenSearch，按 `event.kind` 与 `event.dataset` 路由到对应索引，处理三个时间字段（`@timestamp`、`event.ingested`、`event.created`）并根据 `event.id` 执行幂等去重。

**第三步：检测与融合**。触发 OpenSearch Security Analytics 的 Store-first 检测机制扫描 Telemetry，产出 Raw Findings 后写入 `raw-findings-*` 索引，随后对指定时间窗内的 Raw Findings 执行融合去重，生成 Canonical Findings 并写入 `canonical-findings-*` 索引。

**第四步：入图**。以 Canonical Findings 为主、补充必要的 Telemetry（用于补边与证据回溯），执行 ECS→Graph 转换后批量写入 Neo4j，构建或更新实体图谱。

这四步由同一定时器驱动形成严格的顺序流水线，系统完整规格见 `40-概要设计报告.md`。

> 实现口径（与当前代码对齐）：
>
> - 后端每个 tick 固定执行 Step 1/2/3/4，形成"单定时器顺序流水线"；
> - Step 4 入图以本 tick 的 `event.ingested` 时间窗为边界，确保"本 tick 生成的 Canonical"不会因 `@timestamp` 较早而遗漏。

## 3. 前端可视化数据流

前端可视化的数据交互路径清晰而直接。用户打开前端页面后，界面会向后端发起两类查询请求：事件与告警查询由后端转发至 OpenSearch，图谱查询则由后端调用 Neo4j 执行。前端接收响应数据后进行渲染——事件时间线来自 OpenSearch 的检索结果，图谱则基于 Neo4j 返回的 nodes 与 edges 数据绘制。这种设计让前端只需关注展示逻辑，所有数据访问都通过后端统一代理。

## 4. 溯源任务数据流

溯源任务的数据流体现为"创建-执行-回写-展示"的完整链路。用户在前端图谱上选择目标节点后发起任务创建请求，后端立即生成并返回 `task_id`，快速响应用户操作。Analysis 模块异步接管任务执行：从 Neo4j 读取相关子图数据，运行图算法提取关键路径与解释文本，最后将分析结果写回 Neo4j 的边属性（字段口径见 `32/33`）。前端通过轮询任务状态接口追踪进度，待任务完成后再次请求图查询接口读取边属性，即可在界面上展示溯源结果。用户可导出包含告警、图谱与溯源结果的完整报告。
