# 部署拓扑与网络规划

## 文档目的

本文档定义靶场的节点拓扑、网络规划、端口分配与访问边界，确保演示环境的一致性与可复现性。标准化的拓扑结构与网络配置支持系统在不同环境中快速搭建，避免配置差异导致的演示失败。

## 读者对象

本文档面向三类读者：靶场负责人可从整体把握环境架构；负责部署与编排的同学依据本文档执行操作；负责答辩演示的同学理解系统运行环境的约束与边界。

## 引用关系

本文档聚焦拓扑规划。具体实施细节引用：详细部署步骤见 `../90-运维与靶场/91-靶场部署.md`；自动化编排方案参考 `../90-运维与靶场/92-一键编排.md`；客户机与中心机的接口与端口约定由 `../80-规范/87-客户机与中心机接口.md` 定义。

## 1. 节点与角色

靶场包含三类角色节点。`center` 节点作为中心机，集中部署 OpenSearch、Neo4j、后端 FastAPI 服务与前端 Next.js 应用，构成数据汇聚、存储与分析的核心。`client-01` 到 `client-04` 作为客户机节点，运行 Falco、Filebeat、Suricata 传感器，负责数据采集、本地缓冲与拉取接口暴露。`c2` 节点模拟攻击者的命令与控制服务器，产生可被观测的恶意通信证据，为检测规则与溯源分析提供测试数据。

## 2. 网络规划

网络设计遵循"隔离、受控、最小化暴露"三大原则。靶场网络与宿主机外网完全隔离，所有演示数据在靶场内部闭环流转，既保证安全，也避免演示过程对生产环境的干扰。中心机对外暴露的端口仅面向靶场网络可达范围，不向公网开放不必要的访问入口。客户机遵循最小权限原则，仅向中心机暴露数据拉取接口，不对外提供其他服务端口，降低攻击面与运维复杂度。

## 3. 端口规划

端口分配遵循"职责明确、访问受控"策略。中心机后端 FastAPI 服务监听 8001 端口，仅对靶场内网开放，接收客户机数据拉取请求与前端的查询调用。前端 Next.js 应用运行于 3000 端口，可根据需要开放至公网以便远程演示访问。OpenSearch 的 9200 端口、Neo4j Bolt 协议的 7687 端口与 Neo4j Browser 的 7474 端口仅绑定本地回环地址，禁止外网访问。客户机拉取 API 统一使用 8888 端口，同样仅限靶场内网访问。

| 组件 | 端口 | 协议 | 访问控制 |
|---|---:|---|---|
| center 后端 | 8001 | HTTP | 仅内网 |
| center 前端 | 3000 | HTTP | 公网（可选） |
| OpenSearch | 9200 | HTTP | 仅本地 |
| Neo4j Bolt | 7687 | Bolt | 仅本地 |
| Neo4j Browser | 7474 | HTTP | 仅本地 |
| 客户机拉取 API | 8888 | HTTP | 仅内网 |

## 4. 部署拓扑

整体拓扑采用"中心机集中、客户机分布"结构，符合数据流向的自然逻辑，便于运维管理。客户机分散部署在被监控主机上，负责数据采集与本地队列缓冲，形成分布式的"触角网络"。中心机作为数据处理的核心枢纽，周期性轮询拉取各客户机的数据，写入 OpenSearch 进行持久化，触发检测引擎执行规则匹配，对生成的告警进行融合去重，最终将 Telemetry 与 Canonical Findings 转换为图谱写入 Neo4j。前端应用通过中心机 API 查询数据，展示事件时间线、图谱可视化与溯源分析结果。

## 5. 安全边界与隔离

安全边界的设计贯穿靶场的各个层面。中心机作为核心节点，严格禁止运行未知样本或执行来自外部的不可信代码，所有检测与分析基于已知规则与离线 CTI 数据。靶场网络中组件间的访问鉴权与令牌机制由 `../80-规范/87-客户机与中心机接口.md` 统一定义，确保只有授权的请求才能通过。现场演示的稳定性是第一优先级，任何可能需要人工介入的操作（如异常恢复、数据重置）都必须写入运维文档，避免现场手忙脚乱。
