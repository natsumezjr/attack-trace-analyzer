# 检测与告警融合

## 文档目的

本文件定义中心机侧检测触发、Raw Finding 生成、以及融合去重生成 Canonical Finding 的固定规则与审计口径。

## 读者对象

- 负责 OpenSearch 分析与融合实现的同学
- 负责数据验证与测试的同学

## 引用关系

- 告警数据规范（权威口径）：`../../80-规范/83-告警数据规范.md`
- OpenSearch 索引规范（权威口径）：`../../80-规范/82-OpenSearch索引与Mapping规范.md`
- ECS 字段规范（权威口径）：`../../80-规范/81-ECS字段规范.md`

## 1. 检测触发机制

中心机的检测与融合流程在每个轮询周期（tick）内自动执行，无需人工干预：轮询服务完成数据拉取（Step 1）与入库（Step 2）后，立即触发检测与融合（Step 3）。

触发点位于：
- `backend/app/services/client_poller.py`

### 1.1 检测与融合入口（固定）

检测与融合的统一入口函数固定为：
- `backend/app/services/opensearch/analysis.py:run_data_analysis()`

该函数执行两段核心处理逻辑：

1. **关联分析**：基于 Correlation Rules 执行跨事件关联分析，自动识别高层攻击场景并生成关联告警；
2. **融合去重**：从 `raw-findings-*` 索引读取原始告警，按融合规则聚合去重生成 Canonical Findings，写回 `canonical-findings-*` 索引。

> 说明：底层调用 OpenSearch 插件 API（Security Analytics / Correlation Rules）的细节属于工程实现，可随版本调整；本文件只约束“入口、输入输出与审计口径”。

### 1.2 手动触发（仅调试）

开发/联调阶段允许手动调用 `run_data_analysis()` 单独执行一次，用于排障与回放；但靶场与验收的默认路径以“tick 内固定触发”为准。

## 2. Raw Finding 结构与写入

Raw Finding 来源包括两类数据源：

1. **传感器原生告警**：Filebeat Sigma detector、Falco、Suricata 在客户机侧直接产生的告警事件（`event.kind="alert"`）；
2. **Security Analytics 告警**：OpenSearch Security Analytics 检测引擎产出的 findings，经中心机转换为 ECS 告警事件。

Raw Finding 的字段结构与最小必填字段由权威规范定义，详见：
- `../../80-规范/83-告警数据规范.md`

### 2.1 Security Analytics finding 转换（固定）

当告警来源为 OpenSearch Security Analytics 时，中心机按固定规则将原始 finding 转换为 ECS 告警事件并写入 `raw-findings-*`：

- `event.kind="alert"`
- `event.dataset="finding.raw.security_analytics"`
- `rule.id/rule.name` 从 detector 信息派生
- `threat.*` 从 finding 的 ATT&CK tags 派生（或从固定映射表派生）

实现绑定点：`backend/app/services/opensearch/analysis.py:_convert_security_analytics_finding_to_ecs()`。

## 3. 融合指纹规则

融合去重以固定时间窗内的 Raw Finding 为输入，按指纹规则聚合生成 Canonical Finding。

指纹字段与生成规则由权威规范定义：

- `../../80-规范/83-告警数据规范.md`

### 3.1 时间桶参数（固定）

融合指纹采用固定时间桶策略：
- `TIME_WINDOW_MINUTES = 3`

该参数定义了 Raw Finding 融合的时间窗口，确保只有同一时间桶内的相同指纹告警才会被聚合去重。

实现绑定点：`backend/app/services/opensearch/analysis.py:TIME_WINDOW_MINUTES`

#### 时间桶示意图

```mermaid
gantt
    title 5分钟时间桶聚合示例
    dateFormat X
    axisFormat %s

    section 时间桶0 (0-300s)
    Raw Finding 1    :0, 30
    Raw Finding 2    :50, 20
    Raw Finding 3    :200, 10

    section 时间桶1 (300-600s)
    Raw Finding 4    :300, 40
    Raw Finding 5    :350, 25
    Raw Finding 6    :450, 15

    section 时间桶2 (600-900s)
    Raw Finding 7    :600, 35
    Raw Finding 8    :700, 20
    Raw Finding 9    :800, 30
```

**说明**：
- X 轴表示 Unix 时间戳（秒）
- 每个 5 分钟桶（300 秒）内的 Raw Findings 会被分配到同一个桶中
- 同一个桶内的 Raw Findings 如果指纹相同，才会被融合
- 跨桶的 Raw Findings 即使内容相同也不会被融合

### 3.2 指纹构造要素（固定）

指纹 key 的构造要素固定为：

- `threat.technique.id`
- `host.id`
- `entity_id`（取值顺序固定为：`process.entity_id` → `destination.ip[/destination.domain]` → `file.hash.sha256`）
- `time_bucket`

实现绑定点：`backend/app/services/opensearch/analysis.py:generate_fingerprint()` 与 `fingerprint_id_from_key()`。

### 3.3 字段映射：Raw → Canonical

Raw Finding 转换为 Canonical Finding 时的关键字段映射关系：

```mermaid
flowchart LR
    subgraph RawFinding["Raw Finding"]
        RF1["event.dataset<br/>finding.raw.*"]
        RF2["rule.id / rule.name"]
        RF3["source.ip / source.port"]
        RF4["destination.ip / destination.port"]
        RF5["threat.technique.id"]
        RF6["host.name / host.id"]
        RF7["provider / detector"]
    end

    subgraph CanonicalFinding["Canonical Finding"]
        CF1["event.dataset<br/>finding.canonical"]
        CF2["rule.id / rule.name<br/>(保留优先级最高的)"]
        CF3["source.ip / source.port<br/>(首次出现的)"]
        CF4["destination.ip / destination.port<br/>(首次出现的)"]
        CF5["threat.technique.id<br/>(融合后的)"]
        CF6["host.name / host.id<br/>(统一主机标识)"]
        CF7["provider.*<br/>(来源列表)"]
        CF8["finding.fingerprint<br/>(融合指纹)"]
        CF9["custom.evidence.event_ids<br/>(证据引用)"]
        CF10["finding.dedup_count<br/>(去重计数)"]
    end

    RF1 -->|"dataset 转换"| CF1
    RF2 -->|"保留首次或高优先级"| CF2
    RF3 -->|"保留首次"| CF3
    RF4 -->|"保留首次"| CF4
    RF5 -->|"聚合唯一值"| CF5
    RF6 -->|"保留首次"| CF6
    RF7 -->|"扩展为数组"| CF7
    RF5 -->|"生成唯一指纹"| CF8
    RF1 -->|"收集所有来源"| CF9
    RF1 -->|"计数"| CF10

    classDef rawStyle fill:#e3f2fd,stroke:#1565c0,stroke-width:2px
    classDef canonicalStyle fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef arrowStyle stroke:#ef6c00,stroke-width:2px

    class RawFinding rawStyle
    class CanonicalFinding canonicalStyle
```

**说明**：
- **event.dataset**：从 `finding.raw.*` 转换为 `finding.canonical`
- **provider 字段**：Raw Finding 中的单一 provider 扩展为数组 `provider.*`，记录所有来源
- **finding.fingerprint**：基于指纹要素生成唯一标识符
- **custom.evidence.event_ids**：收集所有融合的 Raw Finding 的 `event.id`
- **finding.dedup_count**：记录融合的 Raw Finding 数量

## 4. Canonical 生成与覆盖规则

Canonical Finding 的生成规则、`event.id` 生成规则与覆盖语义由权威规范定义：
- `../../80-规范/83-告警数据规范.md`

### 4.1 融合写入动作（固定）

融合去重执行以下固定流程：

1. **数据拉取**：从 `raw-findings-*` 索引拉取时间窗内的所有 Raw Findings；
2. **指纹分组**：按融合指纹 key 对 Raw Findings 分组；
3. **聚合合并**：将同一指纹的多条 Raw Findings 合并为一个 Canonical Finding；
4. **单条规范化**：将单个 Raw Finding 的指纹组规范化为 Canonical Finding；
5. **批量写入**：将所有 Canonical Findings 批量写入 `canonical-findings-*` 索引并刷新。

实现绑定点：`backend/app/services/opensearch/analysis.py:deduplicate_findings()`

### 4.2 融合算法流程

```mermaid
flowchart TD
    RawFindings[Raw Findings<br/>时间窗内<br/>3分钟桶] --> TimeBucket[按时间桶分组<br/>time_bucket_id 计算]
    TimeBucket --> Fingerprint[生成指纹<br/>technique_id +<br/>host_id + entity_id +<br/>time_bucket]
    Fingerprint --> Dedup[去重<br/>相同指纹合并<br/>provider 列表]
    Dedup --> Canonical[Canonical Finding<br/>dataset 设置为<br/>finding.canonical<br/>provider 字段列表]
    Canonical --> ProviderMerge[Provider 信息合并<br/>补充 provider字段<br/>host.name等]
    ProviderMerge --> OpenSearch[(OpenSearch<br/>canonical-findings-YYYY.MM.DD)]

    classDef inputStyle fill:#e3f2fd,stroke:#1565c0,stroke-width:2px
    classDef processStyle fill:#fff3e0,stroke:#ef6c00,stroke-width:2px
    classDef outputStyle fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px

    class RawFindings inputStyle
    class TimeBucket,Fingerprint,Dedup processStyle
    class Canonical,ProviderMerge outputStyle
```

**流程说明**：
1. **Raw Findings 聚合**：从 `raw-findings-*` 索引中拉取时间窗内的所有 Raw Findings；
2. **时间桶分组**：按 3 分钟桶分组，确保只有同一时间桶内的 Raw Findings 参与融合；
3. **指纹生成**：基于 `threat.technique.id` + `host.id` + `entity_id` + `time_bucket` 生成唯一指纹 key；
4. **去重融合**：相同指纹的 Raw Findings 合并为一个 Canonical Finding，去重计数写入 `finding.dedup_count`；
5. **Provider 信息合并**：将所有来源的 provider 信息扩展为 `provider.*` 字段数组；
6. **写入 OpenSearch**：批量写入 `canonical-findings-*` 索引并刷新，确保前端可立即查询。

## 5. 审计与可回溯性

为确保告警的完整性与可回溯性，系统遵循以下审计要求：

1. **证据引用完整性**：Raw Finding 与 Canonical Finding 必须包含 `custom.evidence.event_ids[]` 字段，记录关联的 Telemetry 事件 `event.id` 列表；
2. **回溯链路**：Canonical Finding 的证据引用必须能完整回溯到原始 Telemetry 的 `event.id`，支持从告警定位到原始事件；
3. **来源可追溯**：任意 Canonical Finding 必须能定位其来源 providers（`provider.*` 数组）与融合指纹（`finding.fingerprint`），支持告警溯源与去重验证。

字段口径详见：
- `../../80-规范/81-ECS字段规范.md`
