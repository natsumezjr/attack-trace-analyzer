# 拉取接口

## 文档目的

本文档从客户机实现角度描述对外拉取接口的路由清单、返回结构、错误处理机制以及与中心机轮询的配合方式。

## 读者对象

- 客户机 Go 后端开发人员
- 中心机轮询逻辑开发人员

## 引用关系

- 权威接口规范：`../../80-规范/87-客户机与中心机接口.md`
- 客户机总体：`50-总体.md`

## 1. 路由清单

客户机对外暴露 3 个 HTTP GET 路由：

| 路由 | 队列 | 说明 |
|---|---|---|
| `GET /falco` | `data.falco` | 返回并消费 Falco 队列中的消息 |
| `GET /filebeat` | `data.filebeat` | 返回并消费 Filebeat 队列中的消息 |
| `GET /suricata` | `data.suricata` | 返回并消费 Suricata 队列中的消息 |

实现位置：

- 路由入口：`client/backend/main.go`
- 队列消费：`client/backend/queue/client.go`

## 2. 返回结构

接口响应体固定为：

```json
{
  "total": 2,
  "data": [
    {"event": {"id": "evt-..."}, "ecs": {"version": "9.2.0"}},
    {"event": {"id": "evt-..."}, "ecs": {"version": "9.2.0"}}
  ]
}
```

约束：

1. `data[]` 的每个元素必须为 JSON 对象。
2. 每个元素必须包含稳定的 `event.id`。

## 3. 错误处理

当 RabbitMQ 连接或队列操作失败时，接口返回：

```json
{"error": "..."}
```

HTTP 状态码为 `500`

## 4. 与轮询的配合

中心机以固定周期轮询拉取，轮询行为如下：

1. 读取 `client-registry` 中的客户机 `listen_url` 与 `capabilities`
2. 按能力列表调用 `GET /falco`、`GET /suricata`、`GET /filebeat`
3. 收集返回的 `data[]` 列表并写入中心机存储

轮询实现位置：`backend/app/services/client_poller.py`

### 4.1 event.id 补齐规则

客户机拉取接口在返回前补齐 `event.id`：

- 当消息体已包含 `event.id` 时透传
- 当缺失 `event.id` 时，对消息体做 `sha1`，取前 16 位生成：`evt-<sha1[:16]>`

实现位置：`client/backend/queue/client.go` 的 `ensureEventID`
