# 候选路径构造与评分

## 文档目的

本文件定义溯源算法中“候选路径构造与评分”的固定输入输出、时间窗过滤与风险评分规则。

## 读者对象

- 负责溯源算法实现的同学
- 负责测试与可解释性验证的同学

## 引用关系

- 溯源任务模型：`70-任务模型与状态机.md`
- 图谱规范：`../../80-规范/84-Neo4j实体图谱规范.md`

## 1. 输入子图定义

溯源算法的输入由 Neo4j 提供：

- 目标节点 UID：`task.target.node_uid`
- 时间窗：`[task.window.start_ts, task.window.end_ts]`

算法从目标节点的 1-hop incident edges 中获取边集合。

实现入口：

- `backend/app/services/analyze/trace.py` 的 `compute_trace()`

## 2. 时间窗过滤（固定）

输入边集合必须按 `ts_float` 过滤到时间窗内（闭区间语义）：

- `task.window.start_ts <= edge.ts_float <= task.window.end_ts`

时间窗的单位与转换规则由 Neo4j 模块统一处理；算法侧只处理 `ts_float` 数值比较。

## 3. 锚点与段划分（固定）

当前实现不进行攻击阶段段划分；边集合按事件时间排序后直接用于写回与展示。

## 4. 风险评分与排序（固定）

风险评分使用固定的兜底策略：

1. 若边属性包含 `event.severity`，风险分取其数值；
2. 否则若 `is_alarm=true`，风险分取 `50.0`；
3. 其他边风险分取 `0.0`。

实现位置：

- `backend/app/services/analyze/trace.py` 的 `_derive_risk_score()`

## 5. 同分处理规则

同分处理规则固定为：

1. 先按 `ts_float` 时间升序排序；
2. 时间相同按边的 `src_uid` 与 `dst_uid` 字符串排序，保证输出稳定。
