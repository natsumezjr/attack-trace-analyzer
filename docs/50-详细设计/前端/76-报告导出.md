# 报告导出

## 文档目的

本文件定义前端报告导出的数据来源、结构与可复现性约束。

## 读者对象

- 负责前端导出功能的同学
- 负责答辩材料整理的同学

## 引用关系

- 验收标准：`../../20-需求与验收/21-验收标准与验收用例.md`

## 1. 导出内容结构

报告导出面向课程交付与现场答辩，导出产物、结构与字段口径固定。

### 1.1 导出产物（固定）

前端导出产物固定为一个 Markdown 文件：

- 文件名：`attack-trace-report-<task_id>.md`

其中 `<task_id>` 为溯源任务 ID（例如 `trace-aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee`）。

### 1.2 报告章节结构（固定）

Markdown 报告章节结构固定为：

1. 报告元信息
2. 输入与边界
3. 告警与证据摘要
4. 溯源关键路径
5. APT 相似度匹配结果
6. 附录：原始数据（JSON）

### 1.3 字段口径（固定）

报告中的字段口径固定以以下规范为准：

- ECS 字段：`../../80-规范/81-ECS字段规范.md`
- 图查询与任务接口：`../../80-规范/88-前端与中心机接口.md`
- 写回字段：`../../80-规范/85-溯源结果写回规范.md`

## 2. 数据来源

报告导出严格由中心机后端接口提供数据，数据来源固定为以下 4 类请求。

### 2.1 任务信息（固定）

- 方法：`GET`
- 路径：`/api/v1/analysis/tasks/{task_id}`
- 用途：获取任务状态机字段、时间窗与目标节点 UID

### 2.2 溯源关键路径（固定）

- 方法：`POST`
- 路径：`/api/v1/graph/query`
- 请求体固定字段：
  - `action="analysis_edges_by_task"`
  - `task_id=<task_id>`
  - `only_path=true`
  - `include_nodes=true`
- 用途：获取该任务写回的关键路径边与涉及节点

### 2.3 Canonical Finding 摘要（固定）

- 方法：`POST`
- 路径：`/api/v1/findings/search`
- 请求体固定字段：
  - `stage="canonical"`
  - `start_ts/end_ts` 使用任务时间窗
  - `host_id` 为报告主机
- 用途：获取时间窗内 Canonical Finding 的 tactic/technique 覆盖与证据引用

### 2.4 TTP 相似度（固定）

- 方法：`POST`
- 路径：`/api/v1/analysis/ttp-similarity`
- 请求体固定字段：
  - `host_id` 为报告主机
  - `start_ts/end_ts` 使用任务时间窗
- 用途：输出 Top-3 相似 intrusion-set 与解释字段

## 3. 生成规则与可复现性

### 3.1 报告主机选择规则（固定）

报告主机 `host_id` 的取值规则固定为：

1. 当目标节点为 Host 节点时，取该节点的 `host.id`；
2. 当目标节点不是 Host 节点时，取该节点 `props["host.id"]`；
3. 当上述两项均无法取得 `host.id` 时，导出流程终止并提示错误。

### 3.2 排序与格式化（固定）

为保证同一输入导出得到同一关键内容，报告采用固定排序：

1. Canonical Findings：按 `@timestamp` 升序，其次按 `event.id` 升序；
2. 图节点：按 `uid` 升序；
3. 图边：按 `props.ts_float` 升序，其次按 `src_uid`、`rtype`、`dst_uid` 升序；
4. Tactics/Techniques 列表：按字符串升序。

报告中不写入后端响应的 `server_time` 字段；报告只包含与输入相关的稳定字段。

### 3.3 证据引用呈现（固定）

报告中每条关键路径边必须呈现以下字段：

- `event.id`
- `event.dataset`
- `custom.evidence.event_ids[]`
- `analysis.task_id`
- `analysis.is_path_edge`

当某条边为告警边时还必须呈现：

- `is_alarm=true`
- `rule.*`
- `threat.*`
- `custom.finding.*`

这些字段用于现场演示中的“从告警到证据再到路径”的解释闭环。
