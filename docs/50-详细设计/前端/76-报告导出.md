# 报告导出

## 文档目的

本文件定义前端报告导出的数据来源、结构与可复现性约束。

## 读者对象

- 负责前端导出功能的同学
- 负责答辩材料整理的同学

## 引用关系

- 验收标准：`../../20-需求与验收/21-验收标准与验收用例.md`

## 1. 导出内容结构

报告导出面向课程交付与现场答辩，导出产物、结构与字段口径固定。

### 1.1 导出产物（固定）

前端导出产物固定为一个 Markdown 文件：

- 文件名：`attack-trace-report-<task_id>.md`

其中 `<task_id>` 为溯源任务 ID（例如 `trace-aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee`）。

### 1.2 报告章节结构（固定）

Markdown 报告章节结构固定为：

1. 报告元信息
2. 输入与边界
3. 告警与证据摘要
4. 溯源关键路径
5. APT 相似度匹配结果
6. 附录：原始数据（JSON）

### 1.3 字段口径（固定）

报告中的字段口径固定以以下规范为准：

- ECS 字段：`../../80-规范/81-ECS字段规范.md`
- 图查询与任务接口：`../../80-规范/88-前端与中心机接口.md`
- 写回字段：`../../80-规范/85-溯源结果写回规范.md`

## 2. 数据来源

报告导出严格由中心机后端接口提供数据，数据来源固定为以下 4 类请求。

### 2.1 任务信息（固定）

- 方法：`GET`
- 路径：`/api/v1/analysis/tasks/{task_id}`
- 用途：获取任务状态机字段、时间窗与目标节点 UID

### 2.2 溯源关键路径（固定）

- 方法：`POST`
- 路径：`/api/v1/graph/query`
- 请求体固定字段：
  - `action="analysis_edges_by_task"`
  - `task_id=<task_id>`
  - `only_path=false`（默认；前端按 `analysis.is_path_edge=true` 筛选关键路径边）
- 用途：获取该任务写回的关键路径边与涉及节点

> 说明：后端响应固定包含 `nodes[]`（按边集合中的 UID 去重拉取），无需额外的 `include_nodes` 参数；字段结构以 `../../80-规范/88-前端与中心机接口.md` 为准。

### 2.3 Canonical Finding 摘要（固定）

- 方法：`POST`
- 路径：`/api/v1/findings/search`
- 请求体固定字段：
  - `stage="canonical"`
  - `start_ts/end_ts` 使用任务时间窗
  - `host_id` 为报告主机
- 用途：获取时间窗内 Canonical Finding 的 tactic/technique 覆盖与证据引用

### 2.4 TTP 相似度（固定）

TTP 相似度结果的读取规则固定为：

1. **优先**从任务文档 `task.result.ttp_similarity.*` 读取（保证与任务执行时结果一致，避免重复计算）；  
2. 当任务文档缺失该结果时，**回落**调用 `POST /api/v1/analysis/ttp-similarity` 重新计算（`host_id + start_ts/end_ts`）。

## 3. 生成规则与可复现性

### 3.1 报告主机选择规则（固定）

报告主机 `host_id` 的取值规则固定为：

1. 若 `task.target.node_uid` 的 UID 中包含 `host.id`（如 `Host:host.id=...`、`File:host.id=...;file.path=...`），直接从 UID 解析 `host.id`；  
2. 否则，从 `POST /api/v1/graph/query` 的 `nodes[]` 中定位 `uid == task.target.node_uid` 的目标节点，优先取 `node.key["host.id"]`，其次取 `node.props["host.id"]`；  
3. 当上述两项均无法取得 `host.id` 时，导出流程终止并提示错误。

> 说明：中心机后端在节点响应中将唯一键字段拆分为 `key` 与 `props` 两部分，部分节点的 `host.id` 可能出现在 `key` 中；为保证导出稳定性，必须按上述优先级读取。

### 3.2 排序与格式化（固定）

为保证同一输入导出得到同一关键内容，报告采用固定排序：

1. Canonical Findings：按 `@timestamp` 升序，其次按 `event.id` 升序；
2. 图节点：按 `uid` 升序；
3. 图边：按 `props.ts_float` 升序，其次按 `src_uid`、`rtype`、`dst_uid` 升序；
4. Tactics/Techniques 列表：按字符串升序。

报告中不写入后端响应的 `server_time` 字段；报告只包含与输入相关的稳定字段。

### 3.3 证据引用呈现（固定）

报告中每条关键路径边必须呈现以下字段：

- `event.id`
- `event.dataset`
- `custom.evidence.event_ids[]`
- `analysis.task_id`
- `analysis.is_path_edge`

当某条边为告警边时还必须呈现：

- `is_alarm=true`
- `rule.*`
- `threat.*`
- `custom.finding.*`

这些字段用于现场演示中的“从告警到证据再到路径”的解释闭环。
