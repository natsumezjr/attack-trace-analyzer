# 总体与页面结构

## 文档目的

本文件定义前端的页面结构、数据流与与后端接口的固定绑定关系。

## 读者对象

- 负责前端实现的同学
- 负责演示与报告导出的同学

## 引用关系

- 前端与中心机接口：`../../80-规范/88-前端与中心机接口.md`

## 1. 页面结构

前端采用 Next.js App Router（`frontend/app/`），页面与代码文件的绑定关系固定如下。

### 1.1 页面结构图

```mermaid
flowchart TB
    subgraph NextJS["Next.js App Router (:3000)"]
        direction TB

        subgraph Layouts["布局层"]
            RootLayout["layout.tsx<br/>├─ ThemeProvider<br/>├─ ModeToggle<br/>└─ 全局样式"]
            DashLayout["dashboard/layout.tsx<br/>└─ 侧边栏布局"]
            TraceLayout["trace/layout.tsx<br/>└─ 侧边栏布局"]
        end

        subgraph Pages["页面层"]
            Home["page.tsx<br/>/ (首页)"]
            Dashboard["dashboard/page.tsx<br/>/dashboard (总览)"]
            Trace["trace/page.tsx<br/>/trace (溯源分析)"]
        end

        subgraph Components["组件层"]
            Sidebar["app-sidebar.tsx<br/>├─ 主页<br/>├─ 总览<br/>└─ 溯源分析"]
            Graph["图谱可视化组件<br/>G6 图渲染"]
            TaskPanel["任务面板<br/>创建/轮询/进度"]
            ExportBtn["报告导出按钮"]
        end

        RootLayout --> Home
        RootLayout -.->|"共享"| DashLayout
        RootLayout -.->|"共享"| TraceLayout

        DashLayout --> Dashboard
        TraceLayout --> Trace

        Sidebar -.->|"嵌入"| DashLayout
        Sidebar -.->|"嵌入"| TraceLayout
        Graph -.->|"嵌入"| Trace
        TaskPanel -.->|"嵌入"| Trace
        ExportBtn -.->|"嵌入"| Trace
    end

    subgraph Proxy["Next.js 代理 (next.config.ts)"]
        Rewrite["/api/* → http://localhost:8001/api/*<br/>/health → http://localhost:8001/health"]
    end

    subgraph Backend["中心机后端 (:8001)"]
        API["FastAPI<br/>/api/v1/*"]
        Health["/health"]
    end

    subgraph DataLayer["数据层"]
        Neo4j["Neo4j<br/>图数据库"]
        OpenSearch["OpenSearch<br/>事件与发现数据"]
    end

    Pages -->|"HTTP 请求"| Proxy
    Proxy --> Backend
    Backend -.->|"写入/查询"| Neo4j
    Backend -.->|"写入/查询"| OpenSearch

    classDef frontendStyle fill:#e0f7fa,stroke:#006064,stroke-width:2px,color:#000
    classDef pageStyle fill:#b2ebf2,stroke:#006064,stroke-width:2px,color:#000
    classDef compStyle fill:#80deea,stroke:#006064,stroke-width:2px,color:#000
    classDef proxyStyle fill:#4dd0e1,stroke:#006064,stroke-width:2px,color:#000
    classDef backendStyle fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px,color:#000
    classDef dbStyle fill:#e3f2fd,stroke:#1565c0,stroke-width:2px,color:#000

    class RootLayout,DashLayout,TraceLayout frontendStyle
    class Home,Dashboard,Trace pageStyle
    class Sidebar,Graph,TaskPanel,ExportBtn compStyle
    class Rewrite proxyStyle
    class API,Health backendStyle
    class Neo4j,OpenSearch dbStyle
```

### 1.2 页面路由与文件映射（固定）

| 路由 | 页面用途 | 代码位置 |
|---|---|---|
| `/` | 项目首页与入口 | `frontend/app/page.tsx` |
| `/dashboard` | 总览大盘 | `frontend/app/dashboard/page.tsx` |
| `/trace` | 溯源分析主界面 | `frontend/app/trace/page.tsx` |

### 1.2 布局与导航（固定）

布局与导航绑定关系固定：

1. 全站 Root Layout：`frontend/app/layout.tsx`
   - 注入主题切换（`ThemeProvider` + `ModeToggle`）
2. 侧边栏组件：`frontend/components/sidebar/app-sidebar.tsx`
   - 菜单项固定包含：主页、总览、溯源分析
3. `/dashboard` 与 `/trace` 共享侧边栏布局：
   - `frontend/app/dashboard/layout.tsx`
   - `frontend/app/trace/layout.tsx`

### 1.3 组件关系图

```mermaid
flowchart TB
    subgraph Pages["页面层 (青色)"]
        GraphPage[图谱页<br/>/trace]
        DashboardPage[总览页<br/>/dashboard]
    end

    subgraph Components["组件层 (青色)"]
        GraphVis[图谱可视化<br/>G6 Component]
        TaskList[任务列表<br/>TaskTable]
        TaskPanel[任务面板<br/>创建/轮询/进度]
        ReportViewer[报告查看器<br/>PDFViewer]
        Cards[统计卡片<br/>StatCards]
    end

    subgraph API["后端 API (绿色)"]
        GraphAPI[图查询 API<br/>/api/v1/graph/query]
        TaskAPI[任务 API<br/>/api/v1/analysis/tasks]
        EventAPI[事件搜索 API<br/>/api/v1/events/search]
        FindingAPI[发现搜索 API<br/>/api/v1/findings/search]
    end

    GraphPage --> GraphVis
    GraphPage --> TaskPanel
    GraphPage --> TaskList
    GraphPage --> ReportViewer

    DashboardPage --> Cards

    GraphVis -->|"POST 查询图数据"| GraphAPI
    TaskPanel -->|"POST 创建任务"| TaskAPI
    TaskList -->|"GET 轮询状态"| TaskAPI
    Cards -->|"POST 统计"| EventAPI
    Cards -->|"POST 统计"| FindingAPI

    classDef pageStyle fill:#e0f7fa,stroke:#006064,stroke-width:2px,color:#000
    classDef compStyle fill:#b2ebf2,stroke:#006064,stroke-width:2px,color:#000
    classDef apiStyle fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px,color:#000

    class GraphPage,DashboardPage pageStyle
    class GraphVis,TaskList,TaskPanel,ReportViewer,Cards compStyle
    class GraphAPI,TaskAPI,EventAPI,FindingAPI apiStyle
```

## 2. 数据流与状态管理

前端的状态管理采用“页面内状态 + 明确的请求边界”的方式：

1. 页面状态只保存渲染所需的最小集合；
2. 所有后端数据统一通过 `88-前端与中心机接口.md` 获取；
3. 状态变更严格由用户操作或轮询驱动，不通过隐式副作用更新。

### 2.1 Dashboard 数据流（固定）

Dashboard 页展示四类概览卡片。当前实现以静态组件渲染为主；其数据填充采用以下固定数据源：

- Telemetry 统计：`POST /api/v1/events/search`
- Raw/Canonical 告警统计：`POST /api/v1/findings/search`
- 任务统计：`GET /api/v1/analysis/tasks`

Dashboard 页只读取聚合统计，不触发溯源任务与图查询。

### 2.2 Trace 数据流（固定）

Trace 页的数据流固定由 4 个阶段组成：

1. 时间窗输入（最近 N 分钟）→ 图数据拉取
2. 图交互 → 创建溯源任务
3. 任务轮询 → 读取写回边并高亮
4. TTP 相似度 → 输出 Top-3 组织与解释字段

数据流中的所有 HTTP 请求均通过中心机后端完成；前端不直连 OpenSearch 与 Neo4j。

### 2.3 完整数据流图

```mermaid
flowchart LR
    subgraph User["用户操作 (青色)"]
        Input1["设置时间窗"]
        Input2["点选节点"]
        Input3["查看进度"]
        Input4["查看报告"]
    end

    subgraph Frontend["前端应用 (青色)"]
        UI["React 组件"]
        State["useState 状态"]
        Effect["useEffect 轮询"]
    end

    subgraph NextProxy["Next.js 代理 (青色)"]
        Proxy["Rewrite 规则<br/>/api/* → localhost:8001"]
    end

    subgraph Backend["后端服务 (绿色)"]
        GraphService["图服务<br/>/api/v1/graph/query"]
        TaskService["任务服务<br/>/api/v1/analysis/tasks"]
        EventService["事件服务<br/>/api/v1/events/search"]
    end

    subgraph DataLayer["数据层 (深蓝)"]
        Neo4j["Neo4j 图数据库<br/>:7687"]
        OpenSearch["OpenSearch<br/>:9200"]
    end

    Input1 --> UI
    Input2 --> UI
    Input3 --> UI
    Input4 --> UI

    UI -->|"更新"| State
    State -->|"渲染"| UI
    UI -->|"触发请求"| Proxy
    Effect -->|"定时轮询"| Proxy

    Proxy -->|"HTTP"| GraphService
    Proxy -->|"HTTP"| TaskService
    Proxy -->|"HTTP"| EventService

    GraphService -->|"Cypher 查询"| Neo4j
    GraphService -->|"写入/读取写回边"| Neo4j

    TaskService -->|"任务元数据"| Neo4j
    TaskService -.->|"可选"| OpenSearch

    EventService -->|"聚合查询"| OpenSearch

    Neo4j -->|"图数据 (节点/边)"| GraphService
    OpenSearch -->|"事件/统计数据"| EventService

    GraphService -->|"JSON 响应"| Proxy
    TaskService -->|"任务状态"| Proxy
    EventService -->|"统计数据"| Proxy

    Proxy -->|"响应数据"| UI
    UI -->|"更新状态"| State

    classDef userStyle fill:#e0f7fa,stroke:#006064,stroke-width:2px,color:#000
    classDef frontendStyle fill:#b2ebf2,stroke:#006064,stroke-width:2px,color:#000
    classDef proxyStyle fill:#80deea,stroke:#006064,stroke-width:2px,color:#000
    classDef backendStyle fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px,color:#000
    classDef dbStyle fill:#e3f2fd,stroke:#1565c0,stroke-width:2px,color:#000

    class Input1,Input2,Input3,Input4 userStyle
    class UI,State,Effect frontendStyle
    class Proxy proxyStyle
    class GraphService,TaskService,EventService backendStyle
    class Neo4j,OpenSearch dbStyle
```

### 2.4 数据流阶段说明

| 阶段 | 触发条件 | 数据流向 | 涉及组件 | 数据存储 |
|---|---|---|---|---|
| **初始化** | 页面加载 | 前端 → 后端 → Neo4j | 图谱组件 | 图节点与边 |
| **图查询** | 时间窗变更 | 前端 → 后端 → Neo4j | 图谱组件 | 时间窗内子图 |
| **任务创建** | 节点点击 | 前端 → 后端 → Neo4j | 任务面板 | 任务文档 |
| **进度轮询** | 自动触发 | 前端 → 后端 → Neo4j | 任务列表 | 任务状态字段 |
| **写回读取** | 任务完成 | 前端 → 后端 → Neo4j | 图谱组件 | analysis_edges_by_task |
| **TTP 分析** | 任务完成 | 前端 → 后端（缓存） | 报告查看器 | ttp_similarity 字段 |

## 3. 接口调用边界

### 3.1 前端只调用中心机 API（固定）

前端的网络边界固定：

- 仅调用中心机 HTTP API（`/api/v1/*` 与 `/health`）；
- 不直连 OpenSearch（`/9200`）与 Neo4j（`/7687`）。

### 3.2 Trace 页面接口绑定（固定）

Trace 页在不同阶段调用接口的绑定关系固定如下（字段结构以 `88-前端与中心机接口.md` 为准）：

| 阶段 | 触发动作 | 方法 | 路径 | 目的 |
|---|---|---|---|---|
| 图拉取 | 设置时间窗并刷新 | POST | `/api/v1/graph/query` | 获取时间窗图边与节点 |
| 创建任务 | 点选目标节点 | POST | `/api/v1/analysis/tasks` | 创建溯源任务并得到 `task_id` |
| 轮询任务 | 创建任务后自动开始 | GET | `/api/v1/analysis/tasks/{task_id}` | 获取任务状态与进度 |
| 读取写回 | 任务完成后自动触发 | POST | `/api/v1/graph/query` | 读取 `analysis_edges_by_task` 并高亮 |
| 相似度 | 任务完成后自动展示 | - | - | 优先从任务文档 `task.result.ttp_similarity.*` 读取并展示 Top-3；必要时可回落调用 `/api/v1/analysis/ttp-similarity` |

### 3.3 前端代理规则（固定）

本项目运行时前端端口为 `3000`，后端端口为 `8001`。为保证浏览器请求同源，前端通过 Next.js rewrite 规则将以下路径转发到本机后端：

- `/api/*` → `http://localhost:8001/api/*`
- `/health` → `http://localhost:8001/health`

实现绑定点：`frontend/next.config.ts`。

#### 代理配置示例

```typescript
// frontend/next.config.ts
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  async rewrites() {
    return [
      {
        source: "/api/:path*",
        destination: "http://localhost:8001/api/:path*",
      },
      {
        source: "/health",
        destination: "http://localhost:8001/health",
      },
    ];
  },
};

export default nextConfig;
```

#### 端口映射表

| 源端 | 目标端口 | 协议 | 说明 |
|---|---|---|---|
| `:3000` | `:8001` | HTTP | 前端 → 后端 API 请求 |
| `:8001` | `:7687` | Bolt | 后端 → Neo4j 图数据库 |
| `:8001` | `:9200` | HTTP | 后端 → OpenSearch 搜索引擎 |
