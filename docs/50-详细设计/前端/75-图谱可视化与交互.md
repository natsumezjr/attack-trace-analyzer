# 图谱可视化与交互

## 文档目的

本文件定义图谱可视化的渲染模型、筛选与高亮规则、以及点选节点触发溯源任务的交互流程。

## 读者对象

- 负责前端图可视化的同学
- 负责后端图查询接口的同学

## 引用关系

- 图查询接口：`../../80-规范/88-前端与中心机接口.md`
- 图谱规范：`../../80-规范/84-Neo4j实体图谱规范.md`

## 1. 图查询请求与时间窗

图谱页的数据来源固定为中心机图查询接口：`POST /api/v1/graph/query`。

### 1.1 视图模式（固定）

溯源分析页面固定提供三种视图模式：

1. 告警视图：`action="alarm_edges"`
2. 时间窗视图：`action="edges_in_window"`
3. 任务视图：`action="analysis_edges_by_task"`

其中：

- 告警视图用于展示 `is_alarm=true` 的边集合；
- 时间窗视图用于展示用户选定时间窗内的边集合；
- 任务视图用于展示某个溯源任务写回的边集合。

### 1.2 时间窗输入（固定）

后端接口的时间窗字段固定为两个字段（权威口径见 `88-前端与中心机接口.md`）：

- `start_ts`：ISO 8601（UTC）
- `end_ts`：ISO 8601（UTC）

前端页面**不提供高级时间选择器**，仅保留“最近 N 分钟”的快捷方式：

1. 用户选择 `N`（分钟）；
2. 在触发“刷新图谱”或“创建溯源任务”时，前端以当前时刻 `now` 计算：
   - `end_ts = now`
   - `start_ts = now - N minutes`
3. 将计算得到的 `start_ts/end_ts` 同时用于：
   - 时间窗视图（`action="edges_in_window"`）
   - 溯源任务创建（`POST /api/v1/analysis/tasks`）

该规则用于：限制图查询返回规模、保证任务输入与图展示口径一致，并保证报告导出的可复现性。

### 1.3 请求字段固定值（固定）

为保证前端渲染所需字段完整，图查询请求固定携带：

- `allowed_reltypes=null`（不做关系类型裁剪）

时间窗视图在筛选告警边时固定使用：

- `only_alarm=true`

对应接口字段的权威口径见：`../../80-规范/88-前端与中心机接口.md`。

## 2. 渲染模型

前端图渲染使用 AntV G6（`@antv/g6`），图数据模型与样式绑定关系固定。

### 2.1 后端数据模型到 G6 的映射（固定）

后端 `graph/query` 返回：

- `nodes[]`：节点对象（含 `uid/ntype/key/props`）
- `edges[]`：边对象（含 `src_uid/dst_uid/rtype/props`）

G6 映射规则固定为：

1. G6 Node
   - `id = node.uid`
   - `data = node`（完整保留）
   - `label`：从 `node.props` 与 `node.uid` 生成（见 2.2）
2. G6 Edge
   - `source = edge.src_uid`
   - `target = edge.dst_uid`
   - `data = edge`（完整保留）
   - `id`：按固定规则生成（见 2.3）

### 2.2 节点标签生成规则（固定）

节点展示标签固定由以下规则生成（从上到下依次匹配）：

1. Host 节点：
   - `props["host.name"]` 非空则用该值
   - 否则使用 `props["host.id"]`
2. Process 节点：
   - `props["process.name"]` 非空则用该值
   - 否则使用 `props["process.entity_id"]`
3. User 节点：
   - `props["user.name"]` 非空则用该值
   - 否则使用 `props["user.id"]`
4. IP 节点：`props["ip"]`
5. Domain 节点：`props["domain.name"]`
6. File 节点：`props["file.path"]`
7. 兜底：`node.uid`

### 2.3 边 ID 生成规则（固定）

后端边对象不提供独立的稳定 ID，前端为 G6 边生成稳定 `id`，规则固定为：

1. 构造原始串：`raw = src_uid + \"|\" + rtype + \"|\" + dst_uid + \"|\" + ts_float + \"|\" + event_id`
2. 计算 `sha1(raw)` 的前 16 位
3. 拼接为：`e-<sha1_16>`

其中：

- `ts_float` 取 `edge.props["ts_float"]`（数值，秒）
- `event_id` 取 `edge.props["event.id"]`（字符串）

### 2.4 布局与交互能力（固定）

图布局固定采用有向层次布局（Dagre），参数固定：

- `rankdir="LR"`
- `nodesep=30`
- `ranksep=60`

交互能力固定启用：

- 拖动画布
- 缩放画布
- 拖动节点

## 3. 交互规则

### 3.1 选中与详情面板（固定）

用户点选节点或边后，页面固定展示详情面板：

- Node 详情：展示 `uid/ntype/key/props`（JSON 展示）
- Edge 详情：展示 `src_uid/dst_uid/rtype/props`（JSON 展示）

详情面板用于现场演示的证据解释：必须展示 `event.id` 与 `custom.evidence.event_ids[]`。

### 3.2 高亮规则（固定）

边的颜色与线型高亮规则固定：

1. 告警边高亮：当 `edge.props.is_alarm=true` 时，边样式固定为红色加粗；
2. 关键路径边高亮：当 `edge.props["analysis.is_path_edge"]=true` 时，边样式固定为蓝色加粗；
3. 普通边：灰色细线。

当同一条边同时满足 1 与 2 时，关键路径边样式覆盖告警边样式。

## 4. 任务触发与轮询

### 4.1 任务触发（固定）

溯源任务触发动作固定为：

1. 用户在时间窗视图中选中一个节点；
2. 页面使用该节点的 `uid` 作为 `target_node_uid`；
3. 使用当前页面时间窗（由“最近 N 分钟”计算得到）作为 `start_ts/end_ts`；
4. 调用 `POST /api/v1/analysis/tasks` 创建任务。

### 4.2 轮询策略（固定）

任务创建成功后页面进入轮询，轮询策略固定：

- 轮询接口：`GET /api/v1/analysis/tasks/{task_id}`
- 轮询间隔：`1s`
- 停止条件：`task.status` 为 `succeeded` 或 `failed`

### 4.3 写回边读取与渲染（固定）

当 `task.status="succeeded"` 时，页面固定执行：

1. 调用 `POST /api/v1/graph/query`，参数：
   - `action="analysis_edges_by_task"`
   - `task_id=<task_id>`
   - `only_path=true`
2. 将返回边集合叠加到当前图中并触发关键路径高亮（见 3.2）。

当 `task.status="failed"` 时，页面固定展示失败原因（后端返回的 `error.message`）。
