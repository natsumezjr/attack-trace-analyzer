# å›¾è°±å¯è§†åŒ–ä¸äº¤äº’

## æ–‡æ¡£ç›®çš„

æœ¬æ–‡ä»¶å®šä¹‰å›¾è°±å¯è§†åŒ–çš„æ¸²æŸ“æ¨¡å‹ã€ç­›é€‰ä¸é«˜äº®è§„åˆ™ã€ä»¥åŠç‚¹é€‰èŠ‚ç‚¹è§¦å‘æº¯æºä»»åŠ¡çš„äº¤äº’æµç¨‹ã€‚

## è¯»è€…å¯¹è±¡

- è´Ÿè´£å‰ç«¯å›¾å¯è§†åŒ–çš„åŒå­¦
- è´Ÿè´£åç«¯å›¾æŸ¥è¯¢æ¥å£çš„åŒå­¦

## å¼•ç”¨å…³ç³»

- å›¾æŸ¥è¯¢æ¥å£ï¼š`../../80-è§„èŒƒ/88-å‰ç«¯ä¸ä¸­å¿ƒæœºæ¥å£.md`
- å›¾è°±è§„èŒƒï¼š`../../80-è§„èŒƒ/84-Neo4jå®ä½“å›¾è°±è§„èŒƒ.md`

## 1. å›¾æŸ¥è¯¢è¯·æ±‚ä¸æ—¶é—´çª—

å›¾è°±é¡µçš„æ•°æ®æ¥æºå›ºå®šä¸ºä¸­å¿ƒæœºå›¾æŸ¥è¯¢æ¥å£ï¼š`POST /api/v1/graph/query`ã€‚

### 1.1 è§†å›¾æ¨¡å¼ï¼ˆå›ºå®šï¼‰

æº¯æºåˆ†æé¡µé¢å›ºå®šæä¾›ä¸‰ç§è§†å›¾æ¨¡å¼ï¼š

1. å‘Šè­¦è§†å›¾ï¼š`action="alarm_edges"`
2. æ—¶é—´çª—è§†å›¾ï¼š`action="edges_in_window"`
3. ä»»åŠ¡è§†å›¾ï¼š`action="analysis_edges_by_task"`

å…¶ä¸­ï¼š

- å‘Šè­¦è§†å›¾ç”¨äºå±•ç¤º `is_alarm=true` çš„è¾¹é›†åˆï¼›
- æ—¶é—´çª—è§†å›¾ç”¨äºå±•ç¤ºç”¨æˆ·é€‰å®šæ—¶é—´çª—å†…çš„è¾¹é›†åˆï¼›
- ä»»åŠ¡è§†å›¾ç”¨äºå±•ç¤ºæŸä¸ªæº¯æºä»»åŠ¡å†™å›çš„è¾¹é›†åˆã€‚

### 1.2 æ—¶é—´çª—è¾“å…¥ï¼ˆå›ºå®šï¼‰

åç«¯æ¥å£çš„æ—¶é—´çª—å­—æ®µå›ºå®šä¸ºä¸¤ä¸ªå­—æ®µï¼ˆæƒå¨å£å¾„è§ `88-å‰ç«¯ä¸ä¸­å¿ƒæœºæ¥å£.md`ï¼‰ï¼š

- `start_ts`ï¼šISO 8601ï¼ˆUTCï¼‰
- `end_ts`ï¼šISO 8601ï¼ˆUTCï¼‰

å‰ç«¯é¡µé¢**ä¸æä¾›é«˜çº§æ—¶é—´é€‰æ‹©å™¨**ï¼Œä»…ä¿ç•™"æœ€è¿‘ N åˆ†é’Ÿ"çš„å¿«æ·æ–¹å¼ï¼š

1. ç”¨æˆ·é€‰æ‹© `N`ï¼ˆåˆ†é’Ÿï¼‰ï¼›
2. åœ¨è§¦å‘"åˆ·æ–°å›¾è°±"æˆ–"åˆ›å»ºæº¯æºä»»åŠ¡"æ—¶ï¼Œå‰ç«¯ä»¥å½“å‰æ—¶åˆ» `now` è®¡ç®—ï¼š
   - `end_ts = now`
   - `start_ts = now - N minutes`
3. å°†è®¡ç®—å¾—åˆ°çš„ `start_ts/end_ts` åŒæ—¶ç”¨äºï¼š
   - æ—¶é—´çª—è§†å›¾ï¼ˆ`action="edges_in_window"`ï¼‰
   - æº¯æºä»»åŠ¡åˆ›å»ºï¼ˆ`POST /api/v1/analysis/tasks`ï¼‰

è¯¥è§„åˆ™ç”¨äºï¼šé™åˆ¶å›¾æŸ¥è¯¢è¿”å›è§„æ¨¡ã€ä¿è¯ä»»åŠ¡è¾“å…¥ä¸å›¾å±•ç¤ºå£å¾„ä¸€è‡´ï¼Œå¹¶ä¿è¯æŠ¥å‘Šå¯¼å‡ºçš„å¯å¤ç°æ€§ã€‚

**æ—¶é—´çª—è®¡ç®—ç¤ºä¾‹**ï¼š

```javascript
// æ—¶é—´çª—è®¡ç®—å‡½æ•°
function calculateTimeWindow(minutes) {
  const now = new Date();
  const endTs = now.toISOString(); // å½“å‰æ—¶é—´ UTC

  const startTime = new Date(now.getTime() - minutes * 60 * 1000);
  const startTs = startTime.toISOString(); // N åˆ†é’Ÿå‰ UTC

  return {
    start_ts: startTs,
    end_ts: endTs,
  };
}

// ä½¿ç”¨ç¤ºä¾‹
const window = calculateTimeWindow(15);
console.log(window);
// è¾“å‡ºç¤ºä¾‹ï¼š
// {
//   start_ts: "2025-01-16T10:30:00.000Z",
//   end_ts: "2025-01-16T10:45:00.000Z"
// }
```

**æ—¶é—´çª—å¿«æ·é€‰é¡¹**ï¼š

| é€‰é¡¹åç§° | æ—¶é—´èŒƒå›´ | å…¸å‹åœºæ™¯ |
|---------|---------|---------|
| æœ€è¿‘ 5 åˆ†é’Ÿ | N=5 | å®æ—¶ç›‘æ§ |
| æœ€è¿‘ 15 åˆ†é’Ÿ | N=15 | å³æ—¶åˆ†æ |
| æœ€è¿‘ 30 åˆ†é’Ÿ | N=30 | çŸ­æœŸæº¯æº |
| æœ€è¿‘ 1 å°æ—¶ | N=60 | å¸¸è§„åˆ†æ |
| æœ€è¿‘ 3 å°æ—¶ | N=180 | é•¿å‘¨æœŸæº¯æº |

### 1.3 è¯·æ±‚å­—æ®µå›ºå®šå€¼ï¼ˆå›ºå®šï¼‰

ä¸ºä¿è¯å‰ç«¯æ¸²æŸ“æ‰€éœ€å­—æ®µå®Œæ•´ï¼Œå›¾æŸ¥è¯¢è¯·æ±‚å›ºå®šæºå¸¦ï¼š

- `allowed_reltypes=null`ï¼ˆä¸åšå…³ç³»ç±»å‹è£å‰ªï¼‰

æ—¶é—´çª—è§†å›¾åœ¨ç­›é€‰å‘Šè­¦è¾¹æ—¶å›ºå®šä½¿ç”¨ï¼š

- `only_alarm=true`

å¯¹åº”æ¥å£å­—æ®µçš„æƒå¨å£å¾„è§ï¼š`../../80-è§„èŒƒ/88-å‰ç«¯ä¸ä¸­å¿ƒæœºæ¥å£.md`ã€‚

## 2. æ¸²æŸ“æ¨¡å‹

å‰ç«¯å›¾æ¸²æŸ“ä½¿ç”¨ AntV G6ï¼ˆ`@antv/g6`ï¼‰ï¼Œå›¾æ•°æ®æ¨¡å‹ä¸æ ·å¼ç»‘å®šå…³ç³»å›ºå®šã€‚

### 2.0 å›¾è°±æ¸²æŸ“æ•°æ®æµï¼ˆå›ºå®šï¼‰

```mermaid
flowchart LR
    subgraph Backend["åç«¯ API"]
        B1[Neo4j æŸ¥è¯¢]
        B2[å›¾æ•°æ®ç»„è£…]
        B3[JSON å“åº”]
    end

    subgraph Frontend["å‰ç«¯ (Next.js + G6)"]
        F1[æ¥æ”¶ nodes/edges]
        F2[èŠ‚ç‚¹æ ‡ç­¾ç”Ÿæˆ]
        F3[è¾¹ ID ç”Ÿæˆ]
        F4[G6 æ•°æ®æ˜ å°„]
        F5[Dagre å¸ƒå±€]
        F6[æ ·å¼ç»‘å®š]
        F7[å›¾è°±æ¸²æŸ“]
    end

    subgraph Data["æ•°æ®æ¨¡å‹"]
        D1["nodes: nodes æ•°ç»„<br/>uid, ntype, key, props"]
        D2["edges: edges æ•°ç»„<br/>src_uid, dst_uid, rtype, props"]
        D3["G6 èŠ‚ç‚¹<br/>id, data, label"]
        D4["G6 è¾¹<br/>source, target, id, data"]
    end

    B1 --> B2 --> B3
    B3 -->|JSON æ•°æ®| F1
    F1 --> D1
    F1 --> D2
    D1 --> F2
    D2 --> F3
    F2 --> F4
    F3 --> F4
    F4 --> D3
    F4 --> D4
    D3 --> F5
    D4 --> F5
    F5 --> F6
    F6 --> F7

    style Backend fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px
    style Frontend fill:#e0f7fa,stroke:#006064,stroke-width:2px
    style Data fill:#e3f2fd,stroke:#1565c0,stroke-width:2px
```

### 2.1 åç«¯æ•°æ®æ¨¡å‹åˆ° G6 çš„æ˜ å°„ï¼ˆå›ºå®šï¼‰

åç«¯ `graph/query` è¿”å›ï¼š

- `nodes[]`ï¼šèŠ‚ç‚¹å¯¹è±¡ï¼ˆå« `uid/ntype/key/props`ï¼‰
- `edges[]`ï¼šè¾¹å¯¹è±¡ï¼ˆå« `src_uid/dst_uid/rtype/props`ï¼‰

G6 æ˜ å°„è§„åˆ™å›ºå®šä¸ºï¼š

1. G6 Node
   - `id = node.uid`
   - `data = node`ï¼ˆå®Œæ•´ä¿ç•™ï¼‰
   - `label`ï¼šä» `node.props` ä¸ `node.uid` ç”Ÿæˆï¼ˆè§ 2.2ï¼‰
2. G6 Edge
   - `source = edge.src_uid`
   - `target = edge.dst_uid`
   - `data = edge`ï¼ˆå®Œæ•´ä¿ç•™ï¼‰
   - `id`ï¼šæŒ‰å›ºå®šè§„åˆ™ç”Ÿæˆï¼ˆè§ 2.3ï¼‰

**æ•°æ®æ˜ å°„ç¤ºä¾‹**ï¼š

| æ•°æ®å±‚çº§ | åç«¯å­—æ®µ | G6 å­—æ®µ | ç¤ºä¾‹å€¼ |
|---------|---------|---------|--------|
| **èŠ‚ç‚¹æ ‡è¯†** | `uid` | `id` | `"host-12345"` |
| **èŠ‚ç‚¹ç±»å‹** | `ntype` | `data.ntype` | `"Host"` |
| **èŠ‚ç‚¹é”®** | `key` | `data.key` | `"/proc/1234"` |
| **èŠ‚ç‚¹å±æ€§** | `props` | `data.props` | `{host.name: "web-01"}` |
| **èŠ‚ç‚¹æ ‡ç­¾** | - | `label` | `"web-01"` (ä» props ç”Ÿæˆ) |
| **è¾¹æºèŠ‚ç‚¹** | `src_uid` | `source` | `"host-12345"` |
| **è¾¹ç›®æ ‡èŠ‚ç‚¹** | `dst_uid` | `target` | `"proc-67890"` |
| **è¾¹å…³ç³»ç±»å‹** | `rtype` | `data.rtype` | `"spawned"` |
| **è¾¹å±æ€§** | `props` | `data.props` | `{is_alarm: true}` |
| **è¾¹æ ‡è¯†** | - | `id` | `"e-a3f5c9d2b1e4..."` (SHA1 ç”Ÿæˆ) |

### 2.2 èŠ‚ç‚¹æ ‡ç­¾ç”Ÿæˆè§„åˆ™ï¼ˆå›ºå®šï¼‰

èŠ‚ç‚¹å±•ç¤ºæ ‡ç­¾å›ºå®šç”±ä»¥ä¸‹è§„åˆ™ç”Ÿæˆï¼ˆä»ä¸Šåˆ°ä¸‹ä¾æ¬¡åŒ¹é…ï¼‰ï¼š

1. Host èŠ‚ç‚¹ï¼š
   - `props["host.name"]` éç©ºåˆ™ç”¨è¯¥å€¼
   - å¦åˆ™ä½¿ç”¨ `props["host.id"]`
2. Process èŠ‚ç‚¹ï¼š
   - `props["process.name"]` éç©ºåˆ™ç”¨è¯¥å€¼
   - å¦åˆ™ä½¿ç”¨ `props["process.entity_id"]`
3. User èŠ‚ç‚¹ï¼š
   - `props["user.name"]` éç©ºåˆ™ç”¨è¯¥å€¼
   - å¦åˆ™ä½¿ç”¨ `props["user.id"]`
4. IP èŠ‚ç‚¹ï¼š`props["ip"]`
5. Domain èŠ‚ç‚¹ï¼š`props["domain.name"]`
6. File èŠ‚ç‚¹ï¼š`props["file.path"]`
7. å…œåº•ï¼š`node.uid`

### 2.3 è¾¹ ID ç”Ÿæˆè§„åˆ™ï¼ˆå›ºå®šï¼‰

åç«¯è¾¹å¯¹è±¡ä¸æä¾›ç‹¬ç«‹çš„ç¨³å®š IDï¼Œå‰ç«¯ä¸º G6 è¾¹ç”Ÿæˆç¨³å®š `id`ï¼Œè§„åˆ™å›ºå®šä¸ºï¼š

1. æ„é€ åŸå§‹ä¸²ï¼š`raw = src_uid + "|" + rtype + "|" + dst_uid + "|" + ts_float + "|" + event_id`
2. è®¡ç®— `sha1(raw)` çš„å‰ 16 ä½
3. æ‹¼æ¥ä¸ºï¼š`e-<sha1_16>`

å…¶ä¸­ï¼š

- `ts_float` å– `edge.props["ts_float"]`ï¼ˆæ•°å€¼ï¼Œç§’ï¼‰
- `event_id` å– `edge.props["event.id"]`ï¼ˆå­—ç¬¦ä¸²ï¼‰

**ä»£ç ç¤ºä¾‹**ï¼š

```javascript
// ç”Ÿæˆè¾¹ IDï¼ˆå‰ç«¯å®ç°ï¼‰
function generateEdgeId(edge) {
  const raw = `${edge.src_uid}|${edge.rtype}|${edge.dst_uid}|` +
              `${edge.props["ts_float"]}|${edge.props["event.id"]}`;
  const sha1 = crypto.subtle.digest('SHA-1', raw);
  const hash16 = sha1.substring(0, 16);
  return `e-${hash16}`;
}
```

### 2.4 å¸ƒå±€ä¸äº¤äº’èƒ½åŠ›ï¼ˆå›ºå®šï¼‰

å›¾å¸ƒå±€å›ºå®šé‡‡ç”¨æœ‰å‘å±‚æ¬¡å¸ƒå±€ï¼ˆDagreï¼‰ï¼Œå‚æ•°å›ºå®šï¼š

- `rankdir="LR"`
- `nodesep=30`
- `ranksep=60`

**é…ç½®ç¤ºä¾‹**ï¼š

```javascript
// G6 å¸ƒå±€é…ç½®
const layout = {
  type: 'dagre',
  rankdir: 'LR',
  nodesep: 30,
  ranksep: 60,
};

// äº¤äº’æ¨¡å¼é…ç½®
const modes = {
  default: [
    'drag-canvas',
    'zoom-canvas',
    'drag-node',
  ],
};
```

äº¤äº’èƒ½åŠ›å›ºå®šå¯ç”¨ï¼š

- æ‹–åŠ¨ç”»å¸ƒ
- ç¼©æ”¾ç”»å¸ƒ
- æ‹–åŠ¨èŠ‚ç‚¹

## 3. äº¤äº’è§„åˆ™

### 3.1 é€‰ä¸­ä¸è¯¦æƒ…é¢æ¿ï¼ˆå›ºå®šï¼‰

ç”¨æˆ·ç‚¹é€‰èŠ‚ç‚¹æˆ–è¾¹åï¼Œé¡µé¢å›ºå®šå±•ç¤ºè¯¦æƒ…é¢æ¿ï¼š

- Node è¯¦æƒ…ï¼šå±•ç¤º `uid/ntype/key/props`ï¼ˆJSON å±•ç¤ºï¼‰
- Edge è¯¦æƒ…ï¼šå±•ç¤º `src_uid/dst_uid/rtype/props`ï¼ˆJSON å±•ç¤ºï¼‰

è¯¦æƒ…é¢æ¿ç”¨äºç°åœºæ¼”ç¤ºçš„è¯æ®è§£é‡Šï¼šå¿…é¡»å±•ç¤º `event.id` ä¸ `custom.evidence.event_ids[]`ã€‚

### 3.2 é«˜äº®è§„åˆ™ï¼ˆå›ºå®šï¼‰

è¾¹çš„é¢œè‰²ä¸çº¿å‹é«˜äº®è§„åˆ™å›ºå®šï¼š

1. å‘Šè­¦è¾¹é«˜äº®ï¼šå½“ `edge.props.is_alarm=true` æ—¶ï¼Œè¾¹æ ·å¼å›ºå®šä¸ºçº¢è‰²åŠ ç²—ï¼›
2. å…³é”®è·¯å¾„è¾¹é«˜äº®ï¼šå½“ `edge.props["analysis.is_path_edge"]=true` æ—¶ï¼Œè¾¹æ ·å¼å›ºå®šä¸ºè“è‰²åŠ ç²—ï¼›
3. æ™®é€šè¾¹ï¼šç°è‰²ç»†çº¿ã€‚

å½“åŒä¸€æ¡è¾¹åŒæ—¶æ»¡è¶³ 1 ä¸ 2 æ—¶ï¼Œå…³é”®è·¯å¾„è¾¹æ ·å¼è¦†ç›–å‘Šè­¦è¾¹æ ·å¼ã€‚

**é«˜äº®æ•ˆæœç¤ºæ„**ï¼š

| è¾¹ç±»å‹ | åˆ¤æ–­æ¡ä»¶ | æ ·å¼é…ç½® | é¢œè‰²å€¼ | çº¿å®½ |
|--------|----------|----------|--------|------|
| å‘Šè­¦è¾¹ | `is_alarm=true` | çº¢è‰²åŠ ç²— | `#ff4d4f` | 3px |
| å…³é”®è·¯å¾„è¾¹ | `analysis.is_path_edge=true` | è“è‰²åŠ ç²— | `#1890ff` | 3px |
| æ™®é€šè¾¹ | é»˜è®¤ | ç°è‰²ç»†çº¿ | `#d9d9d9` | 1px |

**ä»£ç ç¤ºä¾‹**ï¼š

```javascript
// è¾¹æ ·å¼æ˜ å°„å‡½æ•°
function getEdgeStyle(edge) {
  const props = edge.props || {};

  // ä¼˜å…ˆçº§ï¼šå…³é”®è·¯å¾„ > å‘Šè­¦ > æ™®é€š
  if (props["analysis.is_path_edge"] === true) {
    return {
      stroke: '#1890ff',
      lineWidth: 3,
      lineAppendWidth: 3,
    };
  }

  if (props.is_alarm === true) {
    return {
      stroke: '#ff4d4f',
      lineWidth: 3,
      lineAppendWidth: 3,
    };
  }

  // æ™®é€šè¾¹
  return {
    stroke: '#d9d9d9',
    lineWidth: 1,
    lineAppendWidth: 1,
  };
}
```

**æ ·å¼ä¼˜å…ˆçº§æµç¨‹å›¾**ï¼š

```mermaid
flowchart TD
    Start([æ£€æŸ¥è¾¹å±æ€§]) --> Check1{analysis.is_path_edge ä¸º true?}
    Check1 -->|æ˜¯| PathStyle[åº”ç”¨å…³é”®è·¯å¾„æ ·å¼<br/>é¢œè‰²: #1890ff<br/>çº¿å®½: 3px]
    Check1 -->|å¦| Check2{is_alarm ä¸º true?}
    Check2 -->|æ˜¯| AlarmStyle[åº”ç”¨å‘Šè­¦æ ·å¼<br/>é¢œè‰²: #ff4d4f<br/>çº¿å®½: 3px]
    Check2 -->|å¦| DefaultStyle[åº”ç”¨æ™®é€šæ ·å¼<br/>é¢œè‰²: #d9d9d9<br/>çº¿å®½: 1px]
    PathStyle --> End([æ¸²æŸ“è¾¹])
    AlarmStyle --> End
    DefaultStyle --> End

    style Start fill:#e0f7fa,stroke:#006064
    style Check1 fill:#fff9c4,stroke:#f57f17
    style Check2 fill:#fff9c4,stroke:#f57f17
    style PathStyle fill:#e3f2fd,stroke:#1565c0
    style AlarmStyle fill:#ffebee,stroke:#c62828
    style DefaultStyle fill:#f5f5f5,stroke:#616161
    style End fill:#e0f7fa,stroke:#006064
```

## 4. ä»»åŠ¡è§¦å‘ä¸è½®è¯¢

### 4.0 äº¤äº’æµç¨‹å›¾ï¼ˆå®Œæ•´é—­ç¯ï¼‰

```mermaid
sequenceDiagram
    autonumber
    participant User as ğŸ‘¤ ç”¨æˆ·
    participant Frontend as ğŸ’» å‰ç«¯ (Next.js + G6)
    participant Backend as âš™ï¸ åç«¯ API
    participant Neo4j as ğŸ—„ï¸ Neo4j
    participant OpenSearch as ğŸ“Š OpenSearch

    rect rgb(224, 247, 250)
        Note over User,OpenSearch: ğŸ“ˆ é˜¶æ®µ 1: å›¾è°±åŠ è½½ä¸åˆå§‹åŒ–
        User->>Frontend: 1. é€‰æ‹©æ—¶é—´çª— N åˆ†é’Ÿ
        Frontend->>Frontend: 2. è®¡ç®— start_ts/end_ts<br/>end_ts = now<br/>start_ts = now - N minutes
        User->>Frontend: 3. ç‚¹å‡»"åˆ·æ–°å›¾è°±"
        Frontend->>Backend: 4. POST /api/v1/graph/query<br/>action=edges_in_window<br/>start_ts, end_ts
        Backend->>Neo4j: 5. æŸ¥è¯¢æ—¶é—´çª—å†…çš„è¾¹æ•°æ®
        Neo4j-->>Backend: 6. è¿”å› nodes[] ä¸ edges[]
        Backend-->>Frontend: 7. è¿”å› JSON æ ¼å¼å›¾æ•°æ®
        Frontend->>Frontend: 8. æ‰§è¡Œ G6 æ•°æ®æ˜ å°„ä¸å¸ƒå±€
        Frontend->>Frontend: 9. åº”ç”¨èŠ‚ç‚¹æ ‡ç­¾ä¸è¾¹æ ·å¼
        Frontend-->>User: 10. æ˜¾ç¤ºäº¤äº’å¼å›¾è°±
    end

    rect rgb(232, 245, 233)
        Note over User,OpenSearch: ğŸ¯ é˜¶æ®µ 2: åˆ›å»ºæº¯æºä»»åŠ¡
        User->>Frontend: 11. ç‚¹é€‰ç›®æ ‡èŠ‚ç‚¹
        Frontend->>Frontend: 12. è·å– node.uid ä½œä¸º target
        Frontend->>Backend: 13. POST /api/v1/analysis/tasks<br/>target_node_uid, time_window
        Backend->>Backend: 14. ç”Ÿæˆå”¯ä¸€ task_id
        Backend->>OpenSearch: 15. åˆ›å»ºä»»åŠ¡æ–‡æ¡£<br/>status: "queued"
        OpenSearch-->>Backend: 16. ç¡®è®¤ä»»åŠ¡å·²åˆ›å»º
        Backend-->>Frontend: 17. è¿”å› task_id
        Frontend->>Frontend: 18. å¯åŠ¨è½®è¯¢å®šæ—¶å™¨ (1s)
        Frontend-->>User: 19. æ˜¾ç¤º task_id ä¸çŠ¶æ€
    end

    rect rgb(227, 242, 253)
        Note over User,OpenSearch: â³ é˜¶æ®µ 3: è½®è¯¢ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€
        loop æ¯ 1 ç§’è½®è¯¢ä¸€æ¬¡
            Frontend->>Backend: GET /api/v1/analysis/tasks/{task_id}
            Backend->>OpenSearch: 20. è¯»å–ä»»åŠ¡çŠ¶æ€
            OpenSearch-->>Backend: 21. è¿”å› status å­—æ®µ
            alt status == "running"
                Backend->>Backend: 22. æ‰§è¡Œæº¯æºç®—æ³•
                Backend->>Neo4j: 23. è¯»å–ç›®æ ‡å­å›¾
                Neo4j-->>Backend: 24. è¿”å›å­å›¾èŠ‚ç‚¹ä¸è¾¹
                Backend->>Backend: 25. è®¡ç®—å…³é”®è·¯å¾„
                Backend->>Neo4j: 26. å†™å›è¾¹å±æ€§<br/>analysis.is_path_edge=true<br/>analysis.path_score=X
                Backend->>OpenSearch: 27. æ›´æ–°è¿›åº¦ (5-95%)
                Backend-->>Frontend: 28. è¿”å›è¿›åº¦ç™¾åˆ†æ¯”
                Frontend->>Frontend: 29. æ›´æ–°è¿›åº¦æ¡ UI
            else status == "queued"
                Backend-->>Frontend: 30. è¿”å›ç­‰å¾…çŠ¶æ€ (0%)
                Frontend->>Frontend: 31. ç»§ç»­ç­‰å¾…
            end
        end
    end

    rect rgb(255, 243, 224)
        Note over User,OpenSearch: âœ… é˜¶æ®µ 4: è·å–ç»“æœå¹¶é«˜äº®æ˜¾ç¤º
        Backend->>OpenSearch: 32. æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸º "succeeded"
        Backend-->>Frontend: 33. è¿”å›å®ŒæˆçŠ¶æ€ (100%)
        Frontend->>Frontend: 34. åœæ­¢è½®è¯¢å®šæ—¶å™¨
        Frontend->>Backend: 35. POST /api/v1/graph/query<br/>action=analysis_edges_by_task<br/>task_id, only_path=true
        Backend->>Neo4j: 36. æŸ¥è¯¢å†™å›çš„å…³é”®è·¯å¾„è¾¹
        Neo4j-->>Backend: 37. è¿”å›å¸¦ analysis.* å±æ€§çš„è¾¹
        Backend-->>Frontend: 38. è¿”å›è¾¹æ•°æ®é›†åˆ
        Frontend->>Frontend: 39. å åŠ è¾¹åˆ°å½“å‰å›¾è°±
        Frontend->>Frontend: 40. åº”ç”¨å…³é”®è·¯å¾„é«˜äº®æ ·å¼<br/>è“è‰²åŠ ç²— (#1890ff, 3px)
        Frontend-->>User: 41. æ˜¾ç¤ºå®Œæ•´æº¯æºç»“æœ
    end

    rect rgb(255, 235, 238)
        Note over User,OpenSearch: âš ï¸ å¼‚å¸¸å¤„ç†åˆ†æ”¯
        alt status == "failed"
            Backend-->>Frontend: è¿”å› error.message
            Frontend->>Frontend: åœæ­¢è½®è¯¢å®šæ—¶å™¨
            Frontend-->>User: æ˜¾ç¤ºå¤±è´¥åŸå› ä¸é”™è¯¯ä¿¡æ¯
        end
    end
```

### 4.1 ä»»åŠ¡è§¦å‘ï¼ˆå›ºå®šï¼‰

æº¯æºä»»åŠ¡è§¦å‘åŠ¨ä½œå›ºå®šä¸ºï¼š

1. ç”¨æˆ·åœ¨æ—¶é—´çª—è§†å›¾ä¸­é€‰ä¸­ä¸€ä¸ªèŠ‚ç‚¹ï¼›
2. é¡µé¢ä½¿ç”¨è¯¥èŠ‚ç‚¹çš„ `uid` ä½œä¸º `target_node_uid`ï¼›
3. ä½¿ç”¨å½“å‰é¡µé¢æ—¶é—´çª—ï¼ˆç”±â€œæœ€è¿‘ N åˆ†é’Ÿâ€è®¡ç®—å¾—åˆ°ï¼‰ä½œä¸º `start_ts/end_ts`ï¼›
4. è°ƒç”¨ `POST /api/v1/analysis/tasks` åˆ›å»ºä»»åŠ¡ã€‚

### 4.2 è½®è¯¢ç­–ç•¥ï¼ˆå›ºå®šï¼‰

ä»»åŠ¡åˆ›å»ºæˆåŠŸåé¡µé¢è¿›å…¥è½®è¯¢ï¼Œè½®è¯¢ç­–ç•¥å›ºå®šï¼š

- è½®è¯¢æ¥å£ï¼š`GET /api/v1/analysis/tasks/{task_id}`
- è½®è¯¢é—´éš”ï¼š`1s`
- åœæ­¢æ¡ä»¶ï¼š`task.status` ä¸º `succeeded` æˆ– `failed`

**è½®è¯¢çŠ¶æ€æœº**ï¼š

| ä»»åŠ¡çŠ¶æ€ | å«ä¹‰ | å‰ç«¯è¡Œä¸º | åç»­åŠ¨ä½œ |
|---------|------|---------|---------|
| `queued` | ä»»åŠ¡å·²åˆ›å»ºï¼Œç­‰å¾…æ‰§è¡Œ | æ˜¾ç¤º"ç­‰å¾…ä¸­" (0%) | ç»§ç»­è½®è¯¢ |
| `running` | ä»»åŠ¡æ‰§è¡Œä¸­ | æ˜¾ç¤ºè¿›åº¦æ¡ (5-95%) | ç»§ç»­è½®è¯¢ |
| `succeeded` | ä»»åŠ¡æˆåŠŸå®Œæˆ | åœæ­¢è½®è¯¢ï¼Œæ˜¾ç¤ºæˆåŠŸ | æŸ¥è¯¢å†™å›è¾¹å¹¶é«˜äº® |
| `failed` | ä»»åŠ¡å¤±è´¥ | åœæ­¢è½®è¯¢ï¼Œæ˜¾ç¤ºé”™è¯¯ | å±•ç¤º error.message |

**è½®è¯¢å®ç°ç¤ºä¾‹**ï¼š

```javascript
// å‰ç«¯è½®è¯¢å®ç°
async function pollTaskStatus(taskId) {
  const pollInterval = 1000; // 1s
  let shouldStop = false;

  const timer = setInterval(async () => {
    try {
      const response = await fetch(`/api/v1/analysis/tasks/${taskId}`);
      const task = await response.json();

      // æ›´æ–°è¿›åº¦ UI
      updateProgressBar(task.progress);

      // æ£€æŸ¥ç»ˆæ­¢æ¡ä»¶
      if (task.status === 'succeeded') {
        clearInterval(timer);
        await loadAnalysisEdges(taskId);
        highlightCriticalPath();
      } else if (task.status === 'failed') {
        clearInterval(timer);
        showErrorMessage(task.error?.message || 'ä»»åŠ¡å¤±è´¥');
      }
    } catch (error) {
      clearInterval(timer);
      showErrorMessage('ç½‘ç»œè¯·æ±‚å¤±è´¥');
    }
  }, pollInterval);
}
```

### 4.3 å†™å›è¾¹è¯»å–ä¸æ¸²æŸ“ï¼ˆå›ºå®šï¼‰

å½“ `task.status="succeeded"` æ—¶ï¼Œé¡µé¢å›ºå®šæ‰§è¡Œï¼š

1. è°ƒç”¨ `POST /api/v1/graph/query`ï¼Œå‚æ•°ï¼š
   - `action="analysis_edges_by_task"`
   - `task_id=<task_id>`
   - `only_path=true`
2. å°†è¿”å›è¾¹é›†åˆå åŠ åˆ°å½“å‰å›¾ä¸­å¹¶è§¦å‘å…³é”®è·¯å¾„é«˜äº®ï¼ˆè§ 3.2ï¼‰ã€‚

å½“ `task.status="failed"` æ—¶ï¼Œé¡µé¢å›ºå®šå±•ç¤ºå¤±è´¥åŸå› ï¼ˆåç«¯è¿”å›çš„ `error.message`ï¼‰ã€‚

**API å“åº”ç¤ºä¾‹**ï¼š

```json
// POST /api/v1/graph/query
// action=analysis_edges_by_task
{
  "nodes": [
    {
      "uid": "host-1921681110",
      "ntype": "Host",
      "key": null,
      "props": {
        "host.name": "web-01",
        "host.id": "192.168.1.110"
      }
    },
    {
      "uid": "proc-12345",
      "ntype": "Process",
      "key": "/proc/12345",
      "props": {
        "process.name": "nginx",
        "process.pid": 12345,
        "process.entity_id": "abcdef123456"
      }
    }
  ],
  "edges": [
    {
      "src_uid": "host-1921681110",
      "dst_uid": "proc-12345",
      "rtype": "spawned",
      "props": {
        "ts_float": 1737033600.123,
        "event.id": "event-67890",
        "is_alarm": false,
        "analysis.is_path_edge": true,
        "analysis.path_score": 0.95,
        "analysis.path_position": 3
      }
    }
  ]
}
```
