# 客户端 ↔ 中心机：注册与数据拉取接口规范（v1）

> 本文定义 **客户端后端（Client Backend）** 与 **中心机后端（Center Backend / Next.js）** 的交互协议：  
> - 客户端启动后 **主动向中心机注册**  
> - 注册成功后，中心机 **轮询客户端** 拉取数据（Telemetry/Findings）  
>
> 字段规范（ECS 子集 + `custom.*`）见：`docs/03A-ECS字段规范.md`  
> 存储与图谱设计（OpenSearch + Neo4j）见：`docs/03B-存储与图谱设计.md`

---

## 1. 背景与目标

### 1.1 为什么是“注册 + 轮询”

课程靶场通常是“多节点、短周期、网络环境不稳定”的形态。采用 **客户端注册 + 中心轮询**，好处是：

- 中心机掌握“有哪些客户端在线、各自能力是什么”（注册表）
- 轮询天然具备“背压”：中心机慢时拉取变慢，客户端只需本地缓冲
- 客户端无需对中心机做持续推送，降低实现复杂度（MVP 友好）

### 1.2 本接口覆盖什么

- 客户端向中心机注册（登记：客户端 ID、地址、能力、版本等）
- 中心机向客户端拉取事件（ECS Telemetry + Findings）
- 最小安全机制（token）与幂等性/去重建议

不覆盖（v1 不做）：

- 复杂鉴权/多租户/证书分发
- 双向流式传输（WebSocket/gRPC）
- 远程下发采集/规则配置（可作为 v2 扩展）

---

## 2. 角色与组件边界

### 2.1 客户端（Client Backend）

每个靶场节点（或关键节点）部署一个客户端后端进程，职责：

- 从 3 个采集组件获取数据（本项目只用这些）：
  - **Wazuh**：主机日志（hostlog.*）
  - **Falco**：主机行为告警（hostbehavior.*）
  - **Suricata**：网络流量与告警（netflow.* + alert）
- 将原始事件映射为 ECS 子集字段（见 `docs/03A-ECS字段规范.md`）
- 本地缓冲（队列/文件/SQLite 均可，MVP 不强制实现方式）
- 对外提供 HTTP API，供中心机轮询拉取

### 2.2 中心机（Center Backend / Next.js）

中心机后端由 **Next.js 全栈**承担（API + 页面），职责：

- 接收客户端注册并维护注册表
- 定时轮询客户端拉取事件/告警
- 写入 OpenSearch（Telemetry/Findings/Chains 等索引）
- 写入 Neo4j（实体关系图）
- 触发关联算法/攻击链构建，并提供查询与可视化页面

---

## 3. 约定（必读）

### 3.1 命名与版本

- API 版本：`v1`（体现在路径 `/api/v1/...`）
- 内容类型：`Content-Type: application/json; charset=utf-8`

### 3.2 标识与幂等

- **客户端唯一标识**：`client_id`（字符串，稳定不变）
- **事件唯一标识**：`event.id`（Telemetry/Finding 都必须有）
- 中心机入库去重建议：以 `event.id` 为幂等键（同一事件重复拉取不应产生重复入库）

### 3.3 安全（MVP）

- 注册成功后，中心机下发 `client_token`（Bearer token）
- 中心机轮询客户端时必须携带：
  - `Authorization: Bearer <client_token>`
- 如靶场网络允许，建议使用 HTTPS；若不便，至少在内网隔离环境运行

---

## 4. 接口定义

> 说明：路径写的是“建议”，实现可按你们 Next.js/客户端框架调整，但语义保持一致。

### 4.1 客户端 → 中心机：注册

**POST** `/api/v1/clients/register`（中心机提供）

#### Request Body

```json
{
  "client_id": "client-victim-01",
  "client_version": "0.1.0",
  "listen_url": "http://10.0.0.11:18080",
  "host": { "id": "h-aaa", "name": "victim-01" },
  "capabilities": {
    "wazuh": true,
    "falco": true,
    "suricata": true
  }
}
```

字段说明：

- `client_id`：稳定唯一（建议由部署脚本生成并落盘）
- `listen_url`：中心机可访问的客户端地址（含端口）
- `host.*`：用于展示/筛选的主机信息（与 ECS host 对齐）
- `capabilities`：便于中心机展示“该客户端能提供哪些数据源”

#### Response（200）

```json
{
  "status": "ok",
  "client_token": "token-xxxx",
  "poll_interval_seconds": 5,
  "server_time": "2026-01-12T12:00:00Z"
}
```

#### 幂等性

同一 `client_id` 重复注册应返回同一个逻辑客户端（可更新 `listen_url` / `client_version` / `capabilities`），不应创建重复记录。

---

### 4.2 中心机 → 客户端：健康检查（可选但建议）

**GET** `/api/v1/health`（客户端提供）

Response 示例：

```json
{
  "status": "ok",
  "client_id": "client-victim-01",
  "time": "2026-01-12T12:00:01Z"
}
```

---

### 4.3 中心机 → 客户端：拉取事件（核心接口）

**POST** `/api/v1/pull`（客户端提供）

Headers：

- `Authorization: Bearer <client_token>`

#### Request Body

```json
{
  "cursor": "0",
  "limit": 500,
  "want": {
    "event_kinds": ["event", "alert"],
    "datasets": ["hostlog.*", "hostbehavior.*", "netflow.*", "finding.*"]
  }
}
```

说明：

- `cursor`：中心机保存的“上次拉取位置”（字符串即可，方便你们实现）
  - 例如：本地队列 offset、SQLite 自增 id、文件行号等
- `limit`：分页大小（建议 200–2000，按靶场规模调）
- `want.*`：中心机声明想要的数据范围（MVP 可忽略 filters，全部返回也可以）

#### Response（200）

```json
{
  "status": "ok",
  "items": [
    {
      "ecs": { "version": "9.2.0" },
      "@timestamp": "2026-01-12T03:21:10.123Z",
      "event": {
        "id": "evt-1b2c3d",
        "kind": "event",
        "created": "2026-01-12T03:21:12.001Z",
        "ingested": "2026-01-12T03:21:12.900Z",
        "category": ["authentication"],
        "type": ["start"],
        "action": "user_login",
        "dataset": "hostlog.auth",
        "outcome": "success"
      },
      "host": { "id": "h-aaa", "name": "victim-01" },
      "user": { "name": "alice" },
      "source": { "ip": "10.0.0.8" },
      "session": { "id": "sess-xyz" },
      "agent": { "name": "wazuh-agent", "version": "4.0.0" }
    }
  ],
  "next_cursor": "500",
  "has_more": true,
  "server_time": "2026-01-12T12:00:02Z"
}
```

#### 语义与实现建议

- **去重**：中心机按 `event.id` 去重（幂等）；客户端也可保证游标推进后不重复输出
- **ACK**：
  - v1 简化：不做 ACK 接口；中心机保存 `next_cursor` 即认为消费成功
  - 若担心中心机拉取成功但入库失败，可在中心机只在“入库成功后”推进 cursor

---

### 4.4 错误响应（统一格式）

```json
{
  "status": "error",
  "error": {
    "code": "UNAUTHORIZED",
    "message": "missing or invalid token"
  }
}
```

建议错误码：

- `UNAUTHORIZED`：token 缺失/无效
- `BAD_REQUEST`：参数错误
- `INTERNAL_ERROR`：客户端内部异常

---

## 5. 数据分类建议（用于后续入库路由）

客户端输出的文档以 `event.kind` + `event.dataset` 作为路由依据：

- `event.kind="event"` → OpenSearch `ecs-events-*`（Telemetry）
- `event.kind="alert"` → OpenSearch `raw-findings-*`（Raw Findings）
- 中心机融合去重后产出 → OpenSearch `canonical-findings-*`

> 具体索引划分见 `docs/03B-存储与图谱设计.md`。

---

## 6. 轮询策略（中心机侧）

建议中心机对每个客户端维护以下状态（可存在 OpenSearch/关系表/内存均可）：

- `client_id`
- `listen_url`
- `client_token`（或其哈希）
- `last_seen`（最后成功拉取时间）
- `cursor`（当前消费位置）

轮询建议：

- `poll_interval_seconds` 默认为 5–15 秒（课程演示优先“实时可见”）
- 多客户端时做抖动（jitter），避免同时打到中心机

