# C2部署与证据点

本文件定义 C2（DNS+HTTP）在靶场中的固定部署方式与固定证据生成方式，用于稳定生成 DNS 与 HTTP 两类网络证据，并可在宿主机抓包验收。

## 1. 固定约定

本项目靶场对 C2 的固定约定如下：

- Docker macvlan 网络：`c2-macvlan`
- C2 DNS IP：`10.92.35.50`
- C2 HTTP IP：`10.92.35.51`
- C2 域名：`c2.lab.local`（固定解析到 `10.92.35.51`）
- HTTP 路径：
  - `http://10.92.35.51/health`
  - `http://10.92.35.51/payload`

## 2. macvlan 前置条件（必须满足）

- 宿主机内网网卡：`ens5f1`
- 内网网段：`10.92.35.0/24`
- C2 IP `10.92.35.50` 与 `10.92.35.51` 未被占用

## 3. 创建 Docker macvlan 网络（固定命令）

在宿主机执行：

```bash
sudo docker network create -d macvlan \
  --subnet=10.92.35.0/24 \
  --gateway=10.92.35.254 \
  -o parent=ens5f1 \
  c2-macvlan
```

## 4. 宿主机创建 macvlan0 并添加路由（固定命令）

macvlan 的默认行为会导致宿主机无法直接访问 macvlan 容器 IP。本项目固定通过创建宿主机 `macvlan0` 并添加两条 `/32` 路由解决该问题。

宿主机 `macvlan0` 的 IP 固定为 `10.92.35.60/24`：

```bash
sudo ip link add macvlan0 link ens5f1 type macvlan mode bridge
sudo ip addr add 10.92.35.60/24 dev macvlan0
sudo ip link set macvlan0 up

sudo ip route add 10.92.35.50/32 dev macvlan0 || true
sudo ip route add 10.92.35.51/32 dev macvlan0 || true
```

## 5. 准备 C2 配置与静态内容（固定命令）

本项目固定将 C2 的配置与静态文件放在：`$BASE/run/c2/`。

仓库内同时包含 `scripts/靶场编排/c2_config/` 目录，其内容用于保存 C2 的配置文件模板。靶场运行命令以本文第 6 节为准。

```bash
export BASE=/home/ubuntu/attack-trace-analyzer
mkdir -p "$BASE"/run/c2/html
```

CoreDNS 配置文件固定为：`$BASE/run/c2/Corefile`

```bash
cat > "$BASE"/run/c2/Corefile <<'EOF'
.:53 {
  log
  errors
  hosts /etc/coredns/hosts {
    reload 1s
    fallthrough
  }
  forward . 223.5.5.5 114.114.114.114
}
EOF
```

hosts 记录固定为：`$BASE/run/c2/hosts`

```bash
cat > "$BASE"/run/c2/hosts <<'EOF'
10.92.35.51 c2.lab.local
EOF
```

HTTP 静态内容固定为两个文件：

- `$BASE/run/c2/html/health`
- `$BASE/run/c2/html/payload`

```bash
printf "ok\n" > "$BASE"/run/c2/html/health
printf "hello from c2 (benign)\n" > "$BASE"/run/c2/html/payload
```

## 6. 启动 C2（固定命令）

本项目固定启动两个容器：

- `c2-dns`：CoreDNS（IP=10.92.35.50）
- `c2-http`：Nginx（IP=10.92.35.51）

```bash
docker rm -f c2-dns c2-http || true

docker run -d --name c2-dns \
  --network c2-macvlan --ip 10.92.35.50 \
  -v "$BASE"/run/c2/Corefile:/etc/coredns/Corefile:ro \
  -v "$BASE"/run/c2/hosts:/etc/coredns/hosts:ro \
  coredns/coredns:latest

docker run -d --name c2-http \
  --network c2-macvlan --ip 10.92.35.51 \
  -v "$BASE"/run/c2/html:/usr/share/nginx/html:ro \
  nginx:latest
```

## 7. 验证 C2（固定命令 + 固定预期）

### 7.1 DNS 验证

```bash
dig @10.92.35.50 c2.lab.local +short
```

预期输出固定为：

```
10.92.35.51
```

### 7.2 HTTP 验证

```bash
curl -s http://10.92.35.51/health && echo
curl -s http://10.92.35.51/payload && echo
```

预期输出固定包含：

- `ok`
- `hello from c2 (benign)`

### 7.3 抓包验收（固定）

```bash
sudo timeout 3 tcpdump -i macvlan0 -nn '(host 10.92.35.50 and (udp port 53 or tcp port 53)) or (host 10.92.35.51 and tcp port 80)' &
sleep 0.2
dig @10.92.35.50 c2.lab.local +noall +answer +time=1 +tries=1
curl -s http://10.92.35.51/health && echo
wait
```

## 8. 证据点（固定生成方式）

执行第 7 节的 DNS 与 HTTP 命令会固定产生：

- DNS 查询：`10.92.35.13 -> 10.92.35.50:53`（包含 `c2.lab.local`）
- HTTP 访问：`10.92.35.13 -> 10.92.35.51:80`（包含 `/health`、`/payload`）

这些证据的验证步骤见：

- `94-验证清单.md`
