# 靶场部署

本文件定义课程演示靶场的固定拓扑、固定地址规划、固定端口规划与固定数据目录规划。

靶场在单机条件下提供 **≥5 个逻辑节点**，用于满足课程验收中的“多节点”口径。

## 1. 固定拓扑（6 节点）

本项目靶场固定由以下 6 个节点构成，全部部署在同一台内网 Linux 宿主机 `10.92.35.13` 上：

| 节点 | 数量 | 部署形态 | 作用 |
|---|---:|---|---|
| `center-01` | 1 | OpenSearch+Neo4j 为 Docker Compose；后端与前端为宿主进程 | 数据入库、检测融合、图查询与任务执行、前端展示 |
| `client-01..04` | 4 | 每个实例一套 Docker Compose | Falco/Filebeat/Suricata 采集 → RabbitMQ 队列缓冲 → Client API 拉取 |
| `c2-01` | 1 | Docker macvlan + docker run | CoreDNS + Nginx，提供 DNS+HTTP，用于产生稳定可观测的网络证据 |

## 2. 固定地址与网卡规划

靶场网络口径固定为：

- 宿主机内网 IP：`10.92.35.13`
- 宿主机物理网卡：`ens5f1`
- 宿主机 macvlan 子接口：`macvlan0`（宿主 IP 固定为 `10.92.35.60/24`）
- C2 DNS IP：`10.92.35.50`
- C2 HTTP IP：`10.92.35.51`
- C2 域名：`c2.lab.local`（固定解析到 `10.92.35.51`）

> 说明：C2 使用 macvlan 的目标是让 DNS/HTTP 访问具备可观测的二层链路，并能在宿主机 `macvlan0` 上稳定抓包验收。

## 3. 固定端口规划

### 3.1 中心机端口（宿主机）

- OpenSearch：`9200/tcp`、`9600/tcp`
- Neo4j：`7474/tcp`、`7687/tcp`
- 后端 API：`8001/tcp`
- 前端：`3000/tcp`

### 3.2 客户机端口（宿主机）

客户机对宿主机暴露的端口固定为 4 个 Client API 端口（容器内端口为 8888）：

| 实例 | 宿主端口 | 说明 |
|---|---:|---|
| `client-01` | `18881/tcp` | `GET /filebeat`、`GET /falco`、`GET /suricata` |
| `client-02` | `18882/tcp` | 同上 |
| `client-03` | `18883/tcp` | 同上 |
| `client-04` | `18884/tcp` | 同上 |

RabbitMQ 端口固定只在容器网络内部使用：

- AMQP：`5672/tcp`
- 管理端口：`15672/tcp`

### 3.3 C2 端口（C2 独立 IP）

由于 C2 拥有独立 IP，不做宿主端口映射，端口固定为：

- DNS：`10.92.35.50:53/udp`、`10.92.35.50:53/tcp`
- HTTP：`10.92.35.51:80/tcp`

## 4. 固定数据目录

靶场运行产生的数据固定落在以下位置：

- 统一根目录：`$BASE=/home/ubuntu/attack-trace-analyzer`
- 代码目录：`$BASE/repo/attack-trace-analyzer/`
- 运行目录：`$BASE/run/`
  - `client-01/`、`client-02/`、`client-03/`、`client-04/`
    - `docker-compose.yml`：客户机运行编排
    - `.env`：该实例的端口与 Host 标识
    - `sensor`、`backend`：指向仓库 `client/` 的软链接，用于 compose 构建
    - `data/`：采集输出（`falco.jsonl`、`eve.json` 等）
  - `c2/`：C2 配置与静态页面（见 `93-C2部署与证据点.md`）
- OpenSearch/Neo4j 持久化：Docker named volumes（由 `backend/docker-compose.yml` 创建）

重置与清理步骤见：

- `95-重置复现与排障.md`

## 5. 下一步

一键启动/停止与启动顺序见：

- `92-一键编排.md`
