# 单机靶场落地步骤

本文面向靶场负责人，给出在单台内网 Linux 主机上落地 **≥5 节点靶场**的固定步骤，确保可部署、可复现、可观测。

本文只覆盖靶场底座与采集链路。中心机业务接口与算法接线不影响本文目标达成。

## 0. 前置：连接服务器

如果你使用WSL环境，需要先连接到服务器。详细步骤见：

- `98-WSL连接服务器指南.md`

连接成功后，在服务器上继续执行本文后续步骤。

## 1. 固定目标状态

靶场最终应达到以下状态：

- 节点：`center-01` + `client-01..04` + `c2-01`
- 端口：`91-靶场部署.md` 的端口规划全部可达
- 采集：`94-验证清单.md` 中 4 个 client 的三接口可返回 `total`
- 证据：对 `c2.lab.local` 发起 DNS 与 HTTP 请求后，`macvlan0` 抓包可见 53 与 80 流量

## 2. 宿主机条件检查

在宿主机执行：

```bash
ip -br a
ip route
docker --version
docker-compose --version
```

网卡口径固定为：

- 物理网卡：`ens5f1`
- C2 抓包网卡：`macvlan0`

## 3. 目录规划与变量

本文使用固定根目录：

```bash
export BASE=/home/ubuntu/attack-trace-analyzer
export REPO="$BASE"/repo/attack-trace-analyzer
```

准备目录：

```bash
mkdir -p "$BASE"/{repo,run}
```

## 4. 部署中心机基础设施

在仓库目录执行：

```bash
cd "$REPO"/backend
docker-compose up -d
```

验证端口监听：

```bash
ss -lntup | egrep ':(9200|9600|7474|7687)\\b' || true
```

验证 OpenSearch：

```bash
curl -k -s https://10.92.35.13:9200 >/dev/null && echo "opensearch ok"
```

## 5. 部署 c2-01

按 `93-C2部署与证据点.md` 的第 3 节到第 7 节依次执行，完成：

1. 创建 Docker macvlan 网络 `c2-macvlan`
2. 创建宿主机 `macvlan0` 并添加两条 `/32` 路由
3. 启动 `c2-dns` 与 `c2-http`
4. 完成 DNS、HTTP 与抓包验收

## 6. 部署 4 套 client（单机多实例）

按 `92-一键编排.md` 的第 2.3 节依次执行，完成：

1. 创建 `run/client-01..04` 目录
2. 放置每个实例的 `docker-compose.yml` 与 `sensor`、`backend` 软链接
3. 写入每个实例的 `.env`（端口与 Host 标识）
4. 启动 4 套实例

验证（以 client-01 为例）：

```bash
curl -s http://10.92.35.13:18881/filebeat | head
curl -s http://10.92.35.13:18881/falco | head
curl -s http://10.92.35.13:18881/suricata | head
```

## 7. 做一次证据动作闭环验收

在宿主机执行：

```bash
dig @10.92.35.50 c2.lab.local +noall +answer +time=1 +tries=1
curl -s http://10.92.35.51/health && echo
```

然后按 `94-验证清单.md` 依次完成：

1. 网络端口检查
2. 4 个 client 的三接口产数检查
3. 中心机注册表与检索接口检查

## 8. 重置与复现

演示前重置与排障入口为：

- `95-重置复现与排障.md`
