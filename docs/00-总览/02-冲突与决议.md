# 冲突与决议

本文件用于记录并闭环处理以下冲突：

- 文档与文档之间的口径不一致
- 文档与代码实现之间的口径不一致
- 代码与实际运行行为之间的口径不一致

本项目正文不允许同时保留两种口径。任何冲突必须在此处记录，并给出明确决议与生效范围。

## 1. 记录模板

每条冲突按如下模板记录：

- 编号：CONFLICT-0001
- 发现日期：YYYY-MM-DD
- 冲突主题：一句话概括
- 冲突来源：
  - 文档：相对路径
  - 代码：相对路径
  - 运行行为：复现步骤与证据
- 现状描述：
  - 口径 A：
  - 口径 B：
- 影响范围：会影响哪些报告、接口、数据结构、演示脚本、测试用例
- 决议：唯一生效口径
- 执行动作：需要修改哪些文档/代码/脚本
- 状态：open / decided / fixed

## 2. 冲突列表

- 编号：CONFLICT-0001
  - 发现日期：2026-01-15
  - 冲突主题：报告导出中 TTP 相似度的数据来源口径不一致
  - 冲突来源：
    - 文档：`docs/50-详细设计/前端/76-报告导出.md`（2.4 要求固定调用接口） vs `docs/50-详细设计/前端/74-总体与页面结构.md`（3.2 要求优先读任务文档并可回落调用接口）
    - 代码：`backend/app/services/analyze/pipeline.py`（任务执行时写入 `task.result.ttp_similarity.*`）+ `frontend/app/trace/page.tsx`（展示时读取 `task.result.ttp_similarity.*`）
  - 现状描述：
    - 口径 A：导出固定调用 `POST /api/v1/analysis/ttp-similarity`
    - 口径 B：导出优先读取任务文档 `task.result.ttp_similarity.*`，必要时回落调用接口
  - 影响范围：前端导出实现、答辩演示口径、验收用例 AC-07/AC-08 的结果一致性
  - 决议：导出 **优先读任务文档**，仅在任务文档缺失结果时回落调用 `POST /api/v1/analysis/ttp-similarity`
  - 执行动作：更新 `docs/50-详细设计/前端/76-报告导出.md` 的 2.4 小节；导出实现按该决议执行
  - 状态：fixed

- 编号：CONFLICT-0002
  - 发现日期：2026-01-15
  - 冲突主题：报告导出文档中存在 `include_nodes=true` 参数，但接口与实现不支持
  - 冲突来源：
    - 文档：`docs/50-详细设计/前端/76-报告导出.md`（2.2 写死 include_nodes）
    - 文档：`docs/80-规范/88-前端与中心机接口.md`（GraphQueryRequest 无 include_nodes；响应固定包含 `nodes[]`）
    - 代码：`backend/app/api/routes/graph.py`（GraphQueryRequest 无 include_nodes；响应总是返回 `nodes[]`）
  - 现状描述：
    - 口径 A：请求需携带 `include_nodes=true`
    - 口径 B：无需该参数，响应固定包含 `nodes[]`
  - 影响范围：前端导出实现、接口对齐检查
  - 决议：移除 `include_nodes` 要求；以 `88-前端与中心机接口.md` 与代码实现为准
  - 执行动作：更新 `docs/50-详细设计/前端/76-报告导出.md` 的 2.2 小节说明
  - 状态：fixed

- 编号：CONFLICT-0003
  - 发现日期：2026-01-15
  - 冲突主题：报告主机 `host_id` 的提取规则在“文档 vs 实际接口返回结构”之间存在偏差
  - 冲突来源：
    - 文档：`docs/50-详细设计/前端/76-报告导出.md`（3.1 要求取目标节点 `props["host.id"]`）
    - 代码：`backend/app/services/neo4j/db.py:get_node()`（为避免冗余，响应中将唯一键字段从 `props` 中剔除，放入 `key`）
  - 现状描述：
    - 口径 A：从 `props["host.id"]` 获取（对 File/Host 等节点不稳定）
    - 口径 B：优先从 UID 解析，其次从 `node.key["host.id"]`/`node.props["host.id"]` 获取
  - 影响范围：前端导出稳定性（尤其是选择 File/Host 等节点作为任务目标时）
  - 决议：按“UID 解析 → nodes[] 中 key/props → 失败终止”的固定优先级提取 `host_id`
  - 执行动作：更新 `docs/50-详细设计/前端/76-报告导出.md` 的 3.1 小节；导出实现按该决议执行
  - 状态：fixed

## 3. 决议与生效口径

当状态从 `open` 变更为 `decided` 时，必须在本节补充决议摘要，便于读者快速定位“最终口径”。

- CONFLICT-0001：报告导出的 TTP 相似度 **优先读取任务文档**，仅在缺失时回落调用 `/api/v1/analysis/ttp-similarity`。
- CONFLICT-0002：`graph/query` 不存在 `include_nodes` 请求参数；响应固定返回 `nodes[]`。
- CONFLICT-0003：`host_id` 提取优先从目标 UID 解析，其次从 `nodes[]` 的 `key/props` 读取；失败则终止导出。
