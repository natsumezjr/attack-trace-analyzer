# 溯源结果写回规范

## 文档目的

本文件定义溯源任务对 Neo4j 边属性的写回字段集合、覆盖规则与前端读取口径，是溯源写回数据的唯一权威口径。

## 权威性声明

本文件是 `analysis.*` 写回字段与覆盖规则的唯一权威口径。

## 引用关系

- 溯源任务模型：`../../50-详细设计/分析/70-任务模型与状态机.md`
- Neo4j 实体图谱规范：`84-Neo4j实体图谱规范.md`
- 前端与中心机接口：`88-前端与中心机接口.md`

## 1. 写回目标（固定）

溯源写回的目标是 Neo4j 关系边（relationship）的属性集合。写回对象满足以下条件：

1. 该关系边由图谱入图生成，边属性包含 `event.id`；  
2. 写回时以 `(src_uid, dst_uid, rtype, event.id)` 定位关系边；  
3. 写回只修改 `analysis.*` 命名空间内的字段，不修改业务属性（`ts_float`、`is_alarm`、`custom.evidence.event_ids` 等）。  

实现绑定点：

- 写回入口：`backend/app/services/neo4j/db.py:write_analysis_results()`
- 定位逻辑：`backend/app/services/neo4j/db.py:_write_analysis_result_tx()`

## 2. 写回字段集合（权威）

溯源写回只允许写入以下字段：

| 字段 | 类型 | 规则 |
|---|---|---|
| `analysis.task_id` | string | 必填；等于本次任务 `task_id` |
| `analysis.updated_at` | string | 必填；中心机写入时刻（RFC3339，UTC） |
| `analysis.is_path_edge` | boolean | 必填；关键路径边为 `true`，非关键路径边为 `false` |
| `analysis.risk_score` | float | 只在 `analysis.is_path_edge=true` 时写入 |
| `analysis.ttp.technique_ids` | list[string] | 只在 `analysis.is_path_edge=true` 时写入；为去重后的 technique id 列表 |
| `analysis.summary` | string | 只在 `analysis.is_path_edge=true` 时写入；用于前端展示的短摘要 |

实现绑定点：

- 写回字段白名单：`backend/app/services/neo4j/db.py:_write_analysis_result_tx()` 的 `analysis_fields`
- 写回值构造：`backend/app/services/neo4j/db.py:_analysis_props_from_edge()`

## 3. 覆盖规则（固定）

### 3.1 覆盖写语义

对每一条被本次任务更新的关系边，中心机必须执行：

1. 将所有 `analysis.*` 字段清空为 `null`；  
2. 再写入本次任务的 `analysis.*` 字段集合。  

该行为保证：

- 同一条边在不同任务中的写回互斥，始终以最后一次写回为准；
- 非关键路径边不会残留旧任务的风险分与 technique 标注。

### 3.2 非关键路径边的写回规则

当 `analysis.is_path_edge=false` 时，中心机固定只写入：

- `analysis.task_id`
- `analysis.updated_at`
- `analysis.is_path_edge`

其余字段（`analysis.risk_score`、`analysis.ttp.technique_ids`、`analysis.summary`）在覆盖写过程中会被清空为 `null`，并保持为空。

### 3.3 任务级结果与写回结果的关系

溯源任务的任务级结果存储在 OpenSearch（见 `../../50-详细设计/分析/70-任务模型与状态机.md`），边级写回结果存储在 Neo4j。两者的绑定点固定为：

- `analysis.task_id == task.id`

## 4. 前端读取与过滤规则（固定）

前端读取溯源写回结果只允许通过以下路径完成：

1. 调用 `POST /api/v1/graph/query`，`action="analysis_edges_by_task"`，并传入 `task_id`；
2. 后端返回所有 `analysis.task_id==task_id` 的边；
3. 当 `only_path=true` 时，后端只返回 `analysis.is_path_edge=true` 的边；当 `only_path=false` 时返回全部写回边。

接口字段与请求响应结构以 `88-前端与中心机接口.md` 为准。
