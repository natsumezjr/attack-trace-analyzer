# 环境变量规范（权威）

## 1. 加载规则（必须理解）

### 1.1 Docker Compose 的变量替换

- `backend/docker-compose.yml` 在执行时读取当前 shell 环境变量，并读取同目录的 `backend/.env`（若存在）用于变量替换。
- 当 `backend/.env` 不存在时，`backend/docker-compose.yml` 中 `${VAR:-default}` 形式的变量替换使用 `default`。

### 1.2 后端应用的变量读取

- 后端（Python FastAPI）通过 `os.getenv()` / `os.environ.get()` 读取环境变量。
- 后端应用启动时不会自动加载 `.env` 文件；要使 `backend/.env` 生效，必须通过 shell 导出环境变量或在运行命令前显式加载。

### 1.3 客户机侧的变量读取

- `client/docker-compose.yml` 在执行时读取当前 shell 环境变量，并读取同目录的 `client/.env`（若存在）用于变量替换。
- 客户机侧各传感器/转换器容器通过其自身的环境变量读取配置。

### 1.4 变量作用域对比

| 作用域 | 加载方式 | 典型用途 | 关键点 |
|------|----------|----------|--------|
| **Docker Compose 容器启动** | 从 `.env` 或 shell 读取 | 容器端口、挂载路径、内存限制 | 容器启动时一次性替换 |
| **Python 应用运行时** | `os.getenv()` | 数据库连接、API 配置 | 不自动加载 `.env`，需手动 `source` |
| **客户机容器内部** | docker-compose environment 注入 | 队列名、内部服务地址 | 由 docker-compose 固定注入 |

> **关键理解：** `backend/.env` 不会被 Python 自动加载，需手动执行 `source backend/.env` 或在启动命令前导出变量

---

## 2. 环境变量清单

> 变量名、默认值与作用域必须与代码一致；当代码新增环境变量时必须同步更新本文件。

### 2.1 中心机后端（FastAPI）运行参数

| 变量名 | 默认值 | 作用域 | 说明 |
|---|---:|---|---|
| `APP_NAME` | `Attack Trace Analyzer API` | backend | FastAPI 应用名 |
| `APP_ENV` | `dev` | backend | 运行环境标识 |
| `APP_VERSION` | `0.1.0` | backend | 应用版本 |
| `LOG_LEVEL` | `INFO` | backend | 日志级别 |

### 2.2 中心机定时流水线参数

| 变量名 | 默认值 | 作用域 | 说明 |
|---|---:|---|---|
| `CENTER_POLL_INTERVAL_SECONDS` | `5` | backend | 中心机“单定时器一条龙”周期（秒） |
| `CENTER_POLL_TIMEOUT_SECONDS` | `5` | backend | 中心机轮询客户机 HTTP 请求超时（秒） |

### 2.3 OpenSearch（容器与客户端）

| 变量名 | 默认值 | 作用域 | 说明 |
|---|---:|---|---|
| `OPENSEARCH_INITIAL_ADMIN_PASSWORD` | `OpenSearch@2024!Dev` | docker-compose | OpenSearch 容器初始化密码 |
| `OPENSEARCH_JAVA_OPTS` | `-Xms512m -Xmx512m` | docker-compose | OpenSearch JVM 内存参数 |
| `OPENSEARCH_NODE` | `https://localhost:9200` | backend | OpenSearch 节点 URL |
| `OPENSEARCH_USERNAME` | `admin` | backend | OpenSearch 用户名 |
| `OPENSEARCH_PASSWORD` | `OpenSearch@2024!Dev` | backend | OpenSearch 密码 |
| `OPENSEARCH_URL` | `https://localhost:9200` | scripts | OpenSearch URL（Security Analytics 脚本使用） |
| `OPENSEARCH_USER` | `admin` | scripts | OpenSearch 用户名（Security Analytics 脚本使用） |

约束（固定）：

1. 后端代码使用 `OPENSEARCH_NODE` / `OPENSEARCH_USERNAME` / `OPENSEARCH_PASSWORD`。  
2. Security Analytics 脚本使用 `OPENSEARCH_URL` / `OPENSEARCH_USER` / `OPENSEARCH_PASSWORD`。  
3. 运维启动时必须保证两组变量指向同一 OpenSearch 实例与同一凭据：  
   - `OPENSEARCH_URL == OPENSEARCH_NODE`  
   - `OPENSEARCH_USER == OPENSEARCH_USERNAME`  

### 2.4 Neo4j（容器与客户端）

| 变量名 | 默认值 | 作用域 | 说明 |
|---|---:|---|---|
| `NEO4J_AUTH` | `neo4j/password` | docker-compose | Neo4j 容器认证 |
| `NEO4J_PLUGINS` | `["graph-data-science"]` | docker-compose | 自动安装 Neo4j GDS 插件（用于 `CALL gds.*` 图算法） |
| `NEO4J_dbms_security_procedures_unrestricted` | `gds.*` | docker-compose | 放开 GDS 过程调用（开发/实验环境） |
| `NEO4J_dbms_security_procedures_allowlist` | `gds.*` | docker-compose | 允许 GDS 过程调用（开发/实验环境） |
| `NEO4J_server_memory_pagecache_size` | `1G` | docker-compose | page cache |
| `NEO4J_server_memory_heap_initial__size` | `1G` | docker-compose | heap initial |
| `NEO4J_server_memory_heap_max__size` | `1G` | docker-compose | heap max |
| `NEO4J_URI` | `bolt://localhost:7687` | backend | Neo4j Bolt URI |
| `NEO4J_USER` | `neo4j` | backend | Neo4j 用户名 |
| `NEO4J_PASSWORD` | `password` | backend | Neo4j 密码 |
| `NEO4J_DATABASE` | `""` | backend | Neo4j 数据库名（空字符串表示使用默认数据库） |

### 2.5 LLM 配置（DeepSeek）

| 变量名 | 默认值 | 作用域 | 说明 |
|---|---:|---|---|
| `LLM_PROVIDER` | `deepseek` | backend | LLM 提供方标识（当前仅 `deepseek` 与 `mock`） |
| `DEEPSEEK_API_KEY` | `""` | backend | DeepSeek API Key |
| `DEEPSEEK_BASE_URL` | `https://api.deepseek.com/v1` | backend | DeepSeek API Base URL |
| `DEEPSEEK_MODEL` | `deepseek-chat` | backend | DeepSeek 模型名 |
| `LLM_TIMEOUT` | `30.0` | backend | 请求超时（秒） |
| `LLM_MAX_RETRIES` | `2` | backend | 最大重试次数 |

> 说明：LLM 配置当前仅被 `backend/app/services/analyze/killchain_llm.py` 使用；溯源任务主流水线不依赖 LLM。

### 2.6 离线 CTI 数据

| 变量名 | 默认值 | 作用域 | 说明 |
|---|---:|---|---|
| `ATTACK_CTI_PATH` | `backend/app/services/analyze/ttp_similarity/cti/enterprise-attack.json` | backend | ATT&CK Enterprise CTI 本地文件路径 |

### 2.7 客户机侧（client/docker-compose.yml）

| 变量名 | 默认值 | 作用域 | 说明 |
|---|---:|---|---|
| `HOST_ID` | `sensor-01` | client | 写入 ECS 的 `host.id` |
| `HOST_NAME` | `victim-01` | client | 写入 ECS 的 `host.name` |
| `TZ` | `Asia/Shanghai` | client | 容器时区 |
| `SURICATA_INTERFACE` | `auto` | client | Suricata 抓包网卡 |
| `SURICATA_HOME_NET` | `auto` | client | Suricata `HOME_NET`（影响 `$HOME_NET/$EXTERNAL_NET` 方向规则；`auto` 表示根据抓包网卡推断） |
| `SURICATA_HOME_NET_FALLBACK` | `[10.0.0.0/8,172.16.0.0/12,192.168.0.0/16]` | client | 当 `SURICATA_HOME_NET=auto` 但无法推断时的回退值（必须保持无空格） |
| `SURICATA_MODE` | `live` | client | Suricata 模式（live/pcap） |
| `PCAP_FILE` | `/data/pcap/sample.pcap` | client | pcap 回放文件路径 |

### 2.8 客户机侧内部组件（容器内使用）

这些变量由 `client/docker-compose.yml` 固定注入，用于容器内部连接 RabbitMQ、指定队列与读写路径：

- `RABBITMQ_URL`：RabbitMQ 连接 URL（默认 `amqp://guest:guest@rabbitmq:5672/`）
- `RABBITMQ_QUEUE`：发布端写入的队列名（Falco/Filebeat/Suricata 各自一条队列）
- `FALCO_QUEUE` / `FILEBEAT_QUEUE` / `SURICATA_QUEUE`：客户机 Go Backend 拉取时读取的队列名
- `SERVER_IP`：中心机后端地址（客户机启动时用于 `POST /api/v1/targets/register` 注册）
- `SELF_IP`：客户机上报的自身 IP（可选；为空则自动探测）
- `EVE_FILE` / `OUTPUT_DIR` / `STATE_DIR`：Suricata exporter 读写路径
- `AGENT_NAME` / `AGENT_VERSION`：写入 ECS 的 `agent.*`
