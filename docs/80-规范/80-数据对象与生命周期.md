# 数据对象与生命周期

## 文档目的

本文件定义本项目“数据对象有哪些、存在哪里、生命周期如何、哪些是派生数据”的全局口径，用于：

1. 统一 OpenSearch 与 Neo4j 的职责边界；
2. 为概要设计、详细设计、测试分析与运维文档提供一致的数据层基线；
3. 约束各模块对 `event.id`、证据引用与写回语义的处理方式。

## 权威性声明

本文件是“数据对象清单、存储边界、生命周期与保留周期”的唯一权威口径。  
字段细表、索引 mapping、图谱 schema 与写回字段的权威口径分别在对应规范文档中定义，本文件不重复逐字段展开。

## 引用关系

- ECS 字段规范：`81-ECS字段规范.md`
- OpenSearch 索引与 mapping 规范：`82-OpenSearch索引与Mapping规范.md`
- 告警数据规范：`83-告警数据规范.md`
- Neo4j 实体图谱规范：`84-Neo4j实体图谱规范.md`
- 溯源结果写回规范：`85-溯源结果写回规范.md`

## 1. 数据对象清单（系统只承认这些对象）

### 1.1 Telemetry（事实事件）

- 定义：`event.kind="event"` 的 ECS 事件。
- 权威存储：OpenSearch 按日滚动索引 `ecs-events-YYYY-MM-DD`。
- 用途：事实检索、证据回溯、作为检测输入、作为图谱抽取输入的一部分。
- 全局幂等键：`event.id`（见 `81-ECS字段规范.md`）。

### 1.2 Raw Finding（原始告警）

- 定义：`event.kind="alert"` 且 `event.dataset="finding.raw.<provider>"` 的告警事件。
- 权威存储：OpenSearch 按日滚动索引 `raw-findings-YYYY-MM-DD`。
- 用途：告警审计、作为融合输入、用于解释 Canonical Finding 的来源。
- provider 取值范围与字段要求见：`83-告警数据规范.md`。

### 1.3 Canonical Finding（融合告警）

- 定义：`event.kind="alert"` 且 `event.dataset="finding.canonical"` 的规范化告警事件。
- 权威存储：OpenSearch 按日滚动索引 `canonical-findings-YYYY-MM-DD`。
- 用途：溯源与图谱的告警主输入、前端告警列表展示。

### 1.4 Client Registry（客户机注册表）

- 定义：中心机维护的客户机注册信息与轮询状态。
- 权威存储：OpenSearch 固定索引 `client-registry`（不按日滚动）。
- 用途：轮询调度输入、客户机在线状态展示。

### 1.5 Trace Task（溯源任务元数据）

- 定义：前端触发的溯源任务状态、进度与任务级摘要结果。
- 权威存储：OpenSearch 按日滚动索引 `analysis-tasks-YYYY-MM-DD`。
- 用途：前端轮询任务状态与展示任务级结果（TTP 相似度、边写回统计）。

### 1.6 Entity Graph（实体关系图）

- 定义：由 Telemetry 与 Canonical Finding 抽取出的实体与关系边集合。
- 权威存储：Neo4j（长期保存）。
- 用途：图查询、时间窗过滤、最短路、溯源任务的输入子图。

### 1.7 Analysis Writeback（溯源写回结果）

- 定义：溯源任务对 Neo4j 关系边属性 `analysis.*` 的覆盖写结果。
- 权威存储：Neo4j（写入到边属性）。
- 用途：前端按 `task_id` 读取某次任务写回的边集合，并高亮关键路径。

写回字段集合与覆盖规则见：`85-溯源结果写回规范.md`。

## 2. 存储边界（OpenSearch 与 Neo4j 的分工）

### 2.1 OpenSearch（事实与告警的权威保存）

OpenSearch 固定承担以下职责：

- Telemetry / Findings / Task / Registry 的权威保存与检索；
- 以 `event.id` 做幂等去重（中心机入库固定语义）；
- 作为检测与融合的输入输出承载。

OpenSearch 不承担图结构表达；图结构以 Neo4j 为准。

### 2.2 Neo4j（图结构与写回结果的权威保存）

Neo4j 固定承担以下职责：

- 以实体关系图表达“跨源关联结果”；
- 承载时间窗图查询与最短路计算；
- 承载溯源写回边属性 `analysis.*`。

Neo4j 不承担 Telemetry/Findings 的全量保存与字段检索；该能力以 OpenSearch 为准。

## 3. 一致性与幂等（全局必须满足）

### 3.1 `event.id` 是全局幂等键

- OpenSearch 中所有 ECS 文档必须具备 `event.id`；
- OpenSearch 入库必须按 `event.id` 幂等：同一 `event.id` 重复写入不会产生重复文档。

### 3.2 证据引用链必须闭环

系统必须形成可回溯证据链：

- Raw Finding 通过 `custom.evidence.event_ids[]` 引用触发它的 Telemetry `event.id`；
- Canonical Finding 合并并去重所有证据引用；
- Neo4j 的边属性包含 `custom.evidence.event_ids[]`，可回溯到 OpenSearch 的 Telemetry 文档；
- 溯源写回结果通过 `analysis.task_id` 与证据引用实现可解释与可审计。

**证据链示例：**

```mermaid
flowchart TD
    CF["Canonical Finding<br/>evidence.event_ids = ['evt-001', 'evt-002']"]
    RF_A["Raw Finding A<br/>evidence.event_ids = ['evt-001']"]
    RF_B["Raw Finding B<br/>evidence.event_ids = ['evt-002']"]
    TEL["Telemetry<br/>ecs-events-*"]
    NEO4J["Neo4j 边属性<br/>evidence.event_ids"]
    TASK["溯源任务<br/>analysis.task_id"]

    CF -->|引用| RF_A
    CF -->|引用| RF_B
    RF_A -->|回溯| TEL
    RF_B -->|回溯| TEL
    NEO4J -.->|查询| CF
    NEO4J -.->|查询| TASK
    TASK -->|写回| NEO4J

    CF:::finding
    RF_A:::rawFinding
    RF_B:::rawFinding
    TEL:::telemetry
    NEO4J:::graph
    TASK:::task

    classDef finding fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef rawFinding fill:#ffe0b2,stroke:#ff9800,stroke-width:2px
    classDef telemetry fill:#e3f2fd,stroke:#1565c0,stroke-width:2px
    classDef graph fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
    classDef task fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px

    class CF finding
    class RF_A,RF_B rawFinding
    class TEL telemetry
    class NEO4J graph
    class TASK task
```

> **说明：**
> - Canonical Finding 包含多个 Raw Finding 的证据引用
> - 每个 Raw Finding 可回溯到原始 Telemetry 事件
> - Neo4j 边属性包含证据引用，可直接查询 OpenSearch 获取原始事件
> - 溯源任务通过 `task_id` 写回 Neo4j 边属性，形成完整的证据闭环

---

### 3.3 派生数据的可重建性

- Canonical Finding 是派生数据：Raw Finding 保留完整时可重建；
- Entity Graph 是派生数据：Canonical Finding 与必要 Telemetry 保留完整时可重建；
- Analysis Writeback 是覆盖写派生数据：同一条边在不同任务中会被不同 `task_id` 覆盖写入。

## 4. 保留周期（固定）

| 数据对象 | 存储介质 | 索引或承载位置 | 保留周期 |
|---|---|---|---|
| Telemetry | OpenSearch | `ecs-events-*` | 30 天 |
| Raw Findings | OpenSearch | `raw-findings-*` | 180 天 |
| Canonical Findings | OpenSearch | `canonical-findings-*` | 180 天 |
| Trace Tasks | OpenSearch | `analysis-tasks-*` | 30 天 |
| Client Registry | OpenSearch | `client-registry` | 长期保留 |
| Entity Graph | Neo4j | 节点与关系 | 长期保留 |
| Analysis Writeback | Neo4j | 关系属性 `analysis.*` | 长期保留 |

> 说明：本项目的保留周期是课程演示规模下的固定策略；保留策略的落地方式（ISM/脚本/人工）统一在运维文档中给出，不在本文件展开。
