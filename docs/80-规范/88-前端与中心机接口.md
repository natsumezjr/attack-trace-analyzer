# 前端与中心机接口

## 文档目的

本文件定义前端调用中心机后端的接口清单、请求响应与错误码，是前端接口的唯一权威口径。

## 权威性声明

本文件是前端与中心机接口的唯一权威口径。

## 引用关系

- 全局约定：`86-接口全局约定.md`

## 0. 接口清单（固定）

| 类别 | 方法 | 路径 | 说明 |
|---|---|---|---|
| 健康检查 | GET | `/health` | 后端存活检查 |
| 根路径 | GET | `/` | 服务连通性验证 |
| 事件检索 | POST | `/api/v1/events/search` | 查询 Telemetry（`ecs-events-*`） |
| 告警检索 | POST | `/api/v1/findings/search` | 查询 Raw/Canonical Findings |
| 图查询 | POST | `/api/v1/graph/query` | 图查询与溯源结果读取 |
| 溯源任务 | POST | `/api/v1/analysis/tasks` | 创建溯源任务 |
| 溯源任务 | GET | `/api/v1/analysis/tasks` | 查询任务列表 |
| 溯源任务 | GET | `/api/v1/analysis/tasks/{task_id}` | 查询单个任务 |
| TTP 相似度 | POST | `/api/v1/analysis/ttp-similarity` | 输出 Top-3 相似 intrusion-set |
| 客户机注册 | POST | `/api/v1/clients/register` | 客户机注册（靶场联调使用） |
| 客户机列表 | GET | `/api/v1/clients` | 查询注册表（运维与展示使用） |
| 目标注册 | POST | `/api/v1/targets/register` | 通过 IP 快速注册目标（运维与演示使用） |
| 目标列表 | GET | `/api/v1/targets` | 查询目标列表（运维与演示使用） |

## 1. 事件查询接口：`POST /api/v1/events/search`

### 1.1 Request Body（固定字段）

```json
{
  "start_ts": "2026-01-14T00:00:00Z",
  "end_ts": "2026-01-14T23:59:59Z",
  "host_id": "h-1111111111111111",
  "host_name": "victim-01",
  "event_ids": ["evt-aaaaaaaaaaaaaaaa"],
  "datasets": ["netflow.dns", "hostbehavior.syscall"],
  "query": null,
  "size": 100,
  "offset": 0,
  "sort_order": "desc"
}
```

字段语义（固定）：

- `start_ts/end_ts`：时间窗过滤；当任一字段为 `null` 或缺失时表示不加该边界；
- `host_id/host_name`：主机过滤；当为 `null` 或缺失时表示不按该字段过滤；
- `event_ids`：按 `event.id` 列表过滤；当为 `null` 或缺失时表示不按 ID 过滤；
- `datasets`：按 `event.dataset` 过滤；支持精确值与 wildcard（包含 `*` 或 `?` 时按 wildcard 查询）；
- `query`：高级用法，直接传入 OpenSearch Query DSL 的 `query` 对象；当 `query` 为非空对象时，忽略本请求中的其它过滤字段；
- `size/offset/sort_order`：分页与排序规则见 `86-接口全局约定.md`。

### 1.2 Response Body（固定结构）

```json
{
  "status": "ok",
  "total": 1,
  "items": [
    {
      "@timestamp": "2026-01-14T12:00:00Z",
      "ecs": { "version": "9.2.0" },
      "event": { "id": "evt-aaaaaaaaaaaaaaaa", "kind": "event", "dataset": "netflow.dns" },
      "host": { "id": "h-1111111111111111", "name": "victim-01" }
    }
  ],
  "server_time": "2026-01-14T12:00:01.123456Z"
}
```

## 2. 告警查询接口：`POST /api/v1/findings/search`

### 2.1 Request Body（固定字段）

```json
{
  "stage": "canonical",
  "start_ts": "2026-01-14T00:00:00Z",
  "end_ts": "2026-01-14T23:59:59Z",
  "host_id": "h-1111111111111111",
  "tactic_ids": ["TA0001"],
  "technique_ids": ["T1055"],
  "rule_ids": ["rule-xxxxxxxxxxxxxxxx"],
  "providers": ["security_analytics"],
  "min_severity": 50,
  "query": null,
  "size": 100,
  "offset": 0,
  "sort_order": "desc"
}
```

字段语义（固定）：

- `stage`：`raw` 查询 `raw-findings-*`；`canonical` 查询 `canonical-findings-*`；
- `tactic_ids/technique_ids/rule_ids/providers`：多值过滤；当字段为 `null` 或缺失时表示不按该维度过滤；
- `min_severity`：最小严重度过滤；当字段为 `null` 或缺失时不启用该过滤；
- `query`：高级用法，同 `events/search`。

### 2.2 Response Body（固定结构）

响应结构与 `events/search` 同构：返回 `total`、`items[]` 与 `server_time`。

## 3. 图查询接口：`POST /api/v1/graph/query`

### 3.1 Request Body（固定字段）

```json
{
  "action": "alarm_edges",
  "start_ts": null,
  "end_ts": null,
  "allowed_reltypes": null,
  "only_alarm": false,
  "src_uid": null,
  "dst_uid": null,
  "risk_weights": null,
  "min_risk": 0.0,
  "task_id": null,
  "only_path": false
}
```

字段语义（固定）：

- `action` 取值固定为：
  - `alarm_edges`：查询所有告警边（`is_alarm=true`）；
  - `edges_in_window`：按 `[start_ts,end_ts]` 查询时间窗边集合；
  - `shortest_path_in_window`：按 `[start_ts,end_ts]` + 风险权重计算加权最短路；
  - `analysis_edges_by_task`：按 `task_id` 读取溯源任务写回边集合。
- `allowed_reltypes`：关系类型过滤列表；当为 `null` 或缺失时表示不限制；
- `only_alarm`：仅对 `edges_in_window` 生效；为 `true` 时只返回 `is_alarm=true` 的边；
- `risk_weights/min_risk`：仅对 `shortest_path_in_window` 生效；`risk_weights` 必须为非空字典。

### 3.2 Response Body（固定结构）

#### 3.2.1 `alarm_edges` / `edges_in_window` / `analysis_edges_by_task`

```json
{
  "status": "ok",
  "edges": [
    {
      "src_uid": "Host:host.id=h-1111111111111111",
      "dst_uid": "Domain:domain.name=example.com",
      "rtype": "DNS_QUERY",
      "props": {
        "event.id": "evt-aaaaaaaaaaaaaaaa",
        "ts_float": 1736856000.0,
        "is_alarm": true
      }
    }
  ],
  "nodes": [
    {
      "uid": "Host:host.id=h-1111111111111111",
      "ntype": "Host",
      "key": {"host.id": "h-1111111111111111"},
      "props": {"host.name": "victim-01"}
    }
  ],
  "server_time": "2026-01-14T12:00:01.123456Z"
}
```

#### 3.2.2 `shortest_path_in_window`

```json
{
  "status": "ok",
  "found": true,
  "cost": 12.3,
  "edges": [
    {
      "src_uid": "Host:host.id=h-1111111111111111",
      "dst_uid": "IP:ip=93.184.216.1",
      "rtype": "NET_CONNECT",
      "props": {
        "event.id": "evt-net-001",
        "ts_float": 1736856000.0
      }
    }
  ],
  "nodes": [
    {
      "uid": "Host:host.id=h-1111111111111111",
      "ntype": "Host",
      "key": {"host.id": "h-1111111111111111"},
      "props": {"host.name": "victim-01"}
    },
    {
      "uid": "IP:ip=93.184.216.1",
      "ntype": "IP",
      "key": {"ip": "93.184.216.1"},
      "props": {"ip": "93.184.216.1"}
    }
  ],
  "server_time": "2026-01-14T12:00:01.123456Z"
}
```

### 3.3 `analysis_edges_by_task` 的读取语义（固定）

当 `action="analysis_edges_by_task"` 时：

- `task_id` 必填；
- 当 `only_path=true` 时只返回 `analysis.is_path_edge=true` 的边；
- 当 `only_path=false` 时返回该任务写回的全部边。

写回字段口径见：`85-溯源结果写回规范.md`。

### 3.4 `nodes[]` 的结构（固定）

响应中始终返回 `nodes[]`（按边集合中的 UID 去重拉取）。每个节点对象结构固定为：

- `uid`：节点 UID（例如 `Host:host.id=...`）
- `ntype`：节点类型（`Host|User|Process|File|IP|Domain`）
- `key`：节点唯一键字典
- `props`：节点属性字典（包含 ECS 平铺字段）

## 4. 溯源任务接口

### 4.1 创建任务：`POST /api/v1/analysis/tasks`

Request Body（固定结构）：

```json
{
  "target_node_uid": "Host:host.id=h-1111111111111111",
  "start_ts": "2026-01-14T00:00:00Z",
  "end_ts": "2026-01-14T23:59:59Z"
}
```

Response Body（固定结构）：

```json
{
  "status": "ok",
  "task_id": "trace-aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee",
  "task": {
    "@timestamp": "2026-01-14T12:00:00Z",
    "task.id": "trace-aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee",
    "task.status": "queued",
    "task.progress": 0,
    "task.target.node_uid": "Host:host.id=h-1111111111111111",
    "task.window.start_ts": "2026-01-14T00:00:00Z",
    "task.window.end_ts": "2026-01-14T23:59:59Z"
  },
  "server_time": "2026-01-14T12:00:00.123456Z"
}
```

### 4.2 任务列表：`GET /api/v1/analysis/tasks`

查询参数固定为：

- `status`：`queued|running|succeeded|failed`（缺失时不过滤）
- `target_node_uid`：缺失时不过滤
- `created_from/created_to`：缺失时不过滤
- `size/offset`：分页

响应固定返回：

- `total`
- `items[]`
- `server_time`

### 4.3 单任务查询：`GET /api/v1/analysis/tasks/{task_id}`

当任务不存在时返回：

- HTTP 404
- `error.code="NOT_FOUND"`

#### 4.3.1 Response Body 扩展字段

任务对象的 `task.result` 字段扩展如下（所有新增字段为可选）：

```json
{
  "task": {
    "task.id": "trace-aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee",
    "task.status": "succeeded",
    "task.result": {
      "ttp_similarity": {
        "attack_tactics": ["TA0001", "TA0006", "TA0011"],
        "attack_techniques": ["T1059", "T1055", "T1071"],
        "similar_apts": [
          {
            "intrusion_set": {"id": "G0016", "name": "APT28"},
            "similarity_score": 0.42,
            "top_tactics": ["TA0001"],
            "top_techniques": ["T1059"]
          }
        ]
      },
      "trace": {
        "updated_edges": 42,
        "path_edges": 8
      },
      "killchain_uuid": "abc-123-def-456",
      "killchain": {
        "kc_uuid": "abc-123-def-456",
        "confidence": 0.85,
        "segments": [
          {
            "seg_idx": 0,
            "state": "INITIAL_ACCESS",
            "t_start": 1234567890.0,
            "t_end": 1234567900.0,
            "anchor_in_uid": "Process:pid=1234",
            "anchor_out_uid": "Host:host.id=web-001",
            "abnormal_edge_count": 3
          },
          {
            "seg_idx": 1,
            "state": "EXECUTION",
            "t_start": 1234567900.0,
            "t_end": 1234567950.0,
            "anchor_in_uid": "Host:host.id=web-001",
            "anchor_out_uid": "Process:pid=5678",
            "abnormal_edge_count": 5
          }
        ],
        "selected_paths": [
          {
            "path_id": "p-abc123",
            "src_anchor": "Host:host.id=web-001",
            "dst_anchor": "Process:pid=5678",
            "hop_count": 3,
            "edge_ids": ["evt-aaa", "evt-bbb", "evt-ccc"]
          }
        ],
        "explanation": "攻击者进程 p_c2 (pid:1234) 从外部 IP 1.2.3.4 连接到受害主机 host_web (host.id:host-001)，通过..."
      }
    }
  }
}
```

**新增字段语义**：

- `task.result.killchain_uuid`：关联的 KillChain UUID（字符串），当任务产生 KillChain 结果时存在
- `task.result.killchain`：完整的 KillChain 数据结构（对象），当后端选择嵌入完整数据时存在
  - `kc_uuid`：KillChain 唯一标识符
  - `confidence`：可信度评分（0.0-1.0）
  - `segments[]`：战术分段列表
    - `seg_idx`：段索引（从 0 开始）
    - `state`：战术状态（`INITIAL_ACCESS|EXECUTION|PRIVILEGE_ESCALATION|LATERAL_MOVEMENT|COMMAND_AND_CONTROL|DISCOVERY|IMPACT`）
    - `t_start/t_end`：段起始/结束时间（Unix 时间戳）
    - `anchor_in_uid/anchor_out_uid`：入口/出口锚点 UID
    - `abnormal_edge_count`：段内异常边数量
  - `selected_paths[]`：段间连接路径列表
    - `path_id`：路径唯一标识符
    - `src_anchor/dst_anchor`：源/目标锚点 UID
    - `hop_count`：跳数（边的数量）
    - `edge_ids[]`：路径包含的边 ID 列表
  - `explanation`：LLM 生成的完整攻击链解释（10-20 句中文）

**兼容性说明**：

- 所有新增字段为可选字段
- 前端应处理字段不存在的情况
- 旧版本任务不包含 `killchain_uuid` 和 `killchain` 字段

## 5. KillChain 查询接口（可选）：`GET /api/v1/analysis/killchain/{kc_uuid}`

### 5.1 Request Parameters

路径参数：

- `kc_uuid`：KillChain UUID（必需）

### 5.2 Response Body（固定结构）

```json
{
  "status": "ok",
  "killchain": {
    "kc_uuid": "abc-123-def-456",
    "confidence": 0.85,
    "segments": [...],
    "selected_paths": [...],
    "explanation": "..."
  },
  "server_time": "2026-01-14T12:00:00.123456Z"
}
```

字段语义与 4.3.1 中 `task.result.killchain` 相同。

### 5.3 错误响应

当 `kc_uuid` 不存在时返回：

- HTTP 404
- `error.code="NOT_FOUND"`

当查询失败时返回：

- HTTP 500
- `error.code="INTERNAL_ERROR"`

## 6. TTP 相似度接口：`POST /api/v1/analysis/ttp-similarity`

### 6.1 Request Body（固定字段）

```json
{
  "host_id": "h-1111111111111111",
  "start_ts": "2026-01-14T00:00:00Z",
  "end_ts": "2026-01-14T23:59:59Z"
}
```

字段语义（固定）：

- `host_id`：ECS `host.id`
- `start_ts/end_ts`：时间窗过滤（包含边界）

当 `end_ts < start_ts` 时返回 HTTP 400。

### 6.2 Response Body（固定结构）

```json
{
  "host_id": "h-1111111111111111",
  "start_ts": "2026-01-14T00:00:00Z",
  "end_ts": "2026-01-14T23:59:59Z",
  "attack_tactics": ["TA0001", "TA0011"],
  "attack_techniques": ["T1078", "T1071.001"],
  "similar_apts": [
    {
      "intrusion_set": {"id": "G0016", "name": "APT28"},
      "similarity_score": 0.42,
      "top_tactics": ["TA0001", "TA0011"],
      "top_techniques": ["T1078", "T1071.001"]
    }
  ]
}
```

字段语义（固定）：

- `attack_tactics/attack_techniques`：从 Canonical Findings 提取并规范化后的集合（排序后输出）
- `similar_apts[]`：按 `similarity_score` 降序排列，最多 3 项
