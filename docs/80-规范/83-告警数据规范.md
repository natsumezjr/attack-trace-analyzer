# 告警数据规范

## 文档目的

本文件定义 Raw Finding 与 Canonical Finding 的字段结构、融合规则与证据引用规则，是告警数据的唯一权威口径。

## 权威性声明

本文件是告警数据结构与融合规则的唯一权威口径。

## 引用关系

- 数据对象与生命周期：`80-数据对象与生命周期.md`
- ECS 字段规范：`81-ECS字段规范.md`
- OpenSearch 索引与 mapping 规范：`82-OpenSearch索引与Mapping规范.md`

## 1. Raw Finding（`event.dataset="finding.raw.<provider>"`）

### 1.1 定义

Raw Finding 是“尚未融合”的原始告警事件，来源固定为以下四类 provider：

- `falco`
- `suricata`
- `filebeat_sigma`
- `security_analytics`

Raw Finding 的 `event.dataset` 固定为：

- `finding.raw.<provider>`

### 1.2 必填字段（最小集合）

Raw Finding 必须满足 `81-ECS字段规范.md` 的公共字段要求，并额外满足以下字段约束：

| 字段 | 类型 | 规则 |
|---|---|---|
| `event.kind` | keyword | 固定为 `alert` |
| `event.dataset` | keyword | 固定为 `finding.raw.<provider>` |
| `custom.finding.stage` | keyword | 固定为 `raw` |
| `custom.finding.providers[]` | keyword[] | 固定为单元素数组 `[<provider>]` |
| `event.severity` | integer | 取值范围 0–100；缺失则中心机回填为 `50` |
| `rule.id` | keyword | 必须存在；缺失则中心机按 `rule-` + sha1(rule.name)[:16] 生成 |
| `rule.name` | keyword | 必须存在；缺失则中心机写入 `Unknown` |
| `threat.framework` | keyword | 固定为 `MITRE ATT&CK`（中心机兜底写入） |
| `threat.tactic.id` | keyword | 缺失则中心机写入 `TA0000` |
| `threat.tactic.name` | keyword | 缺失则中心机写入 `Unknown` |
| `threat.technique.id` | keyword | 缺失则中心机写入 `T0000` |
| `threat.technique.name` | keyword | 缺失则中心机写入 `Unknown` |
| `custom.evidence.event_ids[]` | keyword[] | 必须存在；为空时中心机写入 `[event.id]` |

中心机对 Raw Finding 的最小字段兜底逻辑实现入口：

- `backend/app/services/opensearch/storage.py:_ensure_required_fields()`

### 1.3 Security Analytics Raw Finding 的固定口径

Security Analytics 的 finding 会被中心机转换为 ECS Raw Finding，字段固定为：

- `event.dataset="finding.raw.security_analytics"`
- `custom.finding.providers=["security_analytics"]`

转换实现入口：

- `backend/app/services/opensearch/analysis.py:_convert_security_analytics_finding_to_ecs()`

## 2. Canonical Finding（`event.dataset="finding.canonical"`）

### 2.1 定义

Canonical Finding 是中心机对 Raw Finding 做融合去重后的规范告警，满足以下约束：

- `event.kind="alert"`
- `event.dataset="finding.canonical"`
- `custom.finding.stage="canonical"`

Canonical Finding 的生成过程固定为“按指纹分组 → 分组内合并/转换 → 写入 `canonical-findings-*`”，实现入口：

- `backend/app/services/opensearch/analysis.py:deduplicate_findings()`

### 2.2 指纹 key（用于分组的原始指纹）

Raw Finding 分组使用的指纹 key 固定为：

```
{technique_id}|{host_id}|{entity_id}|{time_bucket}
```

各分量的取值规则固定如下：

1. `technique_id`：取 `threat.technique.id`，缺失时取 `unknown`  
2. `host_id`：取 `host.id`，缺失时取 `unknown`  
3. `entity_id`：按以下顺序取第一个命中的实体标识  
   - `process.entity_id`  
   - `destination.ip`（若同时存在 `destination.domain` 则拼接为 `{ip}|{domain}`）  
   - `file.hash.sha256`  
   - 否则取 `unknown`  
4. `time_bucket`：以分钟为窗口对 `@timestamp` 做整除桶化  
   - 时间窗固定为 3 分钟（`TIME_WINDOW_MINUTES=3`）  
   - `time_bucket = floor(timestamp_ms / (3*60*1000))`

指纹 key 的实现入口：

- `backend/app/services/opensearch/analysis.py:generate_fingerprint()`

**示例：** 以下 3 条 Raw Finding 会产生相同的指纹 key，并被融合为 1 条 Canonical Finding：

| # | threat.technique.id | host.id | entity_id | @timestamp | time_bucket | 计算后 fingerprint key |
|---|---------------------|---------|-----------|------------|-------------|------------------------|
| A | T1055 | h-aaa | p-001 | 12:01:23 | bucket-240 | `T1055\|h-aaa\|p-001\|bucket-240` |
| B | T1055 | h-aaa | p-001 | 12:02:45 | bucket-240 | `T1055\|h-aaa\|p-001\|bucket-240` |
| C | T1055 | h-aaa | p-001 | 12:03:10 | bucket-240 | `T1055\|h-aaa\|p-001\|bucket-240` |

> 说明：3 分钟窗口内、同一主机、同一实体、同一种技术类型的告警会被融合

---

### 2.3 `custom.finding.fingerprint`（对外可存储指纹）

Canonical Finding 中用于存储与检索的指纹字段固定为：

- `custom.finding.fingerprint = "fp-" + sha1(fingerprint_key)[:40]`

实现入口：

- `backend/app/services/opensearch/analysis.py:fingerprint_id_from_key()`

### 2.4 Canonical 合并规则（分组内多个 Raw Finding）

当同一指纹 key 分组内 Raw Finding 数量大于 1 时，Canonical Finding 的生成规则固定为：

1. 以分组内第一条 Raw Finding 的内容作为 Canonical 基础文档；
2. 合并并去重 `custom.finding.providers[]`，按字典序排序写入；
3. 合并并去重 `custom.evidence.event_ids[]`，按字典序排序写入；
4. `event.severity` 取分组内最大值；
5. `event.kind="alert"`，`event.dataset="finding.canonical"`；
6. 写入 `custom.confidence`：
   - `custom.confidence = min(0.5 + providers_count*0.15, 1.0)`
7. 写入 `custom.finding.fingerprint`（见 2.3）；
8. 写入 `event.id`：
   - `event.id = "canonical-" + sha256(fingerprint_key)[:16]`

实现入口：

- `backend/app/services/opensearch/analysis.py:merge_findings()`

### 2.5 Canonical 转换规则（分组内仅 1 条 Raw Finding）

当同一指纹 key 分组内 Raw Finding 数量等于 1 时，Canonical Finding 的生成规则固定为：

1. 复制该 Raw Finding 作为基础文档；
2. 写入 `custom.finding.stage="canonical"`；
3. 若 `custom.finding.providers` 缺失，则按 provider 推断逻辑写入一个 provider；
4. 写入 `custom.finding.fingerprint`；
5. 写入 `event.kind="alert"`，`event.dataset="finding.canonical"`；
6. `event.id` 保持为该 Raw Finding 的 `event.id`（不生成新的 canonical-*）。

provider 推断逻辑实现入口：

- `backend/app/services/opensearch/analysis.py:extract_provider()`

## 3. 融合指纹与覆盖规则

本项目的融合去重严格遵循以下覆盖语义：

1. Canonical Finding 是“中心机派生数据”，其 `event.ingested` 必须覆盖为生成时刻；  
2. Canonical Finding 的 `@timestamp` 与 `event.created` 固定继承分组内基础文档的时间戳（分组内第一条 Raw Finding）；  
3. 写入 Canonical 索引时使用 `event.id` 作为文档 ID；同一文档 ID 重复写入覆盖旧内容。  

## 4. 证据引用规则（必须满足）

证据引用字段固定为：

- `custom.evidence.event_ids[]`

规则固定如下：

1. Raw Finding 必须携带 `custom.evidence.event_ids[]` 用于回溯证据事件；
2. Canonical Finding 必须合并并去重分组内所有 Raw Finding 的证据引用；
3. 当 Raw Finding 未携带有效证据引用时，中心机写入 `[event.id]` 作为可审计占位证据引用；
4. 证据引用数组必须按字典序排序，保证输出稳定。
