# 接口全局约定

## 文档目的

本文件定义本项目所有 HTTP API 的全局约定：版本、时间窗、分页、错误码、幂等与重试策略，是接口约定的唯一权威口径。

## 权威性声明

本文件是接口全局约定的唯一权威口径。

## 引用关系

- 客户机与中心机接口：`87-客户机与中心机接口.md`
- 前端与中心机接口：`88-前端与中心机接口.md`

## 1. 版本与路径前缀（固定）

中心机后端 HTTP API 分为两类：

1. **非版本化基础接口**：用于健康检查与连通性验证  
   - `GET /health`  
   - `GET /`  
2. **版本化业务接口**：统一前缀为 `/api/v1`  

除上述两条基础接口外，其余接口必须以 `/api/v1` 开头。

## 2. 内容类型与编码（固定）

- 所有请求与响应体固定为 JSON；
- `Content-Type` 固定为 `application/json; charset=utf-8`；
- 所有时间戳字段使用 UTC 的 RFC3339 字符串表示（以 `Z` 结尾）。

## 3. 通用响应体（固定）

### 3.1 成功响应

成功响应固定包含：

- `status="ok"`

并按接口需要携带业务字段，例如：

```json
{
  "status": "ok",
  "server_time": "2026-01-14T12:00:00.123456Z"
}
```

其中 `server_time` 为中心机生成的 UTC 时间戳，格式为 RFC3339（微秒精度）。

### 3.2 错误响应

错误响应固定形态为：

```json
{
  "status": "error",
  "error": {
    "code": "BAD_REQUEST",
    "message": "..."
  }
}
```

实现绑定点：

- `backend/app/api/utils.py:ok()` 与 `backend/app/api/utils.py:err()`

## 4. 时间窗约定（固定）

### 4.1 输入语义

所有涉及时间窗的接口使用以下语义：

- `start_ts`：起点时间（包含）
- `end_ts`：终点时间（包含）

约束：

- `end_ts` 必须大于或等于 `start_ts`；
- 时间窗的比较以 UTC 时间为准。

**时间窗示例：**

| start_ts | end_ts | 含义 | 返回的数据 |
|----------|--------|------|------------|
| `2026-01-14T00:00:00Z` | `2026-01-14T23:59:59Z` | 整天 | 该日内的所有文档 |
| `2026-01-14T12:00:00Z` | `2026-01-14T12:05:00Z` | 5 分钟窗口 | 12:00:00 ~ 12:05:00 之间的文档 |
| `null` | `2026-01-14T12:00:00Z` | 截止到某时刻 | `@timestamp <= 12:00:00` 的文档 |
| `2026-01-14T12:00:00Z` | `null` | 某时刻之后 | `@timestamp >= 12:00:00` 的文档 |

> 当 `end_ts < start_ts` 时返回 HTTP 400 错误

---

### 4.2 输出语义

列表接口按 `@timestamp` 排序时，排序键固定为 OpenSearch 文档字段 `@timestamp`。

## 5. 分页与排序（固定）

### 5.1 分页参数

本项目所有列表/搜索接口的分页参数固定为：

- `size`：返回条数，范围固定为 `1..2000`
- `offset`：偏移量，范围固定为 `>=0`

### 5.2 排序参数

涉及时间排序的接口使用：

- `sort_order="asc"|"desc"`

默认值为 `desc`，表示按时间从新到旧返回。

## 6. 错误码（固定集合）

中心机对外错误码集合固定为以下几类：

- `BAD_REQUEST`：请求参数不合法或缺失（HTTP 400）
- `NOT_FOUND`：资源不存在（HTTP 404）
- `OPENSEARCH_UNAVAILABLE`：OpenSearch 不可用或鉴权失败（HTTP 503）
- `INTERNAL_ERROR`：中心机内部错误（HTTP 500）

> 说明：客户端返回错误体结构与中心机不同，见 `87-客户机与中心机接口.md`。

## 7. 幂等与重试策略（固定）

### 7.1 安全重试的接口

以下接口的重试语义固定为“可安全重试”：

- 所有 `GET` 接口；
- 所有查询/搜索类 `POST` 接口（请求体只包含查询条件，不产生写入副作用）。

### 7.2 禁止自动重试的接口

以下接口的重试语义固定为“禁止自动重试”：

- `POST /api/v1/analysis/tasks`：每次调用都会创建一个新任务；
- `POST /api/v1/clients/register`：重复调用会覆盖注册表中的客户机记录并产生新的 `client_token`。

## 8. 鉴权与令牌（固定）

本项目的中心机 API 不启用鉴权机制。所有接口均为明文可访问。

客户机注册接口会返回 `client_token` 并将其哈希写入注册表，但该 token 不参与后续拉取鉴权。
