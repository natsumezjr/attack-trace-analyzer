# GitHub Actions CI配置示例
# 复制到 .github/workflows/tests.yml 使用

name: OpenSearch Module Tests

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'backend/opensearch/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'backend/opensearch/**'

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: Install uv
        run: pip install uv
      
      - name: Install dependencies
        run: |
          cd backend
          uv sync
          uv add pytest pytest-html pytest-cov
      
      - name: Run unit tests
        run: |
          cd backend
          uv run pytest opensearch/test/ -m unit -v --tb=short
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: unit-test-results
          path: backend/test_report.html

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    
    services:
      opensearch:
        image: opensearchproject/opensearch:2.11.0
        env:
          discovery.type: single-node
          plugins.security.disabled: false
          plugins.security.authcz.admin_dn:
            - CN=admin,OU=SSL,O=Test,L=Test,C=DE
          plugins.security.ssl.transport.pemcert_filepath: esnode.pem
          plugins.security.ssl.transport.pemkey_filepath: esnode-key.pem
          plugins.security.ssl.transport.pemtrustedcas_filepath: root-ca.pem
          plugins.security.ssl.transport.enforce_hostname_verification: false
          plugins.security.ssl.http.enabled: false
          OPENSEARCH_INITIAL_ADMIN_PASSWORD: OpenSearch@2024!Dev
        ports:
          - 9200:9200
        options: >-
          --health-cmd "curl -k https://localhost:9200 -u admin:OpenSearch@2024!Dev"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: Install uv
        run: pip install uv
      
      - name: Install dependencies
        run: |
          cd backend
          uv sync
          uv add pytest pytest-html pytest-cov
      
      - name: Wait for OpenSearch
        run: |
          timeout 60 bash -c 'until curl -k https://localhost:9200 -u admin:OpenSearch@2024!Dev; do sleep 2; done'
      
      - name: Run integration tests
        env:
          OPENSEARCH_NODE: https://localhost:9200
          OPENSEARCH_USERNAME: admin
          OPENSEARCH_PASSWORD: OpenSearch@2024!Dev
        run: |
          cd backend
          uv run pytest opensearch/test/ -m integration -v --tb=short
      
      - name: Generate coverage report
        run: |
          cd backend
          uv run pytest opensearch/test/ \
            --cov=opensearch \
            --cov-report=xml \
            --cov-report=html
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./backend/coverage.xml
          flags: opensearch
          name: opensearch-coverage
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: integration-test-results
          path: |
            backend/test_report.html
            backend/htmlcov/
