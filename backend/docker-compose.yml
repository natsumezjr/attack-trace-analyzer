# Backend infrastructure services (OpenSearch + Neo4j)
#
# Usage:
#   cd backend
#   cp .env.example .env   # optional (defaults are provided below)
#   docker compose up -d
#
# Notes:
# - This compose file is the single source of truth for backend infra.
# - Python services (uv/FastAPI) run on the host and connect via localhost ports.

services:
  opensearch:
    image: opensearchproject/opensearch:latest
    container_name: opensearch
    env_file:
      - .env
    environment:
      - discovery.type=single-node
      - OPENSEARCH_INITIAL_ADMIN_PASSWORD=${OPENSEARCH_INITIAL_ADMIN_PASSWORD:-OpenSearch@2024!Dev}
      - OPENSEARCH_JAVA_OPTS=${OPENSEARCH_JAVA_OPTS:--Xms512m -Xmx512m}
    ports:
      - "9200:9200"
      - "9600:9600"
    volumes:
      - opensearch-data:/usr/share/opensearch/data
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    healthcheck:
      test: ["CMD-SHELL", "curl -k -s -u admin:${OPENSEARCH_INITIAL_ADMIN_PASSWORD:-OpenSearch@2024!Dev} https://localhost:9200/_cluster/health > /dev/null || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    networks:
      - backend-net

  opensearch-dashboards:
    image: opensearchproject/opensearch-dashboards:latest
    container_name: opensearch-dashboards
    env_file:
      - .env
    ports:
      - "5601:5601"
    environment:
      - 'OPENSEARCH_HOSTS=["https://opensearch:9200"]'
      - 'OPENSEARCH_USERNAME=admin'
      - 'OPENSEARCH_PASSWORD=${OPENSEARCH_INITIAL_ADMIN_PASSWORD:-OpenSearch@2024!Dev}'
      - DISABLE_SECURITY_DASHBOARDS_PLUGIN=true
      - OPENSEARCH_SSL_VERIFICATION_MODE=none
    depends_on:
      opensearch:
        condition: service_healthy
    networks:
      - backend-net


  neo4j:
    image: neo4j:5
    container_name: neo4j
    ports:
      - "7474:7474" # browser
      - "7687:7687" # bolt
    environment:
      - NEO4J_AUTH=${NEO4J_AUTH:-neo4j/password}
      - NEO4J_server_memory_pagecache_size=${NEO4J_server_memory_pagecache_size:-1G}
      - NEO4J_server_memory_heap_initial__size=${NEO4J_server_memory_heap_initial__size:-1G}
      - NEO4J_server_memory_heap_max__size=${NEO4J_server_memory_heap_max__size:-1G}
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:7474 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 8
      start_period: 60s
    networks:
      - backend-net

volumes:
  opensearch-data:
  neo4j_data:
  neo4j_logs:

networks:
  backend-net:
    driver: bridge
