# Backend infrastructure services (OpenSearch + Neo4j)
#
# Usage:
#   cd backend
#   cp .env.example .env   # optional (defaults are provided below)
#   docker compose up -d
#
# Notes:
# - This compose file is the single source of truth for backend infra.
# - Python services (uv/FastAPI) run on the host and connect via localhost ports.

services:
  opensearch:
    image: opensearchproject/opensearch:latest
    container_name: opensearch
    environment:
      - discovery.type=single-node
      - OPENSEARCH_INITIAL_ADMIN_PASSWORD=${OPENSEARCH_INITIAL_ADMIN_PASSWORD:-OpenSearch@2024!Dev}
      - OPENSEARCH_JAVA_OPTS=${OPENSEARCH_JAVA_OPTS:--Xms512m -Xmx512m}
    ports:
      - "9200:9200"
      - "9600:9600"
    volumes:
      - opensearch-data:/usr/share/opensearch/data
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -k -s -u admin:${OPENSEARCH_INITIAL_ADMIN_PASSWORD:-OpenSearch@2024!Dev} https://localhost:9200/_cluster/health > /dev/null || exit 1",
        ]
      interval: 30s
      timeout: 10s
      retries: 8
      start_period: 60s
    networks:
      - backend-net

  neo4j:
    image: neo4j:5
    container_name: neo4j
    ports:
      - "7474:7474" # browser
      - "7687:7687" # bolt
    environment:
      - NEO4J_AUTH=${NEO4J_AUTH:-neo4j/password}
      - NEO4J_server_memory_pagecache_size=${NEO4J_server_memory_pagecache_size:-1G}
      - NEO4J_server_memory_heap_initial__size=${NEO4J_server_memory_heap_initial__size:-1G}
      - NEO4J_server_memory_heap_max__size=${NEO4J_server_memory_heap_max__size:-1G}
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:7474 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 8
      start_period: 60s
    networks:
      - backend-net

  python:
    image: python:3.12-slim
    container_name: backend-python
    working_dir: /app
    volumes:
      - .:/app
    environment:
      # Neo4j 连接配置
      # 注意: NEO4J_PASSWORD 默认值为 "password"，与 NEO4J_AUTH 默认值 "neo4j/password" 匹配
      # 如果修改了 NEO4J_AUTH，请相应设置 NEO4J_PASSWORD 环境变量
      - NEO4J_URI=${NEO4J_URI:-bolt://neo4j:7687}
      - NEO4J_USER=${NEO4J_USER:-neo4j}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-password}
      # LLM 配置（DeepSeek）
      # 注意: DEEPSEEK_API_KEY 应该通过 .env 文件或环境变量设置，不要硬编码在配置文件中
      # 获取 API Key: https://platform.deepseek.com/api_keys
      - LLM_PROVIDER=${LLM_PROVIDER:-mock}
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY:-}
      - DEEPSEEK_BASE_URL=${DEEPSEEK_BASE_URL:-https://api.deepseek.com/v1}
      - DEEPSEEK_MODEL=${DEEPSEEK_MODEL:-deepseek-chat}
      - LLM_TIMEOUT=${LLM_TIMEOUT:-30.0}
      - LLM_MAX_RETRIES=${LLM_MAX_RETRIES:-2}
    depends_on:
      neo4j:
        condition: service_healthy
    networks:
      - backend-net
    # 保持容器运行，用于交互式调试
    command: tail -f /dev/null

volumes:
  opensearch-data:
  neo4j_data:
  neo4j_logs:

networks:
  backend-net:
    driver: bridge
