# Docker Compose 配置（OpenSearch + Neo4j）
# 
# 注意：此文件已合并到项目根目录的 docker-compose.yml
# 建议使用项目根目录的统一配置：
#   cd <project-root>
#   docker compose up -d
#
# 如果只想在此目录使用，可以：
#   docker compose -f docker-compose.yml up -d

version: '3.8'

services:
  opensearch:
    image: opensearchproject/opensearch:latest
    container_name: opensearch
    env_file:
      - .env
    environment:
      - discovery.type=single-node
      - OPENSEARCH_INITIAL_ADMIN_PASSWORD=${OPENSEARCH_INITIAL_ADMIN_PASSWORD:-OpenSearch@2024!Dev}
      - OPENSEARCH_JAVA_OPTS=${OPENSEARCH_JAVA_OPTS:--Xms512m -Xmx512m}
    ports:
      - "9200:9200"
      - "9600:9600"
    volumes:
      - opensearch-data:/usr/share/opensearch/data
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    networks:
      - opensearch-net
  neo4j:
    image: neo4j:5
    container_name: neo4j
    env_file:
      - .env
    ports:
      - "7474:7474"   # browser
      - "7687:7687"   # bolt
    environment:
      - NEO4J_AUTH=${NEO4J_AUTH:-neo4j/password}
      - NEO4J_server_memory_pagecache_size=${NEO4J_server_memory_pagecache_size:-1G}
      - NEO4J_server_memory_heap_initial__size=${NEO4J_server_memory_heap_initial__size:-1G}
      - NEO4J_server_memory_heap_max__size=${NEO4J_server_memory_heap_max__size:-1G}
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:7474 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    networks:
      - opensearch-net

volumes:
  opensearch-data:
  neo4j_data:
  neo4j_logs:

networks:
  opensearch-net:
    driver: bridge
