# 一键编排

本文件给出靶场在单机上的固定启动顺序、固定命令与固定停机顺序，确保演示时“可启动、可验证、可重置”。

## 0. 固定变量

本文件命令默认在靶场宿主机执行，并使用以下固定变量：

```bash
export BASE=/home/ubuntu/attack-trace-analyzer
export REPO="$BASE"/repo/attack-trace-analyzer
```

## 1. 启动顺序（固定）

启动顺序固定为：

1. 启动中心机依赖（OpenSearch、Neo4j）
2. 启动 C2（macvlan 独立 IP）
3. 启动 4 套客户机采集栈（client-01..04）
4. 启动中心机后端（FastAPI）
5. 启动中心机前端（Next.js）
6. 注册 4 个客户机到中心机
7. 按验证清单执行一次闭环验证

## 2. 启动命令（固定）

### 2.1 启动中心机依赖（OpenSearch、Neo4j）

```bash
cd "$REPO"/backend
docker-compose up -d
```

### 2.2 启动 C2（DNS+HTTP）

按 `93-C2部署与证据点.md` 完成部署。该部署包含：

1. 创建 Docker macvlan 网络 `c2-macvlan`
2. 创建宿主机 `macvlan0` 并添加两条 `/32` 路由
3. 启动 `c2-dns` 与 `c2-http` 两个容器

### 2.3 启动 4 套客户机采集栈（client-01..04）

#### 2.3.1 准备 4 个实例运行目录（固定）

```bash
mkdir -p "$BASE"/run/client-{01,02,03,04}/data
```

#### 2.3.2 为每个实例放置 docker-compose.yml 与源码软链接（固定）

```bash
for i in 01 02 03 04; do
  cp "$REPO"/client/docker-compose.yml "$BASE"/run/client-$i/docker-compose.yml
  ln -snf "$REPO"/client/sensor "$BASE"/run/client-$i/sensor
  ln -snf "$REPO"/client/backend "$BASE"/run/client-$i/backend
done
```

#### 2.3.3 为每个实例写入 .env（固定）

```bash
cat > "$BASE"/run/client-01/.env <<'EOF'
CLIENT_API_PORT=18881
HOST_ID=h-client-01
HOST_NAME=victim-01
SURICATA_INTERFACE=macvlan0
EOF

cat > "$BASE"/run/client-02/.env <<'EOF'
CLIENT_API_PORT=18882
HOST_ID=h-client-02
HOST_NAME=victim-02
SURICATA_INTERFACE=macvlan0
EOF

cat > "$BASE"/run/client-03/.env <<'EOF'
CLIENT_API_PORT=18883
HOST_ID=h-client-03
HOST_NAME=victim-03
SURICATA_INTERFACE=macvlan0
EOF

cat > "$BASE"/run/client-04/.env <<'EOF'
CLIENT_API_PORT=18884
HOST_ID=h-client-04
HOST_NAME=victim-04
SURICATA_INTERFACE=macvlan0
EOF
```

#### 2.3.4 启动 4 个实例（固定）

```bash
for i in 01 02 03 04; do
  cd "$BASE"/run/client-$i
  docker-compose up -d --build
done
```

### 2.4 启动中心机后端（FastAPI）

在一个独立终端执行：

```bash
cd "$REPO"/backend
export OPENSEARCH_NODE="https://localhost:9200"
export OPENSEARCH_USERNAME="admin"
export OPENSEARCH_PASSWORD="OpenSearch@2024!Dev"
export OPENSEARCH_URL="https://localhost:9200"
export OPENSEARCH_USER="admin"
export NEO4J_URI="bolt://localhost:7687"
export NEO4J_USER="neo4j"
export NEO4J_PASSWORD="password"
uv sync
uv run uvicorn main:app --host 0.0.0.0 --port 8000
```

### 2.5 启动中心机前端（Next.js）

在另一个独立终端执行：

```bash
cd "$REPO"/frontend
npm ci
npm run dev -- -H 0.0.0.0 -p 3000
```

### 2.6 注册 4 个客户机到中心机（固定）

```bash
curl -sS -X POST "http://localhost:8000/api/v1/clients/register" \
  -H "Content-Type: application/json" \
  -d '{"client_id":"client-01","client_version":"0.1.0","listen_url":"http://10.92.35.13:18881","host":{"id":"h-client-01","name":"victim-01"},"capabilities":{"filebeat":true,"falco":true,"suricata":true}}'

curl -sS -X POST "http://localhost:8000/api/v1/clients/register" \
  -H "Content-Type: application/json" \
  -d '{"client_id":"client-02","client_version":"0.1.0","listen_url":"http://10.92.35.13:18882","host":{"id":"h-client-02","name":"victim-02"},"capabilities":{"filebeat":true,"falco":true,"suricata":true}}'

curl -sS -X POST "http://localhost:8000/api/v1/clients/register" \
  -H "Content-Type: application/json" \
  -d '{"client_id":"client-03","client_version":"0.1.0","listen_url":"http://10.92.35.13:18883","host":{"id":"h-client-03","name":"victim-03"},"capabilities":{"filebeat":true,"falco":true,"suricata":true}}'

curl -sS -X POST "http://localhost:8000/api/v1/clients/register" \
  -H "Content-Type: application/json" \
  -d '{"client_id":"client-04","client_version":"0.1.0","listen_url":"http://10.92.35.13:18884","host":{"id":"h-client-04","name":"victim-04"},"capabilities":{"filebeat":true,"falco":true,"suricata":true}}'
```

每次注册成功必须返回 `status="ok"`。

## 3. 停机顺序（固定）

停机顺序固定为：

1. 停止前端（运行 `npm run dev` 的终端按 `Ctrl+C`）
2. 停止后端（运行 `uvicorn` 的终端按 `Ctrl+C`）
3. 停止 4 套客户机采集栈
4. 停止 C2
5. 停止中心机依赖（OpenSearch、Neo4j）

对应命令（固定）：

```bash
for i in 01 02 03 04; do
  cd "$BASE"/run/client-$i
  docker-compose down
done

docker rm -f c2-dns c2-http || true

cd "$REPO"/backend
docker-compose down
```

## 4. 下一步

验证与证据点检查清单见：

- `94-验证清单.md`
