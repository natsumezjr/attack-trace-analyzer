# 一键编排

本文件给出靶场在单机上的固定启动顺序、固定命令与固定停机顺序，确保演示时“可启动、可验证、可重置”。

## 1. 启动顺序（固定）

启动顺序固定为：

1. 启动中心机依赖（OpenSearch、Neo4j）
2. 启动 C2（macvlan 独立 IP）
3. 启动客户机采集栈
4. 启动中心机后端（FastAPI）
5. 启动中心机前端（Next.js）
6. 注册客户机到中心机
7. 按验证清单执行一次闭环验证

## 2. 启动命令（固定）

所有命令均在仓库根目录执行。

### 2.1 启动中心机依赖（OpenSearch、Neo4j）

```bash
cd backend
docker compose up -d
```

### 2.2 启动 C2（DNS+HTTP）

```bash
cd deploy/c2
docker compose up -d
```

### 2.3 启动客户机采集栈

```bash
cd client
docker compose up -d --build
```

### 2.4 启动中心机后端（FastAPI）

在一个独立终端执行：

```bash
cd backend
export OPENSEARCH_NODE="https://localhost:9200"
export OPENSEARCH_USERNAME="admin"
export OPENSEARCH_PASSWORD="OpenSearch@2024!Dev"
export OPENSEARCH_URL="https://localhost:9200"
export OPENSEARCH_USER="admin"
export NEO4J_URI="bolt://localhost:7687"
export NEO4J_USER="neo4j"
export NEO4J_PASSWORD="password"
export CENTER_RUN_ANALYSIS_EACH_TICK="1"
uv sync
uv run uvicorn main:app --host 0.0.0.0 --port 8000
```

### 2.5 启动中心机前端（Next.js）

在另一个独立终端执行：

```bash
cd frontend
npm ci
npm run dev -- -H 0.0.0.0 -p 3000
```

### 2.6 注册客户机到中心机

```bash
curl -sS -X POST "http://localhost:8000/api/v1/clients/register" \
  -H "Content-Type: application/json" \
  -d '{
    "client_id": "client-01",
    "client_version": "0.1.0",
    "listen_url": "http://10.92.35.13:8888",
    "host": {"id": "h-10.92.35.13", "name": "client-01"},
    "capabilities": {"filebeat": true, "falco": true, "suricata": true}
  }'
```

注册成功必须返回 `status="ok"`。

## 3. 停机顺序（固定）

停机顺序固定为：

1. 停止前端（运行 `npm run dev` 的终端按 `Ctrl+C`）
2. 停止后端（运行 `uvicorn` 的终端按 `Ctrl+C`）
3. 停止客户机采集栈
4. 停止 C2
5. 停止中心机依赖（OpenSearch、Neo4j）

对应命令（固定）：

```bash
cd client
docker compose down

cd ../deploy/c2
docker compose down

cd ../../backend
docker compose down
```

## 4. 下一步

验证与证据点检查清单见：

- `94-验证清单.md`
