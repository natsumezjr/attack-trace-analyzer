# 验证清单

本文件把靶场验收拆成 4 个必须通过的检查段落：网络、采集、中心机入库、证据点。每一项都给出固定命令与固定通过标准。

## 0. 固定变量

本文件命令默认在靶场宿主机执行，并使用以下固定变量：

```bash
export BASE=/home/ubuntu/attack-trace-analyzer
export REPO="$BASE"/repo/attack-trace-analyzer
```

## 1. 网络连通性（必须）

### 1.1 中心机端口（center-01）

在宿主机执行：

```bash
ss -lntup | egrep ':(9200|9600|7474|7687|8000|3000)\\b' || true
```

通过标准（固定）：

- 端口 `9200`、`9600`、`7474`、`7687`、`8000`、`3000` 均处于监听状态。

### 1.2 客户机端口（client-01..04）

在宿主机执行：

```bash
ss -lntup | egrep ':(18881|18882|18883|18884)\\b' || true
```

通过标准（固定）：

- 端口 `18881`、`18882`、`18883`、`18884` 均处于监听状态。

### 1.3 后端健康检查

```bash
curl -sS http://localhost:8000/health
```

通过标准（固定）：

```json
{"status":"ok"}
```

### 1.4 OpenSearch 健康检查

```bash
curl -k -sS -u admin:OpenSearch@2024!Dev https://localhost:9200/_cluster/health
```

通过标准（固定）：

- 输出包含字段 `status`，其值为 `yellow` 或 `green`。

### 1.5 C2 健康检查

按 `93-C2部署与证据点.md` 的第 7 节执行 DNS、HTTP 与抓包验证，通过即为 C2 可用。

## 2. 采集链路（必须）

### 2.1 客户机拉取接口（四实例）

在宿主机执行：

```bash
for p in 18881 18882 18883 18884; do
  echo "== client api :$p =="
  curl -s "http://10.92.35.13:$p/filebeat" | python3 -c "import sys,json; print('filebeat total=', json.load(sys.stdin).get('total'))"
  curl -s "http://10.92.35.13:$p/falco"    | python3 -c "import sys,json; print('falco total=',   json.load(sys.stdin).get('total'))"
  curl -s "http://10.92.35.13:$p/suricata" | python3 -c "import sys,json; print('suricata total=',json.load(sys.stdin).get('total'))"
done
```

通过标准（固定）：

- 对 4 个实例的 3 个接口均返回 JSON；
- 每个返回体包含 `total` 字段；
- 执行一次证据动作后，至少一个实例的 `suricata total` 大于 0。

## 3. 中心机入库与查询（必须）

### 3.1 客户机注册表可见

```bash
curl -sS http://localhost:8000/api/v1/clients | grep -n 'client-0' || true
```

通过标准（固定）：

- 返回 `status="ok"`；
- 返回结果中包含 `client-01`、`client-02`、`client-03`、`client-04`；
- 对每个客户端，`poll.status` 最终变为 `ok` 或 `partial`。

### 3.2 Telemetry 入库可查询

执行一次证据动作（见第 4 节）后等待 10 秒，再执行：

```bash
curl -sS -X POST http://localhost:8000/api/v1/events/search \
  -H "Content-Type: application/json" \
  -d '{"size": 10, "offset": 0, "sort_order": "desc"}' | grep -n '\"total\"'
```

通过标准（固定）：

- 返回 `status="ok"`；
- `total` 大于 0。

### 3.3 Findings 入库可查询

```bash
curl -sS -X POST http://localhost:8000/api/v1/findings/search \
  -H "Content-Type: application/json" \
  -d '{"stage":"raw","size": 10, "offset": 0, "sort_order": "desc"}' | grep -n '\"total\"'
```

通过标准（固定）：

- 返回 `status="ok"`；
- `total` 大于 0。

## 4. 证据点（必须）

证据点固定由两条命令产生（见 `93-C2部署与证据点.md`）：

1. DNS：`dig @10.92.35.50 c2.lab.local +short`
2. HTTP：`curl -s http://10.92.35.51/health && echo`

通过标准（固定）：

- `"$BASE/run/client-01/data/eve.json"` 文件存在且文件大小大于 0；
- `http://10.92.35.13:18881/suricata` 返回 `total>0`；
- 中心机入库后，`/api/v1/events/search` 的 `total` 增加。

## 5. 截图与录像证据（必须）

本项目固定产出以下截图/输出，用于 PPT 与录像：

- `ss -lntup` 的端口监听输出
- DNS 解析输出：`c2.lab.local -> 10.92.35.51`
- HTTP 访问输出：`/health -> ok`
- `GET /suricata` 的 `total>0`
- `POST /api/v1/events/search` 返回 `status="ok"` 且 `total>0`
