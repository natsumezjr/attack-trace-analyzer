# 测试分析报告

## 文档目的

本文件记录本项目测试环境、测试策略、用例覆盖、测试结果与缺陷修复情况，作为课程交付的测试分析报告。

## 读者对象

- 老师与助教
- 团队内部测试负责人

## 引用关系

- 验收用例：`../20-需求与验收/21-验收标准与验收用例.md`
- 测试用例明细：`97-测试用例与结果明细.md`

## 1. 测试环境

### 1.1 硬件与系统

- 设备：MacBook Air（Apple M4，32 GB 内存）
- 系统：macOS 26.1（Build 25B78），架构 arm64
- 时间基准：中心机入库与索引按 UTC 天滚动，前端展示按本地时区渲染

### 1.2 依赖与基础软件版本

- Docker：28.3.3
- Docker Compose：v2.39.2
- 后端运行时：Python 3.12.12（uv 环境），uv 0.9.18
- 前端运行时：Node.js v25.2.1，pnpm 10.18.2
- OpenSearch：3.0.0（`https://localhost:9200`）
- Neo4j：5.15.0（`http://localhost:7474`，`bolt://localhost:7687`）

### 1.3 测试入口与环境开关

- 自动化测试入口固定为：在 `backend/` 目录执行 `uv run pytest`
- 环境开关固定为：
  - `RUN_OPENSEARCH_TESTS=1`：启用 OpenSearch 相关用例
  - `RUN_NEO4J_TESTS=0`：跳过 Neo4j 相关用例
  - `KEEP_NEO4J_TEST_DATA=0`：测试结束清理 Neo4j 测试数据

### 1.4 本次测试执行时间

本报告记录的自动化测试结果执行时间固定为：

- 2026-01-15T07:25:57+08:00（UTC+08:00）

## 2. 测试策略

### 2.1 分层策略

本项目测试按“自底向上”的分层策略组织，覆盖从数据入库到告警融合、再到图谱入库与溯源分析的关键链路：

1. 单元测试（unit）：验证核心函数与模块边界，保证算法与数据口径稳定
2. 集成测试（integration）：验证 OpenSearch 与 Neo4j 交互，保证存储、查询与去重流程可运行
3. 系统测试（system）：按业务闭环验证端到端流程，保证“入库→融合→查询”可复现
4. 验收测试（acceptance）：严格按 `../20-需求与验收/21-验收标准与验收用例.md` 与 `../20-需求与验收/22-攻击场景与复现剧本.md` 执行，证据点与截图口径按 `../10-交付与答辩/14-录像与截图清单.md` 固化

### 2.2 测试数据策略

测试数据分为两类：

- 自动化测试数据：由 `backend/tests/opensearch/test_utils.py` 构造固定结构事件与告警，确保字段口径与边界条件覆盖
- 验收复现数据：由 `../20-需求与验收/22-攻击场景与复现剧本.md` 产出多源证据，确保现场演示稳定输出

### 2.3 隔离与可复现策略

- OpenSearch：每条用例开始前清理近 7 日索引（见 `backend/tests/opensearch/conftest.py`），保证跨次运行无污染
- Neo4j：当 `KEEP_NEO4J_TEST_DATA=0` 时，测试用例结束后清理写入的测试节点与边
- 时间口径：测试用例与索引日期统一使用 UTC，避免跨时区导致的索引名漂移

## 3. 覆盖范围

### 3.1 自动化测试覆盖模块

自动化测试集中覆盖中心机后端核心模块：

- OpenSearch：索引管理、入库去重、告警融合、增量处理（`backend/tests/opensearch/`）
- Neo4j 图谱：ECS→Graph 入库、节点与边模型、图查询工具（`backend/tests/graph/`）
- 溯源分析：FSA 构建、候选子图与 LLM 选择回退路径（`backend/tests/services/analyze/`）

### 3.2 与验收需求的对应关系

自动化测试与验收用例的对应关系以“闭环能力”为主：

- 覆盖 AC-02、AC-03（OpenSearch 入库与告警融合）
- 覆盖 AC-04（图谱查询结果可生成）
- 覆盖 AC-05、AC-06、AC-07 的后端关键组件（任务状态机、结果结构与写回字段口径）

多节点轮询、前端交互与导出材料的完整展示在验收用例中按固定步骤执行，并以截图与录像作为证据。

## 4. 测试结果

### 4.1 自动化测试结果汇总

| 测试集 | 运行命令 | 结果 | 用时 |
|---|---|---|---|
| 后端快速回归（跳过 Neo4j） | `cd backend && RUN_NEO4J_TESTS=0 uv run pytest -q` | 121 passed，62 skipped | 0.20s |
| 后端全量测试（OpenSearch + Neo4j） | `cd backend && RUN_OPENSEARCH_TESTS=1 RUN_NEO4J_TESTS=1 KEEP_NEO4J_TEST_DATA=0 uv run pytest -q` | 182 passed，1 skipped | 196.58s |

跳过用例明细：

- `tests/opensearch/test_system_opensearch.py:362`：需要 mock OpenSearch 连接（用例用于断连场景验证，当前以跳过方式记录）

### 4.2 重要结论

- OpenSearch、Neo4j 相关测试全量通过，核心闭环链路可复现
- 回退路径与异常分支通过单元测试覆盖，保证在 LLM 不可用或输出不合规时仍能产出结果

## 5. 缺陷与修复记录

本节记录本次文档体系重构期间，测试暴露出的关键问题与对应修复：

### 缺陷-001 OpenSearch 索引日期口径不一致导致测试污染

- 现象：同一套用例在 UTC 与本地时区交界时生成不同日期索引，导致索引清理失效与跨次污染
- 修复：统一测试与索引命名使用 UTC，并在每条用例开始前清理近 7 日索引
- 影响：OpenSearch 相关用例稳定通过，跨次运行结果一致

### 缺陷-002 增量状态字段缺少明确映射导致 term 查询失效

- 现象：`custom.finding.detector_id` 未在 mapping 中显式声明，term 查询无法稳定命中
- 修复：在 OpenSearch mapping 中补齐 `custom.finding.detector_id` 为 `keyword`
- 影响：增量处理相关辅助函数可正确返回上次处理时间戳

### 缺陷-003 OpenSearch 增量测试用例误用 fixture 参数

- 现象：测试用例把 `initialized_indices` 当作 client 传入，导致 `_get_last_processed_timestamp` 永远返回空
- 修复：统一使用 `opensearch_client` 作为调用参数，并保留 `initialized_indices` 负责索引初始化
- 影响：增量相关用例稳定通过

## 6. 结论

1. 自动化测试全量通过，OpenSearch 与 Neo4j 的核心链路具备可复现性与稳定性
2. 验收测试按固定剧本与验收用例执行，证据点口径在文档中固化，满足课程交付对“可演示、可解释、可复现”的要求
