# 攻击场景与复现剧本

## 文档目的

本文件定义用于验收与演示的固定攻击复现剧本，明确每一步的攻击动作、产生的证据类型、以及在系统中的预期可观测输出。

## 读者对象

- 靶场负责人（负责复现与证据准备）
- 负责演示的同学（用于讲述与现场操作）
- 测试负责人（用于验收用例复用）

## 引用关系

- 验收用例：`21-验收标准与验收用例.md`
- 运维与靶场：`../90-运维与靶场/91-靶场部署.md`、`../90-运维与靶场/92-一键编排.md`
- 字段口径：`../80-规范/81-ECS字段规范.md`

## 1. 靶场角色与前置条件

### 1.1 节点角色

本剧本使用以下节点角色（名称固定）：

- `center`：中心机
- `client-01`：受害主机 1
- `client-02`：受害主机 2
- `client-03`：受害主机 3
- `client-04`：受害主机 4
- `c2`：命令与控制服务器

### 1.2 前置条件

1. 上述节点全部启动并在线，中心机注册表中可见全部客户机。
2. 客户机侧采集链路正常：Falco、Filebeat、Suricata 均在运行。
3. 轮询与分析链路已启用：中心机能够周期性拉取并写入存储。

## 2. 攻击阶段与动作序列

本剧本固定为 6 个阶段，按顺序执行，不允许跳步。

### 阶段 1 初始访问

**动作**

在 `client-01` 上完成一次远程登录进入系统。

**预期证据**

- Filebeat：认证日志事件（登录成功）

**系统预期输出**

- OpenSearch Telemetry 中出现 `event.dataset="hostlog.auth"` 的事件

### 阶段 2 执行与落地

**动作**

在 `client-01` 上执行命令行程序并产生进程行为。

**预期证据**

- Falco：进程执行事件

**系统预期输出**

- OpenSearch Telemetry 中出现 `event.dataset="hostbehavior.syscall"` 的事件

### 阶段 3 发现与环境探测

**动作**

在 `client-01` 上执行系统信息查询与网络探测类命令。

**预期证据**

- Falco：进程执行序列
- Filebeat：命令或系统日志事件

**系统预期输出**

- Telemetry 中出现连续的进程执行事件，时间轴可复现

### 阶段 4 命令与控制

**动作**

在 `client-01` 与 `c2` 之间建立 DNS 与 HTTP 通信。

**预期证据**

- Suricata：DNS 查询与 HTTP 请求事件

**系统预期输出**

- Telemetry 中出现 `event.dataset="netflow.dns"` 与 `event.dataset="netflow.http"` 的事件
- 若告警规则启用，Raw Findings 中出现与 DNS 隧道或异常 HTTP 相关的告警

### 阶段 5 横向移动

**动作**

从 `client-01` 访问 `client-02` 并执行远程命令或建立远程会话。

**预期证据**

- Filebeat：认证或登录日志
- Suricata：网络连接事件
- Falco：远程执行带来的进程行为

**系统预期输出**

- 图谱中出现跨主机关联的边，时间窗查询可见

### 阶段 6 数据外传

**动作**

从 `client-02` 向 `c2` 发起数据传输。

**预期证据**

- Suricata：HTTP 传输与流量统计

**系统预期输出**

- Telemetry 中出现可回溯的流量与会话事件
- 溯源任务可在图上选择相关节点生成关键路径边

## 3. 证据点与预期输出

本节给出“从动作到系统输出”的固定对应关系：

| 阶段 | 数据源 | 事件类型 | ECS dataset 口径 |
|---|---|---|---|
| 初始访问 | Filebeat | 登录成功 | `hostlog.auth` |
| 执行与落地 | Falco | 进程执行 | `hostbehavior.syscall` |
| C2 通信 | Suricata | DNS 与 HTTP | `netflow.dns`、`netflow.http` |

详细字段要求见：`../80-规范/81-ECS字段规范.md`。

## 4. 复现后的验收关联

本剧本执行完成后，按以下顺序执行验收：

1. `AC-01` 到 `AC-03` 验证采集、入库、告警
2. `AC-04` 验证图查询
3. `AC-05` 到 `AC-07` 验证溯源任务与相似度输出
4. `AC-08` 验证报告导出

