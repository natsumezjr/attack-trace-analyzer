# 需求分析报告

## 文档目的

本文件定义本项目在课程交付场景下的需求范围、边界与验收目标，给出功能需求（FR）与非功能需求（NFR）的编号体系，供验收用例、演示脚本与测试报告引用。

## 读者对象

- 老师与助教
- 项目成员（用于对齐实现边界）
- 测试与运维负责人（用于对齐验收口径）

## 引用关系

- 验收标准与验收用例：`21-验收标准与验收用例.md`
- 安装使用与靶场：`../90-运维与靶场/90-编译安装与使用.md`
- 字段口径（权威）：`../80-规范/81-ECS字段规范.md`
- 告警口径（权威）：`../80-规范/83-告警数据规范.md`
- 图谱口径（权威）：`../80-规范/84-Neo4j实体图谱规范.md`
- 接口口径（权威）：`../80-规范/87-客户机与中心机接口.md`、`../80-规范/88-前端与中心机接口.md`

## 1. 背景与目标

课程设计要求基于**主机日志、主机行为、网络流量**等多源数据完成攻击检测、关联与溯源，并在不少于 **5 个节点**的靶场环境中验证。

本系统的目标是把多源事件统一为同一套字段口径（ECS 子集），并完成：

1. 数据汇聚：把分散在多台主机上的多源事件集中到中心机；
2. 检测产出：通过 Store-first 检测产生 Findings，并把多源重复告警融合为 Canonical；
3. 图谱建模：把 Canonical Findings 与必要的 Telemetry 转换为实体关系图，写入 Neo4j；
4. 可视化：前端通过后端请求 Neo4j 查询图，并渲染展示；
5. 溯源：对老师指定的节点触发异步溯源任务，任务完成后把结果写回 Neo4j 的边属性，供后续查询与报告使用。

本需求分析报告只定义“系统必须具备的能力与验收口径”。字段、接口与图谱等权威口径不在本文件重复，统一引用规范文档。

## 2. 范围与边界

### 2.1 范围内

- 多源数据来源固定为：
  - Filebeat（主机系统日志）
  - Falco（主机行为与告警）
  - Suricata（网络流量与告警）
- 客户机侧必须提供**本地缓冲**与**中心机拉取接口**，保证中心机短暂不可用时数据不丢失。
- 中心机侧必须提供“单定时器一条龙”的定时流水线，按固定顺序完成：
  1) 从客户机拉取新数据  
  2) 写入 OpenSearch（字段处理）  
  3) Store-first 检测 + Raw Findings 融合去重生成 Canonical Findings，写回 OpenSearch  
  4) 触发（Canonical + 补充 Telemetry）ECS→Graph 写入 Neo4j
- 中心机侧必须提供面向前端的 API：事件检索、告警检索、图查询、溯源任务创建与状态查询。
- 靶场验证必须覆盖不少于 5 个节点，并能解释每一类证据来自哪一类数据源。

### 2.2 范围外

- 全量系统调用入库与长期保存（以 Falco 规则与高价值事件为主，不做全量 syscall 采集入库）。
- 深度内存取证与离线镜像分析。
- 多租户、账号体系、复杂鉴权体系（系统面向课程演示，默认单用户使用）。
- 在线外部情报查询（中心机运行时不依赖公网；TTP 知识库采用离线 CTI 数据包）。

## 3. 术语与定义

- **Telemetry**：事实事件（`event.kind="event"`），描述“发生了什么”，不做善恶判断。
- **Raw Finding**：原始告警（`event.kind="alert"` 且 `event.dataset!="finding.canonical"`），来自传感器或检测引擎。
- **Canonical Finding**：规范告警（`event.kind="alert"` 且 `event.dataset="finding.canonical"`），由中心机融合去重生成，作为后续图谱与溯源的主输入。
- **Entity Graph**：实体关系图（Neo4j），节点/边规范见 `../80-规范/84-Neo4j实体图谱规范.md`。
- **Trace Task**：溯源任务。由前端触发创建，后台异步执行，执行结果写回 Neo4j 边属性，便于后续查询。

## 4. 角色与使用场景

### 4.1 角色

- **分析员/老师（统一角色）**：通过前端界面查看告警与图谱，触发溯源任务，查看任务结果并导出报告。

### 4.2 典型场景

1) 在靶场中产生多源事件（日志/行为/流量）。  
2) 中心机定时流水线自动汇聚、检测、融合、入图。  
3) 老师打开前端，查看当前图谱与告警。  
4) 老师在图上选择一个节点，触发溯源任务并等待完成。  
5) 老师再次查询该节点，看到边上附带的溯源与解释结果，并导出报告材料。

## 5. 功能需求（FR）

> 编号用于测试用例、演示脚本与文档互相引用。

### FR-01 多源数据采集接入

- 系统必须接入三类数据源：Filebeat、Falco、Suricata。
- 系统必须在不少于 5 个节点的环境中运行，并能汇聚所有节点的数据到中心机。

### FR-02 统一字段与时间口径

- 系统必须把所有进入中心机的数据统一为 ECS 子集字段口径，并满足 `../80-规范/81-ECS字段规范.md` 的要求。
- 系统必须为每条入库文档生成或补齐 `event.id`，并以 `event.id` 作为幂等去重键。
- 系统必须保证三时间字段存在（`@timestamp`、`event.created`、`event.ingested`），并以 `@timestamp` 作为全局排序与时间窗分析的主时间轴。

### FR-03 中心机定时流水线（单定时器一条龙）

- 中心机必须以固定周期运行同一个定时器，并在每次触发时按顺序执行以下四步：
  1) 拉取：从所有已注册客户机拉取“自上次游标以来”的新数据；
  2) 入库：把拉取到的数据写入 OpenSearch，并在写入前完成字段处理与校验；
  3) 检测与融合：触发 Store-first 检测产出 Raw Findings，并对 Raw Findings 融合去重生成 Canonical Findings，写回 OpenSearch；
  4) 入图：以 Canonical Findings 为主输入，并补充必要的 Telemetry，执行 ECS→Graph 写入 Neo4j。
- 流水线必须是幂等的：同一批数据重复拉取、重复执行，不得产生重复文档与不可控的重复边。

### FR-04 OpenSearch 检索与告警查询

- 后端必须提供按时间窗与主机维度检索 Telemetry 的查询接口。
- 后端必须提供按时间窗、主机、Technique 等维度检索 Findings 的查询接口，并区分 Raw 与 Canonical。

### FR-05 Neo4j 图查询（用于可视化）

- 后端必须提供面向前端的图查询接口，支持按时间窗获取边集合，并在需要时返回相关节点属性。
- 后端必须提供基于时间窗的最短路/路径查询能力，用于展示“从 A 到 B 的关键路径”。

### FR-06 节点溯源任务的创建与状态查询

- 后端必须提供创建溯源任务的接口：输入为“目标节点标识 + 时间窗”，输出为 `task_id`。
- 后端必须在创建任务后立即返回 `task_id`，并把任务放入后台异步执行队列。
- 后端必须提供任务状态查询接口：返回任务当前状态、进度、错误信息（如失败）与完成时间（如完成）。

### FR-07 溯源任务执行与结果写回

- Analysis 模块必须从 Neo4j 读取与目标节点相关的子图数据，并执行溯源分析算法。
- 溯源分析完成后，系统必须把结果写回 Neo4j 的边属性，形成可被后续查询直接读取的“已标注图”。

### FR-08 离线 TTP 相似度匹配

- 系统必须基于 Canonical Findings 中的 `threat.technique.id` 集合，计算与离线 ATT&CK Enterprise CTI 的 Intrusion Set 相似度，并输出 Top-3 候选组织及解释性 techniques。
- 离线 CTI 数据必须随项目交付，系统运行时不依赖外网。

### FR-09 报告导出

- 前端必须提供“报告导出”能力，报告至少包含：时间线摘要、关键图谱截图/数据、Technique 覆盖、溯源任务结果。
- 报告导出必须可复现：同一输入时间窗与同一数据集导出的报告内容一致。

## 6. 非功能需求（NFR）

### NFR-01 可追溯与可解释

- 任意图谱边、任意告警、任意溯源结论必须可回溯到对应的证据事件 `event.id`。

### NFR-02 幂等与一致性

- 中心机流水线必须以 `event.id` 作为全局幂等键，保证重复拉取与重复执行不产生重复文档。
- Neo4j 入图必须以 `../80-规范/84-Neo4j实体图谱规范.md` 的唯一键规则去重节点；边的去重规则必须写死在模块规格文档中。

### NFR-03 性能与响应

- 前端图查询接口必须在秒级返回满足可视化展示的图数据。
- 溯源任务允许长时间运行，但必须提供可被轮询的任务状态与进度。

### NFR-04 可复现

- 系统必须支持在同一组靶场复现同一攻击操作，并得到一致的检测与图谱结果（允许时间戳整体平移）。

### NFR-05 安全边界（课程演示）

- 系统不得在中心机侧运行未知样本。
- 系统默认运行在隔离靶场网络中，中心机对外暴露的接口仅面向靶场内访问。

## 7. 验收标准

验收以“可演示、可解释、可复现”为准，必须满足：

1. 在不少于 5 个节点环境中完成演示；
2. 能展示一条攻击链路的图谱证据，覆盖至少 3 个 ATT&CK 战术阶段；
3. 能在前端图上选定一个节点触发溯源任务，并在任务完成后展示写回边属性的结果；
4. 能导出报告材料，并在报告中解释每一步结论的证据来源（对应 `event.id` 与数据源类型）。
