# 文档体系重构计划

> 目标仓库：`davao/`  
> 本文件是本次“全量文档迁移与重写”的临时计划文档，用于约束目录结构、命名规则、文档边界与迁移映射。  
> 当全部正文完成并通过遗漏检查后，本文件是否保留由最终交付需要决定。

## 1. 重构目标

1. **满足课程交付要求**：提交包内必须包含任务分工说明、作品技术原理介绍、概要设计报告、详细设计报告、测试分析报告、程序编译和安装使用文档，以及 PPT 与截屏录像的产出清单与脚本。
2. **统一文档体系**：将当前分散在 `README.md`、`docs/`、`guide_docs/`、以及代码目录中的 Markdown 内容统一收敛到 `new-docs/`。
3. **消除重复与打架**：建立“单一信息源”规则，字段/接口/Schema 等权威口径集中在规范文档中，报告与设计文档只做引用。
4. **保证确定性**：文档中不出现“多方案、二选一、可选”等表述；所有默认值、边界条件、失败处理与回退行为必须写清且可复现。

## 2. 命名与路径规则

### 2.1 路径命名字符集

目录名与文件名仅允许出现：

- 数字 `0-9`
- 英文字母 `a-zA-Z`
- 汉字
- 连字符 `-`

扩展名统一为 `.md`。

### 2.2 编号规则

- 顶层目录使用编号前缀：`00-`、`10-`、`20-`、`30-`、`40-`、`50-`、`80-`、`90-`、`96-`、`98-`
- 子目录使用中文模块名，不再重复编号
- 文件名使用 `编号-主题.md`，主题只表达该文件独有内容，禁止重复“详细设计-前端-”这类目录信息

## 3. 文档信息架构与边界总则

### 3.1 四类文档与单一信息源

为避免内容重复，文档分为四类并严格分工：

1. **交付与答辩**：对齐老师要求、交付物结构、PPT 演示脚本、录像与截图清单。
2. **报告与设计**：需求分析、概要设计、详细设计、测试分析等“报告型文档”，强调叙事完整与可验收。
3. **规范**：字段、接口、索引、图谱、配置等“权威口径”，全仓库只允许在规范类文档里出现逐字段/逐条表格。
4. **运维与靶场**：编译安装、靶场部署、一键编排、验证清单、重置复现与排障等“操作型文档”。

规则：同一主题只允许一个权威文档；其他文档必须通过引用指向该权威文档，不复制大段内容。

### 3.2 LLM 使用的确定性约束

本项目允许在线调用 LLM，但文档必须定义明确的失败判定与回退策略：

- 当 LLM 配置缺失、调用失败、返回结构不合法时，系统必须执行固定的本地回退算法；
- 回退算法的输入、排序规则与同分处理规则必须写死；
- 测试报告必须覆盖 LLM 正常路径与回退路径。

## 4. 目录结构规划

```
new-docs/
  README.md
  assets/
  00-总览/
    00-文档索引.md
    01-术语与命名.md
    02-冲突与决议.md
    03-文档重构计划.md
  10-交付与答辩/
    10-课程设计要求与评分口径.md
    11-交付物清单与打包结构.md
    12-任务分工说明.md
    13-PPT大纲与演示脚本.md
    14-录像与截图清单.md
  20-需求与验收/
    20-需求分析报告.md
    21-验收标准与验收用例.md
    22-攻击场景与复现剧本.md
  30-技术原理/
    30-作品技术原理介绍.md
  40-概要设计/
    40-概要设计报告.md
    41-数据流与时序.md
    42-部署拓扑与网络规划.md
    43-非功能设计.md
  50-详细设计/
    客户机/
      50-总体.md
      51-Falco采集与ECS转换.md
      52-Suricata采集与ECS转换.md
      53-Filebeat采集与ECS转换.md
      54-RabbitMQ缓冲与队列语义.md
      55-拉取接口.md
    中心机/
      60-总体与代码结构.md
      61-注册与轮询.md
      62-OpenSearch存储与索引治理.md
      63-检测与告警融合.md
      64-Neo4j入图与图查询.md
      65-图谱回标与边属性.md
    分析/
      70-任务模型与状态机.md
      71-候选路径构造与评分.md
      72-LLM选择器与回退机制.md
      73-TTP相似度匹配.md
    前端/
      74-总体与页面结构.md
      75-图谱可视化与交互.md
      76-报告导出.md
  80-规范/
    80-数据对象与生命周期.md
    81-ECS字段规范.md
    82-OpenSearch索引与Mapping规范.md
    83-告警数据规范.md
    84-Neo4j实体图谱规范.md
    85-溯源结果写回规范.md
    86-接口全局约定.md
    87-客户机与中心机接口.md
    88-前端与中心机接口.md
    89-环境变量与配置规范.md
  90-运维与靶场/
    90-编译安装与使用.md
    91-靶场部署.md
    92-一键编排.md
    93-C2部署与证据点.md
    94-验证清单.md
    95-重置复现与排障.md
  96-测试/
    96-测试分析报告.md
    97-测试用例与结果明细.md
  98-附录/
    98-参考资料与链接.md
```

## 5. 文档清单与写作边界

> 本节定义每份文档“写什么/不写什么”与二级标题大纲。迁移时以本节为准，避免重复与冲突。

### 00-总览

#### `00-总览/00-文档索引.md`
- 写：阅读路径、文档分层规则、权威口径规则、如何引用、如何提冲突。
- 不写：任何字段细表、接口细表、实现细节。
- 二级标题：
  - 文档阅读路径
  - 单一信息源规则
  - 文档更新流程
  - 冲突处理流程
  - 文档与代码的绑定点

#### `00-总览/01-术语与命名.md`
- 写：术语表、缩写表、命名约定（节点命名、索引命名、字段命名、目录命名）。
- 不写：任何模块设计细节。
- 二级标题：
  - 术语表
  - 缩写表
  - 命名约定
  - 编号与引用规则

#### `00-总览/02-冲突与决议.md`
- 写：冲突记录模板、冲突列表、决议与生效口径、决议影响范围。
- 不写：正文补丁解释。
- 二级标题：
  - 记录模板
  - 冲突列表
  - 决议与生效口径

### 10-交付与答辩

#### `10-交付与答辩/10-课程设计要求与评分口径.md`
- 写：老师要求、考核打分维度、提交截止时间地点、交付件清单的课程原文与项目内解释。
- 不写：系统设计与实现。
- 二级标题：
  - 课程题目与硬性约束
  - 交付物要求
  - 评分口径与对应材料
  - 时间与提交流程

#### `10-交付与答辩/11-交付物清单与打包结构.md`
- 写：提交包目录结构、文件命名、每一件材料对应本文档体系的路径、最终自检清单。
- 不写：需求与设计正文。
- 二级标题：
  - 提交包结构
  - 交付物与文档映射
  - PPT与录像产出规范
  - 最终自检清单

#### `10-交付与答辩/12-任务分工说明.md`
- 写：成员信息、分工与工作量占比、对应产出物与代码模块。
- 不写：技术方案细节。
- 二级标题：
  - 团队与角色
  - 任务分解与责任人
  - 工作量占比与依据
  - 产出物映射

#### `10-交付与答辩/13-PPT大纲与演示脚本.md`
- 写：PPT 页结构、每页要讲的要点、现场演示脚本（命令与预期画面）、演示失败兜底动作。
- 不写：逐字段规范表。
- 二级标题：
  - 10分钟讲述结构
  - 演示环境检查
  - 演示脚本
  - 演示证据点

#### `10-交付与答辩/14-录像与截图清单.md`
- 写：录像镜头清单、每个镜头必须出现的证据与截图命名、录制顺序与保存位置。
- 不写：系统设计细节。
- 二级标题：
  - 录像脚本
  - 截图清单
  - 证据命名规则

### 20-需求与验收

#### `20-需求与验收/20-需求分析报告.md`
- 写：背景、范围边界、角色、FR/NFR、验收目标。
- 不写：实现细节与字段全表（引用 80-规范）。
- 二级标题：
  - 背景与目标
  - 范围与边界
  - 术语与定义
  - 功能需求
  - 非功能需求
  - 验收目标

#### `20-需求与验收/21-验收标准与验收用例.md`
- 写：验收标准的可检查项与用例步骤，绑定到需求编号与演示脚本。
- 不写：系统设计与字段细表。
- 二级标题：
  - 验收总则
  - 用例清单
  - 用例步骤与证据
  - 失败判定与处理

#### `20-需求与验收/22-攻击场景与复现剧本.md`
- 写：固定攻击链剧本、每一步产生的证据类型、对应数据源与告警、对应图谱变化。
- 不写：部署与编排命令（引用 90-运维与靶场）。
- 二级标题：
  - 靶场角色与前置条件
  - 攻击阶段与动作序列
  - 证据点与预期输出
  - 复现后的验收关联

### 30-技术原理

#### `30-技术原理/30-作品技术原理介绍.md`
- 写：端到端原理：采集、ECS归一化、存储、检测融合、图谱建模、溯源分析、APT相似度、报告导出。
- 不写：逐字段/逐接口表（引用 80-规范）。
- 二级标题：
  - 多源采集与归一化
  - Storefirst检测与告警融合
  - 图谱建模与图查询
  - 溯源任务与算法
  - APT相似度计算
  - 报告导出原理

### 40-概要设计

#### `40-概要设计/40-概要设计报告.md`
- 写：总体架构、模块边界、关键流程、数据分层、对外接口边界。
- 不写：字段细表、接口细表（引用 80-规范）。
- 二级标题：
  - 总体架构
  - 模块划分与职责
  - 数据分层
  - 核心流程概述
  - 安全与边界

#### `40-概要设计/41-数据流与时序.md`
- 写：中心机流水线时序、前端查询链路、溯源任务状态机时序。
- 不写：实现代码结构细节（引用 50-详细设计）。
- 二级标题：
  - 端到端数据流
  - 中心机流水线时序
  - 前端查询时序
  - 溯源任务时序

#### `40-概要设计/42-部署拓扑与网络规划.md`
- 写：5节点靶场拓扑、网络段与端口、组件部署位置、访问边界。
- 不写：具体部署命令（引用 90-运维与靶场）。
- 二级标题：
  - 节点与角色
  - 网络与端口规划
  - 部署拓扑
  - 安全边界与隔离

#### `40-概要设计/43-非功能设计.md`
- 写：幂等、一致性、可解释、性能、稳定性与可复现的工程约束。
- 不写：测试结果（引用 96-测试）。
- 二级标题：
  - 幂等与去重
  - 一致性与回放
  - 可解释与证据链
  - 性能目标与容量边界
  - 稳定性与故障处理

### 50-详细设计（按模块拆分）

> 详细设计只写“实现结构与固定行为”，涉及字段/接口/Schema 的细表必须引用 80-规范。

#### `50-详细设计/客户机/50-总体.md`
- 二级标题：总体架构、组件清单、容器依赖、数据流、运行参数

#### `50-详细设计/客户机/51-Falco采集与ECS转换.md`
- 二级标题：采集输入、转换规则、eventid生成、队列投递、故障处理

#### `50-详细设计/客户机/52-Suricata采集与ECS转换.md`
- 二级标题：EVE输入、转换规则、网络字段、证据引用、故障处理

#### `50-详细设计/客户机/53-Filebeat采集与ECS转换.md`
- 二级标题：日志输入、解析规则、会话重建字段、证据引用、故障处理

#### `50-详细设计/客户机/54-RabbitMQ缓冲与队列语义.md`
- 二级标题：队列命名、消费语义、幂等与重复、断连与恢复、容量边界

#### `50-详细设计/客户机/55-拉取接口.md`
- 二级标题：接口清单、请求响应、游标与增量、错误码、重试策略

#### `50-详细设计/中心机/60-总体与代码结构.md`
- 二级标题：工程结构、生命周期、后台任务、路由组织、模块集成点

#### `50-详细设计/中心机/61-注册与轮询.md`
- 二级标题：注册表结构、注册流程、轮询调度、在线状态、游标推进

#### `50-详细设计/中心机/62-OpenSearch存储与索引治理.md`
- 二级标题：索引体系、写入路由、三时间字段、幂等写入、ISM与运维脚本

#### `50-详细设计/中心机/63-检测与告警融合.md`
- 二级标题：检测触发、Raw结构、融合指纹、Canonical生成、覆盖规则与审计

#### `50-详细设计/中心机/64-Neo4j入图与图查询.md`
- 二级标题：入图范围、节点边模型引用、写入幂等、时间窗查询、最短路

#### `50-详细设计/中心机/65-图谱回标与边属性.md`
- 二级标题：告警映射入图、溯源写回字段、覆盖规则、前端读取口径

#### `50-详细设计/分析/70-任务模型与状态机.md`
- 二级标题：任务文档、状态机、进度更新、失败语义、对外接口绑定

#### `50-详细设计/分析/71-候选路径构造与评分.md`
- 二级标题：输入子图、锚点定义、路径枚举、评分模型、同分处理

#### `50-详细设计/分析/72-LLM选择器与回退机制.md`
- 二级标题：输入裁剪、输出schema、校验、失败判定、回退算法

#### `50-详细设计/分析/73-TTP相似度匹配.md`
- 二级标题：CTI数据、特征抽取、相似度计算、Top3输出、可解释字段

#### `50-详细设计/前端/74-总体与页面结构.md`
- 二级标题：页面与路由、状态管理、API调用边界、数据缓存与刷新策略

#### `50-详细设计/前端/75-图谱可视化与交互.md`
- 二级标题：图查询请求、渲染模型、筛选与高亮、节点点选与任务触发

#### `50-详细设计/前端/76-报告导出.md`
- 二级标题：导出内容结构、数据来源、生成规则、可复现与审计

### 80-规范（权威口径）

#### `80-规范/80-数据对象与生命周期.md`
- 二级标题：对象定义、生命周期、存储边界、保留策略、回放与一致性

#### `80-规范/81-ECS字段规范.md`
- 二级标题：全局字段、Telemetry数据集、告警数据集、三时间字段、示例

#### `80-规范/82-OpenSearch索引与Mapping规范.md`
- 二级标题：索引清单、命名规则、mapping与模板、ISM策略、脚本入口

#### `80-规范/83-告警数据规范.md`
- 二级标题：Raw与Canonical结构、融合字段、指纹规则、证据引用规则

#### `80-规范/84-Neo4j实体图谱规范.md`
- 二级标题：节点类型与唯一键、边类型、边属性、约束与索引、抽取规则

#### `80-规范/85-溯源结果写回规范.md`
- 二级标题：analysis字段集合、覆盖规则、任务绑定、前端读取与过滤规则

#### `80-规范/86-接口全局约定.md`
- 二级标题：版本、鉴权、时间窗、分页、错误码、幂等与重试

#### `80-规范/87-客户机与中心机接口.md`
- 二级标题：注册、轮询拉取、游标语义、错误码、幂等保证

#### `80-规范/88-前端与中心机接口.md`
- 二级标题：事件查询、告警查询、图查询、任务创建与查询、导出接口

#### `80-规范/89-环境变量与配置规范.md`
- 二级标题：加载规则、变量清单、默认值、作用域、LLM配置与回退约束

### 90-运维与靶场

#### `90-运维与靶场/90-编译安装与使用.md`
- 二级标题：前置依赖、启动顺序、健康检查、常用操作、停机与清理

#### `90-运维与靶场/91-靶场部署.md`
- 二级标题：节点规划、网络配置、部署步骤、验证点、交付截图

#### `90-运维与靶场/92-一键编排.md`
- 二级标题：目录组织、启动停止、数据清空、重置、常见故障与修复

#### `90-运维与靶场/93-C2部署与证据点.md`
- 二级标题：C2组件、部署步骤、通信证据点、检测与图谱预期变化

#### `90-运维与靶场/94-验证清单.md`
- 二级标题：网络、采集、入库、告警、入图、溯源、导出证据清单

#### `90-运维与靶场/95-重置复现与排障.md`
- 二级标题：重置流程、复现节奏、排障表、证据定位方法

### 96-测试

#### `96-测试/96-测试分析报告.md`
- 二级标题：测试环境、测试策略、覆盖范围、缺陷与修复、结论

#### `96-测试/97-测试用例与结果明细.md`
- 二级标题：用例列表、步骤、期望结果、实际结果、证据链接与截图

### 98-附录

#### `98-附录/98-参考资料与链接.md`
- 写：引用的外部资料、标准文档、工具文档链接清单。
- 二级标题：参考链接、版本信息、致谢

## 6. 迁移映射表

> 迁移过程中以 `git mv` 优先，保留历史；对需要拆分的旧文档，先迁移到目标目录再做分拆提交，避免一次提交混杂“移动+大改”导致审阅困难。

### 6.1 旧 docs 与 guide_docs

| 旧路径 | 新路径 | 处理方式 |
|---|---|---|
| `docs/00-文档索引.md` | `new-docs/00-总览/00-文档索引.md` | 重写索引以匹配新目录 |
| `docs/冲突汇总.md` | `new-docs/00-总览/02-冲突与决议.md` | 改名并升级为决议闭环 |
| `docs/10-课程设计要求文档.md` | `new-docs/10-交付与答辩/10-课程设计要求与评分口径.md` | 改名微调 |
| `docs/20-整体需求文档.md` | `new-docs/20-需求与验收/20-需求分析报告.md` | 改名微调 |
| `docs/30-系统规格说明书.md` | `new-docs/40-概要设计/40-概要设计报告.md` | 改名并按新边界收敛 |
| `docs/40-模块与数据流说明.md` | `new-docs/40-概要设计/41-数据流与时序.md` | 改名并补齐时序图描述 |
| `docs/50-数据库设计.md` | `new-docs/80-规范/80-数据对象与生命周期.md` | 改名微调 |
| `docs/51-ECS字段规范.md` | `new-docs/80-规范/81-ECS字段规范.md` | 改名微调 |
| `docs/52-实体图谱规范.md` | `new-docs/80-规范/84-Neo4j实体图谱规范.md` | 改名微调 |
| `docs/53-环境变量规范.md` | `new-docs/80-规范/89-环境变量与配置规范.md` | 合并散落配置文档 |
| `docs/54-客户机-中心机接口规范.md` | `new-docs/80-规范/87-客户机与中心机接口.md` | 改名微调 |
| `docs/31-OpenSearch模块规格说明书.md` | `new-docs/50-详细设计/中心机/62-OpenSearch存储与索引治理.md` | 迁移后拆分出索引规范到 82 |
| `docs/32-Neo4j模块规格说明书.md` | `new-docs/50-详细设计/中心机/64-Neo4j入图与图查询.md` | 迁移后与 84/85 对齐去重 |
| `docs/33-Analysis模块规格说明书.md` | `new-docs/50-详细设计/分析/70-任务模型与状态机.md` 等 | 拆分为 70/71/72/73 四篇 |
| `docs/34-客户机规格说明书.md` | `new-docs/50-详细设计/客户机/50-总体.md` 等 | 拆分为 50/51/52/53/54/55 六篇 |
| `docs/35-中心机后端规格说明书.md` | `new-docs/50-详细设计/中心机/60-总体与代码结构.md` 等 | 拆分为 60/61/62/63/64/65 六篇 |
| `guide_docs/01-靶场总体方案（单机多节点）.md` | `new-docs/90-运维与靶场/91-靶场部署.md` | 改名并去掉不确定表述 |
| `guide_docs/02-一键部署编排（center+4client+c2）.md` | `new-docs/90-运维与靶场/92-一键编排.md` | 改名并统一命令口径 |
| `guide_docs/03-c2-01-DNS+HTTP（macvlan优先）.md` | `new-docs/90-运维与靶场/93-C2部署与证据点.md` | 重写为确定部署路径 |
| `guide_docs/04-验证清单（网络-采集-证据）.md` | `new-docs/90-运维与靶场/94-验证清单.md` | 改名微调 |
| `guide_docs/05-重置复现与排障.md` | `new-docs/90-运维与靶场/95-重置复现与排障.md` | 改名微调 |

### 6.2 散落在代码目录的 Markdown

| 旧路径 | 新路径 | 处理方式 |
|---|---|---|
| `backend/docs/DEEPSEEK_SETUP.md` | `new-docs/80-规范/89-环境变量与配置规范.md` | 合并为 LLM 配置章节 |
| `client/sensor/suricata/ECS_RULES_v1.md` | `new-docs/80-规范/81-ECS字段规范.md` | 合并为网络侧字段补充并清理措辞 |
| `backend/tests/services/analyze/README_TESTING.md` | `new-docs/96-测试/96-测试分析报告.md` | 合并为可复现实验命令与证据产出 |
| `backend/app/services/opensearch/scripts/README.md` | `new-docs/80-规范/82-OpenSearch索引与Mapping规范.md` | 合并为脚本入口章节 |

## 7. 提交策略与里程碑

为便于回滚与审阅，提交按以下粒度组织：

1. **计划与结构提交**：落地目录结构、索引与模板、迁移映射表。
2. **迁移提交**：以 `git mv` 为主的纯移动提交（不改正文或只做最小标题修正）。
3. **拆分提交**：将长文按新结构拆成多文档，保持内容不引入新逻辑。
4. **重写提交**：对新增交付件与需要重构逻辑的文档进行实质性写作。
5. **清理提交**：删除旧目录或替换为只读指针文件，保证仓库只存在一套权威文档。

