# 客户机总体

## 文档目的

本文件给出客户机侧的总体设计：组件构成、数据流、与中心机的交互边界，并给出分模块详细设计文档的索引。

## 读者对象

- 负责客户机实现与部署的同学
- 负责靶场联调与排障的同学
- 负责验收与证据准备的同学

## 引用关系

- ECS 字段规范（中心机入库后的权威口径）：`../../80-规范/81-ECS字段规范.md`
- 客户机与中心机接口（权威）：`../../80-规范/87-客户机与中心机接口.md`
- 环境变量与配置（权威）：`../../80-规范/89-环境变量与配置规范.md`
- 靶场部署与一键编排：`../../90-运维与靶场/`

## 1. 客户机职责边界

客户机侧职责固定为：

1. 采集三类数据源：Falco、Filebeat、Suricata；
2. 将各自输出转换为 ECS 子集字段，形成可被中心机入库的 JSON 事件；
3. 将事件写入 RabbitMQ 队列作为本地缓冲；
4. 对外提供拉取接口，供中心机轮询获取增量数据。

客户机侧不负责：

- OpenSearch 的存储与查询；
- Neo4j 的图谱建模与查询；
- 溯源算法执行与写回。

## 2. 组件清单与目录结构

客户机由以下容器组成（以 `client/docker-compose.yml` 为准）：

| 容器 | 作用 | 主要代码位置 |
|---|---|---|
| `rabbitmq` | 本地缓冲区 | `client/docker-compose.yml` |
| `falco` | 主机行为采集 | `client/docker-compose.yml` |
| `falco-ecs` | Falco ECS 转换并投递队列 | `client/sensor/falco/ecs-converter/` |
| `filebeat` | 主机日志采集 + Sigma 检测并投递队列 | `client/sensor/filebeat/` |
| `suricata` | 网络 IDS 与 EVE 输出 | `client/sensor/suricata/engine/` |
| `suricata-exporter` | EVE ECS 转换并投递队列 | `client/sensor/suricata/exporter/` |
| `backend` | 拉取 API（Gin） | `client/backend/` |

## 3. 端到端数据流

客户机侧端到端数据流固定为：

1. Falco 产生 JSONL 事件 → `falco-ecs` 转换为 ECS JSON → 写入 RabbitMQ `data.falco`
2. Filebeat 采集宿主机日志 → detector 应用 Sigma 规则标注告警 → 写入 RabbitMQ `data.filebeat`
3. Suricata 输出 EVE → `suricata-exporter` 转换为 ECS JSON → 写入 RabbitMQ `data.suricata`
4. `backend` 提供 `GET /falco`、`GET /filebeat`、`GET /suricata`，从队列取出并返回事件列表

中心机的轮询逻辑见：

- `backend/app/services/client_poller.py`

## 4. 分模块详细设计索引

客户机侧详细设计按模块拆分如下：

- Falco：`51-Falco采集与ECS转换.md`
- Suricata：`52-Suricata采集与ECS转换.md`
- Filebeat：`53-Filebeat采集与ECS转换.md`
- RabbitMQ：`54-RabbitMQ缓冲与队列语义.md`
- 拉取接口：`55-拉取接口.md`

## 5. 与中心机的交互边界

1. 客户机只暴露拉取接口（HTTP GET），接口形状与行为由 `../../80-规范/87-客户机与中心机接口.md` 定义。
2. 客户机不保存中心机状态，不维护游标；增量语义由 RabbitMQ 队列保证。
3. 客户机返回数据前必须保证事件包含稳定 `event.id`，补齐规则在拉取接口实现中完成。

## 6. 运维与排障入口

客户机的部署、启动、验证、重置与排障统一在运维文档中定义：

- 编译安装与使用：`../../90-运维与靶场/90-编译安装与使用.md`
- 靶场部署：`../../90-运维与靶场/91-靶场部署.md`
- 一键编排：`../../90-运维与靶场/92-一键编排.md`
- 验证清单：`../../90-运维与靶场/94-验证清单.md`
- 重置复现与排障：`../../90-运维与靶场/95-重置复现与排障.md`

