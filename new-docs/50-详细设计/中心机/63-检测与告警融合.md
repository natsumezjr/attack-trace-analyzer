# 检测与告警融合

## 文档目的

本文件定义中心机侧检测触发、Raw Finding 生成、以及融合去重生成 Canonical Finding 的固定规则与审计口径。

## 读者对象

- 负责 OpenSearch 分析与融合实现的同学
- 负责数据验证与测试的同学

## 引用关系

- 告警数据规范（权威口径）：`../../80-规范/83-告警数据规范.md`
- OpenSearch 索引规范（权威口径）：`../../80-规范/82-OpenSearch索引与Mapping规范.md`
- ECS 字段规范（权威口径）：`../../80-规范/81-ECS字段规范.md`

## 1. 检测触发机制

中心机的检测与融合由以下触发路径组成：

1. 轮询服务在每次 tick 拉取并入库后，根据环境变量决定是否执行检测与融合；
2. 手动调用检测脚本执行一次端到端分析。

### 1.1 轮询触发开关

轮询服务在入库后读取环境变量：

- `CENTER_RUN_ANALYSIS_EACH_TICK`

当值为 `1`、`true` 或 `yes` 时，执行检测与融合流程。

实现位置：

- `backend/app/services/client_poller.py`

### 1.2 检测与融合入口（固定）

检测与融合的统一入口函数固定为：

- `backend/app/services/opensearch/analysis.py:run_data_analysis()`

该函数固定执行三步：

1. 检查 Security Analytics 的 rules 与 detector 是否存在；
2. 执行 Security Analytics 检测并将 findings 写入 `raw-findings-*`；
3. 对 `raw-findings-*` 执行融合去重并写入 `canonical-findings-*`。

### 1.3 Security Analytics 规则与 detector 引导（固定）

当 `run_data_analysis()` 检测到 Security Analytics 缺少 rules 或 detector 时，会执行固定的自动引导逻辑：

1. 调用脚本 `backend/app/services/opensearch/scripts/setup_security_analytics.py --multiple`；
2. 执行完成后再次查询 rules 与 detector 数量；
3. 当 rules 与 detector 均存在时认为“就绪”，否则认为“未就绪”。

实现绑定点：`backend/app/services/opensearch/analysis.py:_check_and_setup_rules_detectors()`。

### 1.4 扫描触发条件（固定）

Security Analytics 的扫描触发条件固定为：

1. 当 `trigger_scan=false` 时，不触发扫描，仅拉取已有 findings；
2. 当 `force_scan=true` 时，触发一次扫描；
3. 当已有 findings 数量为 0 时，触发一次扫描；
4. 当最新 finding 的时间距当前超过 5 分钟时，触发一次扫描；
5. 其它情况使用已有 findings。

实现绑定点：`backend/app/services/opensearch/analysis.py:run_security_analytics()`。

## 2. Raw Finding 结构与写入

Raw Finding 由两类来源组成：

1. Filebeat Sigma detector / Falco / Suricata 直接产生的告警事件（客户机侧 `event.kind="alert"`）；
2. OpenSearch Security Analytics 产生的 findings（中心机侧拉取并转换为 ECS 告警事件）。

Raw Finding 的字段结构与最小必填字段由权威规范定义：

- `../../80-规范/83-告警数据规范.md`

### 2.1 Security Analytics finding 转换（固定）

当告警来源为 OpenSearch Security Analytics 时，中心机按固定规则将原始 finding 转换为 ECS 告警事件并写入 `raw-findings-*`：

- `event.kind="alert"`
- `event.dataset="finding.raw.security_analytics"`
- `rule.id/rule.name` 从 detector 信息派生
- `threat.*` 从 finding 的 ATT&CK tags 派生（或从固定映射表派生）

实现绑定点：`backend/app/services/opensearch/analysis.py:_convert_security_analytics_finding_to_ecs()`。

## 3. 融合指纹规则

融合去重以固定时间窗内的 Raw Finding 为输入，按指纹规则聚合生成 Canonical Finding。

指纹字段与生成规则由权威规范定义：

- `../../80-规范/83-告警数据规范.md`

### 3.1 时间桶参数（固定）

融合指纹使用固定时间桶参数：

- `TIME_WINDOW_MINUTES = 3`

实现绑定点：`backend/app/services/opensearch/analysis.py:TIME_WINDOW_MINUTES`。

### 3.2 指纹构造要素（固定）

指纹 key 的构造要素固定为：

- `threat.technique.id`
- `host.id`
- `entity_id`（取值顺序固定为：`process.entity_id` → `destination.ip[/destination.domain]` → `file.hash.sha256`）
- `time_bucket`

实现绑定点：`backend/app/services/opensearch/analysis.py:generate_fingerprint()` 与 `fingerprint_id_from_key()`。

## 4. Canonical 生成与覆盖规则

Canonical Finding 的生成规则、`event.id` 生成规则、以及覆盖行为由权威规范定义：

- `../../80-规范/83-告警数据规范.md`

### 4.1 融合写入动作（固定）

融合写入动作固定为：

1. 从 `raw-findings-*` 拉取 Raw Findings；
2. 按指纹 key 分组；
3. 每组多条 Raw Findings 合并为一个 Canonical Finding；
4. 每组单条 Raw Finding 直接规范化为 Canonical Finding；
5. 批量写入 `canonical-findings-*` 并刷新索引。

实现绑定点：`backend/app/services/opensearch/analysis.py:deduplicate_findings()`。

## 5. 审计与可回溯性

审计与可回溯性要求：

1. Raw 与 Canonical 必须包含证据引用 `custom.evidence.event_ids`；
2. Canonical 的证据引用必须能回溯到 Telemetry 的 `event.id`；
3. 任意 Canonical 必须能定位到其来源 providers 与融合指纹。

字段口径见：

- `../../80-规范/81-ECS字段规范.md`
