# 任务模型与状态机

## 文档目的

本文件定义溯源任务的任务模型、状态机、任务文档结构与进度更新规则，作为前端触发溯源与后端异步执行的统一约束。

## 读者对象

- 负责溯源任务与算法实现的同学
- 负责前端任务交互与轮询的同学
- 负责测试与验收的同学

## 引用关系

- 前端与中心机接口（权威口径）：`../../80-规范/88-前端与中心机接口.md`
- OpenSearch 索引规范（权威口径）：`../../80-规范/82-OpenSearch索引与Mapping规范.md`
- 溯源写回规范（权威口径）：`../../80-规范/85-溯源结果写回规范.md`
- Neo4j 入图与图查询：`../中心机/64-Neo4j入图与图查询.md`

## 1. 触发方式

溯源任务只通过前端点选节点触发创建：

1. 前端在图中选择目标节点；
2. 调用中心机创建任务接口；
3. 中心机立即返回 `task_id`；
4. 中心机后台执行任务并持续更新任务状态；
5. 任务完成后，前端通过图查询接口读取写回结果。

## 2. taskid 规则

`task_id` 格式固定为：

- `trace-<uuid_v4>`

实现入口：

- `backend/app/services/analyze/pipeline.py` 的 `new_task_id()`

## 3. 任务文档存储

任务状态存储在 OpenSearch 的按日滚动索引：

- `analysis-tasks-YYYY-MM-DD`

索引创建与 mapping 入口：

- `backend/app/services/opensearch/mappings.py` 的 `analysis_tasks_mapping`

## 4. 任务文档字段

任务文档字段集合固定为：

- `@timestamp`：任务创建时间（RFC3339）
- `task.id`：`task_id`
- `task.status`：`queued` / `running` / `succeeded` / `failed`
- `task.progress`：整数 0 到 100
- `task.target.node_uid`：目标节点 UID
- `task.window.start_ts`：分析时间窗起点（RFC3339）
- `task.window.end_ts`：分析时间窗终点（RFC3339）
- `task.started_at`：任务开始时间（RFC3339）
- `task.finished_at`：任务结束时间（RFC3339）
- `task.error`：失败原因（字符串）
- `task.result.summary`：任务结果摘要（字符串）

任务级结构化结果字段固定为：

- `task.result.ttp_similarity.attack_tactics`
- `task.result.ttp_similarity.attack_techniques`
- `task.result.ttp_similarity.similar_apts`
- `task.result.trace.updated_edges`
- `task.result.trace.path_edges`

以上字段由任务执行流水线写入，入口为：

- `backend/app/services/analyze/pipeline.py` 的 `run_analysis_task()`

## 5. 状态机与进度更新

### 5.1 状态机

状态转移规则固定为：

- `queued -> running`
- `running -> succeeded`
- `running -> failed`

任何回退与跳转均禁止。

### 5.2 进度更新规则

任务进度由中心机流水线更新：

1. 创建任务文档：`queued`，`progress=0`
2. 开始执行：`running`，`progress=5`
3. 准备并行计算：`progress=20`
4. 写入相似度结果：`progress=70`
5. 写回图边属性：`progress=95`
6. 结束：`succeeded`，`progress=100`

失败时：

- `status=failed`
- `finished_at` 必须写入
- `error` 必须写入

## 6. 结果读取方式

任务完成后，前端通过图查询接口读取写回结果，方式固定为以下一种：

1. 调用 `POST /api/v1/graph/query` 的 `analysis_edges_by_task` 动作，按 `task_id` 拉取写回边集合；

接口权威定义见：

- `../../80-规范/88-前端与中心机接口.md`

