# 总体与页面结构

## 文档目的

本文件定义前端的页面结构、数据流与与后端接口的固定绑定关系。

## 读者对象

- 负责前端实现的同学
- 负责演示与报告导出的同学

## 引用关系

- 前端与中心机接口：`../../80-规范/88-前端与中心机接口.md`

## 1. 页面结构

前端采用 Next.js App Router（`frontend/app/`），页面与代码文件的绑定关系固定如下。

### 1.1 页面路由与文件映射（固定）

| 路由 | 页面用途 | 代码位置 |
|---|---|---|
| `/` | 项目首页与入口 | `frontend/app/page.tsx` |
| `/dashboard` | 总览大盘 | `frontend/app/dashboard/page.tsx` |
| `/trace` | 溯源分析主界面 | `frontend/app/trace/page.tsx` |

### 1.2 布局与导航（固定）

布局与导航绑定关系固定：

1. 全站 Root Layout：`frontend/app/layout.tsx`
   - 注入主题切换（`ThemeProvider` + `ModeToggle`）
2. 侧边栏组件：`frontend/components/sidebar/app-sidebar.tsx`
   - 菜单项固定包含：主页、总览、溯源分析
3. `/dashboard` 与 `/trace` 共享侧边栏布局：
   - `frontend/app/dashboard/layout.tsx`
   - `frontend/app/trace/layout.tsx`

## 2. 数据流与状态管理

前端的状态管理采用“页面内状态 + 明确的请求边界”的方式：

1. 页面状态只保存渲染所需的最小集合；
2. 所有后端数据统一通过 `88-前端与中心机接口.md` 获取；
3. 状态变更严格由用户操作或轮询驱动，不通过隐式副作用更新。

### 2.1 Dashboard 数据流（固定）

Dashboard 页展示四类概览卡片。当前实现以静态组件渲染为主；其数据填充采用以下固定数据源：

- Telemetry 统计：`POST /api/v1/events/search`
- Raw/Canonical 告警统计：`POST /api/v1/findings/search`
- 任务统计：`GET /api/v1/analysis/tasks`

Dashboard 页只读取聚合统计，不触发溯源任务与图查询。

### 2.2 Trace 数据流（固定）

Trace 页的数据流固定由 4 个阶段组成：

1. 时间窗输入 → 图数据拉取
2. 图交互 → 创建溯源任务
3. 任务轮询 → 读取写回边并高亮
4. TTP 相似度 → 输出 Top-3 组织与解释字段

数据流中的所有 HTTP 请求均通过中心机后端完成；前端不直连 OpenSearch 与 Neo4j。

## 3. 接口调用边界

### 3.1 前端只调用中心机 API（固定）

前端的网络边界固定：

- 仅调用中心机 HTTP API（`/api/v1/*` 与 `/health`）；
- 不直连 OpenSearch（`/9200`）与 Neo4j（`/7687`）。

### 3.2 Trace 页面接口绑定（固定）

Trace 页在不同阶段调用接口的绑定关系固定如下（字段结构以 `88-前端与中心机接口.md` 为准）：

| 阶段 | 触发动作 | 方法 | 路径 | 目的 |
|---|---|---|---|---|
| 图拉取 | 设置时间窗并刷新 | POST | `/api/v1/graph/query` | 获取时间窗图边与节点 |
| 创建任务 | 点选目标节点 | POST | `/api/v1/analysis/tasks` | 创建溯源任务并得到 `task_id` |
| 轮询任务 | 创建任务后自动开始 | GET | `/api/v1/analysis/tasks/{task_id}` | 获取任务状态与进度 |
| 读取写回 | 任务完成后自动触发 | POST | `/api/v1/graph/query` | 读取 `analysis_edges_by_task` 并高亮 |
| 相似度 | 任务完成后自动触发 | POST | `/api/v1/analysis/ttp-similarity` | 输出 Top-3 相似 intrusion-set |

### 3.3 前端代理规则（固定）

本项目运行时前端端口为 `3000`，后端端口为 `8000`。为保证浏览器请求同源，前端通过 Next.js rewrite 规则将以下路径转发到本机后端：

- `/api/*` → `http://localhost:8000/api/*`
- `/health` → `http://localhost:8000/health`

实现绑定点：`frontend/next.config.ts`。
