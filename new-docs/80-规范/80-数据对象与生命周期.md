# 数据库设计（全局）

## 0. 文档定位

本文只描述全局数据对象与存储边界，避免与以下文档重复：

- 字段口径：`51-ECS字段规范.md`
- 图谱口径：`52-实体图谱规范.md`
- OpenSearch 模块细节：`31-OpenSearch模块规格说明书.md`
- Neo4j 模块细节：`32-Neo4j模块规格说明书.md`

## 1. 数据对象与生命周期（从底到顶）

系统只承认以下数据对象及其生命周期：

1) **Telemetry**
- 定义：事实事件（`event.kind="event"`）
- 存储：OpenSearch（按日滚动）
- 生命周期：短保留，用于检索、复盘、检测输入与证据回溯

2) **Raw Findings**
- 定义：原始告警（传感器告警 + Store-first 检测输出）
- 存储：OpenSearch（按日滚动）
- 生命周期：中保留，用于审计与融合输入

3) **Canonical Findings**
- 定义：Raw Findings 融合去重后的规范告警（`event.dataset="finding.canonical"`）
- 存储：OpenSearch（按日滚动）
- 生命周期：中保留，用于入图与溯源主输入

4) **Entity Graph**
- 定义：由 Telemetry + Canonical Findings 抽取出的实体与关系
- 存储：Neo4j（长期）
- 生命周期：长期，作为图查询与溯源计算的权威图

5) **Trace Task**
- 定义：用户触发的溯源任务状态与结果摘要
- 存储：
  - OpenSearch：任务状态与进度（按日滚动）
  - Neo4j：结果写回边属性（长期，覆盖写）
- 生命周期：任务状态短保留；边属性为最新一次任务结果（覆盖语义）

6) **Client Registry**
- 定义：中心机维护的客户机注册表与游标
- 存储：OpenSearch（固定索引 `client-registry`）
- 生命周期：长期保留

## 2. OpenSearch 与 Neo4j 的边界（权威）

### 2.1 OpenSearch（事实与告警的权威存储）

OpenSearch 承担以下职责：

- 事实事件与告警的权威保存（可按 `event.id` 精确检索）；
- 作为 Store-first 检测的输入与输出载体；
- 作为前端“列表型检索”的主数据源（事件列表、告警列表、任务列表）。

OpenSearch 不承担：

- 图结构的权威表达（图结构以 Neo4j 为准）；
- 图算法计算（由 Neo4j GDS 与 Analysis 模块完成）。

### 2.2 Neo4j（实体关系图的权威存储）

Neo4j 承担以下职责：

- 以实体关系图形式表达“多源关联结果”；
- 支撑图查询与图算法（时间窗过滤、最短路等）；
- 承载溯源任务写回结果（边属性）。

Neo4j 不承担：

- Telemetry/Findings 的全量保存与按字段检索（由 OpenSearch 承担）。

## 3. 一致性与幂等（全局约束）

### 3.1 `event.id` 是全局幂等键

- OpenSearch 中所有 ECS 文档必须具备 `event.id`。
- OpenSearch 写入必须按 `event.id` 幂等：重复写入不得产生重复文档。

### 3.2 证据引用链（必须闭环）

系统必须形成“上可追溯、下可落地”的证据链：

- Raw Findings 必须通过 `custom.evidence.event_ids[]` 引用触发它们的 Telemetry `event.id`；
- Canonical Findings 必须合并所有证据引用；
- Neo4j 的每条边必须携带 `custom.evidence.event_ids[]`，能回溯到 OpenSearch 的 Telemetry 文档；
- 溯源任务结果必须能通过边属性追溯到：
  - 该边的证据引用
  - 该任务的 `task_id`

### 3.3 派生数据的可重建性

- Canonical Findings 是派生数据：在 Raw Findings 不丢失的前提下可重建。
- Entity Graph 是派生数据：在 Canonical Findings 与必要 Telemetry 不丢失的前提下可重建。
- 溯源任务边属性是覆盖写派生数据：任务状态短保留，边属性保留最新结果。

## 4. 保留策略（固定）

| 数据对象 | 存储介质 | 保留周期 |
|---|---|---|
| Telemetry（`ecs-events-*`） | OpenSearch | 30 天 |
| Raw Findings（`raw-findings-*`） | OpenSearch | 180 天 |
| Canonical Findings（`canonical-findings-*`） | OpenSearch | 180 天 |
| Trace Tasks（`analysis-tasks-*`） | OpenSearch | 30 天 |
| Client Registry（`client-registry`） | OpenSearch | 长期保留 |
| Entity Graph | Neo4j | 长期保留 |

> 说明：保留策略的执行方式（ISM policy）归属于 OpenSearch 模块规格（`31-OpenSearch模块规格说明书.md`）。
