# è¯¦ç»†æŠ€æœ¯æŒ‡å—

## ğŸ“– æœ¬æ–‡æ¡£å†…å®¹

æœ¬æ–‡æ¡£è¯¦ç»†è§£é‡Š APT æ”»å‡»æ¨¡æ‹Ÿçš„æŠ€æœ¯åŸç†ã€ç³»ç»Ÿæ¶æ„å’Œæ£€æµ‹æœºåˆ¶ã€‚

é€‚åˆæƒ³æ·±å…¥ç†è§£ç³»ç»Ÿå·¥ä½œåŸç†çš„è¯»è€…ã€‚

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„è¯¦è§£

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å®¿ä¸»æœºï¼ˆä¸­å¿ƒæœºï¼‰                          â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚         ä¸­å¿ƒæœº                     â”‚   â”‚
â”‚  â”‚                                                        â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚   â”‚
â”‚  â”‚  â”‚  Frontend  â”‚  â”‚  Backend   â”‚  â”‚ OpenSearch â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  (Next.js) â”‚  â”‚  (FastAPI) â”‚  â”‚  + Neo4j   â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  Port:3000 â”‚  â”‚  Port:8001 â”‚  â”‚  Ports:    â”‚     â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚   â”‚
â”‚  â”‚                                                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                              â”‚
â”‚  åŠŸèƒ½ï¼šè½®è¯¢ã€å­˜å‚¨ã€æ£€æµ‹ã€åˆ†æã€å¯è§†åŒ–                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–²
                            â”‚ HTTP è½®è¯¢ï¼ˆæ¯ 10 ç§’ï¼‰
                            â”‚ æ‹‰å–å¢é‡æ•°æ®
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                   â”‚                   â”‚
        â”‚                   â”‚                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è™šæ‹Ÿæœº 1      â”‚   â”‚  è™šæ‹Ÿæœº 2      â”‚   â”‚  è™šæ‹Ÿæœº 3      â”‚   â”‚  è™šæ‹Ÿæœº 4
â”‚  victim-01    â”‚   â”‚  victim-02    â”‚   â”‚  victim-03    â”‚   â”‚  victim-04
â”‚  192.168.1.11 â”‚   â”‚  192.168.1.12 â”‚   â”‚  192.168.1.13 â”‚   â”‚  192.168.1.14
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚               â”‚   â”‚               â”‚   â”‚               â”‚   â”‚               â”‚
â”‚  é‡‡é›†æ ˆï¼š     â”‚   â”‚  é‡‡é›†æ ˆï¼š     â”‚   â”‚  é‡‡é›†æ ˆï¼š     â”‚   â”‚  é‡‡é›†æ ˆï¼š     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Falco   â”‚ â”‚   â”‚  â”‚ Falco   â”‚ â”‚   â”‚  â”‚ Falco   â”‚ â”‚   â”‚  â”‚ Falco   â”‚ â”‚
â”‚  â”‚ç›‘æ§ä¸»æœº â”‚ â”‚   â”‚  â”‚ç›‘æ§ä¸»æœº â”‚ â”‚   â”‚  â”‚ç›‘æ§ä¸»æœº â”‚ â”‚   â”‚  â”‚ç›‘æ§ä¸»æœº â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚Filebeat â”‚ â”‚   â”‚  â”‚Filebeat â”‚ â”‚   â”‚  â”‚Filebeat â”‚ â”‚   â”‚  â”‚Filebeat â”‚ â”‚
â”‚  â”‚æ”¶é›†æ—¥å¿— â”‚ â”‚   â”‚  â”‚æ”¶é›†æ—¥å¿— â”‚ â”‚   â”‚  â”‚æ”¶é›†æ—¥å¿— â”‚ â”‚   â”‚  â”‚æ”¶é›†æ—¥å¿— â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚Suricata â”‚ â”‚   â”‚  â”‚Suricata â”‚ â”‚   â”‚  â”‚Suricata â”‚ â”‚   â”‚  â”‚Suricata â”‚ â”‚
â”‚  â”‚æ•è·ç½‘ç»œ â”‚ â”‚   â”‚  â”‚æ•è·ç½‘ç»œ â”‚ â”‚   â”‚  â”‚æ•è·ç½‘ç»œ â”‚ â”‚   â”‚  â”‚æ•è·ç½‘ç»œ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚       â”‚       â”‚   â”‚       â”‚       â”‚   â”‚       â”‚       â”‚   â”‚       â”‚       â”‚
â”‚       â–¼       â”‚   â”‚       â–¼       â”‚   â”‚       â–¼       â”‚   â”‚       â–¼       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚RabbitMQ â”‚ â”‚   â”‚  â”‚RabbitMQ â”‚ â”‚   â”‚  â”‚RabbitMQ â”‚ â”‚   â”‚  â”‚RabbitMQ â”‚ â”‚
â”‚  â”‚æ¶ˆæ¯é˜Ÿåˆ— â”‚ â”‚   â”‚  â”‚æ¶ˆæ¯é˜Ÿåˆ— â”‚ â”‚   â”‚  â”‚æ¶ˆæ¯é˜Ÿåˆ— â”‚ â”‚   â”‚  â”‚æ¶ˆæ¯é˜Ÿåˆ— â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚       â”‚       â”‚   â”‚       â”‚       â”‚   â”‚       â”‚       â”‚   â”‚       â”‚       â”‚
â”‚       â–¼       â”‚   â”‚       â–¼       â”‚   â”‚       â–¼       â”‚   â”‚       â–¼       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚Go API   â”‚ â”‚   â”‚  â”‚Go API   â”‚ â”‚   â”‚  â”‚Go API   â”‚ â”‚   â”‚  â”‚Go API   â”‚ â”‚
â”‚  â”‚æä¾›æ¥å£ â”‚ â”‚   â”‚  â”‚æä¾›æ¥å£ â”‚ â”‚   â”‚  â”‚æä¾›æ¥å£ â”‚ â”‚   â”‚  â”‚æä¾›æ¥å£ â”‚ â”‚
â”‚  â”‚:18881   â”‚ â”‚   â”‚  â”‚:18882   â”‚ â”‚   â”‚  â”‚:18883   â”‚ â”‚   â”‚  â”‚:18884   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åŠŸèƒ½ï¼šç›‘æ§ã€é‡‡é›†ã€ç¼“å†²ã€æä¾› API
```

---

## ğŸ” é‡‡é›†æœºåˆ¶è¯¦è§£

### 1. Falco - ä¸»æœºè¡Œä¸ºç›‘æ§

**å·¥ä½œåŸç†**ï¼š

```
ç³»ç»Ÿè°ƒç”¨
   â”‚
   â–¼
Linux å†…æ ¸
   â”‚
   â–¼
Falco å†…æ ¸æ¨¡å—
   â”‚
   â–¼
è§„åˆ™å¼•æ“
   â”‚
   â–¼
äº‹ä»¶è¾“å‡º
```

**æ£€æµ‹å†…å®¹**ï¼š
- è¿›ç¨‹å¯åŠ¨ã€ç»“æŸ
- æ–‡ä»¶è¯»å†™
- ç½‘ç»œè¿æ¥
- ç³»ç»Ÿè°ƒç”¨

**äº‹ä»¶æ ¼å¼**ï¼š

```json
{
  "output": "10:10:30.123456789: Notice Shell spawned (user=root cmd=bash parent=sshd)"
  "priority": "Notice",
  "rule": "Shell spawned",
  "time": "2025-01-16T10:10:30.123456789Z",
  "output_fields": {
    "user.name": "root",
    "proc.cmdline": "bash",
    "proc.pname": "sshd"
  }
}
```

**åœ¨æˆ‘ä»¬çš„æ”»å‡»ä¸­æ£€æµ‹åˆ°**ï¼š
- T1059.004: Bash æ‰§è¡Œ
- T1053.003: systemd æœåŠ¡åˆ›å»º
- T1003.003: /etc/shadow è®¿é—®

---

### 2. Filebeat - ç³»ç»Ÿæ—¥å¿—æ”¶é›†

**å·¥ä½œåŸç†**ï¼š

```
æ—¥å¿—æ–‡ä»¶
   â”‚
   â”œâ”€ /var/log/auth.log
   â”œâ”€ /var/log/syslog
   â”œâ”€ /var/log/kern.log
   â””â”€ ...
   â”‚
   â–¼
Filebeat é‡‡é›†å™¨
   â”‚
   â–¼
ECS å­—æ®µå½’ä¸€åŒ–
   â”‚
   â–¼
è¾“å‡ºåˆ° RabbitMQ
```

**æ£€æµ‹å†…å®¹**ï¼š
- SSH ç™»å½•æ—¥å¿—ï¼ˆauth.logï¼‰
- ç³»ç»Ÿæ—¥å¿—ï¼ˆsyslogï¼‰
- å†…æ ¸æ—¥å¿—ï¼ˆkern.logï¼‰

**äº‹ä»¶æ ¼å¼**ï¼š

```json
{
  "@timestamp": "2025-01-16T10:10:30.123Z",
  "event.module": "system",
  "event.dataset": "auth",
  "user.name": "ubuntu",
  "source.ip": "192.168.1.11",
  "action": "accepted"
}
```

**åœ¨æˆ‘ä»¬çš„æ”»å‡»ä¸­æ£€æµ‹åˆ°**ï¼š
- SSH ç™»å½•å°è¯•
- sudo ä½¿ç”¨
- è®¤è¯å¤±è´¥/æˆåŠŸ

---

### 3. Suricata - ç½‘ç»œæµé‡æ•è·

**å·¥ä½œåŸç†**ï¼š

```
ç½‘ç»œæ¥å£
   â”‚
   â–¼
æ•°æ®åŒ…æ•è·
   â”‚
   â–¼
åè®®è§£æ
   â”‚
   â–¼
è§„åˆ™åŒ¹é…
   â”‚
   â–¼
å‘Šè­¦ç”Ÿæˆ
```

**æ£€æµ‹å†…å®¹**ï¼š
- HTTP/HTTPS æµé‡
- DNS æŸ¥è¯¢
- SSH è¿æ¥
- Kerberos æµé‡

**äº‹ä»¶æ ¼å¼**ï¼š

```json
{
  "timestamp": "2025-01-16T10:10:30.123",
  "event_type": "alert",
  "src_ip": "192.168.1.11",
  "dest_ip": "192.168.1.12",
  "dest_port": 22,
  "proto": "TCP",
  "alert": {
    "signature": "ET SSH Potential Misuse"
  }
}
```

**åœ¨æˆ‘ä»¬çš„æ”»å‡»ä¸­æ£€æµ‹åˆ°**ï¼š
- T1190: Web Shell HTTP æµé‡
- T1021: SSH æ¨ªå‘ç§»åŠ¨
- T1071: C2 HTTP æµé‡
- T1558: Kerberos æµé‡

---

## ğŸ“Š æ•°æ®æµè½¬è¯¦è§£

### æ­¥éª¤ 1ï¼šè™šæ‹Ÿæœºé‡‡é›†

```
æ”»å‡»è€…æ‰§è¡Œå‘½ä»¤
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è™šæ‹Ÿæœºä¸Šçš„ä¼ æ„Ÿå™¨                    â”‚
â”‚                                     â”‚
â”‚  Falco: æ£€æµ‹åˆ°å¼‚å¸¸è¿›ç¨‹              â”‚
â”‚  Filebeat: è®°å½•ç³»ç»Ÿæ—¥å¿—             â”‚
â”‚  Suricata: æ•è·ç½‘ç»œåŒ…               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RabbitMQ æ¶ˆæ¯é˜Ÿåˆ—                  â”‚
â”‚  - ç¼“å†²äº‹ä»¶                         â”‚
â”‚  - è§£è€¦é‡‡é›†å’Œå¤„ç†                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Go Backend API                     â”‚
â”‚  - æä¾› HTTP æ¥å£                   â”‚
â”‚  - /falco, /filebeat, /suricata    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ­¥éª¤ 2ï¼šä¸­å¿ƒæœºè½®è¯¢æ‹‰å–

```python
# backend ä¸­çš„è½®è¯¢é€»è¾‘ï¼ˆç®€åŒ–ç‰ˆï¼‰

while True:
    for client in registered_clients:
        # æ‹‰å– Falco äº‹ä»¶
        falco_events = requests.get(
            f"{client.url}/falco?since={last_cursor[client.id]}"
        )
        
        # æ‹‰å– Filebeat äº‹ä»¶
        filebeat_events = requests.get(
            f"{client.url}/filebeat?since={last_cursor[client.id]}"
        )
        
        # æ‹‰å– Suricata äº‹ä»¶
        suricata_events = requests.get(
            f"{client.url}/suricata?since={last_cursor[client.id]}"
        )
        
        # å¤„ç†äº‹ä»¶...
        all_events = falco_events + filebeat_events + suricata_events
        process_events(all_events)
    
    time.sleep(10)  # æ¯ 10 ç§’è½®è¯¢ä¸€æ¬¡
```

### æ­¥éª¤ 3ï¼šå†™å…¥ OpenSearch

```
æ¥æ”¶äº‹ä»¶
    â†“
ECS å­—æ®µå½’ä¸€åŒ–
    â†“
å¹‚ç­‰æ€§å»é‡ï¼ˆåŸºäº event.idï¼‰
    â†“
å†™å…¥ OpenSearch
    â†“
ç´¢å¼•ï¼štelemetry-YYYY-MM-DD
```

**å¹‚ç­‰æ€§ä¿è¯**ï¼š

```python
# ä½¿ç”¨ SHA1 ç”Ÿæˆå”¯ä¸€ ID
event_id = sha1(
    f"{client_id}_{timestamp}_{event_content}"
).hexdigest()

# å¦‚æœå·²å­˜åœ¨åˆ™è·³è¿‡
if opensearch.get(id=event_id):
    continue
else:
    opensearch.index(id=event_id, document=event)
```

### æ­¥éª¤ 4ï¼šSigma è§„åˆ™æ£€æµ‹

```
OpenSearch äº‹ä»¶
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Sigma è§„åˆ™å¼•æ“                      â”‚
â”‚  - åŠ è½½ Sigma è§„åˆ™åº“                 â”‚
â”‚  - åŒ¹é…äº‹ä»¶æ¨¡å¼                     â”‚
â”‚  - ç”Ÿæˆ Raw Findings                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
Raw Findingsï¼ˆåŸå§‹å‘Šè­¦ï¼‰
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‘Šè­¦èåˆ                            â”‚
â”‚  - å»é‡                             â”‚
â”‚  - èšåˆ                             â”‚
â”‚  - å…³è”                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
Canonical Findingsï¼ˆæ ‡å‡†å‘Šè­¦ï¼‰
```

**Sigma è§„åˆ™ç¤ºä¾‹**ï¼š

```yaml
title: SSH Lateral Movement
id: 4b71c7e0-5e4f-4b3c-9a2d-1f3e4d5c6b7a
status: experimental
description: Detects SSH lateral movement
references:
    - https://attack.mitre.org/techniques/T1021/004
author: Your Name
date: 2025/01/16
logsource:
    product: linux
    service: ssh
detection:
    selection:
        event.module: suricata
        dest.port: 22
    condition: selection
falsepositives:
    - Administrative SSH access
level: high
tags:
    - attack.lateral_movement
    - attack.t1021.004
```

### æ­¥éª¤ 5ï¼šæ„å»º Neo4j å›¾è°±

```
Canonical Findings
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ECS â†’ Graph è½¬æ¢å™¨                 â”‚
â”‚                                     â”‚
â”‚  æå–å®ä½“ï¼š                         â”‚
â”‚  - HOST (ä¸»æœº)                      â”‚
â”‚  - USER (ç”¨æˆ·)                      â”‚
â”‚  - PROCESS (è¿›ç¨‹)                   â”‚
â”‚  - FILE (æ–‡ä»¶)                      â”‚
â”‚  - IP (IP åœ°å€)                     â”‚
â”‚  - DOMAIN (åŸŸå)                    â”‚
â”‚                                     â”‚
â”‚  æå–å…³ç³»ï¼š                         â”‚
â”‚  - LOGON (ç™»å½•)                     â”‚
â”‚  - SPAWN (è¿›ç¨‹åˆ›å»º)                 â”‚
â”‚  - NET_CONNECT (ç½‘ç»œè¿æ¥)           â”‚
â”‚  - DNS_QUERY (DNS æŸ¥è¯¢)             â”‚
â”‚  - FILE_ACCESS (æ–‡ä»¶è®¿é—®)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
å†™å…¥ Neo4j
    â†“
å›¾è°±æ„å»ºå®Œæˆ
```

**Neo4j èŠ‚ç‚¹å’Œå…³ç³»**ï¼š

```cypher
// åˆ›å»ºèŠ‚ç‚¹
MERGE (h:HOST {id: "victim-01", name: "victim-01", ip: "192.168.1.11"})
MERGE (p:PROCESS {pid: 1234, cmdline: "bash", host_id: "victim-01"})
MERGE (u:USER {name: "ubuntu", host_id: "victim-01"})
MERGE (ip:IP {address: "192.168.1.12"})

// åˆ›å»ºå…³ç³»
MERGE (u)-[:LOGON]->(h)
MERGE (p)-[:RUNS_ON]->(h)
MERGE (h)-[:NET_CONNECT]->(ip)
```

---

## ğŸ”¬ KillChain åˆ†æè¯¦è§£

### åˆ†ææµç¨‹

```
Neo4j å›¾è°±
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Phase A: FSA çŠ¶æ€æœº                 â”‚
â”‚  - æ˜ å°„äº‹ä»¶åˆ° ATT&CK æˆ˜æœ¯            â”‚
â”‚  - æ„å»ºå€™é€‰æ”»å‡»è·¯å¾„                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
å€™é€‰è·¯å¾„ï¼ˆå¤šæ¡ï¼‰
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Phase B: è·¯å¾„æšä¸¾                   â”‚
â”‚  - å¤šé˜¶æ®µæœç´¢                        â”‚
â”‚  - è½¯å‰ªæä¼˜åŒ–                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
ä¼˜åŒ–åçš„å€™é€‰è·¯å¾„
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Phase C: LLM å…¨å±€é€‰æ‹©               â”‚
â”‚  - ä¸€è‡´æ€§æ£€æŸ¥                        â”‚
â”‚  - ç½®ä¿¡åº¦è¯„åˆ†                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
æœ€ä¼˜æ”»å‡»è·¯å¾„
    â†“
KillChain æŠ¥å‘Š
```

### FSA çŠ¶æ€æœºç¤ºä¾‹

```python
# ç®€åŒ–çš„ FSA æ„å»ºé€»è¾‘

class FSAState:
    def __init__(self, tactic, node_id):
        self.tactic = tactic  # ATT&CK æˆ˜æœ¯
        self.node_id = node_id  # Neo4j èŠ‚ç‚¹ ID
        self.transitions = []  # è½¬ç§»
    
    def add_transition(self, next_state, evidence):
        self.transitions.append((next_state, evidence))

# æ„å»ºçŠ¶æ€æœº
fsa = FSAState("initial_access", "event_123")

# æ·»åŠ è½¬ç§»
fsa.add_transition(
    FSAState("execution", "event_456"),
    evidence={"event_id": "event_123", "technique": "T1059.004"}
)

fsa.add_transition(
    FSAState("persistence", "event_789"),
    evidence={"event_id": "event_456", "technique": "T1053.003"}
)

# ç»§ç»­æ„å»º...
```

### è¯­ä¹‰é”šç‚¹è§„åˆ™

```python
# ä¸åŒé˜¶æ®µä¹‹é—´çš„è¿æ¥è§„åˆ™

ANCHOR_RULES = {
    "initial_access â†’ execution": {
        "pattern": "PROC_SPAWN",
        "description": "è¿›ç¨‹åˆ›å»ºäº‹ä»¶"
    },
    "execution â†’ privilege_escalation": {
        "pattern": "UID_CHANGE",
        "description": "ç”¨æˆ· ID å˜åŒ–"
    },
    "privilege_escalation â†’ lateral_movement": {
        "pattern": "NET_CONNECT_FROM_PRIVILEGED",
        "description": "æ¥è‡ªç‰¹æƒè¿›ç¨‹çš„ç½‘ç»œè¿æ¥"
    },
    # ... æ›´å¤šè§„åˆ™
}
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. å¢é‡è½®è¯¢

```python
# åªæ‹‰å–æ–°æ•°æ®
cursor = last_poll_time  # ä¸Šæ¬¡è½®è¯¢æ—¶é—´æˆ³
events = client.get_events(since=cursor)

# æ›´æ–°æ¸¸æ ‡
last_poll_time = current_time
```

### 2. æ‰¹é‡å†™å…¥

```python
# æ‰¹é‡å†™å…¥ OpenSearch
bulk_data = []
for event in events:
    bulk_data.append({
        "index": {"_index": "telemetry-2025-01-16", "_id": event.id}
    })
    bulk_data.append(event.to_dict())

opensearch.bulk(body=bulk_data)
```

### 3. å›¾è°±ç¼“å­˜

```python
# ç¼“å­˜å¸¸ç”¨æŸ¥è¯¢
cache = {}

def get_host_connections(host_id):
    if host_id not in cache:
        cache[host_id] = neo4j.query(
            "MATCH (h:HOST {id: $id})-[r:NET_CONNECT]-(other) RETURN r, other",
            id=host_id
        )
    
    return cache[host_id]
```

---

## ğŸ” å®‰å…¨è€ƒè™‘

### 1. æ•°æ®éš”ç¦»

```python
# ä¸åŒç§Ÿæˆ·çš„æ•°æ®éš”ç¦»
def query_events(user, query):
    # æ·»åŠ ç”¨æˆ·è¿‡æ»¤
    query["filter"] = {"term": {"tenant_id": user.tenant_id}}
    return opensearch.search(query)
```

### 2. è®¿é—®æ§åˆ¶

```python
# åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶
def check_permission(user, resource):
    role = user.role
    
    if role == "admin":
        return True
    elif role == "analyst" and resource in ["events", "findings"]:
        return True
    else:
        return False
```

### 3. å®¡è®¡æ—¥å¿—

```python
# è®°å½•æ‰€æœ‰æ“ä½œ
def audit_log(user, action, resource):
    log = {
        "timestamp": datetime.now(),
        "user": user.id,
        "action": action,
        "resource": resource,
        "ip": request.remote_addr
    }
    audit_store.write(log)
```

---

## ğŸ“š å‚è€ƒèµ„æ–™

### æŠ€æœ¯æ–‡æ¡£

- **Atomic Red Team**: https://github.com/redcanaryco/atomic-red-team
- **MITRE ATT&CK**: https://attack.mitre.org/
- **ECS è§„èŒƒ**: https://www.elastic.co/guide/en/ecs/current/ecs-reference.html
- **Sigma è§„åˆ™**: https://github.com/SigmaHQ/sigma

### å­¦æœ¯è®ºæ–‡

- **Kill Chain**: Lockheed Martin Cyber Kill Chain
- **ATT&CK**: MITRE ATT&CK Framework
- **FSA**: Finite State Automata in Security

### å¼€æºé¡¹ç›®

- **Falco**: https://github.com/falcosecurity/falco
- **Suricata**: https://suricata.io/
- **Filebeat**: https://www.elastic.co/beats/filebeat
- **Neo4j**: https://neo4j.com/

---

**æ·±å…¥å­¦ä¹ å®Œæˆï¼** ğŸ“
