digraph {
    rankdir=LR;
    fontname="PingFang SC";
    node [fontname="PingFang SC", shape=box, style="rounded, filled", fillcolor=lightblue];
    edge [fontname="PingFang SC"];

    subgraph cluster_clients {
        label="客户机侧";
        style=filled;
        fillcolor="#e1f5fe";
        color="#0277bd";
        penwidth=2;

        Falco [label="Falco 数据\ndata.falco", shape=box, style="rounded, filled", fillcolor="#e1f5fe", color="#0277bd", penwidth=2];
        Filebeat [label="Filebeat 数据\ndata.filebeat", shape=box, style="rounded, filled", fillcolor="#e1f5fe", color="#0277bd", penwidth=2];
        Suricata [label="Suricata 数据\ndata.suricata", shape=box, style="rounded, filled", fillcolor="#e1f5fe", color="#0277bd", penwidth=2];
    }

    subgraph cluster_poller {
        label="轮询层\nclient_poller.py";
        style=filled;
        fillcolor="#fff3e0";
        color="#e65100";
        penwidth=2;

        Poller [label="轮询调度器\n5s 周期", shape=box, style="rounded, filled", fillcolor="#fff3e0", color="#e65100", penwidth=2];
        Fetch [label="拉取接口\nGET /falco\n/filebeat\n/suricata", shape=box, style="rounded, filled", fillcolor="#fff3e0", color="#e65100", penwidth=2];
    }

    subgraph cluster_pipeline {
        label="流水线层\n4步骤顺序执行";
        style=filled;
        fillcolor="#e8f5e9";
        color="#1b5e20";
        penwidth=2;

        Step1 [label="Step1\n拉取数据", shape=box, style="rounded, filled", fillcolor="#e8f5e9", color="#1b5e20", penwidth=2];
        Step2 [label="Step2\nOpenSearch入库\nTelemetry\nRaw Findings", shape=box, style="rounded, filled", fillcolor="#e8f5e9", color="#1b5e20", penwidth=2];
        Step3 [label="Step3\n检测与融合\nCanonical Findings", shape=box, style="rounded, filled", fillcolor="#e8f5e9", color="#1b5e20", penwidth=2];
        Step4 [label="Step4\nNeo4j入图\n实体图谱", shape=box, style="rounded, filled", fillcolor="#e8f5e9", color="#1b5e20", penwidth=2];
    }

    subgraph cluster_storage {
        label="存储层";
        style=filled;
        fillcolor="#f3e5f5";
        color="#7b1fa2";
        penwidth=2;

        OS [label="OpenSearch\necs-events-*\nfindings-raw-*\nfindings-canonical-*\nanalysis-tasks-*", shape=cylinder, style="filled", fillcolor="#f3e5f5", color="#7b1fa2", penwidth=2];
        Neo4j [label="Neo4j\n实体图谱\n溯源结果", shape=cylinder, style="filled", fillcolor="#f3e5f5", color="#7b1fa2", penwidth=2];
    }

    subgraph cluster_analysis {
        label="分析层\n异步任务";
        style=filled;
        fillcolor="#fce4ec";
        color="#880e4f";
        penwidth=2;

        Task [label="溯源任务\n创建→执行→写回", shape=box, style="rounded, filled", fillcolor="#fce4ec", color="#880e4f", penwidth=2];
        Result [label="关键路径\nTTP 匹配", shape=box, style="rounded, filled", fillcolor="#fce4ec", color="#880e4f", penwidth=2];
    }

    Falco -> Poller;
    Filebeat -> Poller;
    Suricata -> Poller;

    Poller -> Fetch;
    Fetch -> Step1;
    Step1 -> Step2;
    Step2 -> Step3;
    Step3 -> Step4;

    Step2 -> OS;
    Step3 -> OS;
    Step4 -> Neo4j;

    Task -> Neo4j [label="读取"];
    Task -> Neo4j [label="写回"];
}
