\documentclass[12pt]{article} % 也支持 14pt/17pt/20pt

% ==== 编译引擎 ====
\usepackage{ifxetex,ifluatex}
\ifxetex\else\ifluatex\else
  \errmessage{请使用 XeLaTeX 或 LuaLaTeX 编译}
\fi\fi

% ==== 字体与版式 ====
\usepackage{ctex,fontspec,geometry,xcolor}
\usepackage{ragged2e}  % 提供更好的左对齐文本支持
\geometry{paperwidth=7.5in,paperheight=10in, margin=0.7in}
% 采用 XeLaTeX 默认西文字体与 ctex 自动中文字体，减少依赖
\linespread{1.4}
\pagecolor{white}\color{black}

% 全局左对齐所有文本（包括 textbf 等）
\RaggedRight  % 使用 ragged2e 的版本，避免单词间隙过大

% ==== 配色 ====
\definecolor{brand}{HTML}{1A9D8F}      % 主品牌色
\definecolor{brandD}{HTML}{2A7F6F}     % 品牌深色
\definecolor{ink}{HTML}{1A1A1A}
\definecolor{keybg}{HTML}{E8F4F1}      % 浅绿色块
\definecolor{keydark}{HTML}{2F5E58}    % 深绿色文字
\definecolor{accent}{HTML}{FF6B6B}     % 强调红
\definecolor{accentD}{HTML}{D94F4F}
\definecolor{soft}{HTML}{F3F8F7}

% 定理配色
\definecolor{secblue}{HTML}{2B44C6}          % 定理深蓝
\definecolor{thmBg}{RGB}{235,245,255}        % 定理底色浅蓝
\definecolor{lemBg}{RGB}{255,240,240}        % 引理底色暖粉
\definecolor{defBg}{RGB}{232,244,241}        % 定义底色浅绿
% 左侧彩条
\colorlet{thmBar}{secblue}      % 定理左条
\colorlet{lemBar}{accentD}      % 引理左条
\colorlet{defBar}{brand}        % 定义左条

% 高亮辅助色
\definecolor{error}{HTML}{E53935}      % 错误/存疑红
\definecolor{info}{HTML}{64B5F6}       % 信息提示蓝
\definecolor{termblue}{HTML}{1A4C9A}   % 专业名词深蓝

% ==== 日期宏 ====
\newcommand{\padzero}[1]{\ifnum#1<10 0\fi\number#1}
\newcommand{\BrandYMD}{{\the\year·\padzero{\the\month}·\padzero{\the\day}}}

% ==== 封面信息 ====
% 说明：本项目交付封面仅保留学校/学院两行信息（不展示姓名/学号/班级）。
\newcommand{\DocTitle}{作品技术原理介绍}
\newcommand{\SchoolName}{北京邮电大学\\网络空间安全学院}

% ==== 超链接 ====
\usepackage[colorlinks=true, linkcolor=brandD, citecolor=brandD, urlcolor=brandD]{hyperref}
\AtBeginDocument{\hypersetup{pdfauthor={}, pdftitle={\DocTitle}}}

% ==== Markdown → LaTeX（pandoc 片段兼容） ====
% 说明：详细设计正文可能由 docs/*.md 自动转换生成（先自动化导入，再逐章润色）。
% 这些宏/包用于保证 pandoc 输出的 longtable/booktabs/tightlist 能直接编译。
\usepackage{graphicx,longtable,booktabs,array,tabularx}
\newcounter{none} % pandoc 可能设置 \LTcaptype=none，用一个空计数器避免 longtable 报错
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}%
}

% ==== 修复表格溢出问题 ====
% 允许 longtable 跨页，并自动调整列宽
\setlength{\LTleft}{0pt}
\setlength{\LTright}{0pt}

% 减小 longtable 列间距
\setlength{\tabcolsep}{3pt}

% 允许表格内容适当缩放以适应页面宽度
\usepackage{adjustbox}

% 设置 longtable 默认字号为 \small
\AtBeginEnvironment{longtable}{\small}

% ==== 修复长路径和代码块溢出 ====
% 允许 URL 和长路径在任意字符处断行
% 注意：XeLaTeX 不需要 inputenc/fontenc，breakurl 与 hyperref 不兼容
% \usepackage[utf8]{inputenc}
% \usepackage[T1]{fontenc}
\usepackage{url}
% \usepackage{breakurl}  % 与 XeLaTeX + hyperref 不兼容，已禁用

% 设置 \texttt 允许断行（用于文件路径和代码片段）
\usepackage{seqsplit}
\renewcommand{\texttt}[1]{%
  \begingroup
    \urlstyle{tt}%
    \expandafter\url\expandafter{\detokenize{#1}}%
  \endgroup
}

% 启用紧急断行，避免长单词溢出
\emergencystretch 3em

% 设置段落容差（允许行溢出更宽容）
\tolerance 1000
\hyphenpenalty 5000
\exhyphenpenalty 5000

% ==== 全局微调版面以容纳更多内容 ====
% 减小段落间距
\setlength{\parskip}{0.3em}

% 减小列表项间距
\setlength{\itemsep}{0.2em}

% 允许段落在页边缘附近断行
\setlength{\parfillskip}{0pt}

% 减小左右边距（通过调整 geometry）
% 注意：已在前面设置 margin=0.7in

% 处理 verbatim 环境溢出
\usepackage{fancyvrb}
\RecustomVerbatimEnvironment{verbatim}{Verbatim}{fontsize=\scriptsize}

% ==== 封面页 ====
\newcommand{\makecoverpage}{%
  \begin{titlepage}
    \thispagestyle{coverstyle}
    \centering
    \vspace*{2.0cm}
    {\bfseries\color{brandD}\fontsize{34pt}{36pt}\selectfont \DocTitle\par}
    \vspace{1.2cm}
    {\color{brand}\rule{0.78\textwidth}{0.6pt}}\\[1.0cm]
    {\sffamily\color{keydark}\Large \textbf{\seriesnum}}\\[2.2cm]
    {\sffamily\color{brandD}\Large \SchoolName\par}
    \vspace{2.0cm}
    {\color{brand}\rule{0.78\textwidth}{0.6pt}}\\[1.0cm]
    {\sffamily\color{keydark}\large\BrandYMD\par}
    \vspace*{0.6cm}
  \end{titlepage}%
}

% ==== 标题样式 ====
\usepackage{titlesec}
\titleformat{\section}[block]
  {\bfseries\color{keydark}\fontsize{24pt}{26pt}\selectfont\raggedright}
  {\thesection}{0.6em}{}
\titlespacing*{\section}{0pt}{0.9em}{0.5em}

\titleformat{\subsection}
  {\Large\bfseries\color{brand}\raggedright}
  {\thesubsection}{0.6em}{}
\titlespacing*{\subsection}{0pt}{0.8em}{0.4em}

% ==== 页眉页脚 ====
\usepackage{fancyhdr}
\fancypagestyle{coverstyle}{%
  \fancyhf{}\renewcommand{\headrulewidth}{0pt}\renewcommand{\footrulewidth}{0pt}
}
\fancyhf{}
\renewcommand{\headrulewidth}{0pt}
\renewcommand{\footrulewidth}{0pt}
\renewcommand{\sectionmark}[1]{} % 移除页眉显示
\fancyhead{} % 清空页眉
\fancyfoot{} % 不显示页脚（含页码）
\pagestyle{fancy}
\setlength{\headheight}{15pt} % 避免 fancyhdr 警告

% ==== 系列编号占位 ====
\newcommand{\seriesnum}{Attack Trace Analyzer（ATA）} % 封面副标题

% ==== 目录页面 ====
\renewcommand{\contentsname}{目录}
\makeatletter
\newcommand{\plainTOC}{% 去掉默认节标题导致的额外垂直间距
  \begingroup
  \parskip=0pt \parindent=0pt
  \@starttoc{toc}%
  \endgroup
}
\makeatother

\newcommand{\makeTOCpage}{%
  \clearpage
  \thispagestyle{coverstyle}
  \begin{center}
    \vspace*{0.8cm}
    {\bfseries\color{brandD}\fontsize{24pt}{26pt}\selectfont 目录}\par
    \vspace{0.18cm}
    {\color{brand}\rule{0.78\textwidth}{0.6pt}}\par
    \vspace{0.08cm}
  \end{center}
  \vspace{-0.28cm}
  {\small\plainTOC}
  \clearpage
}

% ==== 信息块 ====
\usepackage[most]{tcolorbox}
\tcbset{enhanced, boxrule=0.9pt, arc=3pt, left=10pt,right=10pt,top=10pt,bottom=10pt}
\newtcolorbox{KeyBox}{
  colback=keybg, colframe=brandD,
  colbacktitle=brandD, title=\textbf{\color{white}要点},
  fonttitle=\bfseries\large, coltitle=white, breakable
}
\newtcolorbox{Takeaway}{
  colback=accent!12, colframe=accentD,
  colbacktitle=accentD, title=\textbf{\color{white}结论},
  fonttitle=\bfseries\large, coltitle=white, breakable
}

% ==== 侧边栏 ====
\usepackage{mdframed}
\newmdenv[
  topline=false, bottomline=false, rightline=false,
  linewidth=4pt, linecolor=brand, backgroundcolor=soft,
  innerleftmargin=10pt, innerrightmargin=10pt,
  skipabove=6pt, skipbelow=6pt
]{SideBar}

% ==== 数学与定理环境 ====
\usepackage{amsmath,amssymb,bm,amsthm}
\DeclareMathOperator{\Var}{Var}
\newcommand{\E}{\mathbb{E}}
\setcounter{secnumdepth}{3} % 确保子小节编号

% 定理样式（按节编号）
\newtheoremstyle{customthm}{0.8em}{0.8em}{\itshape}{}{\bfseries}{.}{0.5em}{}
\newtheoremstyle{customdef}{0.8em}{0.8em}{}{}{\bfseries}{.}{0.5em}{}

\theoremstyle{customthm}
\newtheorem{theorem}{定理}[section]
\newtheorem{lemma}[theorem]{引理}

\theoremstyle{customdef}
\newtheorem{definition}[theorem]{定义}

% --- 定理类环境（tcolorbox 包裹）---
% 颜色：定理=蓝 (secblue/thmBg)，引理=红 (accentD/lemBg)，定义=绿 (brand/defBg)
% 风格：左侧 2pt 彩条、圆角、统一内边距，标题加粗；[] 为空则不加括号

% 定理环境
\let\oldtheorem\theorem
\let\endoldtheorem\endtheorem
\renewenvironment{theorem}[1][]{%
  \begin{tcolorbox}[
    enhanced,
    breakable,
    colback=thmBg,
    colframe=thmBar,
    boxrule=0pt,
    borderline west={2pt}{0pt}{thmBar},
    sharp corners,
    arc=2pt,
    left=10pt,right=10pt,top=8pt,bottom=8pt,
    before skip=10pt,after skip=10pt
  ]%
  \if\relax\detokenize{#1}\relax
    \begin{oldtheorem}\itshape
  \else
    \begin{oldtheorem}[\textbf{#1}]\itshape
  \fi
}{%
    \end{oldtheorem}%
  \end{tcolorbox}%
}

% 引理环境
\let\oldlemma\lemma
\let\endoldlemma\endlemma
\renewenvironment{lemma}[1][]{%
  \begin{tcolorbox}[
    enhanced,
    breakable,
    colback=lemBg,
    colframe=lemBar,
    boxrule=0pt,
    borderline west={2pt}{0pt}{lemBar},
    sharp corners,
    arc=2pt,
    left=10pt,right=10pt,top=8pt,bottom=8pt,
    before skip=10pt,after skip=10pt
  ]%
  \if\relax\detokenize{#1}\relax
    \begin{oldlemma}\itshape
  \else
    \begin{oldlemma}[\textbf{#1}]\itshape
  \fi
}{%
    \end{oldlemma}%
  \end{tcolorbox}%
}

% 定义环境
\let\olddefinition\definition
\let\endolddefinition\enddefinition
\renewenvironment{definition}[1][]{%
  \begin{tcolorbox}[
    enhanced,
    breakable,
    colback=defBg,
    colframe=defBar,
    boxrule=0pt,
    borderline west={2pt}{0pt}{defBar},
    sharp corners,
    arc=2pt,
    left=10pt,right=10pt,top=8pt,bottom=8pt,
    before skip=10pt,after skip=10pt
  ]%
  \if\relax\detokenize{#1}\relax
    \begin{olddefinition}\itshape
  \else
    \begin{olddefinition}[\textbf{#1}]\itshape
  \fi
}{%
    \end{olddefinition}%
  \end{tcolorbox}%
}

% ==== 章节机制（自定义章号/章题，仅影响编号显示） ====
\newcounter{chapter}
\newcommand{\setchapter}[2]{%
  \setcounter{chapter}{#1}%
  \setcounter{section}{0}%
  \def\ChapterTitle{#2}%
}
\renewcommand{\thesection}{\arabic{chapter}.\arabic{section}}
\renewcommand{\thesubsection}{\arabic{chapter}.\arabic{section}.\arabic{subsection}}
\newcommand{\ChapterHeading}{%
  \vspace*{0.6cm}
  {\centering
    {\fontsize{26pt}{28pt}\selectfont\bfseries\color{keydark}
      第\arabic{chapter}章\ \ChapterTitle\par}
  }%
  \vspace{0.6cm}
}
\newcommand{\BeginChapter}[2]{%
  \clearpage
  \setchapter{#1}{#2}%
  \ChapterHeading
}



% ==== 示例盒子 ====
\definecolor{exframe}{HTML}{6C5CE7}
\definecolor{exbg}{HTML}{F2E9FF}
\newtcolorbox{Example}[1][]{%
  enhanced, colback=exbg, colframe=exframe,
  coltitle=white, colbacktitle=exframe,
  title=\textbf{示例},
  fonttitle=\bfseries, boxrule=1.1pt, arc=4pt,
  left=10pt,right=10pt,top=10pt,bottom=10pt,
  attach boxed title to top left = {yshift=-2mm, xshift=2mm},
  breakable, #1
}

% ==== 证明环境 ====
\renewenvironment{proof}[1][证明]{\par
  \pushQED{\qed}%
  \normalfont \topsep6pt \partopsep0pt
  \trivlist
  \item[\hskip\labelsep\bfseries #1.]\ignorespaces
}{\popQED\endtrivlist}



% ==== 高亮（手绘底色） ====
\usepackage{tikz}
\newcommand{\hltext}[2][yellow!30]{%
  \tikz[baseline=(X.base)] \node[rectangle, rounded corners=2pt,
  fill=#1, inner sep=2pt, anchor=base] (X) {#2};%
}



% ==== 语义化快捷命令 ====
\newcommand{\KeyIdea}[1]{\hltext[keybg]{\textbf{#1}}}            % 关键想法：浅绿底
\newcommand{\Term}[1]{\textcolor{termblue}{\textbf{#1}}}           % 专业名词：品牌深绿字
\newcommand{\Emph}[1]{\textcolor{accentD}{\textbf{#1}}}          % 强调词汇：红
\newcommand{\Confuse}[1]{\hltext[error!20]{\textcolor{error}{#1}}} % 疑问或存疑处

\newcommand{\Info}[1]{\textcolor{info!90!black}{#1}}             % 说明或注解

% ========================= 文档开始 =========================
\begin{document}

% 标题页（信息由上述命令给出，可根据需要修改）
\makecoverpage
\setcounter{page}{1}

% 目录页
\makeTOCpage

% 使用标准 section 编号（用于 pandoc 生成正文）
% 注意：本模板为了"章号"效果重写了 \thesection，这里显式还原为标准编号，避免出现 0.1 之类的编号。
\renewcommand{\thesection}{\arabic{section}}
\renewcommand{\thesubsection}{\thesection.\arabic{subsection}}
\renewcommand{\thesubsubsection}{\thesubsection.\arabic{subsubsection}}

% 自动生成正文（chapters/*.tex → index.tex → \input）
\IfFileExists{index.tex}{%
  \input{index.tex}%
}{%
  \begin{SideBar}
    \textbf{尚未生成正文内容。}
  \end{SideBar}
}%

\end{document}
