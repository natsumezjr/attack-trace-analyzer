# 靶场使用指南（启动 / 验收 / 重置）

目标：给组内同学一份“照做即可”的运行手册。

---

## 1. 启动与停止（常用）

### 1.1 启动 center-01（OpenSearch + Neo4j）

```bash
cd "$BASE"/repo/attack-trace-analyzer/backend
docker-compose up -d
```

停止：

```bash
cd "$BASE"/repo/attack-trace-analyzer/backend
docker-compose down
```

### 1.2 启动/停止单个 client（以 client-01 为例）

```bash
cd "$BASE"/run/client-01
docker-compose up -d --build
docker-compose ps
```

停止：

```bash
cd "$BASE"/run/client-01
docker-compose down
```

client-02/03/04 同理，只是目录不同。

### 1.3 启动/停止 c2-01（DNS + HTTP）

说明：c2-01 用 `docker run` 启动（不是 compose）。

查看状态：

```bash
docker ps --format 'table {{.Names}}\t{{.Status}}\t{{.Networks}}' | egrep 'c2-dns|c2-http' || true
```

停止/删除：

```bash
docker rm -f c2-dns c2-http
```

---

## 2. 一键验收（最推荐）

### 2.1 四个 client 的采集是否在产数

```bash
for p in 18881 18882 18883 18884; do
  echo "== client api :$p =="
  curl -s "http://10.92.35.13:$p/filebeat" | python3 -c "import sys,json; print('filebeat total=', json.load(sys.stdin).get('total'))"
  curl -s "http://10.92.35.13:$p/falco"    | python3 -c "import sys,json; print('falco total=',   json.load(sys.stdin).get('total'))"
  curl -s "http://10.92.35.13:$p/suricata" | python3 -c "import sys,json; print('suricata total=',json.load(sys.stdin).get('total'))"
done
```

### 2.2 C2 的 DNS/HTTP 与抓包证据（以 macvlan0 为准）

```bash
sudo timeout 3 tcpdump -i macvlan0 -nn '(host 10.92.35.50 and (udp port 53 or tcp port 53)) or (host 10.92.35.51 and tcp port 80)' &
sleep 0.2
dig @10.92.35.50 c2.lab.local +noall +answer +time=1 +tries=1
curl -s http://10.92.35.51/health && echo
wait
```

---

## 3. 重置与复现（不会删代码）

### 3.1 仅重置某个 client 的数据（保留容器/配置）

以 client-03 为例（会清空该实例 `./data` 下的数据库/输出文件）：

```bash
cd "$BASE"/run/client-03
docker-compose down
rm -rf ./data/*
docker-compose up -d --build
```

### 3.2 只重置 c2 内容（不改网络）

```bash
rm -rf "$BASE"/run/c2/html/*
printf "ok\n" > "$BASE"/run/c2/html/health
printf "hello from c2 (benign)\n" > "$BASE"/run/c2/html/payload
docker restart c2-http
```

> 注意：macvlan 网络与 `macvlan0` 子接口属于“底座网络配置”，一般不需要频繁重置。

