# 重置 / 复现 / 排障（靶场负责人版）

本文件给你一套“演示前必做”的操作规范：保证你每次演示都从干净状态开始，出问题也能快速定位到是网络、采集还是配置。

---

## 1) 重置（两档策略）

### 档 A：只重置客户机数据（推荐日常使用）

目的：保留中心机数据库（OpenSearch/Neo4j）以便排障，但让 client 的采集证据重新生成。

你要清掉的东西：

- `run/client-*/data/` 下的：
  - `data.db`
  - falco 输出（如 `falco.jsonl`）
  - suricata 输出（eve/log 等）

验收标准：

- 重新启动 client 后，`data.db` 会重新增长
- client API 的 `total` 从小数开始增长

### 档 B：全量重置（演示“从零开始闭环”时用）

目的：连同 OpenSearch/Neo4j 的持久化数据一起清空，保证所有索引/图谱从零生成。

你要额外清掉：

- OpenSearch 数据卷
- Neo4j 数据卷

注意：

- 全量重置会导致中心机初始化时间更长（尤其是 OpenSearch）

---

## 2) 复现（固定节奏，确保可讲述）

推荐把演示拆成三段，每段都能说清楚“证据在哪里”：

1) **网络证据**：DNS（c2.lab.local）+ HTTP（/health）  
2) **主机证据**：一次登录 + 一次文件读写  
3) **多实例差异**：在 client-01 与 client-02 分别做动作，证明“节点维度”成立

对应的验收点见：

- `04-验证清单（网络-采集-证据）.md`

---

## 3) 排障速查

### 3.1 `docker compose` 不可用但 `docker-compose` 可用

这是工具版本问题，不影响靶场本质。短期用 `docker-compose` 跑通即可。

### 3.2 Suricata 看不到 DNS/HTTP（最常见）

优先确认：

- 目标 IP 是否真的会走 `ens5f1`（同机访问宿主 IP 往往走 loopback）
- C2 是否用了 macvlan 独立 IP（推荐）
- Suricata 抓包接口是否明确设置为 `ens5f1`

### 3.3 Falco 起不来

你之前环境检查已经满足：

- `--privileged` 可用
- `/lib/modules/$(uname -r)` 存在
- `/sys/kernel/tracing` 可访问

如果仍失败，收集 Falco 容器日志，一般是 driver/ebpf 加载问题（与内核/权限有关）。

### 3.4 多实例端口冲突

多实例必须改：

- client API 宿主端口（18881..18884）
- suricata-exporter 宿主端口（18081..18084）

并确保每个实例使用不同数据目录，否则 SQLite 会互相污染。

