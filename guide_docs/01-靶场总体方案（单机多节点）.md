# 靶场总体方案（单机多节点）

适用前提：你只有一台内网 Linux 主机（示例：`10.92.35.13`），但需要完成课程“≥5 节点靶场”并支撑多源证据采集与溯源展示。

核心思路：用 Docker 在单机上跑 **1 套中心机** + **4 套客户机实例** + **1 套 C2（DNS+HTTP）**，在“逻辑层面”满足多节点与通信链路。

---

## 1. 节点与角色（推荐最小集）

| 节点 | 数量 | 作用 |
|---|---:|---|
| `center-01` | 1 | OpenSearch + Neo4j + 后端 API + 前端（中心机） |
| `client-01..04` | 4 | 客户机采集：Filebeat/Falco/Suricata → RabbitMQ 队列缓冲 → Client API |
| `c2-01` | 1 | DNS + HTTP（模拟外联目标，产生稳定网络证据） |

> 这样你在“节点数口径”上是 6 个节点（≥5）。

---

## 2. 你作为靶场负责人的交付标准（务必对齐）

即使中心机/客户机业务代码没完全写完，你这部分也要做到：

- **网络可达**：中心机 ↔ 客户机 ↔ C2 的连通性明确（端口规划清晰）
- **采集可跑**：至少 1 个客户机实例能稳定产生并写入 RabbitMQ 队列（`data.filebeat` / `data.falco` / `data.suricata`）
- **证据可见**：能制造并观测到 DNS/HTTP/SSH 这类网络证据（Suricata 可见）
- **可复现**：一键启动/停止 + 一键清空数据（下次演示不串数据）

---

## 3. 单机多节点的“真实性取舍”

单机多节点有两个不可避免的事实：

1) 多个客户机实例共享同一宿主机内核与网卡  
2) 如果目标 IP 是宿主机自身 IP，流量可能走 loopback，导致 Suricata 抓 `ens5f1` 看不到

解决策略：

- **端口与数据隔离**：每个 client 实例独立目录、独立宿主端口
- **C2 用独立 IP**：优先用 macvlan 给 C2 分配一个“内网独立 IP”，让请求真实经过 `ens5f1`

---

## 4. 统一命名/端口/目录约定（强烈建议照这个定）

### 4.1 宿主端口规划

中心机：

- OpenSearch：`9200/9600`
- Neo4j：`7474/7687`
- 后端：`8000`
- 前端：`3000`

客户机（每实例两个端口）：

| 实例 | Client API（容器 8888） | Suricata exporter（容器 8080） |
|---|---:|---:|
| client-01 | 18881 | 18081 |
| client-02 | 18882 | 18082 |
| client-03 | 18883 | 18083 |
| client-04 | 18884 | 18084 |

C2（独立 IP 时无需端口映射；host network 时需要占用宿主 53/80）：

- DNS：53/udp + 53/tcp
- HTTP：80/tcp（或 8088/tcp 避免占用 80）

### 4.2 数据目录规划

建议在宿主机固定一个根目录（示例）：

- `/home/ubuntu/attack-trace-analyzer/`（推荐：避免 sudo 与权限坑）
  - `repo/`（项目代码）
  - `run/`
    - `center/`（可选：中心机持久化数据）
    - `client-01/data/`（含 suricata 输出、falco 输出、filebeat 输出等）
    - `client-02/data/`
    - `client-03/data/`
    - `client-04/data/`
    - `c2/`（DNS/HTTP 配置与日志）

---

## 5. 下一步

按这个方案落地的“一键部署编排”见：

- `02-一键部署编排（center+4client+c2）.md`
